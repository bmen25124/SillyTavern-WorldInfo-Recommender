import*as e from"../../../../power-user.js";import*as t from"../../../../../script.js";import*as n from"../../../../world-info.js";import*as r from"../../../../instruct-mode.js";import*as o from"../../../../chats.js";import*as i from"../../../../openai.js";import*as s from"../../../../authors-note.js";import*as a from"../../../../group-chats.js";import*as l from"../../../regex/engine.js";import*as c from"../../../../utils.js";import*as u from"../../../../../lib.js";var d={d:(e,t)=>{for(var n in t)d.o(t,n)&&!d.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};function p(e,t={}){const n=$(e);if(0===n.length)throw new Error(`Could not find container: ${e}`);n.empty().addClass("fancy-dropdown-container");const r=$("<div></div>").addClass("fancy-dropdown-list").css({"max-height":"300px","overflow-y":"auto",border:"1px solid var(--border-color)","background-color":"var(--bg-color)",color:"var(--text-color)","border-radius":"4px"});n.append(r);let o=[...t.initialValues||[]];const i=()=>{r.find(".fancy-dropdown-item").each((function(){const e=$(this),t=e.data("value");o.includes(t)?(e.addClass("selected"),e.find(".checkmark").show()):(e.removeClass("selected"),e.find(".checkmark").hide())}))};if(t.initialList&&t.initialList.length>0)for(const e of t.initialList){const n=$("<div></div>").addClass("fancy-dropdown-item").data("value",e).css({padding:"8px 12px",cursor:"pointer",display:"flex","align-items":"center","justify-content":"space-between"}).hover((function(){$(this).css("background-color","var(--hover-color, #444)")}),(function(){$(this).css("background-color","")}));$("<span></span>").text(e).appendTo(n);const s=$("<i></i>").addClass("checkmark fa-solid fa-check").css({"margin-left":"8px",display:o.includes(e)?"inline-block":"none"});n.append(s),n.on("click",(function(){const e=$(this).data("value"),n=[...o];o.includes(e)?o=o.filter((t=>t!==e)):o.push(e),i(),t.onSelectChange&&t.onSelectChange(n,o)})),r.append(n)}return i(),{$container:n,$dropdownList:r,getValues:()=>[...o],setValues:e=>{const n=[...o];o=[...e],i(),t.onSelectChange&&JSON.stringify(n)!==JSON.stringify(o)&&t.onSelectChange(n,o)},getOptions:()=>t.initialList||[],addOption:(e,n=!1)=>{if(t.initialList&&t.initialList.includes(e))return;t.initialList||(t.initialList=[]),t.initialList.push(e);const s=$("<div></div>").addClass("fancy-dropdown-item").data("value",e).css({padding:"8px 12px",cursor:"pointer",display:"flex","align-items":"center","justify-content":"space-between"}).hover((function(){$(this).css("background-color","var(--hover-color, #444)")}),(function(){$(this).css("background-color","")}));$("<span></span>").text(e).appendTo(s);const a=$("<i></i>").addClass("checkmark fa-solid fa-check").css({"margin-left":"8px",display:"none"});if(s.append(a),s.on("click",(function(){const e=$(this).data("value"),n=[...o];o.includes(e)?o=o.filter((t=>t!==e)):o.push(e),i(),t.onSelectChange&&t.onSelectChange(n,o)})),r.append(s),n&&!o.includes(e)){const n=[...o];o.push(e),i(),t.onSelectChange&&t.onSelectChange(n,o)}},removeOption:e=>{if(t.initialList&&(t.initialList=t.initialList.filter((t=>t!==e))),o.includes(e)){const n=[...o];o=o.filter((t=>t!==e)),t.onSelectChange&&t.onSelectChange(n,o)}r.find(`.fancy-dropdown-item[data-value="${e}"]`).remove()},selectAll:()=>{const e=[...o];o=[...t.initialList||[]],i(),t.onSelectChange&&JSON.stringify(e)!==JSON.stringify(o)&&t.onSelectChange(e,o)},deselectAll:()=>{const e=[...o];o=[],i(),t.onSelectChange&&e.length>0&&t.onSelectChange(e,o)},disable:()=>{r.css("pointer-events","none").css("opacity","0.6")},enable:()=>{r.css("pointer-events","auto").css("opacity","1")}}}const f=(e=>{var t={};return d.d(t,e),t})({persona_description_positions:()=>e.persona_description_positions,renderStoryString:()=>e.renderStoryString});const h=(e=>{var t={};return d.d(t,e),t})({baseChatReplace:()=>t.baseChatReplace,characters:()=>t.characters,chat_metadata:()=>t.chat_metadata,depth_prompt_depth_default:()=>t.depth_prompt_depth_default,depth_prompt_role_default:()=>t.depth_prompt_role_default,extension_prompt_types:()=>t.extension_prompt_types,getMaxContextSize:()=>t.getMaxContextSize,name1:()=>t.name1,name2:()=>t.name2,parseMesExamples:()=>t.parseMesExamples,this_chid:()=>t.this_chid});const m=(e=>{var t={};return d.d(t,e),t})({METADATA_KEY:()=>n.METADATA_KEY,createWorldInfoEntry:()=>n.createWorldInfoEntry,loadWorldInfo:()=>n.loadWorldInfo,selected_world_info:()=>n.selected_world_info,wi_anchor_position:()=>n.wi_anchor_position,world_info:()=>n.world_info,world_info_include_names:()=>n.world_info_include_names});const g=(e=>{var t={};return d.d(t,e),t})({formatInstructModeExamples:()=>r.formatInstructModeExamples,formatInstructModeSystemPrompt:()=>r.formatInstructModeSystemPrompt});const v=(e=>{var t={};return d.d(t,e),t})({appendFileContent:()=>o.appendFileContent});const y=(e=>{var t={};return d.d(t,e),t})({formatWorldInfo:()=>i.formatWorldInfo,getPromptPosition:()=>i.getPromptPosition,getPromptRole:()=>i.getPromptRole,prepareOpenAIMessages:()=>i.prepareOpenAIMessages,setOpenAIMessageExamples:()=>i.setOpenAIMessageExamples,setOpenAIMessages:()=>i.setOpenAIMessages});const x=(e=>{var t={};return d.d(t,e),t})({metadata_keys:()=>s.metadata_keys});const b=(e=>{var t={};return d.d(t,e),t})({getGroupDepthPrompts:()=>a.getGroupDepthPrompts,selected_group:()=>a.selected_group});const w=(e=>{var t={};return d.d(t,e),t})({getRegexedString:()=>l.getRegexedString,regex_placement:()=>l.regex_placement});const I=(e=>{var t={};return d.d(t,e),t})({getCharaFilename:()=>c.getCharaFilename});async function k(e,t,{escapeHtml:n=!0}={}){await async function(e,...t){await SillyTavern.getContext().SlashCommandParser.commands[e].callback(...t)}("echo",{severity:e,escapeHtml:Boolean(n).toString()},t)}function P(e){return(0,h.getMaxContextSize)(e)}function S(e,t){return(0,h.parseMesExamples)(e,t)}function N(e,t,n){return(0,h.baseChatReplace)(e,t,n)}function E(e){return(0,y.getPromptRole)(e)}function _(e,{wiFormat:t}={}){return(0,y.formatWorldInfo)(e,{wiFormat:t})}function T(e){return(0,y.getPromptPosition)(e)}async function A(e){return await(0,m.loadWorldInfo)(e)}async function O(e,{targetCharacterId:t,presetName:n,instructName:r,contextName:o,syspromptName:i,maxContext:s,includeNames:a,ignoreCharacterFields:l,ignoreAuthorNote:c,ignoreWorldInfo:u,messageIndexesBetween:d}={}){if(!["textgenerationwebui","openai"].includes(e))throw new Error("Unsupported API");const p=SillyTavern.getContext();let I=[],{description:k,personality:A,persona:O,scenario:C,mesExamples:R,system:j,jailbreak:D}=l?{description:"",personality:"",persona:"",scenario:"",mesExamples:"",system:"",jailbreak:""}:p.getCharacterCardFields({chid:t});const L="textgenerationwebui"===e?p.getPresetManager("instruct")?.getCompletionPresetByName(r):void 0,M=!!L?.enabled;let $=S(R,M);const F=function(){if("number"==typeof s)return s;if(!s)return P();if("active"===s||!n)return P();if("number"==typeof s)return s;let t;if("textgenerationwebui"===e){const e=p.getPresetManager("textgenerationwebui")?.getCompletionPresetByName(n);t=e?.max_length}else{const e=p.getPresetManager("openai")?.getCompletionPresetByName(n);t=e?.openai_max_context}return"number"==typeof t?t:P()}();if(F<=0)return[];const V=p.ToolManager.isToolCallingSupported(),W=d?.start??0,B=d?.end?d.end+1:void 0;let U=-1===W&&0===B?[]:p.chat.slice(W,B).filter((e=>!e.is_system||V&&Array.isArray(e.extra?.tool_invocations)));U=await Promise.all(U.map((async(e,t)=>{let n=function(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:i,depth:s}){return(0,w.getRegexedString)(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:i,depth:s})}(e.mes,e.is_user?w.regex_placement.USER_INPUT:w.regex_placement.AI_OUTPUT,{isPrompt:!0,depth:U.length-t-1});return n=await async function(e,t){return await(0,v.appendFileContent)(e,t)}(e,n),e?.extra?.append_title&&e?.extra?.title&&(n=`${n}\n\n${e.extra.title}`),{...e,mes:n,index:t}})));const G=U.map((e=>m.world_info_include_names?`${e.name}: ${e.mes}`:e.mes)).reverse(),{worldInfoString:H,worldInfoBefore:K,worldInfoAfter:q,worldInfoExamples:X,worldInfoDepth:Y,anBefore:z,anAfter:Z}=u?{worldInfoString:"",worldInfoBefore:"",worldInfoAfter:"",worldInfoExamples:[],worldInfoDepth:[],anBefore:[],anAfter:[]}:await p.getWorldInfoPrompt(G,F,!1);for(const se of X){const ae=se.content;if(0===ae.length)continue;const le=S(N(ae,h.name1,h.name2),M);se.position===m.wi_anchor_position.before?$.unshift(...le):$.push(...le)}function J(){let e=0;const t=[];for(let n=U.length-1;n>=0;n--){const r=U[n];if(r.extra?.token_count&&e+r.extra.token_count>F)break;e+=r.extra?.token_count||0,t.unshift({role:r.is_user?"user":"assistant",content:a?`${r.name}: ${r.mes}`:r.mes})}I.push(...t)}if("textgenerationwebui"===e){const ce=[...$];$&&($=function(e,t,n){return(0,g.formatInstructModeExamples)(e,t,n)}($,h.name1,h.name2));const ue=p.getPresetManager("sysprompt")?.getCompletionPresetByName(i);ue&&(j=p.powerUserSettings.prefer_character_prompt&&j?j:N(ue.content,h.name1,h.name2),j=M?(ee=p.substituteParams(j,h.name1,h.name2,ue.content),te=L,(0,g.formatInstructModeSystemPrompt)(ee,te)):j);const de={description:k,personality:A,persona:p.powerUserSettings.persona_description_position==f.persona_description_positions.IN_PROMPT?O:"",scenario:C,system:j,char:h.name2,user:h.name1,wiBefore:K,wiAfter:q,loreBefore:K,loreAfter:q,mesExamples:$.join(""),mesExamplesRaw:ce.join("")},pe=p.getPresetManager("context")?.getCompletionPresetByName(o);let fe=function(e,{customStoryString:t,customInstructSettings:n}={}){return(0,f.renderStoryString)(e,{customStoryString:t,customInstructSettings:n})}(de,{customInstructSettings:L,customStoryString:pe?.story_string});I.push({role:"system",content:fe,ignoreInstruct:!0}),J()}else{let he=(Q=U,(0,y.setOpenAIMessages)(Q)),me=function(e){return(0,y.setOpenAIMessageExamples)(e)}($);async function ge(){let[e,t]=await function({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:i,bias:s,type:a,quietPrompt:l,quietImage:c,extensionPrompts:u,cyclePrompt:d,systemPromptOverride:p,jailbreakPromptOverride:f,personaDescription:h,messages:m,messageExamples:g},v){return(0,y.prepareOpenAIMessages)({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:i,bias:s,type:a,quietPrompt:l,quietImage:c,cyclePrompt:d,systemPromptOverride:p,jailbreakPromptOverride:f,personaDescription:h,extensionPrompts:u,messages:m,messageExamples:g},v)}({name2:h.name2,charDescription:k,charPersonality:A,Scenario:C,worldInfoBefore:K,worldInfoAfter:q,extensionPrompts:p.extensionPrompts,bias:"",type:"normal",quietPrompt:void 0,quietImage:void 0,cyclePrompt:"",systemPromptOverride:j,jailbreakPromptOverride:D,personaDescription:O,messages:he,messageExamples:me},!1);I.push(...e)}if(!n)return await ge(),I;const ve=p.getPresetManager("openai")?.getCompletionPresetByName(n);if(!ve)return console.warn(`Preset not found: ${n}. Using current preset.`),ge(),I;let ye=ve.prompt_order.find((e=>e.character_id===h.this_chid));if(!ye&&ve.prompt_order.length>0&&(ye=ve.prompt_order[0]),!ye)return console.warn(`No prompt order found for preset: ${n}. Using current preset.`),ge(),I;const xe=C&&ve.scenario_format?p.substituteParams(ve.scenario_format):"",be=A&&ve.personality_format?p.substituteParams(ve.personality_format):"",we=p.substituteParams(ve.group_nudge_prompt),Ie=ve.impersonation_prompt?p.substituteParams(ve.impersonation_prompt):"",ke=[];u&&ke.push({role:"system",content:_(K,{wiFormat:ve.wi_format}),identifier:"worldInfoBefore"},{role:"system",content:_(q,{wiFormat:ve.wi_format}),identifier:"worldInfoAfter"}),l||ke.push({role:"system",content:k,identifier:"charDescription"},{role:"system",content:be,identifier:"charPersonality"},{role:"system",content:xe,identifier:"scenario"}),ke.push({role:"system",content:Ie,identifier:"impersonate"},{role:"system",content:we,identifier:"groupNudge"});const Pe=p.extensionPrompts["1_memory"];Pe&&Pe.value&&ke.push({role:E(Pe.role),content:Pe.value,identifier:"summary",position:T(Pe.position)});const Se=p.extensionPrompts["2_floating_prompt"];!c&&Se&&Se.value&&ke.push({role:E(Se.role),content:Se.value,identifier:"authorsNote",position:T(Se.position)});const Ne=p.extensionPrompts["3_vectors"];Ne&&Ne.value&&ke.push({role:"system",content:Ne.value,identifier:"vectorsMemory",position:T(Ne.position)});const Ee=p.extensionPrompts["4_vectors_data_bank"];Ee&&Ee.value&&ke.push({role:E(Ee.role),content:Ee.value,identifier:"vectorsDataBank",position:T(Ee.position)});const _e=p.extensionPrompts.chromadb;_e&&_e.value&&ke.push({role:"system",content:_e.value,identifier:"smartContext",position:T(_e.position)}),!l&&p.powerUserSettings.persona_description&&p.powerUserSettings.persona_description_position===f.persona_description_positions.IN_PROMPT&&ke.push({role:"system",content:p.powerUserSettings.persona_description,identifier:"personaDescription"}),ye.order.forEach((e=>{if(!e.enabled)return;const t=(n=e.identifier,ke.find((e=>e.identifier===n)));var n;t&&t.content?I.push({role:t.role??"system",content:p.substituteParams(t.content)}):"chatHistory"===e.identifier&&J()}))}var Q,ee,te;const ne=["1_memory","2_floating_prompt","3_vectors","4_vectors_data_bank","chromadb","PERSONA_DESCRIPTION","QUIET_PROMPT","DEPTH_PROMPT"];for(const Te in p.extensionPrompts)if(Object.hasOwn(p.extensionPrompts,Te)){const Ae=p.extensionPrompts[Te];if(ne.includes(Te))continue;if(!p.extensionPrompts[Te].value)continue;if(![h.extension_prompt_types.BEFORE_PROMPT,h.extension_prompt_types.IN_PROMPT].includes(Ae.position))continue;if("function"==typeof Ae.filter&&!await Ae.filter())continue;Ae.position===h.extension_prompt_types.BEFORE_PROMPT?I=[...I.slice(0,Ae.depth),{role:E(Ae.role)??"system",content:Ae.value},...I.slice(Ae.depth)]:Ae.position===h.extension_prompt_types.IN_PROMPT&&(I=[...I.slice(0,I.length-Ae.depth),{role:E(Ae.role)??"system",content:Ae.value},...I.slice(I.length-Ae.depth)])}for(const Oe of Y)I=[...I.slice(0,I.length-Oe.depth),{role:E(Oe.role),content:Oe.entries.join("\n")},...I.slice(I.length-Oe.depth)];if(!l){const Ce=(re=b.selected_group,oe=Number(h.this_chid),(0,b.getGroupDepthPrompts)(re,oe));if(b.selected_group&&Array.isArray(Ce)&&Ce.length>0)Ce.forEach(((e,t)=>{I=[...I.slice(0,I.length-e.depth),{role:e.role,content:e.text},...I.slice(I.length-e.depth)]}));else{const Re=N(h.characters[h.this_chid]?.data?.extensions?.depth_prompt?.prompt?.trim(),h.name1,h.name2)||"",je=h.depth_prompt_depth_default,De=h.characters[h.this_chid]?.data?.extensions?.depth_prompt?.role??h.depth_prompt_role_default;I=[...I.slice(0,I.length-je),{role:E(De),content:Re},...I.slice(I.length-je)]}}var re,oe;let ie=-1;if(!c){const Le={prompt:h.chat_metadata[x.metadata_keys.prompt],interval:h.chat_metadata[x.metadata_keys.interval],position:h.chat_metadata[x.metadata_keys.position],depth:h.chat_metadata[x.metadata_keys.depth],role:h.chat_metadata[x.metadata_keys.role]};if(Le.prompt)switch(Le.prompt=N(Le.prompt,h.name1,h.name2),Le.position){case h.extension_prompt_types.IN_PROMPT:I=[...I.slice(0,1),{role:"user",content:Le.prompt},...I.slice(1)],ie=1;break;case h.extension_prompt_types.IN_CHAT:I=[...I.slice(0,I.length-Le.depth),{role:E(Le.role),content:Le.prompt},...I.slice(I.length-Le.depth)],ie=I.length-Le.depth-1;break;case h.extension_prompt_types.BEFORE_PROMPT:I.unshift({role:"user",content:Le.prompt}),ie=0}}return ie>=0&&(z.length>0&&(I=[...I.slice(0,ie),{role:"system",content:z.join("\n")},...I.slice(ie)],ie++),Z.length>0&&(I=[...I.slice(0,ie+1),{role:"system",content:Z.join("\n")},...I.slice(ie+1)])),I}async function C(e,t){function n(t){return e.includes("all")||e.includes(t)}const r=SillyTavern.getContext();let o={};if(n("global")&&m.selected_world_info?.length)for(const e of m.selected_world_info){const t=await A(e);t&&Object.values(t.entries).forEach((t=>{o[e]||(o[e]=[]),o[e].push(t)}))}if(n("chat")){const e=r.chatMetadata[m.METADATA_KEY];if(e&&!o[e]){o[e]=[];const t=await A(e);t&&Object.values(t.entries).forEach((t=>{o[e].push(t)}))}}if(n("character")){const e=h.characters[t];let n=new Set;const r=e?.data?.extensions?.world;r&&n.add(r);const i=function(e,{manualAvatarKey:t}={}){return(0,I.getCharaFilename)(e,{manualAvatarKey:t})}(t),s=m.world_info.charLore?.find((e=>e.name===i));s&&(n=new Set([...n,...s.extraBooks]));for(const e of n){const t=await A(e);t&&!o[e]&&(o[e]=[],Object.values(t.entries).forEach((t=>{o[e].push(t)})))}}if(n("persona")){const e=r.powerUserSettings.persona_description_lorebook;if(e&&!o[e]){o[e]=[];const t=await A(e);t&&Object.values(t.entries).forEach((t=>{o[e].push(t)}))}}return o}var R,j;!function(e){e[e.TEXT=1]="TEXT",e[e.CONFIRM=2]="CONFIRM",e[e.INPUT=3]="INPUT",e[e.DISPLAY=4]="DISPLAY"}(R||(R={})),function(e){e[e.AFFIRMATIVE=1]="AFFIRMATIVE",e[e.NEGATIVE=0]="NEGATIVE",e[e.CANCELLED=null]="CANCELLED"}(j||(j={}));var D='=== SILLYTAVERN===\n\n**SillyTavern** is a popular open-source front-end interface designed for interacting with AI language models. It\'s primarily used for role-playing, creative writing, and conversational experiences, offering a user-friendly platform to customize interactions with AI. Here\'s an overview:\n\n### Key Features:\n1. **AI Backend Compatibility**: Works with APIs like OpenAI (GPT), KoboldAI, Claude, or local models (via services like Text-generation-webui or Ollama).\n2. **Customization**:\n   - Create and import character cards (with personas, scenarios, and dialogue examples).\n   - Adjust model parameters (temperature, repetition penalties) for tailored responses.\n3. **Plugins & Extensions**: Adds features like text-to-speech, image generation, emotion recognition, and world-building tools.\n4. **Privacy**: Self-hosted locally, giving users control over data (unlike cloud-based services).\n\n### Use Cases:\n- Role-playing with AI characters.\n- Collaborative storytelling or creative writing.\n- Experimental AI interactions (users often share character templates and scripts in communities).\n\n### Requirements:\n- Technical setup involves installing Node.js, cloning the GitHub repo, and configuring API connections.\n- Requires access to an AI model backend (e.g., OpenAI API key or a locally hosted model).\n\n### Community & Ethics:\n- Active communities on platforms like GitHub and Reddit share guides, characters, and plugins.\n- Encourages responsible use, as the tool can generate unrestricted content depending on the AI backend.\n\nSillyTavern is not an AI itself but a flexible interface to enhance interactions with LLMs.\n\n=== WORLDINFO (LOREBOOKS) ===\n\n**World Info** (often called **Lorebooks**) is a feature used in AI-driven storytelling and role-playing platforms (like SillyTavern, NovelAI, KoboldAI, or Text-generation-webui) to help AI models maintain consistency in fictional worlds. It acts as a dynamic knowledge base that the AI references during interactions to avoid contradictions and keep track of key details.\n\n---\n\n### **What is World Info/Lorebooks?**\n- **A structured database**: Stores details about characters, locations, rules, events, or concepts in your fictional world.\n- **Contextual triggers**: Entries activate automatically when specific keywords or phrases appear in the conversation/story.\n- **Prevents "amnesia"**: Ensures the AI remembers critical lore without relying solely on its limited context window.\n\n---\n\n### **How It Works**\n1. **Create Entries**: Define elements (e.g., a character’s backstory, a magic system’s rules).\n2. **Set Triggers**: Link entries to keywords (e.g., mention "Dragonstone" → inject lore about that location).\n3. **Dynamic Injection**: When a trigger word appears in the chat/story, the relevant entry is temporarily added to the AI’s context.\n\n---\n\n### **Key Features**\n- **Hierarchy**: Organize entries into categories (e.g., factions, items, timelines).\n- **Priority**: Set which entries take precedence if multiple triggers occur.\n- **Cross-references**: Link entries to each other (e.g., a character entry references their home city).\n- **Formatting**: Use markdown, JSON, or plain text depending on the platform.\n\n---\n\n### **Example Lorebook Entry**\n```plaintext\nName: Dragonstone Citadel\nTriggers: Dragonstone, Citadel, Obsidian Fortress\nContent:\n  A volcanic fortress built from black obsidian. Home to the ancient Order of Flames,\n  who guard the Eternal Fire—a magical flame that grants visions of the future.\n  The citadel is rumored to be cursed, as its rulers never live past 40 years.\n```\n\n---\n\n### **Use Cases**\n1. **Complex Worldbuilding**: Track political factions, religions, or history.\n2. **Character Consistency**: Ensure the AI remembers a character’s motives, secrets, or relationships.\n3. **Magic/Science Systems**: Define rules (e.g., "Magic drains lifeforce" or "Robots cannot harm humans").\n4. **Plot Hooks**: Store hidden clues or foreshadowing for the AI to weave into the narrative.\n\n---\n\n### **Tools Supporting Lorebooks**\n- **SillyTavern**: Integrates with lorebooks via extensions or prompts.\n- **NovelAI**: Has a built-in "Lorebook" feature with advanced triggers.\n- **KoboldAI/Text-generation-webui**: Use "world info" files or scripts.\n- **AIDungeon** (historically): Early adopter of world info, though less popular now.\n\n---\n\n### **Best Practices**\n- **Keep entries concise**: AI models process information best in short, clear snippets.\n- **Balance detail**: Too many entries can overwhelm the context window.\n- **Test triggers**: Ensure keywords are unique enough to avoid false activations.\n- **Update dynamically**: Add/remove entries as the story evolves.\n\nLorebooks are essential for long-term storytelling with AI.',L="{{#each lorebooks}}\n  {{#if this.length}}\n## WORLD NAME: {{@key}}\n    {{#each this as |entry|}}\n      {{#unless entry.disable}}\n- (NAME: {{entry.comment}}) (ID: {{entry.uid}})\nTriggers: {{join entry.key ', '}}\nContent: {{entry.content}}\n\n      {{/unless}}\n    {{/each}}\n  {{/if}}\n{{/each}}",M="- Don't suggest already existing or suggested entries.";const F=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",V=new RegExp("^"+("["+F+"]["+(F+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040")+"]*")+"$");function W(e,t){const n=[];let r=t.exec(e);for(;r;){const o=[];o.startIndex=t.lastIndex-r[0].length;const i=r.length;for(let e=0;e<i;e++)o.push(r[e]);n.push(o),r=t.exec(e)}return n}const B=function(e){const t=V.exec(e);return!(null==t)};const U={allowBooleanAttributes:!1,unpairedTags:[]};function G(e,t){t=Object.assign({},U,t);const n=[];let r=!1,o=!1;"\ufeff"===e[0]&&(e=e.substr(1));for(let i=0;i<e.length;i++)if("<"===e[i]&&"?"===e[i+1]){if(i+=2,i=K(e,i),i.err)return i}else{if("<"!==e[i]){if(H(e[i]))continue;return ee("InvalidChar","char '"+e[i]+"' is not expected.",ne(e,i))}{let s=i;if(i++,"!"===e[i]){i=q(e,i);continue}{let a=!1;"/"===e[i]&&(a=!0,i++);let l="";for(;i<e.length&&">"!==e[i]&&" "!==e[i]&&"\t"!==e[i]&&"\n"!==e[i]&&"\r"!==e[i];i++)l+=e[i];if(l=l.trim(),"/"===l[l.length-1]&&(l=l.substring(0,l.length-1),i--),!B(l)){let t;return t=0===l.trim().length?"Invalid space after '<'.":"Tag '"+l+"' is an invalid name.",ee("InvalidTag",t,ne(e,i))}const c=z(e,i);if(!1===c)return ee("InvalidAttr","Attributes for '"+l+"' have open quote.",ne(e,i));let u=c.value;if(i=c.index,"/"===u[u.length-1]){const n=i-u.length;u=u.substring(0,u.length-1);const o=J(u,t);if(!0!==o)return ee(o.err.code,o.err.msg,ne(e,n+o.err.line));r=!0}else if(a){if(!c.tagClosed)return ee("InvalidTag","Closing tag '"+l+"' doesn't have proper closing.",ne(e,i));if(u.trim().length>0)return ee("InvalidTag","Closing tag '"+l+"' can't have attributes or invalid starting.",ne(e,s));if(0===n.length)return ee("InvalidTag","Closing tag '"+l+"' has not been opened.",ne(e,s));{const t=n.pop();if(l!==t.tagName){let n=ne(e,t.tagStartPos);return ee("InvalidTag","Expected closing tag '"+t.tagName+"' (opened in line "+n.line+", col "+n.col+") instead of closing tag '"+l+"'.",ne(e,s))}0==n.length&&(o=!0)}}else{const a=J(u,t);if(!0!==a)return ee(a.err.code,a.err.msg,ne(e,i-u.length+a.err.line));if(!0===o)return ee("InvalidXml","Multiple possible root nodes found.",ne(e,i));-1!==t.unpairedTags.indexOf(l)||n.push({tagName:l,tagStartPos:s}),r=!0}for(i++;i<e.length;i++)if("<"===e[i]){if("!"===e[i+1]){i++,i=q(e,i);continue}if("?"!==e[i+1])break;if(i=K(e,++i),i.err)return i}else if("&"===e[i]){const t=Q(e,i);if(-1==t)return ee("InvalidChar","char '&' is not expected.",ne(e,i));i=t}else if(!0===o&&!H(e[i]))return ee("InvalidXml","Extra text at the end",ne(e,i));"<"===e[i]&&i--}}}return r?1==n.length?ee("InvalidTag","Unclosed tag '"+n[0].tagName+"'.",ne(e,n[0].tagStartPos)):!(n.length>0)||ee("InvalidXml","Invalid '"+JSON.stringify(n.map((e=>e.tagName)),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1}):ee("InvalidXml","Start tag expected.",1)}function H(e){return" "===e||"\t"===e||"\n"===e||"\r"===e}function K(e,t){const n=t;for(;t<e.length;t++)if("?"!=e[t]&&" "!=e[t]);else{const r=e.substr(n,t-n);if(t>5&&"xml"===r)return ee("InvalidXml","XML declaration allowed only at the start of the document.",ne(e,t));if("?"==e[t]&&">"==e[t+1]){t++;break}}return t}function q(e,t){if(e.length>t+5&&"-"===e[t+1]&&"-"===e[t+2]){for(t+=3;t<e.length;t++)if("-"===e[t]&&"-"===e[t+1]&&">"===e[t+2]){t+=2;break}}else if(e.length>t+8&&"D"===e[t+1]&&"O"===e[t+2]&&"C"===e[t+3]&&"T"===e[t+4]&&"Y"===e[t+5]&&"P"===e[t+6]&&"E"===e[t+7]){let n=1;for(t+=8;t<e.length;t++)if("<"===e[t])n++;else if(">"===e[t]&&(n--,0===n))break}else if(e.length>t+9&&"["===e[t+1]&&"C"===e[t+2]&&"D"===e[t+3]&&"A"===e[t+4]&&"T"===e[t+5]&&"A"===e[t+6]&&"["===e[t+7])for(t+=8;t<e.length;t++)if("]"===e[t]&&"]"===e[t+1]&&">"===e[t+2]){t+=2;break}return t}const X='"',Y="'";function z(e,t){let n="",r="",o=!1;for(;t<e.length;t++){if(e[t]===X||e[t]===Y)""===r?r=e[t]:r!==e[t]||(r="");else if(">"===e[t]&&""===r){o=!0;break}n+=e[t]}return""===r&&{value:n,index:t,tagClosed:o}}const Z=new RegExp("(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['\"])(([\\s\\S])*?)\\5)?","g");function J(e,t){const n=W(e,Z),r={};for(let e=0;e<n.length;e++){if(0===n[e][1].length)return ee("InvalidAttr","Attribute '"+n[e][2]+"' has no space in starting.",re(n[e]));if(void 0!==n[e][3]&&void 0===n[e][4])return ee("InvalidAttr","Attribute '"+n[e][2]+"' is without value.",re(n[e]));if(void 0===n[e][3]&&!t.allowBooleanAttributes)return ee("InvalidAttr","boolean attribute '"+n[e][2]+"' is not allowed.",re(n[e]));const o=n[e][2];if(!te(o))return ee("InvalidAttr","Attribute '"+o+"' is an invalid name.",re(n[e]));if(r.hasOwnProperty(o))return ee("InvalidAttr","Attribute '"+o+"' is repeated.",re(n[e]));r[o]=1}return!0}function Q(e,t){if(";"===e[++t])return-1;if("#"===e[t])return function(e,t){let n=/\d/;for("x"===e[t]&&(t++,n=/[\da-fA-F]/);t<e.length;t++){if(";"===e[t])return t;if(!e[t].match(n))break}return-1}(e,++t);let n=0;for(;t<e.length;t++,n++)if(!(e[t].match(/\w/)&&n<20)){if(";"===e[t])break;return-1}return t}function ee(e,t,n){return{err:{code:e,msg:t,line:n.line||n,col:n.col}}}function te(e){return B(e)}function ne(e,t){const n=e.substring(0,t).split(/\r?\n/);return{line:n.length,col:n[n.length-1].length+1}}function re(e){return e.startIndex+e[1].length}const oe={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(e,t,n){return e}};class ie{constructor(e){this.tagname=e,this.child=[],this[":@"]={}}add(e,t){"__proto__"===e&&(e="#__proto__"),this.child.push({[e]:t})}addChild(e){"__proto__"===e.tagname&&(e.tagname="#__proto__"),e[":@"]&&Object.keys(e[":@"]).length>0?this.child.push({[e.tagname]:e.child,":@":e[":@"]}):this.child.push({[e.tagname]:e.child})}}function se(e,t){const n={};if("O"!==e[t+3]||"C"!==e[t+4]||"T"!==e[t+5]||"Y"!==e[t+6]||"P"!==e[t+7]||"E"!==e[t+8])throw new Error("Invalid Tag instead of DOCTYPE");{t+=9;let r=1,o=!1,i=!1,s="";for(;t<e.length;t++)if("<"!==e[t]||i)if(">"===e[t]){if(i?"-"===e[t-1]&&"-"===e[t-2]&&(i=!1,r--):r--,0===r)break}else"["===e[t]?o=!0:s+=e[t];else{if(o&&ce(e,t)){let r,o;t+=7,[r,o,t]=ae(e,t+1),-1===o.indexOf("&")&&(n[fe(r)]={regx:RegExp(`&${r};`,"g"),val:o})}else if(o&&ue(e,t))t+=8;else if(o&&de(e,t))t+=8;else if(o&&pe(e,t))t+=9;else{if(!le)throw new Error("Invalid DOCTYPE");i=!0}r++,s=""}if(0!==r)throw new Error("Unclosed DOCTYPE")}return{entities:n,i:t}}function ae(e,t){let n="";for(;t<e.length&&"'"!==e[t]&&'"'!==e[t];t++)n+=e[t];if(n=n.trim(),-1!==n.indexOf(" "))throw new Error("External entites are not supported");const r=e[t++];let o="";for(;t<e.length&&e[t]!==r;t++)o+=e[t];return[n,o,t]}function le(e,t){return"!"===e[t+1]&&"-"===e[t+2]&&"-"===e[t+3]}function ce(e,t){return"!"===e[t+1]&&"E"===e[t+2]&&"N"===e[t+3]&&"T"===e[t+4]&&"I"===e[t+5]&&"T"===e[t+6]&&"Y"===e[t+7]}function ue(e,t){return"!"===e[t+1]&&"E"===e[t+2]&&"L"===e[t+3]&&"E"===e[t+4]&&"M"===e[t+5]&&"E"===e[t+6]&&"N"===e[t+7]&&"T"===e[t+8]}function de(e,t){return"!"===e[t+1]&&"A"===e[t+2]&&"T"===e[t+3]&&"T"===e[t+4]&&"L"===e[t+5]&&"I"===e[t+6]&&"S"===e[t+7]&&"T"===e[t+8]}function pe(e,t){return"!"===e[t+1]&&"N"===e[t+2]&&"O"===e[t+3]&&"T"===e[t+4]&&"A"===e[t+5]&&"T"===e[t+6]&&"I"===e[t+7]&&"O"===e[t+8]&&"N"===e[t+9]}function fe(e){if(B(e))return e;throw new Error(`Invalid entity name ${e}`)}const he=/^[-+]?0x[a-fA-F0-9]+$/,me=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,ge={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function ve(e,t={}){if(t=Object.assign({},ge,t),!e||"string"!=typeof e)return e;let n=e.trim();if(void 0!==t.skipLike&&t.skipLike.test(n))return e;if("0"===e)return 0;if(t.hex&&he.test(n))return function(e,t){if(parseInt)return parseInt(e,t);if(Number.parseInt)return Number.parseInt(e,t);if(window&&window.parseInt)return window.parseInt(e,t);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}(n,16);if(-1!==n.search(/[eE]/)){const r=n.match(/^([-\+])?(0*)([0-9]*(\.[0-9]*)?[eE][-\+]?[0-9]+)$/);if(r){if(t.leadingZeros)n=(r[1]||"")+r[3];else if("0"!==r[2]||"."!==r[3][0])return e;return t.eNotation?Number(n):e}return e}{const r=me.exec(n);if(r){const o=r[1],i=r[2];let s=function(e){if(e&&-1!==e.indexOf("."))return"."===(e=e.replace(/0+$/,""))?e="0":"."===e[0]?e="0"+e:"."===e[e.length-1]&&(e=e.substr(0,e.length-1)),e;return e}(r[3]);if(!t.leadingZeros&&i.length>0&&o&&"."!==n[2])return e;if(!t.leadingZeros&&i.length>0&&!o&&"."!==n[1])return e;if(t.leadingZeros&&i===e)return 0;{const r=Number(n),a=""+r;return-1!==a.search(/[eE]/)?t.eNotation?r:e:-1!==n.indexOf(".")?"0"===a&&""===s||a===s||o&&a==="-"+s?r:e:i?s===a||o+s===a?r:e:n===a||n===o+a?r:e}}return e}}function ye(e){return"function"==typeof e?e:Array.isArray(e)?t=>{for(const n of e){if("string"==typeof n&&t===n)return!0;if(n instanceof RegExp&&n.test(t))return!0}}:()=>!1}class xe{constructor(e){this.options=e,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(e,t)=>String.fromCodePoint(Number.parseInt(t,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(e,t)=>String.fromCodePoint(Number.parseInt(t,16))}},this.addExternalEntities=be,this.parseXml=Se,this.parseTextData=we,this.resolveNameSpace=Ie,this.buildAttributesMap=Pe,this.isItStopNode=Te,this.replaceEntitiesValue=Ee,this.readStopNodeData=Ce,this.saveTextToParentTag=_e,this.addChild=Ne,this.ignoreAttributesFn=ye(this.options.ignoreAttributes)}}function be(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];this.lastEntities[r]={regex:new RegExp("&"+r+";","g"),val:e[r]}}}function we(e,t,n,r,o,i,s){if(void 0!==e&&(this.options.trimValues&&!r&&(e=e.trim()),e.length>0)){s||(e=this.replaceEntitiesValue(e));const r=this.options.tagValueProcessor(t,e,n,o,i);if(null==r)return e;if(typeof r!=typeof e||r!==e)return r;if(this.options.trimValues)return Re(e,this.options.parseTagValue,this.options.numberParseOptions);return e.trim()===e?Re(e,this.options.parseTagValue,this.options.numberParseOptions):e}}function Ie(e){if(this.options.removeNSPrefix){const t=e.split(":"),n="/"===e.charAt(0)?"/":"";if("xmlns"===t[0])return"";2===t.length&&(e=n+t[1])}return e}const ke=new RegExp("([^\\s=]+)\\s*(=\\s*(['\"])([\\s\\S]*?)\\3)?","gm");function Pe(e,t,n){if(!0!==this.options.ignoreAttributes&&"string"==typeof e){const n=W(e,ke),r=n.length,o={};for(let e=0;e<r;e++){const r=this.resolveNameSpace(n[e][1]);if(this.ignoreAttributesFn(r,t))continue;let i=n[e][4],s=this.options.attributeNamePrefix+r;if(r.length)if(this.options.transformAttributeName&&(s=this.options.transformAttributeName(s)),"__proto__"===s&&(s="#__proto__"),void 0!==i){this.options.trimValues&&(i=i.trim()),i=this.replaceEntitiesValue(i);const e=this.options.attributeValueProcessor(r,i,t);o[s]=null==e?i:typeof e!=typeof i||e!==i?e:Re(i,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(o[s]=!0)}if(!Object.keys(o).length)return;if(this.options.attributesGroupName){const e={};return e[this.options.attributesGroupName]=o,e}return o}}const Se=function(e){e=e.replace(/\r\n?/g,"\n");const t=new ie("!xml");let n=t,r="",o="";for(let i=0;i<e.length;i++){if("<"===e[i])if("/"===e[i+1]){const t=Ae(e,">",i,"Closing Tag is not closed.");let s=e.substring(i+2,t).trim();if(this.options.removeNSPrefix){const e=s.indexOf(":");-1!==e&&(s=s.substr(e+1))}this.options.transformTagName&&(s=this.options.transformTagName(s)),n&&(r=this.saveTextToParentTag(r,n,o));const a=o.substring(o.lastIndexOf(".")+1);if(s&&-1!==this.options.unpairedTags.indexOf(s))throw new Error(`Unpaired tag can not be used as closing tag: </${s}>`);let l=0;a&&-1!==this.options.unpairedTags.indexOf(a)?(l=o.lastIndexOf(".",o.lastIndexOf(".")-1),this.tagsNodeStack.pop()):l=o.lastIndexOf("."),o=o.substring(0,l),n=this.tagsNodeStack.pop(),r="",i=t}else if("?"===e[i+1]){let t=Oe(e,i,!1,"?>");if(!t)throw new Error("Pi Tag is not closed.");if(r=this.saveTextToParentTag(r,n,o),this.options.ignoreDeclaration&&"?xml"===t.tagName||this.options.ignorePiTags);else{const e=new ie(t.tagName);e.add(this.options.textNodeName,""),t.tagName!==t.tagExp&&t.attrExpPresent&&(e[":@"]=this.buildAttributesMap(t.tagExp,o,t.tagName)),this.addChild(n,e,o)}i=t.closeIndex+1}else if("!--"===e.substr(i+1,3)){const t=Ae(e,"--\x3e",i+4,"Comment is not closed.");if(this.options.commentPropName){const s=e.substring(i+4,t-2);r=this.saveTextToParentTag(r,n,o),n.add(this.options.commentPropName,[{[this.options.textNodeName]:s}])}i=t}else if("!D"===e.substr(i+1,2)){const t=se(e,i);this.docTypeEntities=t.entities,i=t.i}else if("!["===e.substr(i+1,2)){const t=Ae(e,"]]>",i,"CDATA is not closed.")-2,s=e.substring(i+9,t);r=this.saveTextToParentTag(r,n,o);let a=this.parseTextData(s,n.tagname,o,!0,!1,!0,!0);null==a&&(a=""),this.options.cdataPropName?n.add(this.options.cdataPropName,[{[this.options.textNodeName]:s}]):n.add(this.options.textNodeName,a),i=t+2}else{let s=Oe(e,i,this.options.removeNSPrefix),a=s.tagName;const l=s.rawTagName;let c=s.tagExp,u=s.attrExpPresent,d=s.closeIndex;this.options.transformTagName&&(a=this.options.transformTagName(a)),n&&r&&"!xml"!==n.tagname&&(r=this.saveTextToParentTag(r,n,o,!1));const p=n;if(p&&-1!==this.options.unpairedTags.indexOf(p.tagname)&&(n=this.tagsNodeStack.pop(),o=o.substring(0,o.lastIndexOf("."))),a!==t.tagname&&(o+=o?"."+a:a),this.isItStopNode(this.options.stopNodes,o,a)){let t="";if(c.length>0&&c.lastIndexOf("/")===c.length-1)"/"===a[a.length-1]?(a=a.substr(0,a.length-1),o=o.substr(0,o.length-1),c=a):c=c.substr(0,c.length-1),i=s.closeIndex;else if(-1!==this.options.unpairedTags.indexOf(a))i=s.closeIndex;else{const n=this.readStopNodeData(e,l,d+1);if(!n)throw new Error(`Unexpected end of ${l}`);i=n.i,t=n.tagContent}const r=new ie(a);a!==c&&u&&(r[":@"]=this.buildAttributesMap(c,o,a)),t&&(t=this.parseTextData(t,a,o,!0,u,!0,!0)),o=o.substr(0,o.lastIndexOf(".")),r.add(this.options.textNodeName,t),this.addChild(n,r,o)}else{if(c.length>0&&c.lastIndexOf("/")===c.length-1){"/"===a[a.length-1]?(a=a.substr(0,a.length-1),o=o.substr(0,o.length-1),c=a):c=c.substr(0,c.length-1),this.options.transformTagName&&(a=this.options.transformTagName(a));const e=new ie(a);a!==c&&u&&(e[":@"]=this.buildAttributesMap(c,o,a)),this.addChild(n,e,o),o=o.substr(0,o.lastIndexOf("."))}else{const e=new ie(a);this.tagsNodeStack.push(n),a!==c&&u&&(e[":@"]=this.buildAttributesMap(c,o,a)),this.addChild(n,e,o),n=e}r="",i=d}}else r+=e[i]}return t.child};function Ne(e,t,n){const r=this.options.updateTag(t.tagname,n,t[":@"]);!1===r||("string"==typeof r?(t.tagname=r,e.addChild(t)):e.addChild(t))}const Ee=function(e){if(this.options.processEntities){for(let t in this.docTypeEntities){const n=this.docTypeEntities[t];e=e.replace(n.regx,n.val)}for(let t in this.lastEntities){const n=this.lastEntities[t];e=e.replace(n.regex,n.val)}if(this.options.htmlEntities)for(let t in this.htmlEntities){const n=this.htmlEntities[t];e=e.replace(n.regex,n.val)}e=e.replace(this.ampEntity.regex,this.ampEntity.val)}return e};function _e(e,t,n,r){return e&&(void 0===r&&(r=0===t.child.length),void 0!==(e=this.parseTextData(e,t.tagname,n,!1,!!t[":@"]&&0!==Object.keys(t[":@"]).length,r))&&""!==e&&t.add(this.options.textNodeName,e),e=""),e}function Te(e,t,n){const r="*."+n;for(const n in e){const o=e[n];if(r===o||t===o)return!0}return!1}function Ae(e,t,n,r){const o=e.indexOf(t,n);if(-1===o)throw new Error(r);return o+t.length-1}function Oe(e,t,n,r=">"){const o=function(e,t,n=">"){let r,o="";for(let i=t;i<e.length;i++){let t=e[i];if(r)t===r&&(r="");else if('"'===t||"'"===t)r=t;else if(t===n[0]){if(!n[1])return{data:o,index:i};if(e[i+1]===n[1])return{data:o,index:i}}else"\t"===t&&(t=" ");o+=t}}(e,t+1,r);if(!o)return;let i=o.data;const s=o.index,a=i.search(/\s/);let l=i,c=!0;-1!==a&&(l=i.substring(0,a),i=i.substring(a+1).trimStart());const u=l;if(n){const e=l.indexOf(":");-1!==e&&(l=l.substr(e+1),c=l!==o.data.substr(e+1))}return{tagName:l,tagExp:i,closeIndex:s,attrExpPresent:c,rawTagName:u}}function Ce(e,t,n){const r=n;let o=1;for(;n<e.length;n++)if("<"===e[n])if("/"===e[n+1]){const i=Ae(e,">",n,`${t} is not closed`);if(e.substring(n+2,i).trim()===t&&(o--,0===o))return{tagContent:e.substring(r,n),i};n=i}else if("?"===e[n+1]){n=Ae(e,"?>",n+1,"StopNode is not closed.")}else if("!--"===e.substr(n+1,3)){n=Ae(e,"--\x3e",n+3,"StopNode is not closed.")}else if("!["===e.substr(n+1,2)){n=Ae(e,"]]>",n,"StopNode is not closed.")-2}else{const r=Oe(e,n,">");if(r){(r&&r.tagName)===t&&"/"!==r.tagExp[r.tagExp.length-1]&&o++,n=r.closeIndex}}}function Re(e,t,n){if(t&&"string"==typeof e){const t=e.trim();return"true"===t||"false"!==t&&ve(e,n)}return void 0!==e?e:""}function je(e,t){return De(e,t)}function De(e,t,n){let r;const o={};for(let i=0;i<e.length;i++){const s=e[i],a=Le(s);let l="";if(l=void 0===n?a:n+"."+a,a===t.textNodeName)void 0===r?r=s[a]:r+=""+s[a];else{if(void 0===a)continue;if(s[a]){let e=De(s[a],t,l);const n=$e(e,t);s[":@"]?Me(e,s[":@"],l,t):1!==Object.keys(e).length||void 0===e[t.textNodeName]||t.alwaysCreateTextNode?0===Object.keys(e).length&&(t.alwaysCreateTextNode?e[t.textNodeName]="":e=""):e=e[t.textNodeName],void 0!==o[a]&&o.hasOwnProperty(a)?(Array.isArray(o[a])||(o[a]=[o[a]]),o[a].push(e)):t.isArray(a,l,n)?o[a]=[e]:o[a]=e}}}return"string"==typeof r?r.length>0&&(o[t.textNodeName]=r):void 0!==r&&(o[t.textNodeName]=r),o}function Le(e){const t=Object.keys(e);for(let e=0;e<t.length;e++){const n=t[e];if(":@"!==n)return n}}function Me(e,t,n,r){if(t){const o=Object.keys(t),i=o.length;for(let s=0;s<i;s++){const i=o[s];r.isArray(i,n+"."+i,!0,!0)?e[i]=[t[i]]:e[i]=t[i]}}}function $e(e,t){const{textNodeName:n}=t,r=Object.keys(e).length;return 0===r||!(1!==r||!e[n]&&"boolean"!=typeof e[n]&&0!==e[n])}function Fe(e,t){let n="";return t.format&&t.indentBy.length>0&&(n="\n"),Ve(e,t,"",n)}function Ve(e,t,n,r){let o="",i=!1;for(let s=0;s<e.length;s++){const a=e[s],l=We(a);if(void 0===l)continue;let c="";if(c=0===n.length?l:`${n}.${l}`,l===t.textNodeName){let e=a[l];Ue(c,t)||(e=t.tagValueProcessor(l,e),e=Ge(e,t)),i&&(o+=r),o+=e,i=!1;continue}if(l===t.cdataPropName){i&&(o+=r),o+=`<![CDATA[${a[l][0][t.textNodeName]}]]>`,i=!1;continue}if(l===t.commentPropName){o+=r+`\x3c!--${a[l][0][t.textNodeName]}--\x3e`,i=!0;continue}if("?"===l[0]){const e=Be(a[":@"],t),n="?xml"===l?"":r;let s=a[l][0][t.textNodeName];s=0!==s.length?" "+s:"",o+=n+`<${l}${s}${e}?>`,i=!0;continue}let u=r;""!==u&&(u+=t.indentBy);const d=r+`<${l}${Be(a[":@"],t)}`,p=Ve(a[l],t,c,u);-1!==t.unpairedTags.indexOf(l)?t.suppressUnpairedNode?o+=d+">":o+=d+"/>":p&&0!==p.length||!t.suppressEmptyNode?p&&p.endsWith(">")?o+=d+`>${p}${r}</${l}>`:(o+=d+">",p&&""!==r&&(p.includes("/>")||p.includes("</"))?o+=r+t.indentBy+p+r:o+=p,o+=`</${l}>`):o+=d+"/>",i=!0}return o}function We(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];if(e.hasOwnProperty(r)&&":@"!==r)return r}}function Be(e,t){let n="";if(e&&!t.ignoreAttributes)for(let r in e){if(!e.hasOwnProperty(r))continue;let o=t.attributeValueProcessor(r,e[r]);o=Ge(o,t),!0===o&&t.suppressBooleanAttributes?n+=` ${r.substr(t.attributeNamePrefix.length)}`:n+=` ${r.substr(t.attributeNamePrefix.length)}="${o}"`}return n}function Ue(e,t){let n=(e=e.substr(0,e.length-t.textNodeName.length-1)).substr(e.lastIndexOf(".")+1);for(let r in t.stopNodes)if(t.stopNodes[r]===e||t.stopNodes[r]==="*."+n)return!0;return!1}function Ge(e,t){if(e&&e.length>0&&t.processEntities)for(let n=0;n<t.entities.length;n++){const r=t.entities[n];e=e.replace(r.regex,r.val)}return e}const He={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function Ke(e){this.options=Object.assign({},He,e),!0===this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.ignoreAttributesFn=ye(this.options.ignoreAttributes),this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=Ye),this.processTextOrObjNode=qe,this.options.format?(this.indentate=Xe,this.tagEndChar=">\n",this.newLine="\n"):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}function qe(e,t,n,r){const o=this.j2x(e,n+1,r.concat(t));return void 0!==e[this.options.textNodeName]&&1===Object.keys(e).length?this.buildTextValNode(e[this.options.textNodeName],t,o.attrStr,n):this.buildObjectNode(o.val,t,o.attrStr,n)}function Xe(e){return this.options.indentBy.repeat(e)}function Ye(e){return!(!e.startsWith(this.options.attributeNamePrefix)||e===this.options.textNodeName)&&e.substr(this.attrPrefixLen)}Ke.prototype.build=function(e){return this.options.preserveOrder?Fe(e,this.options):(Array.isArray(e)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(e={[this.options.arrayNodeName]:e}),this.j2x(e,0,[]).val)},Ke.prototype.j2x=function(e,t,n){let r="",o="";const i=n.join(".");for(let s in e)if(Object.prototype.hasOwnProperty.call(e,s))if(void 0===e[s])this.isAttribute(s)&&(o+="");else if(null===e[s])this.isAttribute(s)||s===this.options.cdataPropName?o+="":"?"===s[0]?o+=this.indentate(t)+"<"+s+"?"+this.tagEndChar:o+=this.indentate(t)+"<"+s+"/"+this.tagEndChar;else if(e[s]instanceof Date)o+=this.buildTextValNode(e[s],s,"",t);else if("object"!=typeof e[s]){const n=this.isAttribute(s);if(n&&!this.ignoreAttributesFn(n,i))r+=this.buildAttrPairStr(n,""+e[s]);else if(!n)if(s===this.options.textNodeName){let t=this.options.tagValueProcessor(s,""+e[s]);o+=this.replaceEntitiesValue(t)}else o+=this.buildTextValNode(e[s],s,"",t)}else if(Array.isArray(e[s])){const r=e[s].length;let i="",a="";for(let l=0;l<r;l++){const r=e[s][l];if(void 0===r);else if(null===r)"?"===s[0]?o+=this.indentate(t)+"<"+s+"?"+this.tagEndChar:o+=this.indentate(t)+"<"+s+"/"+this.tagEndChar;else if("object"==typeof r)if(this.options.oneListGroup){const e=this.j2x(r,t+1,n.concat(s));i+=e.val,this.options.attributesGroupName&&r.hasOwnProperty(this.options.attributesGroupName)&&(a+=e.attrStr)}else i+=this.processTextOrObjNode(r,s,t,n);else if(this.options.oneListGroup){let e=this.options.tagValueProcessor(s,r);e=this.replaceEntitiesValue(e),i+=e}else i+=this.buildTextValNode(r,s,"",t)}this.options.oneListGroup&&(i=this.buildObjectNode(i,s,a,t)),o+=i}else if(this.options.attributesGroupName&&s===this.options.attributesGroupName){const t=Object.keys(e[s]),n=t.length;for(let o=0;o<n;o++)r+=this.buildAttrPairStr(t[o],""+e[s][t[o]])}else o+=this.processTextOrObjNode(e[s],s,t,n);return{attrStr:r,val:o}},Ke.prototype.buildAttrPairStr=function(e,t){return t=this.options.attributeValueProcessor(e,""+t),t=this.replaceEntitiesValue(t),this.options.suppressBooleanAttributes&&"true"===t?" "+e:" "+e+'="'+t+'"'},Ke.prototype.buildObjectNode=function(e,t,n,r){if(""===e)return"?"===t[0]?this.indentate(r)+"<"+t+n+"?"+this.tagEndChar:this.indentate(r)+"<"+t+n+this.closeTag(t)+this.tagEndChar;{let o="</"+t+this.tagEndChar,i="";return"?"===t[0]&&(i="?",o=""),!n&&""!==n||-1!==e.indexOf("<")?!1!==this.options.commentPropName&&t===this.options.commentPropName&&0===i.length?this.indentate(r)+`\x3c!--${e}--\x3e`+this.newLine:this.indentate(r)+"<"+t+n+i+this.tagEndChar+e+this.indentate(r)+o:this.indentate(r)+"<"+t+n+i+">"+e+o}},Ke.prototype.closeTag=function(e){let t="";return-1!==this.options.unpairedTags.indexOf(e)?this.options.suppressUnpairedNode||(t="/"):t=this.options.suppressEmptyNode?"/":`></${e}`,t},Ke.prototype.buildTextValNode=function(e,t,n,r){if(!1!==this.options.cdataPropName&&t===this.options.cdataPropName)return this.indentate(r)+`<![CDATA[${e}]]>`+this.newLine;if(!1!==this.options.commentPropName&&t===this.options.commentPropName)return this.indentate(r)+`\x3c!--${e}--\x3e`+this.newLine;if("?"===t[0])return this.indentate(r)+"<"+t+n+"?"+this.tagEndChar;{let o=this.options.tagValueProcessor(t,e);return o=this.replaceEntitiesValue(o),""===o?this.indentate(r)+"<"+t+n+this.closeTag(t)+this.tagEndChar:this.indentate(r)+"<"+t+n+">"+o+"</"+t+this.tagEndChar}},Ke.prototype.replaceEntitiesValue=function(e){if(e&&e.length>0&&this.options.processEntities)for(let t=0;t<this.options.entities.length;t++){const n=this.options.entities[t];e=e.replace(n.regex,n.val)}return e};function ze(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Ze(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Ze(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,i=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw i}}}}function Ze(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}var Je="If you are creating a new entry you should write it like this:\n```xml\n<lorebooks>\n    <entry>\n        <worldName>World 1</worldName>\n        <name>Book 1</name>\n        <triggers>word1,word2</triggers>\n        <content>Content of book 1</content>\n    </entry>\n</lorebooks>\n```\n\nIf you are updating an existing entry you should specify the id of the entry. Like this:\n```xml\n<lorebooks>\n    <entry>\n        <worldName>World 1</worldName>\n        <id>15</id> // Id should be the id of the entry\n        <name>Book 1</name>\n        <triggers>word1,word2</triggers>\n        <content>Content of book 1</content>\n    </entry>\n</lorebooks>\n```",Qe=new class{constructor(e){this.externalEntities={},this.options=function(e){return Object.assign({},oe,e)}(e)}parse(e,t){if("string"==typeof e);else{if(!e.toString)throw new Error("XML data is accepted in String or Bytes[] form.");e=e.toString()}if(t){!0===t&&(t={});const n=G(e,t);if(!0!==n)throw Error(`${n.err.msg}:${n.err.line}:${n.err.col}`)}const n=new xe(this.options);n.addExternalEntities(this.externalEntities);const r=n.parseXml(e);return this.options.preserveOrder||void 0===r?r:je(r,this.options)}addEntity(e,t){if(-1!==t.indexOf("&"))throw new Error("Entity value can't have '&'");if(-1!==e.indexOf("&")||-1!==e.indexOf(";"))throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if("&"===t)throw new Error("An entity with value '&' is not permitted");this.externalEntities[e]=t}};function et(e){var t,n,r,o=e.replace(/```xml/g,"").replace(/```/g,""),i={};try{var s,a=Qe.parse(o);if(!a.lorebooks)return i;var l,c=ze(null!==(s=a.lorebooks.entry)&&void 0!==s&&s.content?[a.lorebooks.entry]:a.lorebooks.entry);try{for(c.s();!(l=c.n()).done;){var u,d,p,f=l.value,h=f.worldName;h&&(i[h]||(i[h]=[]),i[h].push({uid:null!==(u=f.id)&&void 0!==u?u:(t=6,n=void 0,r=void 0,n=Math.pow(10,t-1),r=Math.pow(10,t)-1,Math.floor(Math.random()*(r-n+1))+n),key:null!==(d=null===(p=f.triggers)||void 0===p?void 0:p.split(",").map((function(e){return e.trim()})))&&void 0!==d?d:[],content:f.content,comment:f.name}))}}catch(e){c.e(e)}finally{c.f()}return i}catch(e){throw console.error(e),new Error("Model response is not valid XML")}}const tt=(e=>{var t={};return d.d(t,e),t})({Handlebars:()=>u.Handlebars});function nt(e){return nt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},nt(e)}function rt(e){return function(e){if(Array.isArray(e))return at(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||st(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ot(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=st(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,i=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw i}}}}function it(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,i,s,a=[],l=!0,c=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=i.call(n)).done)&&(a.push(r.value),a.length!==t);l=!0);}catch(e){c=!0,o=e}finally{try{if(!l&&null!=n.return&&(s=n.return(),Object(s)!==s))return}finally{if(c)throw o}}return a}}(e,t)||st(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function st(e,t){if(e){if("string"==typeof e)return at(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?at(e,t):void 0}}function at(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function lt(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */lt=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},i="function"==typeof Symbol?Symbol:{},s=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",l=i.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var i=t&&t.prototype instanceof v?t:v,s=Object.create(i.prototype),a=new A(r||[]);return o(s,"_invoke",{value:N(e,n,a)}),s}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var p="suspendedStart",f="suspendedYield",h="executing",m="completed",g={};function v(){}function y(){}function x(){}var b={};c(b,s,(function(){return this}));var w=Object.getPrototypeOf,I=w&&w(w(O([])));I&&I!==n&&r.call(I,s)&&(b=I);var k=x.prototype=v.prototype=Object.create(b);function P(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function S(e,t){function n(o,i,s,a){var l=d(e[o],e,i);if("throw"!==l.type){var c=l.arg,u=c.value;return u&&"object"==nt(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,s,a)}),(function(e){n("throw",e,s,a)})):t.resolve(u).then((function(e){c.value=e,s(c)}),(function(e){return n("throw",e,s,a)}))}a(l.arg)}var i;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return i=i?i.then(o,o):o()}})}function N(t,n,r){var o=p;return function(i,s){if(o===h)throw Error("Generator is already running");if(o===m){if("throw"===i)throw s;return{value:e,done:!0}}for(r.method=i,r.arg=s;;){var a=r.delegate;if(a){var l=E(a,r);if(l){if(l===g)continue;return l}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===p)throw o=m,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=h;var c=d(t,n,r);if("normal"===c.type){if(o=r.done?m:f,c.arg===g)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(o=m,r.method="throw",r.arg=c.arg)}}}function E(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,E(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var i=d(o,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,g;var s=i.arg;return s?s.done?(n[t.resultName]=s.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):s:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function T(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function O(t){if(t||""===t){var n=t[s];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,i=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return i.next=i}}throw new TypeError(nt(t)+" is not iterable")}return y.prototype=x,o(k,"constructor",{value:x,configurable:!0}),o(x,"constructor",{value:y,configurable:!0}),y.displayName=c(x,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,x):(e.__proto__=x,c(e,l,"GeneratorFunction")),e.prototype=Object.create(k),e},t.awrap=function(e){return{__await:e}},P(S.prototype),c(S.prototype,a,(function(){return this})),t.AsyncIterator=S,t.async=function(e,n,r,o,i){void 0===i&&(i=Promise);var s=new S(u(e,n,r,o),i);return t.isGeneratorFunction(n)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},P(k),c(k,l,"Generator"),c(k,s,(function(){return this})),c(k,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=O,A.prototype={constructor:A,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(T),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return a.type="throw",a.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i],a=s.completion;if("root"===s.tryLoc)return o("end");if(s.tryLoc<=this.prev){var l=r.call(s,"catchLoc"),c=r.call(s,"finallyLoc");if(l&&c){if(this.prev<s.catchLoc)return o(s.catchLoc,!0);if(this.prev<s.finallyLoc)return o(s.finallyLoc)}else if(l){if(this.prev<s.catchLoc)return o(s.catchLoc,!0)}else{if(!c)throw Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return o(s.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=e,s.arg=t,i?(this.method="next",this.next=i.finallyLoc,g):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),T(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;T(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:O(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),g}},t}function ct(e,t,n,r,o,i,s){try{var a=e[i](s),l=a.value}catch(e){return void n(e)}a.done?t(l):Promise.resolve(l).then(r,o)}function ut(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function s(e){ct(i,r,o,s,a,"next",e)}function a(e){ct(i,r,o,s,a,"throw",e)}s(void 0)}))}}tt.Handlebars.helpers.join||tt.Handlebars.registerHelper("join",(function(e,t){return e.join(t)}));var dt,pt="SillyTavern-WorldInfo-Recommender",ft=SillyTavern.getContext(),ht={version:"0.1.1",formatVersion:"F_1.0",profileId:"",maxContextType:"profile",maxContextValue:16384,maxResponseToken:1024,contextToSend:{stDescription:!0,messages:{type:"all",first:10,last:10,range:{start:0,end:10}},charCard:!0,authorNote:!0,worldInfo:!0},stWorldInfoPrompt:D,usingDefaultStWorldInfoPrompt:!0,lorebookDefinitionPrompt:L,usingDefaultLorebookDefinitionPrompt:!0,lorebookRulesPrompt:M,usingDefaultLorebookRulesPrompt:!0,responseRulesPrompt:Je,usingDefaultResponseRulesPrompt:!0},mt=new class{settingsKey;defaultSettings;constructor(e,t){this.settingsKey=e,this.defaultSettings=t}async initializeSettings(e={}){const{strategy:t="recursive"}=e,n=this.defaultSettings.version,r=this.defaultSettings.formatVersion,o=SillyTavern.getContext().extensionSettings[this.settingsKey],i={version:{changed:!1,new:n??""},formatVersion:{changed:!1,new:r??""},oldSettings:null,newSettings:this.defaultSettings};if(!o)return SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings(),i;const s={...i,oldSettings:structuredClone(o),version:{changed:!1,old:o.version,new:o.version},formatVersion:{changed:!1,old:o.formatVersion,new:o.formatVersion}};if("recursive"===t){function a(e,t){let n=!1;for(const r of Object.keys(t))void 0===e[r]?(e[r]=t[r],n=!0):"object"==typeof t[r]&&null!==t[r]&&(e[r]=e[r]||{},a(e[r],t[r])&&(n=!0));return n}n&&o.version!==n&&(s.version.changed=!0,s.version.new=n,o.version=n),r&&o.formatVersion!==r&&(s.formatVersion.changed=!0,s.formatVersion.new=r,o.formatVersion=r),(a(o,this.defaultSettings)||s.version.changed||s.formatVersion.changed)&&this.saveSettings()}else if(Array.isArray(t)){n&&!o.version&&(o.version=n,s.version.changed=!0,s.version.new=n),r&&!o.formatVersion&&(o.formatVersion=r,s.formatVersion.changed=!0,s.formatVersion.new=r);let l=structuredClone(o),c=o.formatVersion;try{for(const u of t)if(c===u.from){l=await u.action(l),c=u.to,l.formatVersion=u.to;const d=this.defaultSettings.version;d&&(l.version=d),s.formatVersion.changed=!0,s.formatVersion.new=u.to}if(s.formatVersion.changed){Object.assign(o,l);for(const p of Object.keys(o))Object.keys(l).includes(p)||delete o[p];this.saveSettings()}}catch(f){throw console.error("Failed to apply version changes:",f),new Error(`Version migration failed: ${f instanceof Error?f.message:f}`,{cause:f})}}return s.newSettings=o,s}getSettings(){return SillyTavern.getContext().extensionSettings[this.settingsKey]}updateSetting(e,t){SillyTavern.getContext().extensionSettings[this.settingsKey][e]=t,this.saveSettings()}saveSettings(){SillyTavern.getContext().saveSettingsDebounced()}resetSettings(){SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings()}}("worldInfoRecommender",ht);function gt(){return gt=ut(lt().mark((function e(){var t,n,r,o,i,s,a,l,c,u,d;return lt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ft.renderExtensionTemplateAsync("third-party/".concat(pt),"templates/settings");case 2:t=e.sent,$("#extensions_settings").append(t),n=$(".worldInfoRecommender_settings"),r=mt.getSettings(),o=n.find(".stWorldInfoPrompt"),i=o.find("textarea"),s=n.find(".lorebookDefinitionPrompt"),a=s.find("textarea"),l=n.find(".lorebookRulesPrompt"),c=l.find("textarea"),u=n.find(".responseRulesPrompt"),d=u.find("textarea"),i.val(r.stWorldInfoPrompt),a.val(r.lorebookDefinitionPrompt),c.val(r.lorebookRulesPrompt),d.val(r.responseRulesPrompt),o.find(".restore_default").on("click",ut(lt().mark((function e(){return lt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ft.Popup.show.confirm("Are you sure you want to restore the default ST/World Info description?","World Info Recommender");case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:i.val(D),i.trigger("change");case 7:case"end":return e.stop()}}),e)})))),s.find(".restore_default").on("click",ut(lt().mark((function e(){return lt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ft.Popup.show.confirm("Are you sure you want to restore the default lorebook definition?","World Info Recommender");case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:a.val(L),a.trigger("change");case 7:case"end":return e.stop()}}),e)})))),l.find(".restore_default").on("click",ut(lt().mark((function e(){return lt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ft.Popup.show.confirm("Are you sure you want to restore the default lorebook rules?","World Info Recommender");case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:c.val(M),c.trigger("change");case 7:case"end":return e.stop()}}),e)})))),u.find(".restore_default").on("click",ut(lt().mark((function e(){return lt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ft.Popup.show.confirm("Are you sure you want to restore the default response rules?","World Info Recommender");case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:d.val(Je),d.trigger("change");case 7:case"end":return e.stop()}}),e)})))),i.on("change",(function(){var e;r.stWorldInfoPrompt=null!==(e=i.val())&&void 0!==e?e:"",r.usingDefaultStWorldInfoPrompt=r.stWorldInfoPrompt===D,mt.saveSettings()})),a.on("change",(function(){var e;r.lorebookDefinitionPrompt=null!==(e=a.val())&&void 0!==e?e:"",r.usingDefaultLorebookDefinitionPrompt=r.lorebookDefinitionPrompt===L,mt.saveSettings()})),c.on("change",(function(){var e;r.lorebookRulesPrompt=null!==(e=c.val())&&void 0!==e?e:"",r.usingDefaultLorebookRulesPrompt=r.lorebookRulesPrompt===M,mt.saveSettings()})),d.on("change",(function(){var e;r.responseRulesPrompt=null!==(e=d.val())&&void 0!==e?e:"",r.usingDefaultResponseRulesPrompt=r.responseRulesPrompt===Je,mt.saveSettings()})),dt=$('<div class="menu_button fa-brands fa-wpexplorer interactable" title="World Info Recommender"></div>'),$(".form_create_bottom_buttons_block").prepend(dt),dt.on("click",ut(lt().mark((function e(){var t,n,o,i,s,a,l,c,u,d,f,g,v,y,x,w,I,P,S,N,E,_,T,A,j,D,L,M,F,V,W,B,U,G,H;return lt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return H=function(){return H=ut(lt().mark((function e(t,n){var r,o,i,s,a,l,c,u,d,p,f,h,g=arguments;return lt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=g.length>2&&void 0!==g[2]&&g[2],y[n]||(y[n]=[]),i={entries:{}},s=ot(y[n]);try{for(s.s();!(a=s.n()).done;)l=a.value,i.entries[l.uid]=l}catch(e){s.e(e)}finally{s.f()}if(c=null===(r=y[n])||void 0===r?void 0:r.find((function(e){return e.uid===t.uid})),!(d=!!c)){e.next=11;break}u=c,e.next=19;break;case 11:if(p=Object.values(i.entries),f=p.length>0?p[p.length-1]:void 0,v=n,x=i,u=(0,m.createWorldInfoEntry)(v,x)){e.next=16;break}throw new Error("Failed to create entry");case 16:h=u.uid,f&&Object.assign(u,f),u.uid=h;case 19:if(u.key=t.key,u.content=t.content,u.comment=t.comment,i.entries[u.uid]=u,y[n]=Object.values(i.entries),o){e.next=28;break}return e.next=27,ft.saveWorldInfo(n,i);case 27:ft.reloadWorldInfoEditor(n,!0);case 28:return e.abrupt("return",d?"updated":"added");case 29:case"end":return e.stop()}var v,x}),e)}))),H.apply(this,arguments)},G=function(e,t){return H.apply(this,arguments)},j=function(e){switch(P.hide(),S.hide(),N.hide(),e){case"first":P.show();break;case"last":S.show();break;case"range":N.show()}},e.next=5,ft.renderExtensionTemplateAsync("third-party/".concat(pt),"templates/popup");case 5:return l=e.sent,ft.callGenericPopup(l,R.DISPLAY,void 0,{large:!0,wide:!0}),c=$("#worldInfoRecommenderPopup"),ft.ConnectionManagerRequestService.handleDropdown("#worldInfoRecommenderPopup #worldInfoRecommend_connectionProfile",r.profileId,(function(e){var t;r.profileId=null!==(t=null==e?void 0:e.id)&&void 0!==t?t:"",mt.saveSettings()})),u=c.find("#worldInfoRecommend_stDescription"),d=c.find(".message-options"),f=c.find("#worldInfoRecommend_charCard"),g=c.find("#worldInfoRecommend_authorNote"),v=c.find("#worldInfoRecommend_worldInfo"),u.prop("checked",r.contextToSend.stDescription),f.prop("checked",r.contextToSend.charCard),g.prop("checked",r.contextToSend.authorNote),v.prop("checked",r.contextToSend.worldInfo),e.next=20,C(["all"],h.this_chid);case 20:y=e.sent,0===(x=Object.keys(y)).length&&k("warning","No active World Info entries found."),w=structuredClone(x),p("#worldInfoRecommend_worldInfoContainer",{label:"World Info",initialList:x,initialValues:w,onSelectChange:function(e,t){w=t}}),I=d.find("#messageType"),P=d.find("#firstX"),S=d.find("#lastX"),N=d.find("#rangeX"),E=d.find("#firstXMessages"),_=d.find("#lastXMessages"),T=d.find("#rangeStart"),A=d.find("#rangeEnd"),I.val(r.contextToSend.messages.type),E.val(null!==(t=r.contextToSend.messages.first)&&void 0!==t?t:10),_.val(null!==(n=r.contextToSend.messages.last)&&void 0!==n?n:10),T.val(null!==(o=null===(i=r.contextToSend.messages.range)||void 0===i?void 0:i.start)&&void 0!==o?o:0),A.val(null!==(s=null===(a=r.contextToSend.messages.range)||void 0===a?void 0:a.end)&&void 0!==s?s:10),j(r.contextToSend.messages.type),u.on("change",(function(){r.contextToSend.stDescription=u.prop("checked"),mt.saveSettings()})),f.on("change",(function(){r.contextToSend.charCard=f.prop("checked"),mt.saveSettings()})),g.on("change",(function(){r.contextToSend.authorNote=g.prop("checked"),mt.saveSettings()})),v.on("change",(function(){r.contextToSend.worldInfo=v.prop("checked"),mt.saveSettings()})),I.on("change",(function(){var e=I.val();r.contextToSend.messages.type=e,mt.saveSettings(),j(e)})),E.on("change",(function(){r.contextToSend.messages.first=parseInt(E.val())||10,mt.saveSettings()})),_.on("change",(function(){r.contextToSend.messages.last=parseInt(_.val())||10,mt.saveSettings()})),T.on("change",(function(){r.contextToSend.messages.range||(r.contextToSend.messages.range={start:0,end:10}),r.contextToSend.messages.range.start=parseInt(T.val())||0,mt.saveSettings()})),A.on("change",(function(){r.contextToSend.messages.range||(r.contextToSend.messages.range={start:0,end:10}),r.contextToSend.messages.range.end=parseInt(A.val())||10,mt.saveSettings()})),D=c.find("#worldInfoRecommend_maxContextType"),L=c.find("#worldInfoRecommend_maxTokens_container"),D.val(r.maxContextType),L.css("display","custom"===r.maxContextType?"block":"none"),D.on("change",(function(){var e=D.val();r.maxContextType=e,mt.saveSettings(),"custom"===e?L.show():L.hide()})),(M=c.find("#worldInfoRecommend_maxTokens")).val(r.maxContextValue),M.on("change",(function(){var e=Number(M.val());r.maxContextValue=e,mt.saveSettings()})),(F=c.find("#worldInfoRecommend_maxResponseTokens")).val(r.maxResponseToken),F.on("change",(function(){var e=Number(F.val());r.maxResponseToken=e,mt.saveSettings()})),V={},W=[],B=c.find("#worldInfoRecommend_sendPrompt"),(U=c.find("#worldInfoRecommend_addAll")).on("click",ut(lt().mark((function e(){var t,n,r,o,i,s,a,l,u,d,p,f,h,m,g,v,b,w,I,P,S,N;return lt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,U.prop("disabled",!0),0!==x.length){e.next=5;break}return k("error","No available worlds to add entries to"),e.abrupt("return");case 5:if(t=Object.values(V).reduce((function(e,t){return e+t.length}),0),0!==t){e.next=9;break}return k("warning","No entries to add"),e.abrupt("return");case 9:return e.next=11,ft.Popup.show.confirm("World Info Recommender","Are you sure you want to add/update all ".concat(t," suggested entries?"));case 11:if(e.sent){e.next=14;break}return e.abrupt("return");case 14:n=0,r=0,o=[],i=new Set,s=0,a=Object.entries(V);case 19:if(!(s<a.length)){e.next=56;break}if(l=it(a[s],2),u=l[0],0!==(d=l[1]).length){e.next=23;break}return e.abrupt("continue",53);case 23:p=ot(d),e.prev=24,p.s();case 26:if((f=p.n()).done){e.next=45;break}return h=f.value,y[m=u]||(m=x[0]),e.prev=30,e.next=33,G(h,m,!0);case 33:g=e.sent,o.push({worldName:m,entry:h,status:g}),"added"===g?n++:r++,i.add(m),e.next=43;break;case 39:e.prev=39,e.t0=e.catch(30),console.error("Failed to process entry: ".concat(h.comment),e.t0),k("error","Failed to process entry: ".concat(h.comment));case 43:e.next=26;break;case 45:e.next=50;break;case 47:e.prev=47,e.t1=e.catch(24),p.e(e.t1);case 50:return e.prev=50,p.f(),e.finish(50);case 53:s++,e.next=19;break;case 56:v=ot(i),e.prev=57,v.s();case 59:if((b=v.n()).done){e.next=69;break}w=b.value,I={entries:{}},P=ot(y[w]);try{for(P.s();!(S=P.n()).done;)N=S.value,I.entries[N.uid]=N}catch(e){P.e(e)}finally{P.f()}return e.next=66,ft.saveWorldInfo(w,I);case 66:ft.reloadWorldInfoEditor(w,!0);case 67:e.next=59;break;case 69:e.next=74;break;case 71:e.prev=71,e.t2=e.catch(57),v.e(e.t2);case 74:return e.prev=74,v.f(),e.finish(74);case 77:V={},c.find("#worldInfoRecommend_suggestedEntries").empty(),n>0||r>0?k("success",'\n            <div class="results-summary">\n              <p>Successfully processed '.concat(n+r," entries:</p>\n              <ul>\n              <li>Added: ").concat(n,"</li>\n              <li>Updated: ").concat(r,"</li>\n              <li>Modified worlds: ").concat(Array.from(i).join(", "),"</li>\n              </ul>\n            </div>"),{escapeHtml:!1}):k("warning","No entries were processed successfully"),e.next=86;break;case 82:e.prev=82,e.t3=e.catch(0),console.error(e.t3),k("error",e.t3 instanceof Error?e.t3.message:e.t3);case 86:return e.prev=86,U.prop("disabled",!1),e.finish(86);case 89:case"end":return e.stop()}}),e,null,[[0,82,86,89],[24,47,50,53],[30,39],[57,71,74,77]])})))),B.on("click",ut(lt().mark((function e(){var t,n,o,i,s,a,l,u,d,p,f,h,m,g,v,I,P,S,N,E,_,T,A,C,R,j;return lt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,i=function(e,t){var n=e.data("world-name"),r=e.data("id"),o=e.data("comment");e&&n&&null!=r&&o?(t&&W.push("".concat(n," (").concat(o,")")),V[n]=V[n].filter((function(e){return e.uid!==parseInt(r)})),e.remove()):n||k("warning","Selected entry is missing world name")},B.prop("disabled",!0),r.profileId){e.next=5;break}return e.abrupt("return");case 5:if(s=SillyTavern.getContext(),a=null===(o=s.extensionSettings.connectionManager)||void 0===o||null===(o=o.profiles)||void 0===o?void 0:o.find((function(e){return e.id===r.profileId}))){e.next=9;break}return e.abrupt("return");case 9:if(l=c.find("#worldInfoRecommend_prompt").val()){e.next=12;break}return e.abrupt("return");case 12:if(l=ft.substituteParams(l.trim())){e.next=15;break}return e.abrupt("return");case 15:if(u=[],d=a.api?ft.CONNECT_API_MAP[a.api].selected:void 0){e.next=19;break}return e.abrupt("return");case 19:p={presetName:a.preset,contextName:a.context,instructName:a.instruct,syspromptName:a.sysprompt,ignoreCharacterFields:!r.contextToSend.charCard,ignoreWorldInfo:!0,ignoreAuthorNote:!r.contextToSend.authorNote,maxContext:"custom"===r.maxContextType?r.maxContextValue:"profile"===r.maxContextType?"preset":"active",includeNames:!!b.selected_group},e.t0=r.contextToSend.messages.type,e.next="none"===e.t0?23:"first"===e.t0?25:"last"===e.t0?27:"range"===e.t0?30:(e.t0,32);break;case 23:return p.messageIndexesBetween={start:-1,end:-1},e.abrupt("break",33);case 25:return p.messageIndexesBetween={start:0,end:null!==(t=r.contextToSend.messages.first)&&void 0!==t?t:10},e.abrupt("break",33);case 27:return f=null!==(n=r.contextToSend.messages.last)&&void 0!==n?n:10,p.messageIndexesBetween={end:s.chat.length-1,start:s.chat.length-f},e.abrupt("break",33);case 30:return r.contextToSend.messages.range&&(p.messageIndexesBetween={start:r.contextToSend.messages.range.start,end:r.contextToSend.messages.range.end}),e.abrupt("break",33);case 32:return e.abrupt("break",33);case 33:return e.t1=u.push,e.t2=u,e.t3=rt,e.next=38,O(d,p);case 38:return e.t4=e.sent,e.t5=(0,e.t3)(e.t4),e.t1.apply.call(e.t1,e.t2,e.t5),r.contextToSend.stDescription&&u.push({role:"system",content:r.stWorldInfoPrompt}),r.contextToSend.worldInfo&&w.length>0&&(h=tt.Handlebars.compile(r.lorebookDefinitionPrompt,{noEscape:!0}),m={},Object.entries(y).filter((function(e){var t=it(e,2),n=t[0];return t[1].length>0&&w.includes(n)})).forEach((function(e){var t=it(e,2),n=t[0],r=t[1];m[n]=r})),(g=h({lorebooks:m}))&&u.push({role:"assistant",content:"=== CURRENT LOREBOOKS ===\n".concat(g)})),W.length>0&&(v="# Blacklisted Entries:\n",W.forEach((function(e){v+="- ".concat(e,"\n")})),u.push({role:"system",content:v})),Object.keys(V).length>0&&(I=Object.values(V).some((function(e){return e.length>0})),I&&(P=tt.Handlebars.compile(r.lorebookDefinitionPrompt,{noEscape:!0}),S={},Object.entries(V).filter((function(e){var t=it(e,2);t[0];return t[1].length>0})).forEach((function(e){var t=it(e,2),n=t[0],r=t[1];S[n]=r})),N=P({lorebooks:S}),u.push({role:"system",content:"=== Already suggested entries ===\n".concat(N)}))),E="".concat(r.responseRulesPrompt,"\n\n").concat(r.lorebookRulesPrompt,"\n\nYour task:\n").concat(l),u.push({role:"user",content:E}),e.next=49,ft.ConnectionManagerRequestService.sendRequest(a.id,u,r.maxResponseToken);case 49:if(_=e.sent,T=et(_.content),0!==Object.keys(T).length){e.next=54;break}return k("warning","No entries in response"),e.abrupt("return");case 54:if(Object.entries(T).forEach((function(e){var t=it(e,2),n=t[0],r=t[1];y[n]&&r.forEach((function(e){var t,r=null===(t=y[n])||void 0===t?void 0:t.find((function(t){return t.uid===e.uid}));r&&(0===e.key.length&&(e.key=r.key),e.comment||(e.comment=r.comment))}))})),A=c.find("#worldInfoRecommend_suggestedEntries"),C=c.find("#worldInfoRecommend_entryTemplate")){e.next=59;break}return e.abrupt("return");case 59:R=null,Object.entries(T).forEach((function(e){var t=it(e,2),n=t[0];t[1].forEach((function(e){var t=n,r=x.indexOf(t);-1===r&&(t=R||(x.length>0?x[0]:"")),r=x.indexOf(t),V[n]||(V[n]=[]);var o,i=V[n].find((function(t){return t.uid===e.uid&&t.comment===e.comment}));if(i){var s='.entry[data-id="'.concat(e.uid,'"][data-world-name="').concat(n,'"]');o=A.find(s)}else o=$(C.html());if(o.attr("data-world-name",n),o.attr("data-id",e.uid.toString()),o.attr("data-comment",e.comment),t){var a,l=null===(a=y[t])||void 0===a?void 0:a.find((function(t){return t.uid===e.uid}));o.find(".add").text(l?"Update":"Add")}var c=o.find(".world-select");c.empty(),x.forEach((function(e,t){var n=document.createElement("option");n.value=t.toString(),n.text=e,c.append(n)})),-1!==r&&c.val(r.toString()),c.on("change",(function(){var t,n=parseInt($(this).val());if(!(isNaN(n)||n<0||n>=x.length)){var r=x[n],i=null===(t=y[r])||void 0===t?void 0:t.find((function(t){return t.uid===e.uid&&t.comment===e.comment}));o.find(".add").text(i?"Update":"Add")}})),o.find(".comment").text(e.comment),o.find(".key").text(e.key.join(", ")),o.find(".content").text(e.content),i?(i.key=e.key,i.content=e.content,i.comment=e.comment):(V[n].push(e),A.append(o))}))})),A.find(".blacklist").on("click",(function(e){var t=$(e.currentTarget).closest(".entry");t&&i(t,!0)})),A.find(".remove").on("click",(function(e){var t=$(e.currentTarget).closest(".entry");t&&i(t,!1)})),(j=A.find(".add")).on("click",function(){var e=ut(lt().mark((function e(t){var n,r,o,s,a,l,c,u;return lt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,j.prop("disabled",!0),n=$(t.currentTarget).closest(".entry")){e.next=5;break}return e.abrupt("return");case 5:if(r=n.data("world-name"),o=n.data("id"),s=n.data("comment"),n&&r&&null!=o&&s){e.next=11;break}return r||k("warning","Selected entry is missing world name"),e.abrupt("return");case 11:if(a=structuredClone(V[r].find((function(e){return e.uid===parseInt(o)}))),a){e.next=14;break}return e.abrupt("return");case 14:if(l=n.find(".world-select"),c=parseInt(l.val()),!(isNaN(c)||c<0||c>=x.length)){e.next=19;break}return k("warning","Please select a valid world"),e.abrupt("return");case 19:return u=x[c],R=u,i(n,!1),e.next=24,G(a,u);case 24:k("success","added"===e.sent?"Entry added":"Entry updated"),e.next=32;break;case 28:e.prev=28,e.t0=e.catch(0),console.error(e.t0),k("error",e.t0 instanceof Error?e.t0.message:e.t0);case 32:return e.prev=32,j.prop("disabled",!1),e.finish(32);case 35:case"end":return e.stop()}}),e,null,[[0,28,32,35]])})));return function(t){return e.apply(this,arguments)}}()),e.next=71;break;case 67:e.prev=67,e.t6=e.catch(0),console.error(e.t6),k("error",e.t6 instanceof Error?e.t6.message:e.t6);case 71:return e.prev=71,B.prop("disabled",!1),e.finish(71);case 74:case"end":return e.stop()}}),e,null,[[0,67,71,74]])}))));case 65:case"end":return e.stop()}}),e)}))));case 30:case"end":return e.stop()}}),e)}))),gt.apply(this,arguments)}function vt(){var e;!function(){gt.apply(this,arguments)}(),ft.SlashCommandParser.addCommandObject(ft.SlashCommand.fromProps({name:"world-info-recommender-popup-open",helpString:"Open World Info Recommender popup",unnamedArgumentList:[],callback:(e=ut(lt().mark((function e(t,n){return lt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!dt){e.next=3;break}return dt.trigger("click"),e.abrupt("return",!0);case 3:return e.abrupt("return",!1);case 4:case"end":return e.stop()}}),e)}))),function(t,n){return e.apply(this,arguments)}),returns:ft.ARGUMENT_TYPE.BOOLEAN}))}if(ft.ConnectionManagerRequestService&&ft.getCharacterCardFields&&ft.getWorldInfoPrompt&&ft.reloadWorldInfoEditor)mt.initializeSettings().then((function(e){if(e.version.changed){var t=mt.getSettings(),n=!1;t.usingDefaultStWorldInfoPrompt&&t.stWorldInfoPrompt!==D&&(t.stWorldInfoPrompt=D,n=!0),t.usingDefaultLorebookDefinitionPrompt&&t.lorebookDefinitionPrompt!==L&&(t.lorebookDefinitionPrompt=L,n=!0),t.usingDefaultLorebookRulesPrompt&&t.lorebookRulesPrompt!==M&&(t.lorebookRulesPrompt=M,n=!0),t.usingDefaultResponseRulesPrompt&&t.responseRulesPrompt!==Je&&(t.responseRulesPrompt=Je,n=!0),n&&mt.saveSettings()}vt()})).catch((function(e){k("error",e),ft.Popup.show.confirm("Data migration failed. Do you want to reset the World Info Recommender data?","World Info Recommender").then((function(e){e&&(mt.resetSettings(),vt())}))}));else{k("error","[World Info Recommender Error] Make sure you are on staging branch and staging is updated.")}