import*as e from"../../../../power-user.js";import*as t from"../../../../../script.js";import*as n from"../../../../world-info.js";import*as r from"../../../../instruct-mode.js";import*as o from"../../../../chats.js";import*as i from"../../../../openai.js";import*as s from"../../../../authors-note.js";import*as a from"../../../../group-chats.js";import*as c from"../../../regex/engine.js";import*as l from"../../../../utils.js";var u={d:(e,t)=>{for(var n in t)u.o(t,n)&&!u.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};function d(e,t={}){const n=$(e);if(0===n.length)throw new Error(`Could not find container: ${e}`);n.empty().addClass("fancy-dropdown-container");const r=$("<div></div>").addClass("fancy-dropdown-list").css({"max-height":"300px","overflow-y":"auto",border:"1px solid var(--border-color)","background-color":"var(--bg-color)",color:"var(--text-color)","border-radius":"4px"});n.append(r);let o=[...t.initialValues||[]];const i=()=>{r.find(".fancy-dropdown-item").each((function(){const e=$(this),t=e.data("value");o.includes(t)?(e.addClass("selected"),e.find(".checkmark").show()):(e.removeClass("selected"),e.find(".checkmark").hide())}))};if(t.initialList&&t.initialList.length>0)for(const e of t.initialList){const n=$("<div></div>").addClass("fancy-dropdown-item").data("value",e).css({padding:"8px 12px",cursor:"pointer",display:"flex","align-items":"center","justify-content":"space-between"}).hover((function(){$(this).css("background-color","var(--hover-color, #444)")}),(function(){$(this).css("background-color","")}));$("<span></span>").text(e).appendTo(n);const s=$("<i></i>").addClass("checkmark fa-solid fa-check").css({"margin-left":"8px",display:o.includes(e)?"inline-block":"none"});n.append(s),n.on("click",(function(){const e=$(this).data("value"),n=[...o];o.includes(e)?o=o.filter((t=>t!==e)):o.push(e),i(),t.onSelectChange&&t.onSelectChange(n,o)})),r.append(n)}return i(),{$container:n,$dropdownList:r,getValues:()=>[...o],setValues:e=>{const n=[...o];o=[...e],i(),t.onSelectChange&&JSON.stringify(n)!==JSON.stringify(o)&&t.onSelectChange(n,o)},getOptions:()=>t.initialList||[],addOption:(e,n=!1)=>{if(t.initialList&&t.initialList.includes(e))return;t.initialList||(t.initialList=[]),t.initialList.push(e);const s=$("<div></div>").addClass("fancy-dropdown-item").data("value",e).css({padding:"8px 12px",cursor:"pointer",display:"flex","align-items":"center","justify-content":"space-between"}).hover((function(){$(this).css("background-color","var(--hover-color, #444)")}),(function(){$(this).css("background-color","")}));$("<span></span>").text(e).appendTo(s);const a=$("<i></i>").addClass("checkmark fa-solid fa-check").css({"margin-left":"8px",display:"none"});if(s.append(a),s.on("click",(function(){const e=$(this).data("value"),n=[...o];o.includes(e)?o=o.filter((t=>t!==e)):o.push(e),i(),t.onSelectChange&&t.onSelectChange(n,o)})),r.append(s),n&&!o.includes(e)){const n=[...o];o.push(e),i(),t.onSelectChange&&t.onSelectChange(n,o)}},removeOption:e=>{if(t.initialList&&(t.initialList=t.initialList.filter((t=>t!==e))),o.includes(e)){const n=[...o];o=o.filter((t=>t!==e)),t.onSelectChange&&t.onSelectChange(n,o)}r.find(`.fancy-dropdown-item[data-value="${e}"]`).remove()},selectAll:()=>{const e=[...o];o=[...t.initialList||[]],i(),t.onSelectChange&&JSON.stringify(e)!==JSON.stringify(o)&&t.onSelectChange(e,o)},deselectAll:()=>{const e=[...o];o=[],i(),t.onSelectChange&&e.length>0&&t.onSelectChange(e,o)},disable:()=>{r.css("pointer-events","none").css("opacity","0.6")},enable:()=>{r.css("pointer-events","auto").css("opacity","1")}}}const p=(e=>{var t={};return u.d(t,e),t})({persona_description_positions:()=>e.persona_description_positions,renderStoryString:()=>e.renderStoryString});const f=(e=>{var t={};return u.d(t,e),t})({baseChatReplace:()=>t.baseChatReplace,characters:()=>t.characters,chat_metadata:()=>t.chat_metadata,depth_prompt_depth_default:()=>t.depth_prompt_depth_default,depth_prompt_role_default:()=>t.depth_prompt_role_default,extension_prompt_types:()=>t.extension_prompt_types,getMaxContextSize:()=>t.getMaxContextSize,name1:()=>t.name1,name2:()=>t.name2,parseMesExamples:()=>t.parseMesExamples,this_chid:()=>t.this_chid});const h=(e=>{var t={};return u.d(t,e),t})({METADATA_KEY:()=>n.METADATA_KEY,createWorldInfoEntry:()=>n.createWorldInfoEntry,loadWorldInfo:()=>n.loadWorldInfo,selected_world_info:()=>n.selected_world_info,wi_anchor_position:()=>n.wi_anchor_position,world_info:()=>n.world_info,world_info_include_names:()=>n.world_info_include_names});const m=(e=>{var t={};return u.d(t,e),t})({formatInstructModeExamples:()=>r.formatInstructModeExamples,formatInstructModeSystemPrompt:()=>r.formatInstructModeSystemPrompt});const g=(e=>{var t={};return u.d(t,e),t})({appendFileContent:()=>o.appendFileContent});const v=(e=>{var t={};return u.d(t,e),t})({formatWorldInfo:()=>i.formatWorldInfo,getPromptPosition:()=>i.getPromptPosition,getPromptRole:()=>i.getPromptRole,prepareOpenAIMessages:()=>i.prepareOpenAIMessages,setOpenAIMessageExamples:()=>i.setOpenAIMessageExamples,setOpenAIMessages:()=>i.setOpenAIMessages});const y=(e=>{var t={};return u.d(t,e),t})({metadata_keys:()=>s.metadata_keys});const x=(e=>{var t={};return u.d(t,e),t})({getGroupDepthPrompts:()=>a.getGroupDepthPrompts,selected_group:()=>a.selected_group});const b=(e=>{var t={};return u.d(t,e),t})({getRegexedString:()=>c.getRegexedString,regex_placement:()=>c.regex_placement});const w=(e=>{var t={};return u.d(t,e),t})({getCharaFilename:()=>l.getCharaFilename});async function N(e,t){await async function(e,...t){await SillyTavern.getContext().SlashCommandParser.commands[e].callback(...t)}("echo",{severity:e},t)}function I(e){return(0,f.getMaxContextSize)(e)}function S(e,t){return(0,f.parseMesExamples)(e,t)}function E(e,t,n){return(0,f.baseChatReplace)(e,t,n)}function _(e){return(0,v.getPromptRole)(e)}function T(e,{wiFormat:t}={}){return(0,v.formatWorldInfo)(e,{wiFormat:t})}function P(e){return(0,v.getPromptPosition)(e)}async function k(e){return await(0,h.loadWorldInfo)(e)}async function A(e,{targetCharacterId:t,presetName:n,instructName:r,contextName:o,syspromptName:i,maxContext:s,includeNames:a,ignoreCharacterFields:c,ignoreAuthorNote:l,ignoreWorldInfo:u,messageIndexesBetween:d}={}){if(!["textgenerationwebui","openai"].includes(e))throw new Error("Unsupported API");const w=SillyTavern.getContext();let N=[],{description:k,personality:A,persona:O,scenario:C,mesExamples:j,system:R,jailbreak:L}=c?{description:"",personality:"",persona:"",scenario:"",mesExamples:"",system:"",jailbreak:""}:w.getCharacterCardFields({chid:t});const M="textgenerationwebui"===e?w.getPresetManager("instruct")?.getCompletionPresetByName(r):void 0,D=!!M?.enabled;let $=S(j,D);const F=function(){if("number"==typeof s)return s;if(!s)return I();if("active"===s||!n)return I();if("number"==typeof s)return s;let t;if("textgenerationwebui"===e){const e=w.getPresetManager("textgenerationwebui")?.getCompletionPresetByName(n);t=e?.max_length}else{const e=w.getPresetManager("openai")?.getCompletionPresetByName(n);t=e?.openai_max_context}return"number"==typeof t?t:I()}();if(F<=0)return[];const V=w.ToolManager.isToolCallingSupported(),B=d?.start??0,W=d?.end?d.end+1:void 0;let U=-1===B&&0===W?[]:w.chat.slice(B,W).filter((e=>!e.is_system||V&&Array.isArray(e.extra?.tool_invocations)));U=await Promise.all(U.map((async(e,t)=>{let n=function(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:i,depth:s}){return(0,b.getRegexedString)(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:i,depth:s})}(e.mes,e.is_user?b.regex_placement.USER_INPUT:b.regex_placement.AI_OUTPUT,{isPrompt:!0,depth:U.length-t-1});return n=await async function(e,t){return await(0,g.appendFileContent)(e,t)}(e,n),e?.extra?.append_title&&e?.extra?.title&&(n=`${n}\n\n${e.extra.title}`),{...e,mes:n,index:t}})));const G=U.map((e=>h.world_info_include_names?`${e.name}: ${e.mes}`:e.mes)).reverse(),{worldInfoString:K,worldInfoBefore:q,worldInfoAfter:X,worldInfoExamples:Y,worldInfoDepth:H,anBefore:z,anAfter:Z}=u?{worldInfoString:"",worldInfoBefore:"",worldInfoAfter:"",worldInfoExamples:[],worldInfoDepth:[],anBefore:[],anAfter:[]}:await w.getWorldInfoPrompt(G,F,!1);for(const se of Y){const ae=se.content;if(0===ae.length)continue;const ce=S(E(ae,f.name1,f.name2),D);se.position===h.wi_anchor_position.before?$.unshift(...ce):$.push(...ce)}function J(){let e=0;const t=[];for(let n=U.length-1;n>=0;n--){const r=U[n];if(r.extra?.token_count&&e+r.extra.token_count>F)break;e+=r.extra?.token_count||0,t.unshift({role:r.is_user?"user":"assistant",content:a?`${r.name}: ${r.mes}`:r.mes})}N.push(...t)}if("textgenerationwebui"===e){const le=[...$];$&&($=function(e,t,n){return(0,m.formatInstructModeExamples)(e,t,n)}($,f.name1,f.name2));const ue=w.getPresetManager("sysprompt")?.getCompletionPresetByName(i);ue&&(R=w.powerUserSettings.prefer_character_prompt&&R?R:E(ue.content,f.name1,f.name2),R=D?(ee=w.substituteParams(R,f.name1,f.name2,ue.content),te=M,(0,m.formatInstructModeSystemPrompt)(ee,te)):R);const de={description:k,personality:A,persona:w.powerUserSettings.persona_description_position==p.persona_description_positions.IN_PROMPT?O:"",scenario:C,system:R,char:f.name2,user:f.name1,wiBefore:q,wiAfter:X,loreBefore:q,loreAfter:X,mesExamples:$.join(""),mesExamplesRaw:le.join("")},pe=w.getPresetManager("context")?.getCompletionPresetByName(o);let fe=function(e,{customStoryString:t,customInstructSettings:n}={}){return(0,p.renderStoryString)(e,{customStoryString:t,customInstructSettings:n})}(de,{customInstructSettings:M,customStoryString:pe?.story_string});N.push({role:"system",content:fe,ignoreInstruct:!0}),J()}else{let he=(Q=U,(0,v.setOpenAIMessages)(Q)),me=function(e){return(0,v.setOpenAIMessageExamples)(e)}($);async function ge(){let[e,t]=await function({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:i,bias:s,type:a,quietPrompt:c,quietImage:l,extensionPrompts:u,cyclePrompt:d,systemPromptOverride:p,jailbreakPromptOverride:f,personaDescription:h,messages:m,messageExamples:g},y){return(0,v.prepareOpenAIMessages)({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:i,bias:s,type:a,quietPrompt:c,quietImage:l,cyclePrompt:d,systemPromptOverride:p,jailbreakPromptOverride:f,personaDescription:h,extensionPrompts:u,messages:m,messageExamples:g},y)}({name2:f.name2,charDescription:k,charPersonality:A,Scenario:C,worldInfoBefore:q,worldInfoAfter:X,extensionPrompts:w.extensionPrompts,bias:"",type:"normal",quietPrompt:void 0,quietImage:void 0,cyclePrompt:"",systemPromptOverride:R,jailbreakPromptOverride:L,personaDescription:O,messages:he,messageExamples:me},!1);N.push(...e)}if(!n)return await ge(),N;const ve=w.getPresetManager("openai")?.getCompletionPresetByName(n);if(!ve)return console.warn(`Preset not found: ${n}. Using current preset.`),ge(),N;let ye=ve.prompt_order.find((e=>e.character_id===f.this_chid));if(!ye&&ve.prompt_order.length>0&&(ye=ve.prompt_order[0]),!ye)return console.warn(`No prompt order found for preset: ${n}. Using current preset.`),ge(),N;const xe=C&&ve.scenario_format?w.substituteParams(ve.scenario_format):"",be=A&&ve.personality_format?w.substituteParams(ve.personality_format):"",we=w.substituteParams(ve.group_nudge_prompt),Ne=ve.impersonation_prompt?w.substituteParams(ve.impersonation_prompt):"",Ie=[];u&&Ie.push({role:"system",content:T(q,{wiFormat:ve.wi_format}),identifier:"worldInfoBefore"},{role:"system",content:T(X,{wiFormat:ve.wi_format}),identifier:"worldInfoAfter"}),c||Ie.push({role:"system",content:k,identifier:"charDescription"},{role:"system",content:be,identifier:"charPersonality"},{role:"system",content:xe,identifier:"scenario"}),Ie.push({role:"system",content:Ne,identifier:"impersonate"},{role:"system",content:we,identifier:"groupNudge"});const Se=w.extensionPrompts["1_memory"];Se&&Se.value&&Ie.push({role:_(Se.role),content:Se.value,identifier:"summary",position:P(Se.position)});const Ee=w.extensionPrompts["2_floating_prompt"];!l&&Ee&&Ee.value&&Ie.push({role:_(Ee.role),content:Ee.value,identifier:"authorsNote",position:P(Ee.position)});const _e=w.extensionPrompts["3_vectors"];_e&&_e.value&&Ie.push({role:"system",content:_e.value,identifier:"vectorsMemory",position:P(_e.position)});const Te=w.extensionPrompts["4_vectors_data_bank"];Te&&Te.value&&Ie.push({role:_(Te.role),content:Te.value,identifier:"vectorsDataBank",position:P(Te.position)});const Pe=w.extensionPrompts.chromadb;Pe&&Pe.value&&Ie.push({role:"system",content:Pe.value,identifier:"smartContext",position:P(Pe.position)}),!c&&w.powerUserSettings.persona_description&&w.powerUserSettings.persona_description_position===p.persona_description_positions.IN_PROMPT&&Ie.push({role:"system",content:w.powerUserSettings.persona_description,identifier:"personaDescription"}),ye.order.forEach((e=>{if(!e.enabled)return;const t=(n=e.identifier,Ie.find((e=>e.identifier===n)));var n;t&&t.content?N.push({role:t.role??"system",content:w.substituteParams(t.content)}):"chatHistory"===e.identifier&&J()}))}var Q,ee,te;const ne=["1_memory","2_floating_prompt","3_vectors","4_vectors_data_bank","chromadb","PERSONA_DESCRIPTION","QUIET_PROMPT","DEPTH_PROMPT"];for(const ke in w.extensionPrompts)if(Object.hasOwn(w.extensionPrompts,ke)){const Ae=w.extensionPrompts[ke];if(ne.includes(ke))continue;if(!w.extensionPrompts[ke].value)continue;if(![f.extension_prompt_types.BEFORE_PROMPT,f.extension_prompt_types.IN_PROMPT].includes(Ae.position))continue;if("function"==typeof Ae.filter&&!await Ae.filter())continue;Ae.position===f.extension_prompt_types.BEFORE_PROMPT?N=[...N.slice(0,Ae.depth),{role:_(Ae.role)??"system",content:Ae.value},...N.slice(Ae.depth)]:Ae.position===f.extension_prompt_types.IN_PROMPT&&(N=[...N.slice(0,N.length-Ae.depth),{role:_(Ae.role)??"system",content:Ae.value},...N.slice(N.length-Ae.depth)])}for(const Oe of H)N=[...N.slice(0,N.length-Oe.depth),{role:_(Oe.role),content:Oe.entries.join("\n")},...N.slice(N.length-Oe.depth)];if(!c){const Ce=(re=x.selected_group,oe=Number(f.this_chid),(0,x.getGroupDepthPrompts)(re,oe));if(x.selected_group&&Array.isArray(Ce)&&Ce.length>0)Ce.forEach(((e,t)=>{N=[...N.slice(0,N.length-e.depth),{role:e.role,content:e.text},...N.slice(N.length-e.depth)]}));else{const je=E(f.characters[f.this_chid]?.data?.extensions?.depth_prompt?.prompt?.trim(),f.name1,f.name2)||"",Re=f.depth_prompt_depth_default,Le=f.characters[f.this_chid]?.data?.extensions?.depth_prompt?.role??f.depth_prompt_role_default;N=[...N.slice(0,N.length-Re),{role:_(Le),content:je},...N.slice(N.length-Re)]}}var re,oe;let ie=-1;if(!l){const Me={prompt:f.chat_metadata[y.metadata_keys.prompt],interval:f.chat_metadata[y.metadata_keys.interval],position:f.chat_metadata[y.metadata_keys.position],depth:f.chat_metadata[y.metadata_keys.depth],role:f.chat_metadata[y.metadata_keys.role]};if(Me.prompt)switch(Me.prompt=E(Me.prompt,f.name1,f.name2),Me.position){case f.extension_prompt_types.IN_PROMPT:N=[...N.slice(0,1),{role:"user",content:Me.prompt},...N.slice(1)],ie=1;break;case f.extension_prompt_types.IN_CHAT:N=[...N.slice(0,N.length-Me.depth),{role:_(Me.role),content:Me.prompt},...N.slice(N.length-Me.depth)],ie=N.length-Me.depth-1;break;case f.extension_prompt_types.BEFORE_PROMPT:N.unshift({role:"user",content:Me.prompt}),ie=0}}return ie>=0&&(z.length>0&&(N=[...N.slice(0,ie),{role:"system",content:z.join("\n")},...N.slice(ie)],ie++),Z.length>0&&(N=[...N.slice(0,ie+1),{role:"system",content:Z.join("\n")},...N.slice(ie+1)])),N}async function O(e,t){function n(t){return e.includes("all")||e.includes(t)}const r=SillyTavern.getContext();let o={};if(n("global")&&h.selected_world_info?.length)for(const e of h.selected_world_info){const t=await k(e);t&&Object.values(t.entries).forEach((t=>{o[e]||(o[e]=[]),o[e].push(t)}))}if(n("chat")){const e=r.chatMetadata[h.METADATA_KEY];if(e&&!o[e]){o[e]=[];const t=await k(e);t&&Object.values(t.entries).forEach((t=>{o[e].push(t)}))}}if(n("character")){const e=f.characters[t];let n=new Set;const r=e?.data?.extensions?.world;r&&n.add(r);const i=function(e,{manualAvatarKey:t}={}){return(0,w.getCharaFilename)(e,{manualAvatarKey:t})}(t),s=h.world_info.charLore?.find((e=>e.name===i));s&&(n=new Set([...n,...s.extraBooks]));for(const e of n){const t=await k(e);t&&!o[e]&&(o[e]=[],Object.values(t.entries).forEach((t=>{o[e].push(t)})))}}if(n("persona")){const e=r.powerUserSettings.persona_description_lorebook;if(e&&!o[e]){o[e]=[];const t=await k(e);t&&Object.values(t.entries).forEach((t=>{o[e].push(t)}))}}return o}var C,j;!function(e){e[e.TEXT=1]="TEXT",e[e.CONFIRM=2]="CONFIRM",e[e.INPUT=3]="INPUT",e[e.DISPLAY=4]="DISPLAY"}(C||(C={})),function(e){e[e.AFFIRMATIVE=1]="AFFIRMATIVE",e[e.NEGATIVE=0]="NEGATIVE",e[e.CANCELLED=null]="CANCELLED"}(j||(j={}));var R='=== SILLYTAVERN===\n\n**SillyTavern** is a popular open-source front-end interface designed for interacting with AI language models. It\'s primarily used for role-playing, creative writing, and conversational experiences, offering a user-friendly platform to customize interactions with AI. Here\'s an overview:\n\n### Key Features:\n1. **AI Backend Compatibility**: Works with APIs like OpenAI (GPT), KoboldAI, Claude, or local models (via services like Text-generation-webui or Ollama).\n2. **Customization**:\n   - Create and import character cards (with personas, scenarios, and dialogue examples).\n   - Adjust model parameters (temperature, repetition penalties) for tailored responses.\n3. **Plugins & Extensions**: Adds features like text-to-speech, image generation, emotion recognition, and world-building tools.\n4. **Privacy**: Self-hosted locally, giving users control over data (unlike cloud-based services).\n\n### Use Cases:\n- Role-playing with AI characters.\n- Collaborative storytelling or creative writing.\n- Experimental AI interactions (users often share character templates and scripts in communities).\n\n### Requirements:\n- Technical setup involves installing Node.js, cloning the GitHub repo, and configuring API connections.\n- Requires access to an AI model backend (e.g., OpenAI API key or a locally hosted model).\n\n### Community & Ethics:\n- Active communities on platforms like GitHub and Reddit share guides, characters, and plugins.\n- Encourages responsible use, as the tool can generate unrestricted content depending on the AI backend.\n\nSillyTavern is not an AI itself but a flexible interface to enhance interactions with LLMs.\n\n=== WORLDINFO (LOREBOOKS) ===\n\n**World Info** (often called **Lorebooks**) is a feature used in AI-driven storytelling and role-playing platforms (like SillyTavern, NovelAI, KoboldAI, or Text-generation-webui) to help AI models maintain consistency in fictional worlds. It acts as a dynamic knowledge base that the AI references during interactions to avoid contradictions and keep track of key details.\n\n---\n\n### **What is World Info/Lorebooks?**\n- **A structured database**: Stores details about characters, locations, rules, events, or concepts in your fictional world.\n- **Contextual triggers**: Entries activate automatically when specific keywords or phrases appear in the conversation/story.\n- **Prevents "amnesia"**: Ensures the AI remembers critical lore without relying solely on its limited context window.\n\n---\n\n### **How It Works**\n1. **Create Entries**: Define elements (e.g., a character’s backstory, a magic system’s rules).\n2. **Set Triggers**: Link entries to keywords (e.g., mention "Dragonstone" → inject lore about that location).\n3. **Dynamic Injection**: When a trigger word appears in the chat/story, the relevant entry is temporarily added to the AI’s context.\n\n---\n\n### **Key Features**\n- **Hierarchy**: Organize entries into categories (e.g., factions, items, timelines).\n- **Priority**: Set which entries take precedence if multiple triggers occur.\n- **Cross-references**: Link entries to each other (e.g., a character entry references their home city).\n- **Formatting**: Use markdown, JSON, or plain text depending on the platform.\n\n---\n\n### **Example Lorebook Entry**\n```plaintext\nName: Dragonstone Citadel\nTriggers: Dragonstone, Citadel, Obsidian Fortress\nContent:\n  A volcanic fortress built from black obsidian. Home to the ancient Order of Flames,\n  who guard the Eternal Fire—a magical flame that grants visions of the future.\n  The citadel is rumored to be cursed, as its rulers never live past 40 years.\n```\n\n---\n\n### **Use Cases**\n1. **Complex Worldbuilding**: Track political factions, religions, or history.\n2. **Character Consistency**: Ensure the AI remembers a character’s motives, secrets, or relationships.\n3. **Magic/Science Systems**: Define rules (e.g., "Magic drains lifeforce" or "Robots cannot harm humans").\n4. **Plot Hooks**: Store hidden clues or foreshadowing for the AI to weave into the narrative.\n\n---\n\n### **Tools Supporting Lorebooks**\n- **SillyTavern**: Integrates with lorebooks via extensions or prompts.\n- **NovelAI**: Has a built-in "Lorebook" feature with advanced triggers.\n- **KoboldAI/Text-generation-webui**: Use "world info" files or scripts.\n- **AIDungeon** (historically): Early adopter of world info, though less popular now.\n\n---\n\n### **Best Practices**\n- **Keep entries concise**: AI models process information best in short, clear snippets.\n- **Balance detail**: Too many entries can overwhelm the context window.\n- **Test triggers**: Ensure keywords are unique enough to avoid false activations.\n- **Update dynamically**: Add/remove entries as the story evolves.\n\nLorebooks are essential for long-term storytelling with AI.';const L=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",M=new RegExp("^"+("["+L+"]["+(L+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040")+"]*")+"$");function D(e,t){const n=[];let r=t.exec(e);for(;r;){const o=[];o.startIndex=t.lastIndex-r[0].length;const i=r.length;for(let e=0;e<i;e++)o.push(r[e]);n.push(o),r=t.exec(e)}return n}const F=function(e){const t=M.exec(e);return!(null==t)};const V={allowBooleanAttributes:!1,unpairedTags:[]};function B(e,t){t=Object.assign({},V,t);const n=[];let r=!1,o=!1;"\ufeff"===e[0]&&(e=e.substr(1));for(let i=0;i<e.length;i++)if("<"===e[i]&&"?"===e[i+1]){if(i+=2,i=U(e,i),i.err)return i}else{if("<"!==e[i]){if(W(e[i]))continue;return Z("InvalidChar","char '"+e[i]+"' is not expected.",Q(e,i))}{let s=i;if(i++,"!"===e[i]){i=G(e,i);continue}{let a=!1;"/"===e[i]&&(a=!0,i++);let c="";for(;i<e.length&&">"!==e[i]&&" "!==e[i]&&"\t"!==e[i]&&"\n"!==e[i]&&"\r"!==e[i];i++)c+=e[i];if(c=c.trim(),"/"===c[c.length-1]&&(c=c.substring(0,c.length-1),i--),!F(c)){let t;return t=0===c.trim().length?"Invalid space after '<'.":"Tag '"+c+"' is an invalid name.",Z("InvalidTag",t,Q(e,i))}const l=X(e,i);if(!1===l)return Z("InvalidAttr","Attributes for '"+c+"' have open quote.",Q(e,i));let u=l.value;if(i=l.index,"/"===u[u.length-1]){const n=i-u.length;u=u.substring(0,u.length-1);const o=H(u,t);if(!0!==o)return Z(o.err.code,o.err.msg,Q(e,n+o.err.line));r=!0}else if(a){if(!l.tagClosed)return Z("InvalidTag","Closing tag '"+c+"' doesn't have proper closing.",Q(e,i));if(u.trim().length>0)return Z("InvalidTag","Closing tag '"+c+"' can't have attributes or invalid starting.",Q(e,s));if(0===n.length)return Z("InvalidTag","Closing tag '"+c+"' has not been opened.",Q(e,s));{const t=n.pop();if(c!==t.tagName){let n=Q(e,t.tagStartPos);return Z("InvalidTag","Expected closing tag '"+t.tagName+"' (opened in line "+n.line+", col "+n.col+") instead of closing tag '"+c+"'.",Q(e,s))}0==n.length&&(o=!0)}}else{const a=H(u,t);if(!0!==a)return Z(a.err.code,a.err.msg,Q(e,i-u.length+a.err.line));if(!0===o)return Z("InvalidXml","Multiple possible root nodes found.",Q(e,i));-1!==t.unpairedTags.indexOf(c)||n.push({tagName:c,tagStartPos:s}),r=!0}for(i++;i<e.length;i++)if("<"===e[i]){if("!"===e[i+1]){i++,i=G(e,i);continue}if("?"!==e[i+1])break;if(i=U(e,++i),i.err)return i}else if("&"===e[i]){const t=z(e,i);if(-1==t)return Z("InvalidChar","char '&' is not expected.",Q(e,i));i=t}else if(!0===o&&!W(e[i]))return Z("InvalidXml","Extra text at the end",Q(e,i));"<"===e[i]&&i--}}}return r?1==n.length?Z("InvalidTag","Unclosed tag '"+n[0].tagName+"'.",Q(e,n[0].tagStartPos)):!(n.length>0)||Z("InvalidXml","Invalid '"+JSON.stringify(n.map((e=>e.tagName)),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1}):Z("InvalidXml","Start tag expected.",1)}function W(e){return" "===e||"\t"===e||"\n"===e||"\r"===e}function U(e,t){const n=t;for(;t<e.length;t++)if("?"!=e[t]&&" "!=e[t]);else{const r=e.substr(n,t-n);if(t>5&&"xml"===r)return Z("InvalidXml","XML declaration allowed only at the start of the document.",Q(e,t));if("?"==e[t]&&">"==e[t+1]){t++;break}}return t}function G(e,t){if(e.length>t+5&&"-"===e[t+1]&&"-"===e[t+2]){for(t+=3;t<e.length;t++)if("-"===e[t]&&"-"===e[t+1]&&">"===e[t+2]){t+=2;break}}else if(e.length>t+8&&"D"===e[t+1]&&"O"===e[t+2]&&"C"===e[t+3]&&"T"===e[t+4]&&"Y"===e[t+5]&&"P"===e[t+6]&&"E"===e[t+7]){let n=1;for(t+=8;t<e.length;t++)if("<"===e[t])n++;else if(">"===e[t]&&(n--,0===n))break}else if(e.length>t+9&&"["===e[t+1]&&"C"===e[t+2]&&"D"===e[t+3]&&"A"===e[t+4]&&"T"===e[t+5]&&"A"===e[t+6]&&"["===e[t+7])for(t+=8;t<e.length;t++)if("]"===e[t]&&"]"===e[t+1]&&">"===e[t+2]){t+=2;break}return t}const K='"',q="'";function X(e,t){let n="",r="",o=!1;for(;t<e.length;t++){if(e[t]===K||e[t]===q)""===r?r=e[t]:r!==e[t]||(r="");else if(">"===e[t]&&""===r){o=!0;break}n+=e[t]}return""===r&&{value:n,index:t,tagClosed:o}}const Y=new RegExp("(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['\"])(([\\s\\S])*?)\\5)?","g");function H(e,t){const n=D(e,Y),r={};for(let e=0;e<n.length;e++){if(0===n[e][1].length)return Z("InvalidAttr","Attribute '"+n[e][2]+"' has no space in starting.",ee(n[e]));if(void 0!==n[e][3]&&void 0===n[e][4])return Z("InvalidAttr","Attribute '"+n[e][2]+"' is without value.",ee(n[e]));if(void 0===n[e][3]&&!t.allowBooleanAttributes)return Z("InvalidAttr","boolean attribute '"+n[e][2]+"' is not allowed.",ee(n[e]));const o=n[e][2];if(!J(o))return Z("InvalidAttr","Attribute '"+o+"' is an invalid name.",ee(n[e]));if(r.hasOwnProperty(o))return Z("InvalidAttr","Attribute '"+o+"' is repeated.",ee(n[e]));r[o]=1}return!0}function z(e,t){if(";"===e[++t])return-1;if("#"===e[t])return function(e,t){let n=/\d/;for("x"===e[t]&&(t++,n=/[\da-fA-F]/);t<e.length;t++){if(";"===e[t])return t;if(!e[t].match(n))break}return-1}(e,++t);let n=0;for(;t<e.length;t++,n++)if(!(e[t].match(/\w/)&&n<20)){if(";"===e[t])break;return-1}return t}function Z(e,t,n){return{err:{code:e,msg:t,line:n.line||n,col:n.col}}}function J(e){return F(e)}function Q(e,t){const n=e.substring(0,t).split(/\r?\n/);return{line:n.length,col:n[n.length-1].length+1}}function ee(e){return e.startIndex+e[1].length}const te={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(e,t,n){return e}};class ne{constructor(e){this.tagname=e,this.child=[],this[":@"]={}}add(e,t){"__proto__"===e&&(e="#__proto__"),this.child.push({[e]:t})}addChild(e){"__proto__"===e.tagname&&(e.tagname="#__proto__"),e[":@"]&&Object.keys(e[":@"]).length>0?this.child.push({[e.tagname]:e.child,":@":e[":@"]}):this.child.push({[e.tagname]:e.child})}}function re(e,t){const n={};if("O"!==e[t+3]||"C"!==e[t+4]||"T"!==e[t+5]||"Y"!==e[t+6]||"P"!==e[t+7]||"E"!==e[t+8])throw new Error("Invalid Tag instead of DOCTYPE");{t+=9;let r=1,o=!1,i=!1,s="";for(;t<e.length;t++)if("<"!==e[t]||i)if(">"===e[t]){if(i?"-"===e[t-1]&&"-"===e[t-2]&&(i=!1,r--):r--,0===r)break}else"["===e[t]?o=!0:s+=e[t];else{if(o&&se(e,t)){let r,o;t+=7,[r,o,t]=oe(e,t+1),-1===o.indexOf("&")&&(n[ue(r)]={regx:RegExp(`&${r};`,"g"),val:o})}else if(o&&ae(e,t))t+=8;else if(o&&ce(e,t))t+=8;else if(o&&le(e,t))t+=9;else{if(!ie)throw new Error("Invalid DOCTYPE");i=!0}r++,s=""}if(0!==r)throw new Error("Unclosed DOCTYPE")}return{entities:n,i:t}}function oe(e,t){let n="";for(;t<e.length&&"'"!==e[t]&&'"'!==e[t];t++)n+=e[t];if(n=n.trim(),-1!==n.indexOf(" "))throw new Error("External entites are not supported");const r=e[t++];let o="";for(;t<e.length&&e[t]!==r;t++)o+=e[t];return[n,o,t]}function ie(e,t){return"!"===e[t+1]&&"-"===e[t+2]&&"-"===e[t+3]}function se(e,t){return"!"===e[t+1]&&"E"===e[t+2]&&"N"===e[t+3]&&"T"===e[t+4]&&"I"===e[t+5]&&"T"===e[t+6]&&"Y"===e[t+7]}function ae(e,t){return"!"===e[t+1]&&"E"===e[t+2]&&"L"===e[t+3]&&"E"===e[t+4]&&"M"===e[t+5]&&"E"===e[t+6]&&"N"===e[t+7]&&"T"===e[t+8]}function ce(e,t){return"!"===e[t+1]&&"A"===e[t+2]&&"T"===e[t+3]&&"T"===e[t+4]&&"L"===e[t+5]&&"I"===e[t+6]&&"S"===e[t+7]&&"T"===e[t+8]}function le(e,t){return"!"===e[t+1]&&"N"===e[t+2]&&"O"===e[t+3]&&"T"===e[t+4]&&"A"===e[t+5]&&"T"===e[t+6]&&"I"===e[t+7]&&"O"===e[t+8]&&"N"===e[t+9]}function ue(e){if(F(e))return e;throw new Error(`Invalid entity name ${e}`)}const de=/^[-+]?0x[a-fA-F0-9]+$/,pe=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,fe={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function he(e,t={}){if(t=Object.assign({},fe,t),!e||"string"!=typeof e)return e;let n=e.trim();if(void 0!==t.skipLike&&t.skipLike.test(n))return e;if("0"===e)return 0;if(t.hex&&de.test(n))return function(e,t){if(parseInt)return parseInt(e,t);if(Number.parseInt)return Number.parseInt(e,t);if(window&&window.parseInt)return window.parseInt(e,t);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}(n,16);if(-1!==n.search(/[eE]/)){const r=n.match(/^([-\+])?(0*)([0-9]*(\.[0-9]*)?[eE][-\+]?[0-9]+)$/);if(r){if(t.leadingZeros)n=(r[1]||"")+r[3];else if("0"!==r[2]||"."!==r[3][0])return e;return t.eNotation?Number(n):e}return e}{const r=pe.exec(n);if(r){const o=r[1],i=r[2];let s=function(e){if(e&&-1!==e.indexOf("."))return"."===(e=e.replace(/0+$/,""))?e="0":"."===e[0]?e="0"+e:"."===e[e.length-1]&&(e=e.substr(0,e.length-1)),e;return e}(r[3]);if(!t.leadingZeros&&i.length>0&&o&&"."!==n[2])return e;if(!t.leadingZeros&&i.length>0&&!o&&"."!==n[1])return e;if(t.leadingZeros&&i===e)return 0;{const r=Number(n),a=""+r;return-1!==a.search(/[eE]/)?t.eNotation?r:e:-1!==n.indexOf(".")?"0"===a&&""===s||a===s||o&&a==="-"+s?r:e:i?s===a||o+s===a?r:e:n===a||n===o+a?r:e}}return e}}function me(e){return"function"==typeof e?e:Array.isArray(e)?t=>{for(const n of e){if("string"==typeof n&&t===n)return!0;if(n instanceof RegExp&&n.test(t))return!0}}:()=>!1}class ge{constructor(e){this.options=e,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(e,t)=>String.fromCodePoint(Number.parseInt(t,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(e,t)=>String.fromCodePoint(Number.parseInt(t,16))}},this.addExternalEntities=ve,this.parseXml=Ne,this.parseTextData=ye,this.resolveNameSpace=xe,this.buildAttributesMap=we,this.isItStopNode=_e,this.replaceEntitiesValue=Se,this.readStopNodeData=ke,this.saveTextToParentTag=Ee,this.addChild=Ie,this.ignoreAttributesFn=me(this.options.ignoreAttributes)}}function ve(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];this.lastEntities[r]={regex:new RegExp("&"+r+";","g"),val:e[r]}}}function ye(e,t,n,r,o,i,s){if(void 0!==e&&(this.options.trimValues&&!r&&(e=e.trim()),e.length>0)){s||(e=this.replaceEntitiesValue(e));const r=this.options.tagValueProcessor(t,e,n,o,i);if(null==r)return e;if(typeof r!=typeof e||r!==e)return r;if(this.options.trimValues)return Ae(e,this.options.parseTagValue,this.options.numberParseOptions);return e.trim()===e?Ae(e,this.options.parseTagValue,this.options.numberParseOptions):e}}function xe(e){if(this.options.removeNSPrefix){const t=e.split(":"),n="/"===e.charAt(0)?"/":"";if("xmlns"===t[0])return"";2===t.length&&(e=n+t[1])}return e}const be=new RegExp("([^\\s=]+)\\s*(=\\s*(['\"])([\\s\\S]*?)\\3)?","gm");function we(e,t,n){if(!0!==this.options.ignoreAttributes&&"string"==typeof e){const n=D(e,be),r=n.length,o={};for(let e=0;e<r;e++){const r=this.resolveNameSpace(n[e][1]);if(this.ignoreAttributesFn(r,t))continue;let i=n[e][4],s=this.options.attributeNamePrefix+r;if(r.length)if(this.options.transformAttributeName&&(s=this.options.transformAttributeName(s)),"__proto__"===s&&(s="#__proto__"),void 0!==i){this.options.trimValues&&(i=i.trim()),i=this.replaceEntitiesValue(i);const e=this.options.attributeValueProcessor(r,i,t);o[s]=null==e?i:typeof e!=typeof i||e!==i?e:Ae(i,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(o[s]=!0)}if(!Object.keys(o).length)return;if(this.options.attributesGroupName){const e={};return e[this.options.attributesGroupName]=o,e}return o}}const Ne=function(e){e=e.replace(/\r\n?/g,"\n");const t=new ne("!xml");let n=t,r="",o="";for(let i=0;i<e.length;i++){if("<"===e[i])if("/"===e[i+1]){const t=Te(e,">",i,"Closing Tag is not closed.");let s=e.substring(i+2,t).trim();if(this.options.removeNSPrefix){const e=s.indexOf(":");-1!==e&&(s=s.substr(e+1))}this.options.transformTagName&&(s=this.options.transformTagName(s)),n&&(r=this.saveTextToParentTag(r,n,o));const a=o.substring(o.lastIndexOf(".")+1);if(s&&-1!==this.options.unpairedTags.indexOf(s))throw new Error(`Unpaired tag can not be used as closing tag: </${s}>`);let c=0;a&&-1!==this.options.unpairedTags.indexOf(a)?(c=o.lastIndexOf(".",o.lastIndexOf(".")-1),this.tagsNodeStack.pop()):c=o.lastIndexOf("."),o=o.substring(0,c),n=this.tagsNodeStack.pop(),r="",i=t}else if("?"===e[i+1]){let t=Pe(e,i,!1,"?>");if(!t)throw new Error("Pi Tag is not closed.");if(r=this.saveTextToParentTag(r,n,o),this.options.ignoreDeclaration&&"?xml"===t.tagName||this.options.ignorePiTags);else{const e=new ne(t.tagName);e.add(this.options.textNodeName,""),t.tagName!==t.tagExp&&t.attrExpPresent&&(e[":@"]=this.buildAttributesMap(t.tagExp,o,t.tagName)),this.addChild(n,e,o)}i=t.closeIndex+1}else if("!--"===e.substr(i+1,3)){const t=Te(e,"--\x3e",i+4,"Comment is not closed.");if(this.options.commentPropName){const s=e.substring(i+4,t-2);r=this.saveTextToParentTag(r,n,o),n.add(this.options.commentPropName,[{[this.options.textNodeName]:s}])}i=t}else if("!D"===e.substr(i+1,2)){const t=re(e,i);this.docTypeEntities=t.entities,i=t.i}else if("!["===e.substr(i+1,2)){const t=Te(e,"]]>",i,"CDATA is not closed.")-2,s=e.substring(i+9,t);r=this.saveTextToParentTag(r,n,o);let a=this.parseTextData(s,n.tagname,o,!0,!1,!0,!0);null==a&&(a=""),this.options.cdataPropName?n.add(this.options.cdataPropName,[{[this.options.textNodeName]:s}]):n.add(this.options.textNodeName,a),i=t+2}else{let s=Pe(e,i,this.options.removeNSPrefix),a=s.tagName;const c=s.rawTagName;let l=s.tagExp,u=s.attrExpPresent,d=s.closeIndex;this.options.transformTagName&&(a=this.options.transformTagName(a)),n&&r&&"!xml"!==n.tagname&&(r=this.saveTextToParentTag(r,n,o,!1));const p=n;if(p&&-1!==this.options.unpairedTags.indexOf(p.tagname)&&(n=this.tagsNodeStack.pop(),o=o.substring(0,o.lastIndexOf("."))),a!==t.tagname&&(o+=o?"."+a:a),this.isItStopNode(this.options.stopNodes,o,a)){let t="";if(l.length>0&&l.lastIndexOf("/")===l.length-1)"/"===a[a.length-1]?(a=a.substr(0,a.length-1),o=o.substr(0,o.length-1),l=a):l=l.substr(0,l.length-1),i=s.closeIndex;else if(-1!==this.options.unpairedTags.indexOf(a))i=s.closeIndex;else{const n=this.readStopNodeData(e,c,d+1);if(!n)throw new Error(`Unexpected end of ${c}`);i=n.i,t=n.tagContent}const r=new ne(a);a!==l&&u&&(r[":@"]=this.buildAttributesMap(l,o,a)),t&&(t=this.parseTextData(t,a,o,!0,u,!0,!0)),o=o.substr(0,o.lastIndexOf(".")),r.add(this.options.textNodeName,t),this.addChild(n,r,o)}else{if(l.length>0&&l.lastIndexOf("/")===l.length-1){"/"===a[a.length-1]?(a=a.substr(0,a.length-1),o=o.substr(0,o.length-1),l=a):l=l.substr(0,l.length-1),this.options.transformTagName&&(a=this.options.transformTagName(a));const e=new ne(a);a!==l&&u&&(e[":@"]=this.buildAttributesMap(l,o,a)),this.addChild(n,e,o),o=o.substr(0,o.lastIndexOf("."))}else{const e=new ne(a);this.tagsNodeStack.push(n),a!==l&&u&&(e[":@"]=this.buildAttributesMap(l,o,a)),this.addChild(n,e,o),n=e}r="",i=d}}else r+=e[i]}return t.child};function Ie(e,t,n){const r=this.options.updateTag(t.tagname,n,t[":@"]);!1===r||("string"==typeof r?(t.tagname=r,e.addChild(t)):e.addChild(t))}const Se=function(e){if(this.options.processEntities){for(let t in this.docTypeEntities){const n=this.docTypeEntities[t];e=e.replace(n.regx,n.val)}for(let t in this.lastEntities){const n=this.lastEntities[t];e=e.replace(n.regex,n.val)}if(this.options.htmlEntities)for(let t in this.htmlEntities){const n=this.htmlEntities[t];e=e.replace(n.regex,n.val)}e=e.replace(this.ampEntity.regex,this.ampEntity.val)}return e};function Ee(e,t,n,r){return e&&(void 0===r&&(r=0===t.child.length),void 0!==(e=this.parseTextData(e,t.tagname,n,!1,!!t[":@"]&&0!==Object.keys(t[":@"]).length,r))&&""!==e&&t.add(this.options.textNodeName,e),e=""),e}function _e(e,t,n){const r="*."+n;for(const n in e){const o=e[n];if(r===o||t===o)return!0}return!1}function Te(e,t,n,r){const o=e.indexOf(t,n);if(-1===o)throw new Error(r);return o+t.length-1}function Pe(e,t,n,r=">"){const o=function(e,t,n=">"){let r,o="";for(let i=t;i<e.length;i++){let t=e[i];if(r)t===r&&(r="");else if('"'===t||"'"===t)r=t;else if(t===n[0]){if(!n[1])return{data:o,index:i};if(e[i+1]===n[1])return{data:o,index:i}}else"\t"===t&&(t=" ");o+=t}}(e,t+1,r);if(!o)return;let i=o.data;const s=o.index,a=i.search(/\s/);let c=i,l=!0;-1!==a&&(c=i.substring(0,a),i=i.substring(a+1).trimStart());const u=c;if(n){const e=c.indexOf(":");-1!==e&&(c=c.substr(e+1),l=c!==o.data.substr(e+1))}return{tagName:c,tagExp:i,closeIndex:s,attrExpPresent:l,rawTagName:u}}function ke(e,t,n){const r=n;let o=1;for(;n<e.length;n++)if("<"===e[n])if("/"===e[n+1]){const i=Te(e,">",n,`${t} is not closed`);if(e.substring(n+2,i).trim()===t&&(o--,0===o))return{tagContent:e.substring(r,n),i};n=i}else if("?"===e[n+1]){n=Te(e,"?>",n+1,"StopNode is not closed.")}else if("!--"===e.substr(n+1,3)){n=Te(e,"--\x3e",n+3,"StopNode is not closed.")}else if("!["===e.substr(n+1,2)){n=Te(e,"]]>",n,"StopNode is not closed.")-2}else{const r=Pe(e,n,">");if(r){(r&&r.tagName)===t&&"/"!==r.tagExp[r.tagExp.length-1]&&o++,n=r.closeIndex}}}function Ae(e,t,n){if(t&&"string"==typeof e){const t=e.trim();return"true"===t||"false"!==t&&he(e,n)}return void 0!==e?e:""}function Oe(e,t){return Ce(e,t)}function Ce(e,t,n){let r;const o={};for(let i=0;i<e.length;i++){const s=e[i],a=je(s);let c="";if(c=void 0===n?a:n+"."+a,a===t.textNodeName)void 0===r?r=s[a]:r+=""+s[a];else{if(void 0===a)continue;if(s[a]){let e=Ce(s[a],t,c);const n=Le(e,t);s[":@"]?Re(e,s[":@"],c,t):1!==Object.keys(e).length||void 0===e[t.textNodeName]||t.alwaysCreateTextNode?0===Object.keys(e).length&&(t.alwaysCreateTextNode?e[t.textNodeName]="":e=""):e=e[t.textNodeName],void 0!==o[a]&&o.hasOwnProperty(a)?(Array.isArray(o[a])||(o[a]=[o[a]]),o[a].push(e)):t.isArray(a,c,n)?o[a]=[e]:o[a]=e}}}return"string"==typeof r?r.length>0&&(o[t.textNodeName]=r):void 0!==r&&(o[t.textNodeName]=r),o}function je(e){const t=Object.keys(e);for(let e=0;e<t.length;e++){const n=t[e];if(":@"!==n)return n}}function Re(e,t,n,r){if(t){const o=Object.keys(t),i=o.length;for(let s=0;s<i;s++){const i=o[s];r.isArray(i,n+"."+i,!0,!0)?e[i]=[t[i]]:e[i]=t[i]}}}function Le(e,t){const{textNodeName:n}=t,r=Object.keys(e).length;return 0===r||!(1!==r||!e[n]&&"boolean"!=typeof e[n]&&0!==e[n])}function Me(e,t){let n="";return t.format&&t.indentBy.length>0&&(n="\n"),De(e,t,"",n)}function De(e,t,n,r){let o="",i=!1;for(let s=0;s<e.length;s++){const a=e[s],c=$e(a);if(void 0===c)continue;let l="";if(l=0===n.length?c:`${n}.${c}`,c===t.textNodeName){let e=a[c];Ve(l,t)||(e=t.tagValueProcessor(c,e),e=Be(e,t)),i&&(o+=r),o+=e,i=!1;continue}if(c===t.cdataPropName){i&&(o+=r),o+=`<![CDATA[${a[c][0][t.textNodeName]}]]>`,i=!1;continue}if(c===t.commentPropName){o+=r+`\x3c!--${a[c][0][t.textNodeName]}--\x3e`,i=!0;continue}if("?"===c[0]){const e=Fe(a[":@"],t),n="?xml"===c?"":r;let s=a[c][0][t.textNodeName];s=0!==s.length?" "+s:"",o+=n+`<${c}${s}${e}?>`,i=!0;continue}let u=r;""!==u&&(u+=t.indentBy);const d=r+`<${c}${Fe(a[":@"],t)}`,p=De(a[c],t,l,u);-1!==t.unpairedTags.indexOf(c)?t.suppressUnpairedNode?o+=d+">":o+=d+"/>":p&&0!==p.length||!t.suppressEmptyNode?p&&p.endsWith(">")?o+=d+`>${p}${r}</${c}>`:(o+=d+">",p&&""!==r&&(p.includes("/>")||p.includes("</"))?o+=r+t.indentBy+p+r:o+=p,o+=`</${c}>`):o+=d+"/>",i=!0}return o}function $e(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];if(e.hasOwnProperty(r)&&":@"!==r)return r}}function Fe(e,t){let n="";if(e&&!t.ignoreAttributes)for(let r in e){if(!e.hasOwnProperty(r))continue;let o=t.attributeValueProcessor(r,e[r]);o=Be(o,t),!0===o&&t.suppressBooleanAttributes?n+=` ${r.substr(t.attributeNamePrefix.length)}`:n+=` ${r.substr(t.attributeNamePrefix.length)}="${o}"`}return n}function Ve(e,t){let n=(e=e.substr(0,e.length-t.textNodeName.length-1)).substr(e.lastIndexOf(".")+1);for(let r in t.stopNodes)if(t.stopNodes[r]===e||t.stopNodes[r]==="*."+n)return!0;return!1}function Be(e,t){if(e&&e.length>0&&t.processEntities)for(let n=0;n<t.entities.length;n++){const r=t.entities[n];e=e.replace(r.regex,r.val)}return e}const We={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function Ue(e){this.options=Object.assign({},We,e),!0===this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.ignoreAttributesFn=me(this.options.ignoreAttributes),this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=qe),this.processTextOrObjNode=Ge,this.options.format?(this.indentate=Ke,this.tagEndChar=">\n",this.newLine="\n"):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}function Ge(e,t,n,r){const o=this.j2x(e,n+1,r.concat(t));return void 0!==e[this.options.textNodeName]&&1===Object.keys(e).length?this.buildTextValNode(e[this.options.textNodeName],t,o.attrStr,n):this.buildObjectNode(o.val,t,o.attrStr,n)}function Ke(e){return this.options.indentBy.repeat(e)}function qe(e){return!(!e.startsWith(this.options.attributeNamePrefix)||e===this.options.textNodeName)&&e.substr(this.attrPrefixLen)}Ue.prototype.build=function(e){return this.options.preserveOrder?Me(e,this.options):(Array.isArray(e)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(e={[this.options.arrayNodeName]:e}),this.j2x(e,0,[]).val)},Ue.prototype.j2x=function(e,t,n){let r="",o="";const i=n.join(".");for(let s in e)if(Object.prototype.hasOwnProperty.call(e,s))if(void 0===e[s])this.isAttribute(s)&&(o+="");else if(null===e[s])this.isAttribute(s)||s===this.options.cdataPropName?o+="":"?"===s[0]?o+=this.indentate(t)+"<"+s+"?"+this.tagEndChar:o+=this.indentate(t)+"<"+s+"/"+this.tagEndChar;else if(e[s]instanceof Date)o+=this.buildTextValNode(e[s],s,"",t);else if("object"!=typeof e[s]){const n=this.isAttribute(s);if(n&&!this.ignoreAttributesFn(n,i))r+=this.buildAttrPairStr(n,""+e[s]);else if(!n)if(s===this.options.textNodeName){let t=this.options.tagValueProcessor(s,""+e[s]);o+=this.replaceEntitiesValue(t)}else o+=this.buildTextValNode(e[s],s,"",t)}else if(Array.isArray(e[s])){const r=e[s].length;let i="",a="";for(let c=0;c<r;c++){const r=e[s][c];if(void 0===r);else if(null===r)"?"===s[0]?o+=this.indentate(t)+"<"+s+"?"+this.tagEndChar:o+=this.indentate(t)+"<"+s+"/"+this.tagEndChar;else if("object"==typeof r)if(this.options.oneListGroup){const e=this.j2x(r,t+1,n.concat(s));i+=e.val,this.options.attributesGroupName&&r.hasOwnProperty(this.options.attributesGroupName)&&(a+=e.attrStr)}else i+=this.processTextOrObjNode(r,s,t,n);else if(this.options.oneListGroup){let e=this.options.tagValueProcessor(s,r);e=this.replaceEntitiesValue(e),i+=e}else i+=this.buildTextValNode(r,s,"",t)}this.options.oneListGroup&&(i=this.buildObjectNode(i,s,a,t)),o+=i}else if(this.options.attributesGroupName&&s===this.options.attributesGroupName){const t=Object.keys(e[s]),n=t.length;for(let o=0;o<n;o++)r+=this.buildAttrPairStr(t[o],""+e[s][t[o]])}else o+=this.processTextOrObjNode(e[s],s,t,n);return{attrStr:r,val:o}},Ue.prototype.buildAttrPairStr=function(e,t){return t=this.options.attributeValueProcessor(e,""+t),t=this.replaceEntitiesValue(t),this.options.suppressBooleanAttributes&&"true"===t?" "+e:" "+e+'="'+t+'"'},Ue.prototype.buildObjectNode=function(e,t,n,r){if(""===e)return"?"===t[0]?this.indentate(r)+"<"+t+n+"?"+this.tagEndChar:this.indentate(r)+"<"+t+n+this.closeTag(t)+this.tagEndChar;{let o="</"+t+this.tagEndChar,i="";return"?"===t[0]&&(i="?",o=""),!n&&""!==n||-1!==e.indexOf("<")?!1!==this.options.commentPropName&&t===this.options.commentPropName&&0===i.length?this.indentate(r)+`\x3c!--${e}--\x3e`+this.newLine:this.indentate(r)+"<"+t+n+i+this.tagEndChar+e+this.indentate(r)+o:this.indentate(r)+"<"+t+n+i+">"+e+o}},Ue.prototype.closeTag=function(e){let t="";return-1!==this.options.unpairedTags.indexOf(e)?this.options.suppressUnpairedNode||(t="/"):t=this.options.suppressEmptyNode?"/":`></${e}`,t},Ue.prototype.buildTextValNode=function(e,t,n,r){if(!1!==this.options.cdataPropName&&t===this.options.cdataPropName)return this.indentate(r)+`<![CDATA[${e}]]>`+this.newLine;if(!1!==this.options.commentPropName&&t===this.options.commentPropName)return this.indentate(r)+`\x3c!--${e}--\x3e`+this.newLine;if("?"===t[0])return this.indentate(r)+"<"+t+n+"?"+this.tagEndChar;{let o=this.options.tagValueProcessor(t,e);return o=this.replaceEntitiesValue(o),""===o?this.indentate(r)+"<"+t+n+this.closeTag(t)+this.tagEndChar:this.indentate(r)+"<"+t+n+">"+o+"</"+t+this.tagEndChar}},Ue.prototype.replaceEntitiesValue=function(e){if(e&&e.length>0&&this.options.processEntities)for(let t=0;t<this.options.entities.length;t++){const n=this.options.entities[t];e=e.replace(n.regex,n.val)}return e};function Xe(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Ye(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Ye(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,i=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw i}}}}function Ye(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}var He="If you are creating a new entry you should write it like this:\n```xml\n<lorebooks>\n    <entry>\n        <worldName>World 1</worldName>\n        <name>Book 1</name>\n        <triggers>word1,word2</triggers>\n        <content>Content of book 1</content>\n    </entry>\n</lorebooks>\n```\n\nIf you are updating an existing entry you should specify the id of the entry. Like this:\n```xml\n<lorebooks>\n    <entry>\n        <worldName>World 1</worldName>\n        <id>15</id> // Id should be the id of the entry\n        <name>Book 1</name>\n        <triggers>word1,word2</triggers>\n        <content>Content of book 1</content>\n    </entry>\n</lorebooks>\n```\n\n- Don't suggest already existing or suggested entries.",ze=new class{constructor(e){this.externalEntities={},this.options=function(e){return Object.assign({},te,e)}(e)}parse(e,t){if("string"==typeof e);else{if(!e.toString)throw new Error("XML data is accepted in String or Bytes[] form.");e=e.toString()}if(t){!0===t&&(t={});const n=B(e,t);if(!0!==n)throw Error(`${n.err.msg}:${n.err.line}:${n.err.col}`)}const n=new ge(this.options);n.addExternalEntities(this.externalEntities);const r=n.parseXml(e);return this.options.preserveOrder||void 0===r?r:Oe(r,this.options)}addEntity(e,t){if(-1!==t.indexOf("&"))throw new Error("Entity value can't have '&'");if(-1!==e.indexOf("&")||-1!==e.indexOf(";"))throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if("&"===t)throw new Error("An entity with value '&' is not permitted");this.externalEntities[e]=t}};function Ze(e){var t,n,r,o=e.replace(/```xml/g,"").replace(/```/g,""),i={};try{var s,a=ze.parse(o);if(!a.lorebooks)return i;var c,l=Xe(null!==(s=a.lorebooks.entry)&&void 0!==s&&s.content?[a.lorebooks.entry]:a.lorebooks.entry);try{for(l.s();!(c=l.n()).done;){var u,d,p,f=c.value,h=f.worldName;h&&(i[h]||(i[h]=[]),i[h].push({uid:null!==(u=f.id)&&void 0!==u?u:(t=6,n=void 0,r=void 0,n=Math.pow(10,t-1),r=Math.pow(10,t)-1,Math.floor(Math.random()*(r-n+1))+n),key:null!==(d=null===(p=f.triggers)||void 0===p?void 0:p.split(",").map((function(e){return e.trim()})))&&void 0!==d?d:[],content:f.content,comment:f.name}))}}catch(e){l.e(e)}finally{l.f()}return i}catch(e){throw console.error(e),new Error("Model response is not valid XML")}}function Je(e){return Je="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Je(e)}function Qe(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=nt(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,i=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw i}}}}function et(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,i,s,a=[],c=!0,l=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=i.call(n)).done)&&(a.push(r.value),a.length!==t);c=!0);}catch(e){l=!0,o=e}finally{try{if(!c&&null!=n.return&&(s=n.return(),Object(s)!==s))return}finally{if(l)throw o}}return a}}(e,t)||nt(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function tt(e){return function(e){if(Array.isArray(e))return rt(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||nt(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function nt(e,t){if(e){if("string"==typeof e)return rt(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?rt(e,t):void 0}}function rt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function ot(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */ot=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},i="function"==typeof Symbol?Symbol:{},s=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var i=t&&t.prototype instanceof v?t:v,s=Object.create(i.prototype),a=new A(r||[]);return o(s,"_invoke",{value:_(e,n,a)}),s}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var p="suspendedStart",f="suspendedYield",h="executing",m="completed",g={};function v(){}function y(){}function x(){}var b={};l(b,s,(function(){return this}));var w=Object.getPrototypeOf,N=w&&w(w(O([])));N&&N!==n&&r.call(N,s)&&(b=N);var I=x.prototype=v.prototype=Object.create(b);function S(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function E(e,t){function n(o,i,s,a){var c=d(e[o],e,i);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==Je(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,s,a)}),(function(e){n("throw",e,s,a)})):t.resolve(u).then((function(e){l.value=e,s(l)}),(function(e){return n("throw",e,s,a)}))}a(c.arg)}var i;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return i=i?i.then(o,o):o()}})}function _(t,n,r){var o=p;return function(i,s){if(o===h)throw Error("Generator is already running");if(o===m){if("throw"===i)throw s;return{value:e,done:!0}}for(r.method=i,r.arg=s;;){var a=r.delegate;if(a){var c=T(a,r);if(c){if(c===g)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===p)throw o=m,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=h;var l=d(t,n,r);if("normal"===l.type){if(o=r.done?m:f,l.arg===g)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=m,r.method="throw",r.arg=l.arg)}}}function T(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,T(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var i=d(o,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,g;var s=i.arg;return s?s.done?(n[t.resultName]=s.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):s:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function P(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function k(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(P,this),this.reset(!0)}function O(t){if(t||""===t){var n=t[s];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,i=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return i.next=i}}throw new TypeError(Je(t)+" is not iterable")}return y.prototype=x,o(I,"constructor",{value:x,configurable:!0}),o(x,"constructor",{value:y,configurable:!0}),y.displayName=l(x,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,x):(e.__proto__=x,l(e,c,"GeneratorFunction")),e.prototype=Object.create(I),e},t.awrap=function(e){return{__await:e}},S(E.prototype),l(E.prototype,a,(function(){return this})),t.AsyncIterator=E,t.async=function(e,n,r,o,i){void 0===i&&(i=Promise);var s=new E(u(e,n,r,o),i);return t.isGeneratorFunction(n)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},S(I),l(I,c,"Generator"),l(I,s,(function(){return this})),l(I,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=O,A.prototype={constructor:A,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(k),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return a.type="throw",a.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i],a=s.completion;if("root"===s.tryLoc)return o("end");if(s.tryLoc<=this.prev){var c=r.call(s,"catchLoc"),l=r.call(s,"finallyLoc");if(c&&l){if(this.prev<s.catchLoc)return o(s.catchLoc,!0);if(this.prev<s.finallyLoc)return o(s.finallyLoc)}else if(c){if(this.prev<s.catchLoc)return o(s.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return o(s.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=e,s.arg=t,i?(this.method="next",this.next=i.finallyLoc,g):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),k(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;k(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:O(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),g}},t}function it(e,t,n,r,o,i,s){try{var a=e[i](s),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,o)}function st(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function s(e){it(i,r,o,s,a,"next",e)}function a(e){it(i,r,o,s,a,"throw",e)}s(void 0)}))}}var at,ct="SillyTavern-WorldInfo-Recommender",lt=SillyTavern.getContext(),ut={version:"0.1.0",formatVersion:"F_1.0",profileId:"",maxContextType:"profile",maxContextValue:16384,maxResponseToken:1024,contextToSend:{stDescription:!0,messages:{type:"all",first:10,last:10,range:{start:0,end:10}},charCard:!0,authorNote:!0,worldInfo:!0},stWorldInfoPrompt:R,responseRulesPrompt:He},dt=new class{settingsKey;defaultSettings;constructor(e,t){this.settingsKey=e,this.defaultSettings=t}async initializeSettings(e={}){const{strategy:t="recursive"}=e,n=this.defaultSettings.version,r=this.defaultSettings.formatVersion,o=SillyTavern.getContext().extensionSettings[this.settingsKey],i={version:{changed:!1,new:n??""},formatVersion:{changed:!1,new:r??""},oldSettings:null,newSettings:this.defaultSettings};if(!o)return SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings(),i;const s={...i,oldSettings:structuredClone(o),version:{changed:!1,old:o.version,new:o.version},formatVersion:{changed:!1,old:o.formatVersion,new:o.formatVersion}};if("recursive"===t){function a(e,t){let n=!1;for(const r of Object.keys(t))void 0===e[r]?(e[r]=t[r],n=!0):"object"==typeof t[r]&&null!==t[r]&&(e[r]=e[r]||{},a(e[r],t[r])&&(n=!0));return n}n&&o.version!==n&&(s.version.changed=!0,s.version.new=n,o.version=n),r&&o.formatVersion!==r&&(s.formatVersion.changed=!0,s.formatVersion.new=r,o.formatVersion=r),(a(o,this.defaultSettings)||s.version.changed||s.formatVersion.changed)&&this.saveSettings()}else if(Array.isArray(t)){n&&!o.version&&(o.version=n,s.version.changed=!0,s.version.new=n),r&&!o.formatVersion&&(o.formatVersion=r,s.formatVersion.changed=!0,s.formatVersion.new=r);let c=structuredClone(o),l=o.formatVersion;try{for(const u of t)if(l===u.from){c=await u.action(c),l=u.to,c.formatVersion=u.to;const d=this.defaultSettings.version;d&&(c.version=d),s.formatVersion.changed=!0,s.formatVersion.new=u.to}if(s.formatVersion.changed){Object.assign(o,c);for(const p of Object.keys(o))Object.keys(c).includes(p)||delete o[p];this.saveSettings()}}catch(f){throw console.error("Failed to apply version changes:",f),new Error(`Version migration failed: ${f instanceof Error?f.message:f}`,{cause:f})}}return s.newSettings=o,s}getSettings(){return SillyTavern.getContext().extensionSettings[this.settingsKey]}updateSetting(e,t){SillyTavern.getContext().extensionSettings[this.settingsKey][e]=t,this.saveSettings()}saveSettings(){SillyTavern.getContext().saveSettingsDebounced()}resetSettings(){SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings()}}("worldInfoRecommender",ut);function pt(){return pt=st(ot().mark((function e(){var t,n,r,o,i,s,a;return ot().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,lt.renderExtensionTemplateAsync("third-party/".concat(ct),"templates/settings");case 2:t=e.sent,$("#extensions_settings").append(t),n=$(".worldInfoRecommender_settings"),r=dt.getSettings(),o=n.find(".stWorldInfoPrompt"),i=o.find("textarea"),s=n.find(".responseRulesPrompt"),a=s.find("textarea"),i.val(r.stWorldInfoPrompt),a.val(r.responseRulesPrompt),o.find(".restore_default").on("click",st(ot().mark((function e(){return ot().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,lt.Popup.show.confirm("Are you sure you want to restore the default ST/World Info description?","World Info Recommender");case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:i.val(R),i.trigger("change");case 7:case"end":return e.stop()}}),e)})))),s.find(".restore_default").on("click",st(ot().mark((function e(){return ot().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,lt.Popup.show.confirm("Are you sure you want to restore the default response rules?","World Info Recommender");case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:a.val(He),a.trigger("change");case 7:case"end":return e.stop()}}),e)})))),i.on("change",(function(){var e;r.stWorldInfoPrompt=null!==(e=i.val())&&void 0!==e?e:"",dt.saveSettings()})),a.on("change",(function(){var e;r.responseRulesPrompt=null!==(e=a.val())&&void 0!==e?e:"",dt.saveSettings()})),at=$('<div class="menu_button fa-brands fa-wpexplorer interactable" title="World Info Recommender"></div>'),$(".form_create_bottom_buttons_block").prepend(at),at.on("click",st(ot().mark((function e(){var t,n,o,i,s,a,c,l,u,p,m,g,v,y,b,w,I,S,E,_,T,P,k,j,R,L,M,D,F,V,B,W;return ot().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return R=function(e){switch(S.hide(),E.hide(),_.hide(),e){case"first":S.show();break;case"last":E.show();break;case"range":_.show()}},e.next=3,lt.renderExtensionTemplateAsync("third-party/".concat(ct),"templates/popup");case 3:return c=e.sent,lt.callGenericPopup(c,C.DISPLAY,void 0,{large:!0,wide:!0}),l=$("#worldInfoRecommenderPopup"),lt.ConnectionManagerRequestService.handleDropdown("#worldInfoRecommenderPopup #worldInfoRecommend_connectionProfile",r.profileId,(function(e){var t;r.profileId=null!==(t=null==e?void 0:e.id)&&void 0!==t?t:"",dt.saveSettings()})),u=l.find("#worldInfoRecommend_stDescription"),p=l.find(".message-options"),m=l.find("#worldInfoRecommend_charCard"),g=l.find("#worldInfoRecommend_authorNote"),v=l.find("#worldInfoRecommend_worldInfo"),u.prop("checked",r.contextToSend.stDescription),m.prop("checked",r.contextToSend.charCard),g.prop("checked",r.contextToSend.authorNote),v.prop("checked",r.contextToSend.worldInfo),e.next=18,O(["all"],f.this_chid);case 18:y=e.sent,0===(b=Object.keys(y)).length&&N("warning","No active World Info entries found."),w=structuredClone(b),d("#worldInfoRecommend_worldInfoContainer",{label:"World Info",initialList:b,initialValues:w,onSelectChange:function(e,t){w=t}}),I=p.find("#messageType"),S=p.find("#firstX"),E=p.find("#lastX"),_=p.find("#rangeX"),T=p.find("#firstXMessages"),P=p.find("#lastXMessages"),k=p.find("#rangeStart"),j=p.find("#rangeEnd"),I.val(r.contextToSend.messages.type),T.val(null!==(t=r.contextToSend.messages.first)&&void 0!==t?t:10),P.val(null!==(n=r.contextToSend.messages.last)&&void 0!==n?n:10),k.val(null!==(o=null===(i=r.contextToSend.messages.range)||void 0===i?void 0:i.start)&&void 0!==o?o:0),j.val(null!==(s=null===(a=r.contextToSend.messages.range)||void 0===a?void 0:a.end)&&void 0!==s?s:10),R(r.contextToSend.messages.type),u.on("change",(function(){r.contextToSend.stDescription=u.prop("checked"),dt.saveSettings()})),m.on("change",(function(){r.contextToSend.charCard=m.prop("checked"),dt.saveSettings()})),g.on("change",(function(){r.contextToSend.authorNote=g.prop("checked"),dt.saveSettings()})),v.on("change",(function(){r.contextToSend.worldInfo=v.prop("checked"),dt.saveSettings()})),I.on("change",(function(){var e=I.val();r.contextToSend.messages.type=e,dt.saveSettings(),R(e)})),T.on("change",(function(){r.contextToSend.messages.first=parseInt(T.val())||10,dt.saveSettings()})),P.on("change",(function(){r.contextToSend.messages.last=parseInt(P.val())||10,dt.saveSettings()})),k.on("change",(function(){r.contextToSend.messages.range||(r.contextToSend.messages.range={start:0,end:10}),r.contextToSend.messages.range.start=parseInt(k.val())||0,dt.saveSettings()})),j.on("change",(function(){r.contextToSend.messages.range||(r.contextToSend.messages.range={start:0,end:10}),r.contextToSend.messages.range.end=parseInt(j.val())||10,dt.saveSettings()})),L=l.find("#worldInfoRecommend_maxContextType"),M=l.find("#worldInfoRecommend_maxTokens_container"),L.val(r.maxContextType),M.css("display","custom"===r.maxContextType?"block":"none"),L.on("change",(function(){var e=L.val();r.maxContextType=e,dt.saveSettings(),"custom"===e?M.show():M.hide()})),(D=l.find("#worldInfoRecommend_maxTokens")).val(r.maxContextValue),D.on("change",(function(){var e=Number(D.val());r.maxContextValue=e,dt.saveSettings()})),(F=l.find("#worldInfoRecommend_maxResponseTokens")).val(r.maxResponseToken),F.on("change",(function(){var e=Number(F.val());r.maxResponseToken=e,dt.saveSettings()})),V={},B=[],(W=l.find("#worldInfoRecommend_sendPrompt")).on("click",st(ot().mark((function e(){var t,n,o,i,s,a,c,u,d,p,f,m,g,v,I,S,E,_,T,P,k,O;return ot().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,i=function(e,t){var n=e.data("world-name"),r=e.data("id"),o=e.data("comment");e&&n&&null!=r&&o?(t&&B.push("".concat(n," (").concat(o,")")),V[n]=V[n].filter((function(e){return e.uid!==parseInt(r)})),e.remove()):n||N("warning","Selected entry is missing world name")},W.prop("disabled",!0),r.profileId){e.next=5;break}return e.abrupt("return");case 5:if(s=SillyTavern.getContext(),a=null===(o=s.extensionSettings.connectionManager)||void 0===o||null===(o=o.profiles)||void 0===o?void 0:o.find((function(e){return e.id===r.profileId}))){e.next=9;break}return e.abrupt("return");case 9:if(c=l.find("#worldInfoRecommend_prompt").val()){e.next=12;break}return e.abrupt("return");case 12:if(c=lt.substituteParams(c.trim())){e.next=15;break}return e.abrupt("return");case 15:if(u=[],d=a.api?lt.CONNECT_API_MAP[a.api].selected:void 0){e.next=19;break}return e.abrupt("return");case 19:p={presetName:a.preset,contextName:a.context,instructName:a.instruct,syspromptName:a.sysprompt,ignoreCharacterFields:!r.contextToSend.charCard,ignoreWorldInfo:!0,ignoreAuthorNote:!r.contextToSend.authorNote,maxContext:"custom"===r.maxContextType?r.maxContextValue:"profile"===r.maxContextType?"preset":"active",includeNames:!!x.selected_group},e.t0=r.contextToSend.messages.type,e.next="none"===e.t0?23:"first"===e.t0?25:"last"===e.t0?27:"range"===e.t0?30:(e.t0,32);break;case 23:return p.messageIndexesBetween={start:-1,end:-1},e.abrupt("break",33);case 25:return p.messageIndexesBetween={start:0,end:null!==(t=r.contextToSend.messages.first)&&void 0!==t?t:10},e.abrupt("break",33);case 27:return f=null!==(n=r.contextToSend.messages.last)&&void 0!==n?n:10,p.messageIndexesBetween={end:s.chat.length-1,start:s.chat.length-f},e.abrupt("break",33);case 30:return r.contextToSend.messages.range&&(p.messageIndexesBetween={start:r.contextToSend.messages.range.start,end:r.contextToSend.messages.range.end}),e.abrupt("break",33);case 32:return e.abrupt("break",33);case 33:return e.t1=u.push,e.t2=u,e.t3=tt,e.next=38,A(d,p);case 38:return e.t4=e.sent,e.t5=(0,e.t3)(e.t4),e.t1.apply.call(e.t1,e.t2,e.t5),r.contextToSend.stDescription&&u.push({role:"system",content:r.stWorldInfoPrompt}),r.contextToSend.worldInfo&&b.length>0&&(m="",Object.entries(y).forEach((function(e){var t=et(e,2),n=t[0],r=t[1];w.includes(n)&&r.length>0&&(m+="# WORLD NAME: ".concat(n,"\n"),r.forEach((function(e){m+="## (NAME: ".concat(e.comment,") (ID: ").concat(e.uid,")\n"),m+="Triggers: ".concat(e.key.join(", "),"\n"),m+="Content: ".concat(e.content,"\n\n")})),m+="\n\n")})),m&&u.push({role:"assistant",content:"=== CURRENT LOREBOOKS ===\n".concat(m)})),B.length>0&&(g="# Blacklisted Entries:\n",B.forEach((function(e){g+="- ".concat(e,"\n")})),u.push({role:"system",content:g})),Object.keys(V).length>0&&(v=Object.values(V).some((function(e){return e.length>0})),v&&(I="# Already suggested entries:\n",Object.entries(V).forEach((function(e){var t=et(e,2),n=t[0],r=t[1];r.length>0&&(I+="## WORLD NAME: ".concat(n,"\n"),r.forEach((function(e){I+="- (NAME: ".concat(e.comment,") (ID: ").concat(e.uid,")\n"),I+="Triggers: ".concat(e.key.join(", "),"\n"),I+="Content: ".concat(e.content,"\n\n")})))})),u.push({role:"system",content:I}))),S="".concat(r.responseRulesPrompt,"\n\n").concat(c),u.push({role:"user",content:S}),e.next=49,lt.ConnectionManagerRequestService.sendRequest(a.id,u,r.maxResponseToken);case 49:if(E=e.sent,_=Ze(E.content),0!==Object.keys(_).length){e.next=54;break}return N("warning","No entries in response"),e.abrupt("return");case 54:if(Object.entries(_).forEach((function(e){var t=et(e,2),n=t[0],r=t[1];y[n]&&r.forEach((function(e){var t,r=null===(t=y[n])||void 0===t?void 0:t.find((function(t){return t.uid===e.uid}));r&&(0===e.key.length&&(e.key=r.key),e.comment||(e.comment=r.comment))}))})),T=l.find("#worldInfoRecommend_suggestedEntries"),P=l.find("#worldInfoRecommend_entryTemplate")){e.next=59;break}return e.abrupt("return");case 59:k=null,Object.entries(_).forEach((function(e){var t=et(e,2),n=t[0];t[1].forEach((function(e){var t=n,r=b.indexOf(t);-1===r&&(t=k||(b.length>0?b[0]:"")),r=b.indexOf(t),V[n]||(V[n]=[]);var o,i=V[n].find((function(t){return t.uid===e.uid&&t.comment===e.comment}));if(i){var s='.entry[data-id="'.concat(e.uid,'"][data-world-name="').concat(n,'"]');o=T.find(s)}else o=$(P.html());if(o.attr("data-world-name",n),o.attr("data-id",e.uid.toString()),o.attr("data-comment",e.comment),t){var a,c=null===(a=y[t])||void 0===a?void 0:a.find((function(t){return t.uid===e.uid}));o.find(".add").text(c?"Update":"Add")}var l=o.find(".world-select");l.empty(),b.forEach((function(e,t){var n=document.createElement("option");n.value=t.toString(),n.text=e,l.append(n)})),-1!==r&&l.val(r.toString()),l.on("change",(function(){var t,n=parseInt($(this).val());if(!(isNaN(n)||n<0||n>=b.length)){var r=b[n],i=null===(t=y[r])||void 0===t?void 0:t.find((function(t){return t.uid===e.uid&&t.comment===e.comment}));o.find(".add").text(i?"Update":"Add")}})),o.find(".comment").text(e.comment),o.find(".key").text(e.key.join(", ")),o.find(".content").text(e.content),i?(i.key=e.key,i.content=e.content,i.comment=e.comment):(V[n].push(e),T.append(o))}))})),T.find(".blacklist").on("click",(function(e){var t=$(e.currentTarget).closest(".entry");t&&i(t,!0)})),T.find(".remove").on("click",(function(e){var t=$(e.currentTarget).closest(".entry");t&&i(t,!1)})),(O=T.find(".add")).on("click",function(){var e=st(ot().mark((function e(t){var n,r,o,s,a,c,l,u,d,p,f,m,g,v,x,w,I,S;return ot().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,O.prop("disabled",!0),r=$(t.currentTarget).closest(".entry")){e.next=5;break}return e.abrupt("return");case 5:if(o=r.data("world-name"),s=r.data("id"),a=r.data("comment"),r&&o&&null!=s&&a){e.next=11;break}return o||N("warning","Selected entry is missing world name"),e.abrupt("return");case 11:if(c=structuredClone(V[o].find((function(e){return e.uid===parseInt(s)}))),c){e.next=14;break}return e.abrupt("return");case 14:if(l=r.find(".world-select"),u=parseInt(l.val()),!(isNaN(u)||u<0||u>=b.length)){e.next=19;break}return N("warning","Please select a valid world"),e.abrupt("return");case 19:o=b[u],k=o,d=null===(n=y[o])||void 0===n?void 0:n.find((function(e){return e.uid===c.uid})),i(r,!1),p={entries:{}},f=Qe(y[o]);try{for(f.s();!(m=f.n()).done;)g=m.value,p.entries[g.uid]=g}catch(e){f.e(e)}finally{f.f()}if(!(x=!!d)){e.next=31;break}v=d,e.next=40;break;case 31:if(w=Object.values(p.entries),I=w.length>0?w[w.length-1]:void 0,E=o,_=p,v=(0,h.createWorldInfoEntry)(E,_)){e.next=37;break}return N("error","Failed to create entry"),e.abrupt("return");case 37:S=v.uid,I&&Object.assign(v,I),v.uid=S;case 40:return v.key=c.key,v.content=c.content,v.comment=c.comment,e.next=45,lt.saveWorldInfo(o,p);case 45:y[o]=Object.values(p.entries),lt.reloadWorldInfoEditor(o,!0),N("success",x?"Entry updated":"Entry added"),e.next=54;break;case 50:e.prev=50,e.t0=e.catch(0),console.error(e.t0),N("error",e.t0 instanceof Error?e.t0.message:e.t0);case 54:return e.prev=54,O.prop("disabled",!1),e.finish(54);case 57:case"end":return e.stop()}var E,_}),e,null,[[0,50,54,57]])})));return function(t){return e.apply(this,arguments)}}()),e.next=71;break;case 67:e.prev=67,e.t6=e.catch(0),console.error(e.t6),N("error",e.t6 instanceof Error?e.t6.message:e.t6);case 71:return e.prev=71,W.prop("disabled",!1),e.finish(71);case 74:case"end":return e.stop()}}),e,null,[[0,67,71,74]])}))));case 61:case"end":return e.stop()}}),e)}))));case 20:case"end":return e.stop()}}),e)}))),pt.apply(this,arguments)}function ft(){var e;!function(){pt.apply(this,arguments)}(),lt.SlashCommandParser.addCommandObject(lt.SlashCommand.fromProps({name:"world-info-recommender-popup-open",helpString:"Open World Info Recommender popup",unnamedArgumentList:[],callback:(e=st(ot().mark((function e(t,n){return ot().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!at){e.next=3;break}return at.trigger("click"),e.abrupt("return",!0);case 3:return e.abrupt("return",!1);case 4:case"end":return e.stop()}}),e)}))),function(t,n){return e.apply(this,arguments)}),returns:lt.ARGUMENT_TYPE.BOOLEAN}))}if(lt.ConnectionManagerRequestService&&lt.getCharacterCardFields&&lt.getWorldInfoPrompt&&lt.reloadWorldInfoEditor)dt.initializeSettings().then((function(e){ft()})).catch((function(e){N("error",e),lt.Popup.show.confirm("Data migration failed. Do you want to reset the World Info Recommender data?","World Info Recommender").then((function(e){e&&(dt.resetSettings(),ft())}))}));else{N("error","[World Info Recommender Error] Make sure you are on staging branch and staging is updated.")}