import*as e from"../../../../power-user.js";import*as t from"../../../../../script.js";import*as r from"../../../../world-info.js";import*as n from"../../../../instruct-mode.js";import*as o from"../../../../chats.js";import*as a from"../../../../openai.js";import*as i from"../../../../authors-note.js";import*as s from"../../../../group-chats.js";import*as c from"../../../regex/engine.js";import*as l from"../../../../utils.js";import*as u from"../../../../slash-commands/SlashCommandCommonEnumsProvider.js";import*as d from"../../../../../lib.js";var p={552:function(e,t,r){var n;/*! showdown v 2.1.0 - 21-04-2022 */
(function(){function o(e){var t={omitExtraWLInCodeBlocks:{defaultValue:!1,describe:"Omit the default extra whiteline added to code blocks",type:"boolean"},noHeaderId:{defaultValue:!1,describe:"Turn on/off generated header id",type:"boolean"},prefixHeaderId:{defaultValue:!1,describe:"Add a prefix to the generated header ids. Passing a string will prefix that string to the header id. Setting to true will add a generic 'section-' prefix",type:"string"},rawPrefixHeaderId:{defaultValue:!1,describe:'Setting this option to true will prevent showdown from modifying the prefix. This might result in malformed IDs (if, for instance, the " char is used in the prefix)',type:"boolean"},ghCompatibleHeaderId:{defaultValue:!1,describe:"Generate header ids compatible with github style (spaces are replaced with dashes, a bunch of non alphanumeric chars are removed)",type:"boolean"},rawHeaderId:{defaultValue:!1,describe:"Remove only spaces, ' and \" from generated header ids (including prefixes), replacing them with dashes (-). WARNING: This might result in malformed ids",type:"boolean"},headerLevelStart:{defaultValue:!1,describe:"The header blocks level start",type:"integer"},parseImgDimensions:{defaultValue:!1,describe:"Turn on/off image dimension parsing",type:"boolean"},simplifiedAutoLink:{defaultValue:!1,describe:"Turn on/off GFM autolink style",type:"boolean"},excludeTrailingPunctuationFromURLs:{defaultValue:!1,describe:"Excludes trailing punctuation from links generated with autoLinking",type:"boolean"},literalMidWordUnderscores:{defaultValue:!1,describe:"Parse midword underscores as literal underscores",type:"boolean"},literalMidWordAsterisks:{defaultValue:!1,describe:"Parse midword asterisks as literal asterisks",type:"boolean"},strikethrough:{defaultValue:!1,describe:"Turn on/off strikethrough support",type:"boolean"},tables:{defaultValue:!1,describe:"Turn on/off tables support",type:"boolean"},tablesHeaderId:{defaultValue:!1,describe:"Add an id to table headers",type:"boolean"},ghCodeBlocks:{defaultValue:!0,describe:"Turn on/off GFM fenced code blocks support",type:"boolean"},tasklists:{defaultValue:!1,describe:"Turn on/off GFM tasklist support",type:"boolean"},smoothLivePreview:{defaultValue:!1,describe:"Prevents weird effects in live previews due to incomplete input",type:"boolean"},smartIndentationFix:{defaultValue:!1,describe:"Tries to smartly fix indentation in es6 strings",type:"boolean"},disableForced4SpacesIndentedSublists:{defaultValue:!1,describe:"Disables the requirement of indenting nested sublists by 4 spaces",type:"boolean"},simpleLineBreaks:{defaultValue:!1,describe:"Parses simple line breaks as <br> (GFM Style)",type:"boolean"},requireSpaceBeforeHeadingText:{defaultValue:!1,describe:"Makes adding a space between `#` and the header text mandatory (GFM Style)",type:"boolean"},ghMentions:{defaultValue:!1,describe:"Enables github @mentions",type:"boolean"},ghMentionsLink:{defaultValue:"https://github.com/{u}",describe:"Changes the link generated by @mentions. Only applies if ghMentions option is enabled.",type:"string"},encodeEmails:{defaultValue:!0,describe:"Encode e-mail addresses through the use of Character Entities, transforming ASCII e-mail addresses into its equivalent decimal entities",type:"boolean"},openLinksInNewWindow:{defaultValue:!1,describe:"Open all links in new windows",type:"boolean"},backslashEscapesHTMLTags:{defaultValue:!1,describe:"Support for HTML Tag escaping. ex: <div>foo</div>",type:"boolean"},emoji:{defaultValue:!1,describe:"Enable emoji support. Ex: `this is a :smile: emoji`",type:"boolean"},underline:{defaultValue:!1,describe:"Enable support for underline. Syntax is double or triple underscores: `__underline word__`. With this option enabled, underscores no longer parses into `<em>` and `<strong>`",type:"boolean"},ellipsis:{defaultValue:!0,describe:"Replaces three dots with the ellipsis unicode character",type:"boolean"},completeHTMLDocument:{defaultValue:!1,describe:"Outputs a complete html document, including `<html>`, `<head>` and `<body>` tags",type:"boolean"},metadata:{defaultValue:!1,describe:"Enable support for document metadata (defined at the top of the document between `«««` and `»»»` or between `---` and `---`).",type:"boolean"},splitAdjacentBlockquotes:{defaultValue:!1,describe:"Split adjacent blockquote blocks",type:"boolean"}};if(!1===e)return JSON.parse(JSON.stringify(t));var r={};for(var n in t)t.hasOwnProperty(n)&&(r[n]=t[n].defaultValue);return r}var a={},i={},s={},c=o(!0),l="vanilla",u={github:{omitExtraWLInCodeBlocks:!0,simplifiedAutoLink:!0,excludeTrailingPunctuationFromURLs:!0,literalMidWordUnderscores:!0,strikethrough:!0,tables:!0,tablesHeaderId:!0,ghCodeBlocks:!0,tasklists:!0,disableForced4SpacesIndentedSublists:!0,simpleLineBreaks:!0,requireSpaceBeforeHeadingText:!0,ghCompatibleHeaderId:!0,ghMentions:!0,backslashEscapesHTMLTags:!0,emoji:!0,splitAdjacentBlockquotes:!0},original:{noHeaderId:!0,ghCodeBlocks:!1},ghost:{omitExtraWLInCodeBlocks:!0,parseImgDimensions:!0,simplifiedAutoLink:!0,excludeTrailingPunctuationFromURLs:!0,literalMidWordUnderscores:!0,strikethrough:!0,tables:!0,tablesHeaderId:!0,ghCodeBlocks:!0,tasklists:!0,smoothLivePreview:!0,simpleLineBreaks:!0,requireSpaceBeforeHeadingText:!0,ghMentions:!1,encodeEmails:!0},vanilla:o(!0),allOn:function(){var e=o(!0),t={};for(var r in e)e.hasOwnProperty(r)&&(t[r]=!0);return t}()};function d(e,t){var r=t?"Error in "+t+" extension->":"Error in unnamed extension",n={valid:!0,error:""};a.helper.isArray(e)||(e=[e]);for(var o=0;o<e.length;++o){var i=r+" sub-extension "+o+": ",s=e[o];if("object"!=typeof s)return n.valid=!1,n.error=i+"must be an object, but "+typeof s+" given",n;if(!a.helper.isString(s.type))return n.valid=!1,n.error=i+'property "type" must be a string, but '+typeof s.type+" given",n;var c=s.type=s.type.toLowerCase();if("language"===c&&(c=s.type="lang"),"html"===c&&(c=s.type="output"),"lang"!==c&&"output"!==c&&"listener"!==c)return n.valid=!1,n.error=i+"type "+c+' is not recognized. Valid values: "lang/language", "output/html" or "listener"',n;if("listener"===c){if(a.helper.isUndefined(s.listeners))return n.valid=!1,n.error=i+'. Extensions of type "listener" must have a property called "listeners"',n}else if(a.helper.isUndefined(s.filter)&&a.helper.isUndefined(s.regex))return n.valid=!1,n.error=i+c+' extensions must define either a "regex" property or a "filter" method',n;if(s.listeners){if("object"!=typeof s.listeners)return n.valid=!1,n.error=i+'"listeners" property must be an object but '+typeof s.listeners+" given",n;for(var l in s.listeners)if(s.listeners.hasOwnProperty(l)&&"function"!=typeof s.listeners[l])return n.valid=!1,n.error=i+'"listeners" property must be an hash of [event name]: [callback]. listeners.'+l+" must be a function but "+typeof s.listeners[l]+" given",n}if(s.filter){if("function"!=typeof s.filter)return n.valid=!1,n.error=i+'"filter" must be a function, but '+typeof s.filter+" given",n}else if(s.regex){if(a.helper.isString(s.regex)&&(s.regex=new RegExp(s.regex,"g")),!(s.regex instanceof RegExp))return n.valid=!1,n.error=i+'"regex" property must either be a string or a RegExp object, but '+typeof s.regex+" given",n;if(a.helper.isUndefined(s.replace))return n.valid=!1,n.error=i+'"regex" extensions must implement a replace string or function',n}}return n}function p(e,t){return"¨E"+t.charCodeAt(0)+"E"}a.helper={},a.extensions={},a.setOption=function(e,t){return c[e]=t,this},a.getOption=function(e){return c[e]},a.getOptions=function(){return c},a.resetOptions=function(){c=o(!0)},a.setFlavor=function(e){if(!u.hasOwnProperty(e))throw Error(e+" flavor was not found");a.resetOptions();var t=u[e];for(var r in l=e,t)t.hasOwnProperty(r)&&(c[r]=t[r])},a.getFlavor=function(){return l},a.getFlavorOptions=function(e){if(u.hasOwnProperty(e))return u[e]},a.getDefaultOptions=function(e){return o(e)},a.subParser=function(e,t){if(a.helper.isString(e)){if(void 0===t){if(i.hasOwnProperty(e))return i[e];throw Error("SubParser named "+e+" not registered!")}i[e]=t}},a.extension=function(e,t){if(!a.helper.isString(e))throw Error("Extension 'name' must be a string");if(e=a.helper.stdExtName(e),a.helper.isUndefined(t)){if(!s.hasOwnProperty(e))throw Error("Extension named "+e+" is not registered!");return s[e]}"function"==typeof t&&(t=t()),a.helper.isArray(t)||(t=[t]);var r=d(t,e);if(!r.valid)throw Error(r.error);s[e]=t},a.getAllExtensions=function(){return s},a.removeExtension=function(e){delete s[e]},a.resetExtensions=function(){s={}},a.validateExtension=function(e){var t=d(e,null);return!!t.valid||(console.warn(t.error),!1)},a.hasOwnProperty("helper")||(a.helper={}),a.helper.isString=function(e){return"string"==typeof e||e instanceof String},a.helper.isFunction=function(e){return e&&"[object Function]"==={}.toString.call(e)},a.helper.isArray=function(e){return Array.isArray(e)},a.helper.isUndefined=function(e){return void 0===e},a.helper.forEach=function(e,t){if(a.helper.isUndefined(e))throw new Error("obj param is required");if(a.helper.isUndefined(t))throw new Error("callback param is required");if(!a.helper.isFunction(t))throw new Error("callback param must be a function/closure");if("function"==typeof e.forEach)e.forEach(t);else if(a.helper.isArray(e))for(var r=0;r<e.length;r++)t(e[r],r,e);else{if("object"!=typeof e)throw new Error("obj does not seem to be an array or an iterable object");for(var n in e)e.hasOwnProperty(n)&&t(e[n],n,e)}},a.helper.stdExtName=function(e){return e.replace(/[_?*+\/\\.^-]/g,"").replace(/\s/g,"").toLowerCase()},a.helper.escapeCharactersCallback=p,a.helper.escapeCharacters=function(e,t,r){var n="(["+t.replace(/([\[\]\\])/g,"\\$1")+"])";r&&(n="\\\\"+n);var o=new RegExp(n,"g");return e=e.replace(o,p)},a.helper.unescapeHTMLEntities=function(e){return e.replace(/&quot;/g,'"').replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")};var h=function(e,t,r,n){var o,a,i,s,c,l=n||"",u=l.indexOf("g")>-1,d=new RegExp(t+"|"+r,"g"+l.replace(/g/g,"")),p=new RegExp(t,l.replace(/g/g,"")),h=[];do{for(o=0;i=d.exec(e);)if(p.test(i[0]))o++||(s=(a=d.lastIndex)-i[0].length);else if(o&&! --o){c=i.index+i[0].length;var f={left:{start:s,end:a},match:{start:a,end:i.index},right:{start:i.index,end:c},wholeMatch:{start:s,end:c}};if(h.push(f),!u)return h}}while(o&&(d.lastIndex=a));return h};a.helper.matchRecursiveRegExp=function(e,t,r,n){for(var o=h(e,t,r,n),a=[],i=0;i<o.length;++i)a.push([e.slice(o[i].wholeMatch.start,o[i].wholeMatch.end),e.slice(o[i].match.start,o[i].match.end),e.slice(o[i].left.start,o[i].left.end),e.slice(o[i].right.start,o[i].right.end)]);return a},a.helper.replaceRecursiveRegExp=function(e,t,r,n,o){if(!a.helper.isFunction(t)){var i=t;t=function(){return i}}var s=h(e,r,n,o),c=e,l=s.length;if(l>0){var u=[];0!==s[0].wholeMatch.start&&u.push(e.slice(0,s[0].wholeMatch.start));for(var d=0;d<l;++d)u.push(t(e.slice(s[d].wholeMatch.start,s[d].wholeMatch.end),e.slice(s[d].match.start,s[d].match.end),e.slice(s[d].left.start,s[d].left.end),e.slice(s[d].right.start,s[d].right.end))),d<l-1&&u.push(e.slice(s[d].wholeMatch.end,s[d+1].wholeMatch.start));s[l-1].wholeMatch.end<e.length&&u.push(e.slice(s[l-1].wholeMatch.end)),c=u.join("")}return c},a.helper.regexIndexOf=function(e,t,r){if(!a.helper.isString(e))throw"InvalidArgumentError: first parameter of showdown.helper.regexIndexOf function must be a string";if(t instanceof RegExp==!1)throw"InvalidArgumentError: second parameter of showdown.helper.regexIndexOf function must be an instance of RegExp";var n=e.substring(r||0).search(t);return n>=0?n+(r||0):n},a.helper.splitAtIndex=function(e,t){if(!a.helper.isString(e))throw"InvalidArgumentError: first parameter of showdown.helper.regexIndexOf function must be a string";return[e.substring(0,t),e.substring(t)]},a.helper.encodeEmailAddress=function(e){var t=[function(e){return"&#"+e.charCodeAt(0)+";"},function(e){return"&#x"+e.charCodeAt(0).toString(16)+";"},function(e){return e}];return e=e.replace(/./g,(function(e){if("@"===e)e=t[Math.floor(2*Math.random())](e);else{var r=Math.random();e=r>.9?t[2](e):r>.45?t[1](e):t[0](e)}return e}))},a.helper.padEnd=function(e,t,r){return t|=0,r=String(r||" "),e.length>t?String(e):((t-=e.length)>r.length&&(r+=r.repeat(t/r.length)),String(e)+r.slice(0,t))},"undefined"==typeof console&&(console={warn:function(e){alert(e)},log:function(e){alert(e)},error:function(e){throw e}}),a.helper.regexes={asteriskDashAndColon:/([*_:~])/g},a.helper.emojis={"+1":"👍","-1":"👎",100:"💯",1234:"🔢","1st_place_medal":"🥇","2nd_place_medal":"🥈","3rd_place_medal":"🥉","8ball":"🎱",a:"🅰️",ab:"🆎",abc:"🔤",abcd:"🔡",accept:"🉑",aerial_tramway:"🚡",airplane:"✈️",alarm_clock:"⏰",alembic:"⚗️",alien:"👽",ambulance:"🚑",amphora:"🏺",anchor:"⚓️",angel:"👼",anger:"💢",angry:"😠",anguished:"😧",ant:"🐜",apple:"🍎",aquarius:"♒️",aries:"♈️",arrow_backward:"◀️",arrow_double_down:"⏬",arrow_double_up:"⏫",arrow_down:"⬇️",arrow_down_small:"🔽",arrow_forward:"▶️",arrow_heading_down:"⤵️",arrow_heading_up:"⤴️",arrow_left:"⬅️",arrow_lower_left:"↙️",arrow_lower_right:"↘️",arrow_right:"➡️",arrow_right_hook:"↪️",arrow_up:"⬆️",arrow_up_down:"↕️",arrow_up_small:"🔼",arrow_upper_left:"↖️",arrow_upper_right:"↗️",arrows_clockwise:"🔃",arrows_counterclockwise:"🔄",art:"🎨",articulated_lorry:"🚛",artificial_satellite:"🛰",astonished:"😲",athletic_shoe:"👟",atm:"🏧",atom_symbol:"⚛️",avocado:"🥑",b:"🅱️",baby:"👶",baby_bottle:"🍼",baby_chick:"🐤",baby_symbol:"🚼",back:"🔙",bacon:"🥓",badminton:"🏸",baggage_claim:"🛄",baguette_bread:"🥖",balance_scale:"⚖️",balloon:"🎈",ballot_box:"🗳",ballot_box_with_check:"☑️",bamboo:"🎍",banana:"🍌",bangbang:"‼️",bank:"🏦",bar_chart:"📊",barber:"💈",baseball:"⚾️",basketball:"🏀",basketball_man:"⛹️",basketball_woman:"⛹️&zwj;♀️",bat:"🦇",bath:"🛀",bathtub:"🛁",battery:"🔋",beach_umbrella:"🏖",bear:"🐻",bed:"🛏",bee:"🐝",beer:"🍺",beers:"🍻",beetle:"🐞",beginner:"🔰",bell:"🔔",bellhop_bell:"🛎",bento:"🍱",biking_man:"🚴",bike:"🚲",biking_woman:"🚴&zwj;♀️",bikini:"👙",biohazard:"☣️",bird:"🐦",birthday:"🎂",black_circle:"⚫️",black_flag:"🏴",black_heart:"🖤",black_joker:"🃏",black_large_square:"⬛️",black_medium_small_square:"◾️",black_medium_square:"◼️",black_nib:"✒️",black_small_square:"▪️",black_square_button:"🔲",blonde_man:"👱",blonde_woman:"👱&zwj;♀️",blossom:"🌼",blowfish:"🐡",blue_book:"📘",blue_car:"🚙",blue_heart:"💙",blush:"😊",boar:"🐗",boat:"⛵️",bomb:"💣",book:"📖",bookmark:"🔖",bookmark_tabs:"📑",books:"📚",boom:"💥",boot:"👢",bouquet:"💐",bowing_man:"🙇",bow_and_arrow:"🏹",bowing_woman:"🙇&zwj;♀️",bowling:"🎳",boxing_glove:"🥊",boy:"👦",bread:"🍞",bride_with_veil:"👰",bridge_at_night:"🌉",briefcase:"💼",broken_heart:"💔",bug:"🐛",building_construction:"🏗",bulb:"💡",bullettrain_front:"🚅",bullettrain_side:"🚄",burrito:"🌯",bus:"🚌",business_suit_levitating:"🕴",busstop:"🚏",bust_in_silhouette:"👤",busts_in_silhouette:"👥",butterfly:"🦋",cactus:"🌵",cake:"🍰",calendar:"📆",call_me_hand:"🤙",calling:"📲",camel:"🐫",camera:"📷",camera_flash:"📸",camping:"🏕",cancer:"♋️",candle:"🕯",candy:"🍬",canoe:"🛶",capital_abcd:"🔠",capricorn:"♑️",car:"🚗",card_file_box:"🗃",card_index:"📇",card_index_dividers:"🗂",carousel_horse:"🎠",carrot:"🥕",cat:"🐱",cat2:"🐈",cd:"💿",chains:"⛓",champagne:"🍾",chart:"💹",chart_with_downwards_trend:"📉",chart_with_upwards_trend:"📈",checkered_flag:"🏁",cheese:"🧀",cherries:"🍒",cherry_blossom:"🌸",chestnut:"🌰",chicken:"🐔",children_crossing:"🚸",chipmunk:"🐿",chocolate_bar:"🍫",christmas_tree:"🎄",church:"⛪️",cinema:"🎦",circus_tent:"🎪",city_sunrise:"🌇",city_sunset:"🌆",cityscape:"🏙",cl:"🆑",clamp:"🗜",clap:"👏",clapper:"🎬",classical_building:"🏛",clinking_glasses:"🥂",clipboard:"📋",clock1:"🕐",clock10:"🕙",clock1030:"🕥",clock11:"🕚",clock1130:"🕦",clock12:"🕛",clock1230:"🕧",clock130:"🕜",clock2:"🕑",clock230:"🕝",clock3:"🕒",clock330:"🕞",clock4:"🕓",clock430:"🕟",clock5:"🕔",clock530:"🕠",clock6:"🕕",clock630:"🕡",clock7:"🕖",clock730:"🕢",clock8:"🕗",clock830:"🕣",clock9:"🕘",clock930:"🕤",closed_book:"📕",closed_lock_with_key:"🔐",closed_umbrella:"🌂",cloud:"☁️",cloud_with_lightning:"🌩",cloud_with_lightning_and_rain:"⛈",cloud_with_rain:"🌧",cloud_with_snow:"🌨",clown_face:"🤡",clubs:"♣️",cocktail:"🍸",coffee:"☕️",coffin:"⚰️",cold_sweat:"😰",comet:"☄️",computer:"💻",computer_mouse:"🖱",confetti_ball:"🎊",confounded:"😖",confused:"😕",congratulations:"㊗️",construction:"🚧",construction_worker_man:"👷",construction_worker_woman:"👷&zwj;♀️",control_knobs:"🎛",convenience_store:"🏪",cookie:"🍪",cool:"🆒",policeman:"👮",copyright:"©️",corn:"🌽",couch_and_lamp:"🛋",couple:"👫",couple_with_heart_woman_man:"💑",couple_with_heart_man_man:"👨&zwj;❤️&zwj;👨",couple_with_heart_woman_woman:"👩&zwj;❤️&zwj;👩",couplekiss_man_man:"👨&zwj;❤️&zwj;💋&zwj;👨",couplekiss_man_woman:"💏",couplekiss_woman_woman:"👩&zwj;❤️&zwj;💋&zwj;👩",cow:"🐮",cow2:"🐄",cowboy_hat_face:"🤠",crab:"🦀",crayon:"🖍",credit_card:"💳",crescent_moon:"🌙",cricket:"🏏",crocodile:"🐊",croissant:"🥐",crossed_fingers:"🤞",crossed_flags:"🎌",crossed_swords:"⚔️",crown:"👑",cry:"😢",crying_cat_face:"😿",crystal_ball:"🔮",cucumber:"🥒",cupid:"💘",curly_loop:"➰",currency_exchange:"💱",curry:"🍛",custard:"🍮",customs:"🛃",cyclone:"🌀",dagger:"🗡",dancer:"💃",dancing_women:"👯",dancing_men:"👯&zwj;♂️",dango:"🍡",dark_sunglasses:"🕶",dart:"🎯",dash:"💨",date:"📅",deciduous_tree:"🌳",deer:"🦌",department_store:"🏬",derelict_house:"🏚",desert:"🏜",desert_island:"🏝",desktop_computer:"🖥",male_detective:"🕵️",diamond_shape_with_a_dot_inside:"💠",diamonds:"♦️",disappointed:"😞",disappointed_relieved:"😥",dizzy:"💫",dizzy_face:"😵",do_not_litter:"🚯",dog:"🐶",dog2:"🐕",dollar:"💵",dolls:"🎎",dolphin:"🐬",door:"🚪",doughnut:"🍩",dove:"🕊",dragon:"🐉",dragon_face:"🐲",dress:"👗",dromedary_camel:"🐪",drooling_face:"🤤",droplet:"💧",drum:"🥁",duck:"🦆",dvd:"📀","e-mail":"📧",eagle:"🦅",ear:"👂",ear_of_rice:"🌾",earth_africa:"🌍",earth_americas:"🌎",earth_asia:"🌏",egg:"🥚",eggplant:"🍆",eight_pointed_black_star:"✴️",eight_spoked_asterisk:"✳️",electric_plug:"🔌",elephant:"🐘",email:"✉️",end:"🔚",envelope_with_arrow:"📩",euro:"💶",european_castle:"🏰",european_post_office:"🏤",evergreen_tree:"🌲",exclamation:"❗️",expressionless:"😑",eye:"👁",eye_speech_bubble:"👁&zwj;🗨",eyeglasses:"👓",eyes:"👀",face_with_head_bandage:"🤕",face_with_thermometer:"🤒",fist_oncoming:"👊",factory:"🏭",fallen_leaf:"🍂",family_man_woman_boy:"👪",family_man_boy:"👨&zwj;👦",family_man_boy_boy:"👨&zwj;👦&zwj;👦",family_man_girl:"👨&zwj;👧",family_man_girl_boy:"👨&zwj;👧&zwj;👦",family_man_girl_girl:"👨&zwj;👧&zwj;👧",family_man_man_boy:"👨&zwj;👨&zwj;👦",family_man_man_boy_boy:"👨&zwj;👨&zwj;👦&zwj;👦",family_man_man_girl:"👨&zwj;👨&zwj;👧",family_man_man_girl_boy:"👨&zwj;👨&zwj;👧&zwj;👦",family_man_man_girl_girl:"👨&zwj;👨&zwj;👧&zwj;👧",family_man_woman_boy_boy:"👨&zwj;👩&zwj;👦&zwj;👦",family_man_woman_girl:"👨&zwj;👩&zwj;👧",family_man_woman_girl_boy:"👨&zwj;👩&zwj;👧&zwj;👦",family_man_woman_girl_girl:"👨&zwj;👩&zwj;👧&zwj;👧",family_woman_boy:"👩&zwj;👦",family_woman_boy_boy:"👩&zwj;👦&zwj;👦",family_woman_girl:"👩&zwj;👧",family_woman_girl_boy:"👩&zwj;👧&zwj;👦",family_woman_girl_girl:"👩&zwj;👧&zwj;👧",family_woman_woman_boy:"👩&zwj;👩&zwj;👦",family_woman_woman_boy_boy:"👩&zwj;👩&zwj;👦&zwj;👦",family_woman_woman_girl:"👩&zwj;👩&zwj;👧",family_woman_woman_girl_boy:"👩&zwj;👩&zwj;👧&zwj;👦",family_woman_woman_girl_girl:"👩&zwj;👩&zwj;👧&zwj;👧",fast_forward:"⏩",fax:"📠",fearful:"😨",feet:"🐾",female_detective:"🕵️&zwj;♀️",ferris_wheel:"🎡",ferry:"⛴",field_hockey:"🏑",file_cabinet:"🗄",file_folder:"📁",film_projector:"📽",film_strip:"🎞",fire:"🔥",fire_engine:"🚒",fireworks:"🎆",first_quarter_moon:"🌓",first_quarter_moon_with_face:"🌛",fish:"🐟",fish_cake:"🍥",fishing_pole_and_fish:"🎣",fist_raised:"✊",fist_left:"🤛",fist_right:"🤜",flags:"🎏",flashlight:"🔦",fleur_de_lis:"⚜️",flight_arrival:"🛬",flight_departure:"🛫",floppy_disk:"💾",flower_playing_cards:"🎴",flushed:"😳",fog:"🌫",foggy:"🌁",football:"🏈",footprints:"👣",fork_and_knife:"🍴",fountain:"⛲️",fountain_pen:"🖋",four_leaf_clover:"🍀",fox_face:"🦊",framed_picture:"🖼",free:"🆓",fried_egg:"🍳",fried_shrimp:"🍤",fries:"🍟",frog:"🐸",frowning:"😦",frowning_face:"☹️",frowning_man:"🙍&zwj;♂️",frowning_woman:"🙍",middle_finger:"🖕",fuelpump:"⛽️",full_moon:"🌕",full_moon_with_face:"🌝",funeral_urn:"⚱️",game_die:"🎲",gear:"⚙️",gem:"💎",gemini:"♊️",ghost:"👻",gift:"🎁",gift_heart:"💝",girl:"👧",globe_with_meridians:"🌐",goal_net:"🥅",goat:"🐐",golf:"⛳️",golfing_man:"🏌️",golfing_woman:"🏌️&zwj;♀️",gorilla:"🦍",grapes:"🍇",green_apple:"🍏",green_book:"📗",green_heart:"💚",green_salad:"🥗",grey_exclamation:"❕",grey_question:"❔",grimacing:"😬",grin:"😁",grinning:"😀",guardsman:"💂",guardswoman:"💂&zwj;♀️",guitar:"🎸",gun:"🔫",haircut_woman:"💇",haircut_man:"💇&zwj;♂️",hamburger:"🍔",hammer:"🔨",hammer_and_pick:"⚒",hammer_and_wrench:"🛠",hamster:"🐹",hand:"✋",handbag:"👜",handshake:"🤝",hankey:"💩",hatched_chick:"🐥",hatching_chick:"🐣",headphones:"🎧",hear_no_evil:"🙉",heart:"❤️",heart_decoration:"💟",heart_eyes:"😍",heart_eyes_cat:"😻",heartbeat:"💓",heartpulse:"💗",hearts:"♥️",heavy_check_mark:"✔️",heavy_division_sign:"➗",heavy_dollar_sign:"💲",heavy_heart_exclamation:"❣️",heavy_minus_sign:"➖",heavy_multiplication_x:"✖️",heavy_plus_sign:"➕",helicopter:"🚁",herb:"🌿",hibiscus:"🌺",high_brightness:"🔆",high_heel:"👠",hocho:"🔪",hole:"🕳",honey_pot:"🍯",horse:"🐴",horse_racing:"🏇",hospital:"🏥",hot_pepper:"🌶",hotdog:"🌭",hotel:"🏨",hotsprings:"♨️",hourglass:"⌛️",hourglass_flowing_sand:"⏳",house:"🏠",house_with_garden:"🏡",houses:"🏘",hugs:"🤗",hushed:"😯",ice_cream:"🍨",ice_hockey:"🏒",ice_skate:"⛸",icecream:"🍦",id:"🆔",ideograph_advantage:"🉐",imp:"👿",inbox_tray:"📥",incoming_envelope:"📨",tipping_hand_woman:"💁",information_source:"ℹ️",innocent:"😇",interrobang:"⁉️",iphone:"📱",izakaya_lantern:"🏮",jack_o_lantern:"🎃",japan:"🗾",japanese_castle:"🏯",japanese_goblin:"👺",japanese_ogre:"👹",jeans:"👖",joy:"😂",joy_cat:"😹",joystick:"🕹",kaaba:"🕋",key:"🔑",keyboard:"⌨️",keycap_ten:"🔟",kick_scooter:"🛴",kimono:"👘",kiss:"💋",kissing:"😗",kissing_cat:"😽",kissing_closed_eyes:"😚",kissing_heart:"😘",kissing_smiling_eyes:"😙",kiwi_fruit:"🥝",koala:"🐨",koko:"🈁",label:"🏷",large_blue_circle:"🔵",large_blue_diamond:"🔷",large_orange_diamond:"🔶",last_quarter_moon:"🌗",last_quarter_moon_with_face:"🌜",latin_cross:"✝️",laughing:"😆",leaves:"🍃",ledger:"📒",left_luggage:"🛅",left_right_arrow:"↔️",leftwards_arrow_with_hook:"↩️",lemon:"🍋",leo:"♌️",leopard:"🐆",level_slider:"🎚",libra:"♎️",light_rail:"🚈",link:"🔗",lion:"🦁",lips:"👄",lipstick:"💄",lizard:"🦎",lock:"🔒",lock_with_ink_pen:"🔏",lollipop:"🍭",loop:"➿",loud_sound:"🔊",loudspeaker:"📢",love_hotel:"🏩",love_letter:"💌",low_brightness:"🔅",lying_face:"🤥",m:"Ⓜ️",mag:"🔍",mag_right:"🔎",mahjong:"🀄️",mailbox:"📫",mailbox_closed:"📪",mailbox_with_mail:"📬",mailbox_with_no_mail:"📭",man:"👨",man_artist:"👨&zwj;🎨",man_astronaut:"👨&zwj;🚀",man_cartwheeling:"🤸&zwj;♂️",man_cook:"👨&zwj;🍳",man_dancing:"🕺",man_facepalming:"🤦&zwj;♂️",man_factory_worker:"👨&zwj;🏭",man_farmer:"👨&zwj;🌾",man_firefighter:"👨&zwj;🚒",man_health_worker:"👨&zwj;⚕️",man_in_tuxedo:"🤵",man_judge:"👨&zwj;⚖️",man_juggling:"🤹&zwj;♂️",man_mechanic:"👨&zwj;🔧",man_office_worker:"👨&zwj;💼",man_pilot:"👨&zwj;✈️",man_playing_handball:"🤾&zwj;♂️",man_playing_water_polo:"🤽&zwj;♂️",man_scientist:"👨&zwj;🔬",man_shrugging:"🤷&zwj;♂️",man_singer:"👨&zwj;🎤",man_student:"👨&zwj;🎓",man_teacher:"👨&zwj;🏫",man_technologist:"👨&zwj;💻",man_with_gua_pi_mao:"👲",man_with_turban:"👳",tangerine:"🍊",mans_shoe:"👞",mantelpiece_clock:"🕰",maple_leaf:"🍁",martial_arts_uniform:"🥋",mask:"😷",massage_woman:"💆",massage_man:"💆&zwj;♂️",meat_on_bone:"🍖",medal_military:"🎖",medal_sports:"🏅",mega:"📣",melon:"🍈",memo:"📝",men_wrestling:"🤼&zwj;♂️",menorah:"🕎",mens:"🚹",metal:"🤘",metro:"🚇",microphone:"🎤",microscope:"🔬",milk_glass:"🥛",milky_way:"🌌",minibus:"🚐",minidisc:"💽",mobile_phone_off:"📴",money_mouth_face:"🤑",money_with_wings:"💸",moneybag:"💰",monkey:"🐒",monkey_face:"🐵",monorail:"🚝",moon:"🌔",mortar_board:"🎓",mosque:"🕌",motor_boat:"🛥",motor_scooter:"🛵",motorcycle:"🏍",motorway:"🛣",mount_fuji:"🗻",mountain:"⛰",mountain_biking_man:"🚵",mountain_biking_woman:"🚵&zwj;♀️",mountain_cableway:"🚠",mountain_railway:"🚞",mountain_snow:"🏔",mouse:"🐭",mouse2:"🐁",movie_camera:"🎥",moyai:"🗿",mrs_claus:"🤶",muscle:"💪",mushroom:"🍄",musical_keyboard:"🎹",musical_note:"🎵",musical_score:"🎼",mute:"🔇",nail_care:"💅",name_badge:"📛",national_park:"🏞",nauseated_face:"🤢",necktie:"👔",negative_squared_cross_mark:"❎",nerd_face:"🤓",neutral_face:"😐",new:"🆕",new_moon:"🌑",new_moon_with_face:"🌚",newspaper:"📰",newspaper_roll:"🗞",next_track_button:"⏭",ng:"🆖",no_good_man:"🙅&zwj;♂️",no_good_woman:"🙅",night_with_stars:"🌃",no_bell:"🔕",no_bicycles:"🚳",no_entry:"⛔️",no_entry_sign:"🚫",no_mobile_phones:"📵",no_mouth:"😶",no_pedestrians:"🚷",no_smoking:"🚭","non-potable_water":"🚱",nose:"👃",notebook:"📓",notebook_with_decorative_cover:"📔",notes:"🎶",nut_and_bolt:"🔩",o:"⭕️",o2:"🅾️",ocean:"🌊",octopus:"🐙",oden:"🍢",office:"🏢",oil_drum:"🛢",ok:"🆗",ok_hand:"👌",ok_man:"🙆&zwj;♂️",ok_woman:"🙆",old_key:"🗝",older_man:"👴",older_woman:"👵",om:"🕉",on:"🔛",oncoming_automobile:"🚘",oncoming_bus:"🚍",oncoming_police_car:"🚔",oncoming_taxi:"🚖",open_file_folder:"📂",open_hands:"👐",open_mouth:"😮",open_umbrella:"☂️",ophiuchus:"⛎",orange_book:"📙",orthodox_cross:"☦️",outbox_tray:"📤",owl:"🦉",ox:"🐂",package:"📦",page_facing_up:"📄",page_with_curl:"📃",pager:"📟",paintbrush:"🖌",palm_tree:"🌴",pancakes:"🥞",panda_face:"🐼",paperclip:"📎",paperclips:"🖇",parasol_on_ground:"⛱",parking:"🅿️",part_alternation_mark:"〽️",partly_sunny:"⛅️",passenger_ship:"🛳",passport_control:"🛂",pause_button:"⏸",peace_symbol:"☮️",peach:"🍑",peanuts:"🥜",pear:"🍐",pen:"🖊",pencil2:"✏️",penguin:"🐧",pensive:"😔",performing_arts:"🎭",persevere:"😣",person_fencing:"🤺",pouting_woman:"🙎",phone:"☎️",pick:"⛏",pig:"🐷",pig2:"🐖",pig_nose:"🐽",pill:"💊",pineapple:"🍍",ping_pong:"🏓",pisces:"♓️",pizza:"🍕",place_of_worship:"🛐",plate_with_cutlery:"🍽",play_or_pause_button:"⏯",point_down:"👇",point_left:"👈",point_right:"👉",point_up:"☝️",point_up_2:"👆",police_car:"🚓",policewoman:"👮&zwj;♀️",poodle:"🐩",popcorn:"🍿",post_office:"🏣",postal_horn:"📯",postbox:"📮",potable_water:"🚰",potato:"🥔",pouch:"👝",poultry_leg:"🍗",pound:"💷",rage:"😡",pouting_cat:"😾",pouting_man:"🙎&zwj;♂️",pray:"🙏",prayer_beads:"📿",pregnant_woman:"🤰",previous_track_button:"⏮",prince:"🤴",princess:"👸",printer:"🖨",purple_heart:"💜",purse:"👛",pushpin:"📌",put_litter_in_its_place:"🚮",question:"❓",rabbit:"🐰",rabbit2:"🐇",racehorse:"🐎",racing_car:"🏎",radio:"📻",radio_button:"🔘",radioactive:"☢️",railway_car:"🚃",railway_track:"🛤",rainbow:"🌈",rainbow_flag:"🏳️&zwj;🌈",raised_back_of_hand:"🤚",raised_hand_with_fingers_splayed:"🖐",raised_hands:"🙌",raising_hand_woman:"🙋",raising_hand_man:"🙋&zwj;♂️",ram:"🐏",ramen:"🍜",rat:"🐀",record_button:"⏺",recycle:"♻️",red_circle:"🔴",registered:"®️",relaxed:"☺️",relieved:"😌",reminder_ribbon:"🎗",repeat:"🔁",repeat_one:"🔂",rescue_worker_helmet:"⛑",restroom:"🚻",revolving_hearts:"💞",rewind:"⏪",rhinoceros:"🦏",ribbon:"🎀",rice:"🍚",rice_ball:"🍙",rice_cracker:"🍘",rice_scene:"🎑",right_anger_bubble:"🗯",ring:"💍",robot:"🤖",rocket:"🚀",rofl:"🤣",roll_eyes:"🙄",roller_coaster:"🎢",rooster:"🐓",rose:"🌹",rosette:"🏵",rotating_light:"🚨",round_pushpin:"📍",rowing_man:"🚣",rowing_woman:"🚣&zwj;♀️",rugby_football:"🏉",running_man:"🏃",running_shirt_with_sash:"🎽",running_woman:"🏃&zwj;♀️",sa:"🈂️",sagittarius:"♐️",sake:"🍶",sandal:"👡",santa:"🎅",satellite:"📡",saxophone:"🎷",school:"🏫",school_satchel:"🎒",scissors:"✂️",scorpion:"🦂",scorpius:"♏️",scream:"😱",scream_cat:"🙀",scroll:"📜",seat:"💺",secret:"㊙️",see_no_evil:"🙈",seedling:"🌱",selfie:"🤳",shallow_pan_of_food:"🥘",shamrock:"☘️",shark:"🦈",shaved_ice:"🍧",sheep:"🐑",shell:"🐚",shield:"🛡",shinto_shrine:"⛩",ship:"🚢",shirt:"👕",shopping:"🛍",shopping_cart:"🛒",shower:"🚿",shrimp:"🦐",signal_strength:"📶",six_pointed_star:"🔯",ski:"🎿",skier:"⛷",skull:"💀",skull_and_crossbones:"☠️",sleeping:"😴",sleeping_bed:"🛌",sleepy:"😪",slightly_frowning_face:"🙁",slightly_smiling_face:"🙂",slot_machine:"🎰",small_airplane:"🛩",small_blue_diamond:"🔹",small_orange_diamond:"🔸",small_red_triangle:"🔺",small_red_triangle_down:"🔻",smile:"😄",smile_cat:"😸",smiley:"😃",smiley_cat:"😺",smiling_imp:"😈",smirk:"😏",smirk_cat:"😼",smoking:"🚬",snail:"🐌",snake:"🐍",sneezing_face:"🤧",snowboarder:"🏂",snowflake:"❄️",snowman:"⛄️",snowman_with_snow:"☃️",sob:"😭",soccer:"⚽️",soon:"🔜",sos:"🆘",sound:"🔉",space_invader:"👾",spades:"♠️",spaghetti:"🍝",sparkle:"❇️",sparkler:"🎇",sparkles:"✨",sparkling_heart:"💖",speak_no_evil:"🙊",speaker:"🔈",speaking_head:"🗣",speech_balloon:"💬",speedboat:"🚤",spider:"🕷",spider_web:"🕸",spiral_calendar:"🗓",spiral_notepad:"🗒",spoon:"🥄",squid:"🦑",stadium:"🏟",star:"⭐️",star2:"🌟",star_and_crescent:"☪️",star_of_david:"✡️",stars:"🌠",station:"🚉",statue_of_liberty:"🗽",steam_locomotive:"🚂",stew:"🍲",stop_button:"⏹",stop_sign:"🛑",stopwatch:"⏱",straight_ruler:"📏",strawberry:"🍓",stuck_out_tongue:"😛",stuck_out_tongue_closed_eyes:"😝",stuck_out_tongue_winking_eye:"😜",studio_microphone:"🎙",stuffed_flatbread:"🥙",sun_behind_large_cloud:"🌥",sun_behind_rain_cloud:"🌦",sun_behind_small_cloud:"🌤",sun_with_face:"🌞",sunflower:"🌻",sunglasses:"😎",sunny:"☀️",sunrise:"🌅",sunrise_over_mountains:"🌄",surfing_man:"🏄",surfing_woman:"🏄&zwj;♀️",sushi:"🍣",suspension_railway:"🚟",sweat:"😓",sweat_drops:"💦",sweat_smile:"😅",sweet_potato:"🍠",swimming_man:"🏊",swimming_woman:"🏊&zwj;♀️",symbols:"🔣",synagogue:"🕍",syringe:"💉",taco:"🌮",tada:"🎉",tanabata_tree:"🎋",taurus:"♉️",taxi:"🚕",tea:"🍵",telephone_receiver:"📞",telescope:"🔭",tennis:"🎾",tent:"⛺️",thermometer:"🌡",thinking:"🤔",thought_balloon:"💭",ticket:"🎫",tickets:"🎟",tiger:"🐯",tiger2:"🐅",timer_clock:"⏲",tipping_hand_man:"💁&zwj;♂️",tired_face:"😫",tm:"™️",toilet:"🚽",tokyo_tower:"🗼",tomato:"🍅",tongue:"👅",top:"🔝",tophat:"🎩",tornado:"🌪",trackball:"🖲",tractor:"🚜",traffic_light:"🚥",train:"🚋",train2:"🚆",tram:"🚊",triangular_flag_on_post:"🚩",triangular_ruler:"📐",trident:"🔱",triumph:"😤",trolleybus:"🚎",trophy:"🏆",tropical_drink:"🍹",tropical_fish:"🐠",truck:"🚚",trumpet:"🎺",tulip:"🌷",tumbler_glass:"🥃",turkey:"🦃",turtle:"🐢",tv:"📺",twisted_rightwards_arrows:"🔀",two_hearts:"💕",two_men_holding_hands:"👬",two_women_holding_hands:"👭",u5272:"🈹",u5408:"🈴",u55b6:"🈺",u6307:"🈯️",u6708:"🈷️",u6709:"🈶",u6e80:"🈵",u7121:"🈚️",u7533:"🈸",u7981:"🈲",u7a7a:"🈳",umbrella:"☔️",unamused:"😒",underage:"🔞",unicorn:"🦄",unlock:"🔓",up:"🆙",upside_down_face:"🙃",v:"✌️",vertical_traffic_light:"🚦",vhs:"📼",vibration_mode:"📳",video_camera:"📹",video_game:"🎮",violin:"🎻",virgo:"♍️",volcano:"🌋",volleyball:"🏐",vs:"🆚",vulcan_salute:"🖖",walking_man:"🚶",walking_woman:"🚶&zwj;♀️",waning_crescent_moon:"🌘",waning_gibbous_moon:"🌖",warning:"⚠️",wastebasket:"🗑",watch:"⌚️",water_buffalo:"🐃",watermelon:"🍉",wave:"👋",wavy_dash:"〰️",waxing_crescent_moon:"🌒",wc:"🚾",weary:"😩",wedding:"💒",weight_lifting_man:"🏋️",weight_lifting_woman:"🏋️&zwj;♀️",whale:"🐳",whale2:"🐋",wheel_of_dharma:"☸️",wheelchair:"♿️",white_check_mark:"✅",white_circle:"⚪️",white_flag:"🏳️",white_flower:"💮",white_large_square:"⬜️",white_medium_small_square:"◽️",white_medium_square:"◻️",white_small_square:"▫️",white_square_button:"🔳",wilted_flower:"🥀",wind_chime:"🎐",wind_face:"🌬",wine_glass:"🍷",wink:"😉",wolf:"🐺",woman:"👩",woman_artist:"👩&zwj;🎨",woman_astronaut:"👩&zwj;🚀",woman_cartwheeling:"🤸&zwj;♀️",woman_cook:"👩&zwj;🍳",woman_facepalming:"🤦&zwj;♀️",woman_factory_worker:"👩&zwj;🏭",woman_farmer:"👩&zwj;🌾",woman_firefighter:"👩&zwj;🚒",woman_health_worker:"👩&zwj;⚕️",woman_judge:"👩&zwj;⚖️",woman_juggling:"🤹&zwj;♀️",woman_mechanic:"👩&zwj;🔧",woman_office_worker:"👩&zwj;💼",woman_pilot:"👩&zwj;✈️",woman_playing_handball:"🤾&zwj;♀️",woman_playing_water_polo:"🤽&zwj;♀️",woman_scientist:"👩&zwj;🔬",woman_shrugging:"🤷&zwj;♀️",woman_singer:"👩&zwj;🎤",woman_student:"👩&zwj;🎓",woman_teacher:"👩&zwj;🏫",woman_technologist:"👩&zwj;💻",woman_with_turban:"👳&zwj;♀️",womans_clothes:"👚",womans_hat:"👒",women_wrestling:"🤼&zwj;♀️",womens:"🚺",world_map:"🗺",worried:"😟",wrench:"🔧",writing_hand:"✍️",x:"❌",yellow_heart:"💛",yen:"💴",yin_yang:"☯️",yum:"😋",zap:"⚡️",zipper_mouth_face:"🤐",zzz:"💤",octocat:'<img alt=":octocat:" height="20" width="20" align="absmiddle" src="https://assets-cdn.github.com/images/icons/emoji/octocat.png">',showdown:"<span style=\"font-family: 'Anonymous Pro', monospace; text-decoration: underline; text-decoration-style: dashed; text-decoration-color: #3e8b8a;text-underline-position: under;\">S</span>"},a.Converter=function(e){var t={},r=[],n=[],o={},i=l,p={parsed:{},raw:"",format:""};function h(e,t){if(t=t||null,a.helper.isString(e)){if(t=e=a.helper.stdExtName(e),a.extensions[e])return console.warn("DEPRECATION WARNING: "+e+" is an old extension that uses a deprecated loading method.Please inform the developer that the extension should be updated!"),void function(e,t){"function"==typeof e&&(e=e(new a.Converter));a.helper.isArray(e)||(e=[e]);var o=d(e,t);if(!o.valid)throw Error(o.error);for(var i=0;i<e.length;++i)switch(e[i].type){case"lang":r.push(e[i]);break;case"output":n.push(e[i]);break;default:throw Error("Extension loader error: Type unrecognized!!!")}}(a.extensions[e],e);if(a.helper.isUndefined(s[e]))throw Error('Extension "'+e+'" could not be loaded. It was either not found or is not a valid extension.');e=s[e]}"function"==typeof e&&(e=e()),a.helper.isArray(e)||(e=[e]);var o=d(e,t);if(!o.valid)throw Error(o.error);for(var i=0;i<e.length;++i){switch(e[i].type){case"lang":r.push(e[i]);break;case"output":n.push(e[i])}if(e[i].hasOwnProperty("listeners"))for(var c in e[i].listeners)e[i].listeners.hasOwnProperty(c)&&f(c,e[i].listeners[c])}}function f(e,t){if(!a.helper.isString(e))throw Error("Invalid argument in converter.listen() method: name must be a string, but "+typeof e+" given");if("function"!=typeof t)throw Error("Invalid argument in converter.listen() method: callback must be a function, but "+typeof t+" given");o.hasOwnProperty(e)||(o[e]=[]),o[e].push(t)}!function(){for(var r in e=e||{},c)c.hasOwnProperty(r)&&(t[r]=c[r]);if("object"!=typeof e)throw Error("Converter expects the passed parameter to be an object, but "+typeof e+" was passed instead.");for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.extensions&&a.helper.forEach(t.extensions,h)}(),this._dispatch=function(e,t,r,n){if(o.hasOwnProperty(e))for(var a=0;a<o[e].length;++a){var i=o[e][a](e,t,this,r,n);i&&void 0!==i&&(t=i)}return t},this.listen=function(e,t){return f(e,t),this},this.makeHtml=function(e){if(!e)return e;var o={gHtmlBlocks:[],gHtmlMdBlocks:[],gHtmlSpans:[],gUrls:{},gTitles:{},gDimensions:{},gListLevel:0,hashLinkCounts:{},langExtensions:r,outputModifiers:n,converter:this,ghCodeBlocks:[],metadata:{parsed:{},raw:"",format:""}};return e=(e=(e=(e=(e=e.replace(/¨/g,"¨T")).replace(/\$/g,"¨D")).replace(/\r\n/g,"\n")).replace(/\r/g,"\n")).replace(/\u00A0/g,"&nbsp;"),t.smartIndentationFix&&(e=function(e){var t=e.match(/^\s*/)[0].length,r=new RegExp("^\\s{0,"+t+"}","gm");return e.replace(r,"")}(e)),e="\n\n"+e+"\n\n",e=(e=a.subParser("detab")(e,t,o)).replace(/^[ \t]+$/gm,""),a.helper.forEach(r,(function(r){e=a.subParser("runExtension")(r,e,t,o)})),e=a.subParser("metadata")(e,t,o),e=a.subParser("hashPreCodeTags")(e,t,o),e=a.subParser("githubCodeBlocks")(e,t,o),e=a.subParser("hashHTMLBlocks")(e,t,o),e=a.subParser("hashCodeTags")(e,t,o),e=a.subParser("stripLinkDefinitions")(e,t,o),e=a.subParser("blockGamut")(e,t,o),e=a.subParser("unhashHTMLSpans")(e,t,o),e=(e=(e=a.subParser("unescapeSpecialChars")(e,t,o)).replace(/¨D/g,"$$")).replace(/¨T/g,"¨"),e=a.subParser("completeHTMLDocument")(e,t,o),a.helper.forEach(n,(function(r){e=a.subParser("runExtension")(r,e,t,o)})),p=o.metadata,e},this.makeMarkdown=this.makeMd=function(e,t){if(e=(e=(e=e.replace(/\r\n/g,"\n")).replace(/\r/g,"\n")).replace(/>[ \t]+</,">¨NBSP;<"),!t){if(!window||!window.document)throw new Error("HTMLParser is undefined. If in a webworker or nodejs environment, you need to provide a WHATWG DOM and HTML such as JSDOM");t=window.document}var r=t.createElement("div");r.innerHTML=e;var n={preList:function(e){for(var t=e.querySelectorAll("pre"),r=[],n=0;n<t.length;++n)if(1===t[n].childElementCount&&"code"===t[n].firstChild.tagName.toLowerCase()){var o=t[n].firstChild.innerHTML.trim(),i=t[n].firstChild.getAttribute("data-language")||"";if(""===i)for(var s=t[n].firstChild.className.split(" "),c=0;c<s.length;++c){var l=s[c].match(/^language-(.+)$/);if(null!==l){i=l[1];break}}o=a.helper.unescapeHTMLEntities(o),r.push(o),t[n].outerHTML='<precode language="'+i+'" precodenum="'+n.toString()+'"></precode>'}else r.push(t[n].innerHTML),t[n].innerHTML="",t[n].setAttribute("prenum",n.toString());return r}(r)};!function e(t){for(var r=0;r<t.childNodes.length;++r){var n=t.childNodes[r];3===n.nodeType?/\S/.test(n.nodeValue)||/^[ ]+$/.test(n.nodeValue)?(n.nodeValue=n.nodeValue.split("\n").join(" "),n.nodeValue=n.nodeValue.replace(/(\s)+/g,"$1")):(t.removeChild(n),--r):1===n.nodeType&&e(n)}}(r);for(var o=r.childNodes,i="",s=0;s<o.length;s++)i+=a.subParser("makeMarkdown.node")(o[s],n);return i},this.setOption=function(e,r){t[e]=r},this.getOption=function(e){return t[e]},this.getOptions=function(){return t},this.addExtension=function(e,t){h(e,t=t||null)},this.useExtension=function(e){h(e)},this.setFlavor=function(e){if(!u.hasOwnProperty(e))throw Error(e+" flavor was not found");var r=u[e];for(var n in i=e,r)r.hasOwnProperty(n)&&(t[n]=r[n])},this.getFlavor=function(){return i},this.removeExtension=function(e){a.helper.isArray(e)||(e=[e]);for(var t=0;t<e.length;++t){for(var o=e[t],i=0;i<r.length;++i)r[i]===o&&r.splice(i,1);for(var s=0;s<n.length;++s)n[s]===o&&n.splice(s,1)}},this.getAllExtensions=function(){return{language:r,output:n}},this.getMetadata=function(e){return e?p.raw:p.parsed},this.getMetadataFormat=function(){return p.format},this._setMetadataPair=function(e,t){p.parsed[e]=t},this._setMetadataFormat=function(e){p.format=e},this._setMetadataRaw=function(e){p.raw=e}},a.subParser("anchors",(function(e,t,r){var n=function(e,n,o,i,s,c,l){if(a.helper.isUndefined(l)&&(l=""),o=o.toLowerCase(),e.search(/\(<?\s*>? ?(['"].*['"])?\)$/m)>-1)i="";else if(!i){if(o||(o=n.toLowerCase().replace(/ ?\n/g," ")),i="#"+o,a.helper.isUndefined(r.gUrls[o]))return e;i=r.gUrls[o],a.helper.isUndefined(r.gTitles[o])||(l=r.gTitles[o])}var u='<a href="'+(i=i.replace(a.helper.regexes.asteriskDashAndColon,a.helper.escapeCharactersCallback))+'"';return""!==l&&null!==l&&(u+=' title="'+(l=(l=l.replace(/"/g,"&quot;")).replace(a.helper.regexes.asteriskDashAndColon,a.helper.escapeCharactersCallback))+'"'),t.openLinksInNewWindow&&!/^#/.test(i)&&(u+=' rel="noopener noreferrer" target="¨E95Eblank"'),u+=">"+n+"</a>"};return e=(e=(e=(e=(e=r.converter._dispatch("anchors.before",e,t,r)).replace(/\[((?:\[[^\]]*]|[^\[\]])*)] ?(?:\n *)?\[(.*?)]()()()()/g,n)).replace(/\[((?:\[[^\]]*]|[^\[\]])*)]()[ \t]*\([ \t]?<([^>]*)>(?:[ \t]*((["'])([^"]*?)\5))?[ \t]?\)/g,n)).replace(/\[((?:\[[^\]]*]|[^\[\]])*)]()[ \t]*\([ \t]?<?([\S]+?(?:\([\S]*?\)[\S]*?)?)>?(?:[ \t]*((["'])([^"]*?)\5))?[ \t]?\)/g,n)).replace(/\[([^\[\]]+)]()()()()()/g,n),t.ghMentions&&(e=e.replace(/(^|\s)(\\)?(@([a-z\d]+(?:[a-z\d.-]+?[a-z\d]+)*))/gim,(function(e,r,n,o,i){if("\\"===n)return r+o;if(!a.helper.isString(t.ghMentionsLink))throw new Error("ghMentionsLink option must be a string");var s=t.ghMentionsLink.replace(/\{u}/g,i),c="";return t.openLinksInNewWindow&&(c=' rel="noopener noreferrer" target="¨E95Eblank"'),r+'<a href="'+s+'"'+c+">"+o+"</a>"}))),e=r.converter._dispatch("anchors.after",e,t,r)}));var f=/([*~_]+|\b)(((https?|ftp|dict):\/\/|www\.)[^'">\s]+?\.[^'">\s]+?)()(\1)?(?=\s|$)(?!["<>])/gi,m=/([*~_]+|\b)(((https?|ftp|dict):\/\/|www\.)[^'">\s]+\.[^'">\s]+?)([.!?,()\[\]])?(\1)?(?=\s|$)(?!["<>])/gi,g=/()<(((https?|ftp|dict):\/\/|www\.)[^'">\s]+)()>()/gi,b=/(^|\s)(?:mailto:)?([A-Za-z0-9!#$%&'*+-/=?^_`{|}~.]+@[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+)(?=$|\s)/gim,v=/<()(?:mailto:)?([-.\w]+@[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+)>/gi,_=function(e){return function(t,r,n,o,i,s,c){var l=n=n.replace(a.helper.regexes.asteriskDashAndColon,a.helper.escapeCharactersCallback),u="",d="",p=r||"",h=c||"";return/^www\./i.test(n)&&(n=n.replace(/^www\./i,"http://www.")),e.excludeTrailingPunctuationFromURLs&&s&&(u=s),e.openLinksInNewWindow&&(d=' rel="noopener noreferrer" target="¨E95Eblank"'),p+'<a href="'+n+'"'+d+">"+l+"</a>"+u+h}},w=function(e,t){return function(r,n,o){var i="mailto:";return n=n||"",o=a.subParser("unescapeSpecialChars")(o,e,t),e.encodeEmails?(i=a.helper.encodeEmailAddress(i+o),o=a.helper.encodeEmailAddress(o)):i+=o,n+'<a href="'+i+'">'+o+"</a>"}};a.subParser("autoLinks",(function(e,t,r){return e=(e=(e=r.converter._dispatch("autoLinks.before",e,t,r)).replace(g,_(t))).replace(v,w(t,r)),e=r.converter._dispatch("autoLinks.after",e,t,r)})),a.subParser("simplifiedAutoLinks",(function(e,t,r){return t.simplifiedAutoLink?(e=r.converter._dispatch("simplifiedAutoLinks.before",e,t,r),e=(e=t.excludeTrailingPunctuationFromURLs?e.replace(m,_(t)):e.replace(f,_(t))).replace(b,w(t,r)),e=r.converter._dispatch("simplifiedAutoLinks.after",e,t,r)):e})),a.subParser("blockGamut",(function(e,t,r){return e=r.converter._dispatch("blockGamut.before",e,t,r),e=a.subParser("blockQuotes")(e,t,r),e=a.subParser("headers")(e,t,r),e=a.subParser("horizontalRule")(e,t,r),e=a.subParser("lists")(e,t,r),e=a.subParser("codeBlocks")(e,t,r),e=a.subParser("tables")(e,t,r),e=a.subParser("hashHTMLBlocks")(e,t,r),e=a.subParser("paragraphs")(e,t,r),e=r.converter._dispatch("blockGamut.after",e,t,r)})),a.subParser("blockQuotes",(function(e,t,r){e=r.converter._dispatch("blockQuotes.before",e,t,r),e+="\n\n";var n=/(^ {0,3}>[ \t]?.+\n(.+\n)*\n*)+/gm;return t.splitAdjacentBlockquotes&&(n=/^ {0,3}>[\s\S]*?(?:\n\n)/gm),e=e.replace(n,(function(e){return e=(e=(e=e.replace(/^[ \t]*>[ \t]?/gm,"")).replace(/¨0/g,"")).replace(/^[ \t]+$/gm,""),e=a.subParser("githubCodeBlocks")(e,t,r),e=(e=(e=a.subParser("blockGamut")(e,t,r)).replace(/(^|\n)/g,"$1  ")).replace(/(\s*<pre>[^\r]+?<\/pre>)/gm,(function(e,t){var r=t;return r=(r=r.replace(/^  /gm,"¨0")).replace(/¨0/g,"")})),a.subParser("hashBlock")("<blockquote>\n"+e+"\n</blockquote>",t,r)})),e=r.converter._dispatch("blockQuotes.after",e,t,r)})),a.subParser("codeBlocks",(function(e,t,r){e=r.converter._dispatch("codeBlocks.before",e,t,r);return e=(e=(e+="¨0").replace(/(?:\n\n|^)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=¨0))/g,(function(e,n,o){var i=n,s=o,c="\n";return i=a.subParser("outdent")(i,t,r),i=a.subParser("encodeCode")(i,t,r),i=(i=(i=a.subParser("detab")(i,t,r)).replace(/^\n+/g,"")).replace(/\n+$/g,""),t.omitExtraWLInCodeBlocks&&(c=""),i="<pre><code>"+i+c+"</code></pre>",a.subParser("hashBlock")(i,t,r)+s}))).replace(/¨0/,""),e=r.converter._dispatch("codeBlocks.after",e,t,r)})),a.subParser("codeSpans",(function(e,t,r){return void 0===(e=r.converter._dispatch("codeSpans.before",e,t,r))&&(e=""),e=e.replace(/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/gm,(function(e,n,o,i){var s=i;return s=(s=s.replace(/^([ \t]*)/g,"")).replace(/[ \t]*$/g,""),s=n+"<code>"+(s=a.subParser("encodeCode")(s,t,r))+"</code>",s=a.subParser("hashHTMLSpans")(s,t,r)})),e=r.converter._dispatch("codeSpans.after",e,t,r)})),a.subParser("completeHTMLDocument",(function(e,t,r){if(!t.completeHTMLDocument)return e;e=r.converter._dispatch("completeHTMLDocument.before",e,t,r);var n="html",o="<!DOCTYPE HTML>\n",a="",i='<meta charset="utf-8">\n',s="",c="";for(var l in void 0!==r.metadata.parsed.doctype&&(o="<!DOCTYPE "+r.metadata.parsed.doctype+">\n","html"!==(n=r.metadata.parsed.doctype.toString().toLowerCase())&&"html5"!==n||(i='<meta charset="utf-8">')),r.metadata.parsed)if(r.metadata.parsed.hasOwnProperty(l))switch(l.toLowerCase()){case"doctype":break;case"title":a="<title>"+r.metadata.parsed.title+"</title>\n";break;case"charset":i="html"===n||"html5"===n?'<meta charset="'+r.metadata.parsed.charset+'">\n':'<meta name="charset" content="'+r.metadata.parsed.charset+'">\n';break;case"language":case"lang":s=' lang="'+r.metadata.parsed[l]+'"',c+='<meta name="'+l+'" content="'+r.metadata.parsed[l]+'">\n';break;default:c+='<meta name="'+l+'" content="'+r.metadata.parsed[l]+'">\n'}return e=o+"<html"+s+">\n<head>\n"+a+i+c+"</head>\n<body>\n"+e.trim()+"\n</body>\n</html>",e=r.converter._dispatch("completeHTMLDocument.after",e,t,r)})),a.subParser("detab",(function(e,t,r){return e=(e=(e=(e=(e=(e=r.converter._dispatch("detab.before",e,t,r)).replace(/\t(?=\t)/g,"    ")).replace(/\t/g,"¨A¨B")).replace(/¨B(.+?)¨A/g,(function(e,t){for(var r=t,n=4-r.length%4,o=0;o<n;o++)r+=" ";return r}))).replace(/¨A/g,"    ")).replace(/¨B/g,""),e=r.converter._dispatch("detab.after",e,t,r)})),a.subParser("ellipsis",(function(e,t,r){return t.ellipsis?(e=(e=r.converter._dispatch("ellipsis.before",e,t,r)).replace(/\.\.\./g,"…"),e=r.converter._dispatch("ellipsis.after",e,t,r)):e})),a.subParser("emoji",(function(e,t,r){if(!t.emoji)return e;return e=(e=r.converter._dispatch("emoji.before",e,t,r)).replace(/:([\S]+?):/g,(function(e,t){return a.helper.emojis.hasOwnProperty(t)?a.helper.emojis[t]:e})),e=r.converter._dispatch("emoji.after",e,t,r)})),a.subParser("encodeAmpsAndAngles",(function(e,t,r){return e=(e=(e=(e=(e=r.converter._dispatch("encodeAmpsAndAngles.before",e,t,r)).replace(/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/g,"&amp;")).replace(/<(?![a-z\/?$!])/gi,"&lt;")).replace(/</g,"&lt;")).replace(/>/g,"&gt;"),e=r.converter._dispatch("encodeAmpsAndAngles.after",e,t,r)})),a.subParser("encodeBackslashEscapes",(function(e,t,r){return e=(e=(e=r.converter._dispatch("encodeBackslashEscapes.before",e,t,r)).replace(/\\(\\)/g,a.helper.escapeCharactersCallback)).replace(/\\([`*_{}\[\]()>#+.!~=|:-])/g,a.helper.escapeCharactersCallback),e=r.converter._dispatch("encodeBackslashEscapes.after",e,t,r)})),a.subParser("encodeCode",(function(e,t,r){return e=(e=r.converter._dispatch("encodeCode.before",e,t,r)).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/([*_{}\[\]\\=~-])/g,a.helper.escapeCharactersCallback),e=r.converter._dispatch("encodeCode.after",e,t,r)})),a.subParser("escapeSpecialCharsWithinTagAttributes",(function(e,t,r){return e=(e=(e=r.converter._dispatch("escapeSpecialCharsWithinTagAttributes.before",e,t,r)).replace(/<\/?[a-z\d_:-]+(?:[\s]+[\s\S]+?)?>/gi,(function(e){return e.replace(/(.)<\/?code>(?=.)/g,"$1`").replace(/([\\`*_~=|])/g,a.helper.escapeCharactersCallback)}))).replace(/<!(--(?:(?:[^>-]|-[^>])(?:[^-]|-[^-])*)--)>/gi,(function(e){return e.replace(/([\\`*_~=|])/g,a.helper.escapeCharactersCallback)})),e=r.converter._dispatch("escapeSpecialCharsWithinTagAttributes.after",e,t,r)})),a.subParser("githubCodeBlocks",(function(e,t,r){return t.ghCodeBlocks?(e=r.converter._dispatch("githubCodeBlocks.before",e,t,r),e=(e=(e+="¨0").replace(/(?:^|\n)(?: {0,3})(```+|~~~+)(?: *)([^\s`~]*)\n([\s\S]*?)\n(?: {0,3})\1/g,(function(e,n,o,i){var s=t.omitExtraWLInCodeBlocks?"":"\n";return i=a.subParser("encodeCode")(i,t,r),i="<pre><code"+(o?' class="'+o+" language-"+o+'"':"")+">"+(i=(i=(i=a.subParser("detab")(i,t,r)).replace(/^\n+/g,"")).replace(/\n+$/g,""))+s+"</code></pre>",i=a.subParser("hashBlock")(i,t,r),"\n\n¨G"+(r.ghCodeBlocks.push({text:e,codeblock:i})-1)+"G\n\n"}))).replace(/¨0/,""),r.converter._dispatch("githubCodeBlocks.after",e,t,r)):e})),a.subParser("hashBlock",(function(e,t,r){return e=(e=r.converter._dispatch("hashBlock.before",e,t,r)).replace(/(^\n+|\n+$)/g,""),e="\n\n¨K"+(r.gHtmlBlocks.push(e)-1)+"K\n\n",e=r.converter._dispatch("hashBlock.after",e,t,r)})),a.subParser("hashCodeTags",(function(e,t,r){e=r.converter._dispatch("hashCodeTags.before",e,t,r);return e=a.helper.replaceRecursiveRegExp(e,(function(e,n,o,i){var s=o+a.subParser("encodeCode")(n,t,r)+i;return"¨C"+(r.gHtmlSpans.push(s)-1)+"C"}),"<code\\b[^>]*>","</code>","gim"),e=r.converter._dispatch("hashCodeTags.after",e,t,r)})),a.subParser("hashElement",(function(e,t,r){return function(e,t){var n=t;return n=(n=(n=n.replace(/\n\n/g,"\n")).replace(/^\n/,"")).replace(/\n+$/g,""),n="\n\n¨K"+(r.gHtmlBlocks.push(n)-1)+"K\n\n"}})),a.subParser("hashHTMLBlocks",(function(e,t,r){e=r.converter._dispatch("hashHTMLBlocks.before",e,t,r);var n=["pre","div","h1","h2","h3","h4","h5","h6","blockquote","table","dl","ol","ul","script","noscript","form","fieldset","iframe","math","style","section","header","footer","nav","article","aside","address","audio","canvas","figure","hgroup","output","video","p"],o=function(e,t,n,o){var a=e;return-1!==n.search(/\bmarkdown\b/)&&(a=n+r.converter.makeHtml(t)+o),"\n\n¨K"+(r.gHtmlBlocks.push(a)-1)+"K\n\n"};t.backslashEscapesHTMLTags&&(e=e.replace(/\\<(\/?[^>]+?)>/g,(function(e,t){return"&lt;"+t+"&gt;"})));for(var i=0;i<n.length;++i)for(var s,c=new RegExp("^ {0,3}(<"+n[i]+"\\b[^>]*>)","im"),l="<"+n[i]+"\\b[^>]*>",u="</"+n[i]+">";-1!==(s=a.helper.regexIndexOf(e,c));){var d=a.helper.splitAtIndex(e,s),p=a.helper.replaceRecursiveRegExp(d[1],o,l,u,"im");if(p===d[1])break;e=d[0].concat(p)}return e=e.replace(/(\n {0,3}(<(hr)\b([^<>])*?\/?>)[ \t]*(?=\n{2,}))/g,a.subParser("hashElement")(e,t,r)),e=(e=a.helper.replaceRecursiveRegExp(e,(function(e){return"\n\n¨K"+(r.gHtmlBlocks.push(e)-1)+"K\n\n"}),"^ {0,3}\x3c!--","--\x3e","gm")).replace(/(?:\n\n)( {0,3}(?:<([?%])[^\r]*?\2>)[ \t]*(?=\n{2,}))/g,a.subParser("hashElement")(e,t,r)),e=r.converter._dispatch("hashHTMLBlocks.after",e,t,r)})),a.subParser("hashHTMLSpans",(function(e,t,r){function n(e){return"¨C"+(r.gHtmlSpans.push(e)-1)+"C"}return e=(e=(e=(e=(e=r.converter._dispatch("hashHTMLSpans.before",e,t,r)).replace(/<[^>]+?\/>/gi,(function(e){return n(e)}))).replace(/<([^>]+?)>[\s\S]*?<\/\1>/g,(function(e){return n(e)}))).replace(/<([^>]+?)\s[^>]+?>[\s\S]*?<\/\1>/g,(function(e){return n(e)}))).replace(/<[^>]+?>/gi,(function(e){return n(e)})),e=r.converter._dispatch("hashHTMLSpans.after",e,t,r)})),a.subParser("unhashHTMLSpans",(function(e,t,r){e=r.converter._dispatch("unhashHTMLSpans.before",e,t,r);for(var n=0;n<r.gHtmlSpans.length;++n){for(var o=r.gHtmlSpans[n],a=0;/¨C(\d+)C/.test(o);){var i=RegExp.$1;if(o=o.replace("¨C"+i+"C",r.gHtmlSpans[i]),10===a){console.error("maximum nesting of 10 spans reached!!!");break}++a}e=e.replace("¨C"+n+"C",o)}return e=r.converter._dispatch("unhashHTMLSpans.after",e,t,r)})),a.subParser("hashPreCodeTags",(function(e,t,r){e=r.converter._dispatch("hashPreCodeTags.before",e,t,r);return e=a.helper.replaceRecursiveRegExp(e,(function(e,n,o,i){var s=o+a.subParser("encodeCode")(n,t,r)+i;return"\n\n¨G"+(r.ghCodeBlocks.push({text:e,codeblock:s})-1)+"G\n\n"}),"^ {0,3}<pre\\b[^>]*>\\s*<code\\b[^>]*>","^ {0,3}</code>\\s*</pre>","gim"),e=r.converter._dispatch("hashPreCodeTags.after",e,t,r)})),a.subParser("headers",(function(e,t,r){e=r.converter._dispatch("headers.before",e,t,r);var n=isNaN(parseInt(t.headerLevelStart))?1:parseInt(t.headerLevelStart),o=t.smoothLivePreview?/^(.+)[ \t]*\n={2,}[ \t]*\n+/gm:/^(.+)[ \t]*\n=+[ \t]*\n+/gm,i=t.smoothLivePreview?/^(.+)[ \t]*\n-{2,}[ \t]*\n+/gm:/^(.+)[ \t]*\n-+[ \t]*\n+/gm;e=(e=e.replace(o,(function(e,o){var i=a.subParser("spanGamut")(o,t,r),s=t.noHeaderId?"":' id="'+c(o)+'"',l="<h"+n+s+">"+i+"</h"+n+">";return a.subParser("hashBlock")(l,t,r)}))).replace(i,(function(e,o){var i=a.subParser("spanGamut")(o,t,r),s=t.noHeaderId?"":' id="'+c(o)+'"',l=n+1,u="<h"+l+s+">"+i+"</h"+l+">";return a.subParser("hashBlock")(u,t,r)}));var s=t.requireSpaceBeforeHeadingText?/^(#{1,6})[ \t]+(.+?)[ \t]*#*\n+/gm:/^(#{1,6})[ \t]*(.+?)[ \t]*#*\n+/gm;function c(e){var n,o;if(t.customizedHeaderId){var i=e.match(/\{([^{]+?)}\s*$/);i&&i[1]&&(e=i[1])}return n=e,o=a.helper.isString(t.prefixHeaderId)?t.prefixHeaderId:!0===t.prefixHeaderId?"section-":"",t.rawPrefixHeaderId||(n=o+n),n=t.ghCompatibleHeaderId?n.replace(/ /g,"-").replace(/&amp;/g,"").replace(/¨T/g,"").replace(/¨D/g,"").replace(/[&+$,\/:;=?@"#{}|^¨~\[\]`\\*)(%.!'<>]/g,"").toLowerCase():t.rawHeaderId?n.replace(/ /g,"-").replace(/&amp;/g,"&").replace(/¨T/g,"¨").replace(/¨D/g,"$").replace(/["']/g,"-").toLowerCase():n.replace(/[^\w]/g,"").toLowerCase(),t.rawPrefixHeaderId&&(n=o+n),r.hashLinkCounts[n]?n=n+"-"+r.hashLinkCounts[n]++:r.hashLinkCounts[n]=1,n}return e=e.replace(s,(function(e,o,i){var s=i;t.customizedHeaderId&&(s=i.replace(/\s?\{([^{]+?)}\s*$/,""));var l=a.subParser("spanGamut")(s,t,r),u=t.noHeaderId?"":' id="'+c(i)+'"',d=n-1+o.length,p="<h"+d+u+">"+l+"</h"+d+">";return a.subParser("hashBlock")(p,t,r)})),e=r.converter._dispatch("headers.after",e,t,r)})),a.subParser("horizontalRule",(function(e,t,r){e=r.converter._dispatch("horizontalRule.before",e,t,r);var n=a.subParser("hashBlock")("<hr />",t,r);return e=(e=(e=e.replace(/^ {0,2}( ?-){3,}[ \t]*$/gm,n)).replace(/^ {0,2}( ?\*){3,}[ \t]*$/gm,n)).replace(/^ {0,2}( ?_){3,}[ \t]*$/gm,n),e=r.converter._dispatch("horizontalRule.after",e,t,r)})),a.subParser("images",(function(e,t,r){function n(e,t,n,o,i,s,c,l){var u=r.gUrls,d=r.gTitles,p=r.gDimensions;if(n=n.toLowerCase(),l||(l=""),e.search(/\(<?\s*>? ?(['"].*['"])?\)$/m)>-1)o="";else if(""===o||null===o){if(""!==n&&null!==n||(n=t.toLowerCase().replace(/ ?\n/g," ")),o="#"+n,a.helper.isUndefined(u[n]))return e;o=u[n],a.helper.isUndefined(d[n])||(l=d[n]),a.helper.isUndefined(p[n])||(i=p[n].width,s=p[n].height)}t=t.replace(/"/g,"&quot;").replace(a.helper.regexes.asteriskDashAndColon,a.helper.escapeCharactersCallback);var h='<img src="'+(o=o.replace(a.helper.regexes.asteriskDashAndColon,a.helper.escapeCharactersCallback))+'" alt="'+t+'"';return l&&a.helper.isString(l)&&(h+=' title="'+(l=l.replace(/"/g,"&quot;").replace(a.helper.regexes.asteriskDashAndColon,a.helper.escapeCharactersCallback))+'"'),i&&s&&(h+=' width="'+(i="*"===i?"auto":i)+'"',h+=' height="'+(s="*"===s?"auto":s)+'"'),h+=" />"}return e=(e=(e=(e=(e=(e=r.converter._dispatch("images.before",e,t,r)).replace(/!\[([^\]]*?)] ?(?:\n *)?\[([\s\S]*?)]()()()()()/g,n)).replace(/!\[([^\]]*?)][ \t]*()\([ \t]?<?(data:.+?\/.+?;base64,[A-Za-z0-9+/=\n]+?)>?(?: =([*\d]+[A-Za-z%]{0,4})x([*\d]+[A-Za-z%]{0,4}))?[ \t]*(?:(["'])([^"]*?)\6)?[ \t]?\)/g,(function(e,t,r,o,a,i,s,c){return n(e,t,r,o=o.replace(/\s/g,""),a,i,s,c)}))).replace(/!\[([^\]]*?)][ \t]*()\([ \t]?<([^>]*)>(?: =([*\d]+[A-Za-z%]{0,4})x([*\d]+[A-Za-z%]{0,4}))?[ \t]*(?:(?:(["'])([^"]*?)\6))?[ \t]?\)/g,n)).replace(/!\[([^\]]*?)][ \t]*()\([ \t]?<?([\S]+?(?:\([\S]*?\)[\S]*?)?)>?(?: =([*\d]+[A-Za-z%]{0,4})x([*\d]+[A-Za-z%]{0,4}))?[ \t]*(?:(["'])([^"]*?)\6)?[ \t]?\)/g,n)).replace(/!\[([^\[\]]+)]()()()()()/g,n),e=r.converter._dispatch("images.after",e,t,r)})),a.subParser("italicsAndBold",(function(e,t,r){function n(e,t,r){return t+e+r}return e=r.converter._dispatch("italicsAndBold.before",e,t,r),e=t.literalMidWordUnderscores?(e=(e=e.replace(/\b___(\S[\s\S]*?)___\b/g,(function(e,t){return n(t,"<strong><em>","</em></strong>")}))).replace(/\b__(\S[\s\S]*?)__\b/g,(function(e,t){return n(t,"<strong>","</strong>")}))).replace(/\b_(\S[\s\S]*?)_\b/g,(function(e,t){return n(t,"<em>","</em>")})):(e=(e=e.replace(/___(\S[\s\S]*?)___/g,(function(e,t){return/\S$/.test(t)?n(t,"<strong><em>","</em></strong>"):e}))).replace(/__(\S[\s\S]*?)__/g,(function(e,t){return/\S$/.test(t)?n(t,"<strong>","</strong>"):e}))).replace(/_([^\s_][\s\S]*?)_/g,(function(e,t){return/\S$/.test(t)?n(t,"<em>","</em>"):e})),e=t.literalMidWordAsterisks?(e=(e=e.replace(/([^*]|^)\B\*\*\*(\S[\s\S]*?)\*\*\*\B(?!\*)/g,(function(e,t,r){return n(r,t+"<strong><em>","</em></strong>")}))).replace(/([^*]|^)\B\*\*(\S[\s\S]*?)\*\*\B(?!\*)/g,(function(e,t,r){return n(r,t+"<strong>","</strong>")}))).replace(/([^*]|^)\B\*(\S[\s\S]*?)\*\B(?!\*)/g,(function(e,t,r){return n(r,t+"<em>","</em>")})):(e=(e=e.replace(/\*\*\*(\S[\s\S]*?)\*\*\*/g,(function(e,t){return/\S$/.test(t)?n(t,"<strong><em>","</em></strong>"):e}))).replace(/\*\*(\S[\s\S]*?)\*\*/g,(function(e,t){return/\S$/.test(t)?n(t,"<strong>","</strong>"):e}))).replace(/\*([^\s*][\s\S]*?)\*/g,(function(e,t){return/\S$/.test(t)?n(t,"<em>","</em>"):e})),e=r.converter._dispatch("italicsAndBold.after",e,t,r)})),a.subParser("lists",(function(e,t,r){function n(e,n){r.gListLevel++,e=e.replace(/\n{2,}$/,"\n");var o=/(\n)?(^ {0,3})([*+-]|\d+[.])[ \t]+((\[(x|X| )?])?[ \t]*[^\r]+?(\n{1,2}))(?=\n*(¨0| {0,3}([*+-]|\d+[.])[ \t]+))/gm,i=/\n[ \t]*\n(?!¨0)/.test(e+="¨0");return t.disableForced4SpacesIndentedSublists&&(o=/(\n)?(^ {0,3})([*+-]|\d+[.])[ \t]+((\[(x|X| )?])?[ \t]*[^\r]+?(\n{1,2}))(?=\n*(¨0|\2([*+-]|\d+[.])[ \t]+))/gm),e=(e=e.replace(o,(function(e,n,o,s,c,l,u){u=u&&""!==u.trim();var d=a.subParser("outdent")(c,t,r),p="";return l&&t.tasklists&&(p=' class="task-list-item" style="list-style-type: none;"',d=d.replace(/^[ \t]*\[(x|X| )?]/m,(function(){var e='<input type="checkbox" disabled style="margin: 0px 0.35em 0.25em -1.6em; vertical-align: middle;"';return u&&(e+=" checked"),e+=">"}))),d=d.replace(/^([-*+]|\d\.)[ \t]+[\S\n ]*/g,(function(e){return"¨A"+e})),n||d.search(/\n{2,}/)>-1?(d=a.subParser("githubCodeBlocks")(d,t,r),d=a.subParser("blockGamut")(d,t,r)):(d=(d=a.subParser("lists")(d,t,r)).replace(/\n$/,""),d=(d=a.subParser("hashHTMLBlocks")(d,t,r)).replace(/\n\n+/g,"\n\n"),d=i?a.subParser("paragraphs")(d,t,r):a.subParser("spanGamut")(d,t,r)),d="<li"+p+">"+(d=d.replace("¨A",""))+"</li>\n"}))).replace(/¨0/g,""),r.gListLevel--,n&&(e=e.replace(/\s+$/,"")),e}function o(e,t){if("ol"===t){var r=e.match(/^ *(\d+)\./);if(r&&"1"!==r[1])return' start="'+r[1]+'"'}return""}function i(e,r,a){var i=t.disableForced4SpacesIndentedSublists?/^ ?\d+\.[ \t]/gm:/^ {0,3}\d+\.[ \t]/gm,s=t.disableForced4SpacesIndentedSublists?/^ ?[*+-][ \t]/gm:/^ {0,3}[*+-][ \t]/gm,c="ul"===r?i:s,l="";if(-1!==e.search(c))!function t(u){var d=u.search(c),p=o(e,r);-1!==d?(l+="\n\n<"+r+p+">\n"+n(u.slice(0,d),!!a)+"</"+r+">\n",c="ul"===(r="ul"===r?"ol":"ul")?i:s,t(u.slice(d))):l+="\n\n<"+r+p+">\n"+n(u,!!a)+"</"+r+">\n"}(e);else{var u=o(e,r);l="\n\n<"+r+u+">\n"+n(e,!!a)+"</"+r+">\n"}return l}return e=r.converter._dispatch("lists.before",e,t,r),e+="¨0",e=(e=r.gListLevel?e.replace(/^(( {0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(¨0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm,(function(e,t,r){return i(t,r.search(/[*+-]/g)>-1?"ul":"ol",!0)})):e.replace(/(\n\n|^\n?)(( {0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(¨0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm,(function(e,t,r,n){return i(r,n.search(/[*+-]/g)>-1?"ul":"ol",!1)}))).replace(/¨0/,""),e=r.converter._dispatch("lists.after",e,t,r)})),a.subParser("metadata",(function(e,t,r){if(!t.metadata)return e;function n(e){r.metadata.raw=e,(e=(e=e.replace(/&/g,"&amp;").replace(/"/g,"&quot;")).replace(/\n {4}/g," ")).replace(/^([\S ]+): +([\s\S]+?)$/gm,(function(e,t,n){return r.metadata.parsed[t]=n,""}))}return e=(e=(e=r.converter._dispatch("metadata.before",e,t,r)).replace(/^\s*«««+(\S*?)\n([\s\S]+?)\n»»»+\n/,(function(e,t,r){return n(r),"¨M"}))).replace(/^\s*---+(\S*?)\n([\s\S]+?)\n---+\n/,(function(e,t,o){return t&&(r.metadata.format=t),n(o),"¨M"})),e=e.replace(/¨M/g,""),e=r.converter._dispatch("metadata.after",e,t,r)})),a.subParser("outdent",(function(e,t,r){return e=(e=(e=r.converter._dispatch("outdent.before",e,t,r)).replace(/^(\t|[ ]{1,4})/gm,"¨0")).replace(/¨0/g,""),e=r.converter._dispatch("outdent.after",e,t,r)})),a.subParser("paragraphs",(function(e,t,r){for(var n=(e=(e=(e=r.converter._dispatch("paragraphs.before",e,t,r)).replace(/^\n+/g,"")).replace(/\n+$/g,"")).split(/\n{2,}/g),o=[],i=n.length,s=0;s<i;s++){var c=n[s];c.search(/¨(K|G)(\d+)\1/g)>=0?o.push(c):c.search(/\S/)>=0&&(c=(c=a.subParser("spanGamut")(c,t,r)).replace(/^([ \t]*)/g,"<p>"),c+="</p>",o.push(c))}for(i=o.length,s=0;s<i;s++){for(var l="",u=o[s],d=!1;/¨(K|G)(\d+)\1/.test(u);){var p=RegExp.$1,h=RegExp.$2;l=(l="K"===p?r.gHtmlBlocks[h]:d?a.subParser("encodeCode")(r.ghCodeBlocks[h].text,t,r):r.ghCodeBlocks[h].codeblock).replace(/\$/g,"$$$$"),u=u.replace(/(\n\n)?¨(K|G)\d+\2(\n\n)?/,l),/^<pre\b[^>]*>\s*<code\b[^>]*>/.test(u)&&(d=!0)}o[s]=u}return e=(e=(e=o.join("\n")).replace(/^\n+/g,"")).replace(/\n+$/g,""),r.converter._dispatch("paragraphs.after",e,t,r)})),a.subParser("runExtension",(function(e,t,r,n){if(e.filter)t=e.filter(t,n.converter,r);else if(e.regex){var o=e.regex;o instanceof RegExp||(o=new RegExp(o,"g")),t=t.replace(o,e.replace)}return t})),a.subParser("spanGamut",(function(e,t,r){return e=r.converter._dispatch("spanGamut.before",e,t,r),e=a.subParser("codeSpans")(e,t,r),e=a.subParser("escapeSpecialCharsWithinTagAttributes")(e,t,r),e=a.subParser("encodeBackslashEscapes")(e,t,r),e=a.subParser("images")(e,t,r),e=a.subParser("anchors")(e,t,r),e=a.subParser("autoLinks")(e,t,r),e=a.subParser("simplifiedAutoLinks")(e,t,r),e=a.subParser("emoji")(e,t,r),e=a.subParser("underline")(e,t,r),e=a.subParser("italicsAndBold")(e,t,r),e=a.subParser("strikethrough")(e,t,r),e=a.subParser("ellipsis")(e,t,r),e=a.subParser("hashHTMLSpans")(e,t,r),e=a.subParser("encodeAmpsAndAngles")(e,t,r),t.simpleLineBreaks?/\n\n¨K/.test(e)||(e=e.replace(/\n+/g,"<br />\n")):e=e.replace(/  +\n/g,"<br />\n"),e=r.converter._dispatch("spanGamut.after",e,t,r)})),a.subParser("strikethrough",(function(e,t,r){return t.strikethrough&&(e=(e=r.converter._dispatch("strikethrough.before",e,t,r)).replace(/(?:~){2}([\s\S]+?)(?:~){2}/g,(function(e,n){return function(e){return t.simplifiedAutoLink&&(e=a.subParser("simplifiedAutoLinks")(e,t,r)),"<del>"+e+"</del>"}(n)})),e=r.converter._dispatch("strikethrough.after",e,t,r)),e})),a.subParser("stripLinkDefinitions",(function(e,t,r){var n=function(n,o,i,s,c,l,u){return o=o.toLowerCase(),e.toLowerCase().split(o).length-1<2?n:(i.match(/^data:.+?\/.+?;base64,/)?r.gUrls[o]=i.replace(/\s/g,""):r.gUrls[o]=a.subParser("encodeAmpsAndAngles")(i,t,r),l?l+u:(u&&(r.gTitles[o]=u.replace(/"|'/g,"&quot;")),t.parseImgDimensions&&s&&c&&(r.gDimensions[o]={width:s,height:c}),""))};return e=(e=(e=(e+="¨0").replace(/^ {0,3}\[([^\]]+)]:[ \t]*\n?[ \t]*<?(data:.+?\/.+?;base64,[A-Za-z0-9+/=\n]+?)>?(?: =([*\d]+[A-Za-z%]{0,4})x([*\d]+[A-Za-z%]{0,4}))?[ \t]*\n?[ \t]*(?:(\n*)["|'(](.+?)["|')][ \t]*)?(?:\n\n|(?=¨0)|(?=\n\[))/gm,n)).replace(/^ {0,3}\[([^\]]+)]:[ \t]*\n?[ \t]*<?([^>\s]+)>?(?: =([*\d]+[A-Za-z%]{0,4})x([*\d]+[A-Za-z%]{0,4}))?[ \t]*\n?[ \t]*(?:(\n*)["|'(](.+?)["|')][ \t]*)?(?:\n+|(?=¨0))/gm,n)).replace(/¨0/,"")})),a.subParser("tables",(function(e,t,r){if(!t.tables)return e;function n(e,n){return"<td"+n+">"+a.subParser("spanGamut")(e,t,r)+"</td>\n"}function o(e){var o,i=e.split("\n");for(o=0;o<i.length;++o)/^ {0,3}\|/.test(i[o])&&(i[o]=i[o].replace(/^ {0,3}\|/,"")),/\|[ \t]*$/.test(i[o])&&(i[o]=i[o].replace(/\|[ \t]*$/,"")),i[o]=a.subParser("codeSpans")(i[o],t,r);var s,c,l,u,d=i[0].split("|").map((function(e){return e.trim()})),p=i[1].split("|").map((function(e){return e.trim()})),h=[],f=[],m=[],g=[];for(i.shift(),i.shift(),o=0;o<i.length;++o)""!==i[o].trim()&&h.push(i[o].split("|").map((function(e){return e.trim()})));if(d.length<p.length)return e;for(o=0;o<p.length;++o)m.push((s=p[o],/^:[ \t]*--*$/.test(s)?' style="text-align:left;"':/^--*[ \t]*:[ \t]*$/.test(s)?' style="text-align:right;"':/^:[ \t]*--*[ \t]*:$/.test(s)?' style="text-align:center;"':""));for(o=0;o<d.length;++o)a.helper.isUndefined(m[o])&&(m[o]=""),f.push((c=d[o],l=m[o],u=void 0,u="",c=c.trim(),(t.tablesHeaderId||t.tableHeaderId)&&(u=' id="'+c.replace(/ /g,"_").toLowerCase()+'"'),"<th"+u+l+">"+(c=a.subParser("spanGamut")(c,t,r))+"</th>\n"));for(o=0;o<h.length;++o){for(var b=[],v=0;v<f.length;++v)a.helper.isUndefined(h[o][v]),b.push(n(h[o][v],m[v]));g.push(b)}return function(e,t){for(var r="<table>\n<thead>\n<tr>\n",n=e.length,o=0;o<n;++o)r+=e[o];for(r+="</tr>\n</thead>\n<tbody>\n",o=0;o<t.length;++o){r+="<tr>\n";for(var a=0;a<n;++a)r+=t[o][a];r+="</tr>\n"}return r+"</tbody>\n</table>\n"}(f,g)}return e=(e=(e=(e=r.converter._dispatch("tables.before",e,t,r)).replace(/\\(\|)/g,a.helper.escapeCharactersCallback)).replace(/^ {0,3}\|?.+\|.+\n {0,3}\|?[ \t]*:?[ \t]*(?:[-=]){2,}[ \t]*:?[ \t]*\|[ \t]*:?[ \t]*(?:[-=]){2,}[\s\S]+?(?:\n\n|¨0)/gm,o)).replace(/^ {0,3}\|.+\|[ \t]*\n {0,3}\|[ \t]*:?[ \t]*(?:[-=]){2,}[ \t]*:?[ \t]*\|[ \t]*\n( {0,3}\|.+\|[ \t]*\n)*(?:\n|¨0)/gm,o),e=r.converter._dispatch("tables.after",e,t,r)})),a.subParser("underline",(function(e,t,r){return t.underline?(e=r.converter._dispatch("underline.before",e,t,r),e=(e=t.literalMidWordUnderscores?(e=e.replace(/\b___(\S[\s\S]*?)___\b/g,(function(e,t){return"<u>"+t+"</u>"}))).replace(/\b__(\S[\s\S]*?)__\b/g,(function(e,t){return"<u>"+t+"</u>"})):(e=e.replace(/___(\S[\s\S]*?)___/g,(function(e,t){return/\S$/.test(t)?"<u>"+t+"</u>":e}))).replace(/__(\S[\s\S]*?)__/g,(function(e,t){return/\S$/.test(t)?"<u>"+t+"</u>":e}))).replace(/(_)/g,a.helper.escapeCharactersCallback),e=r.converter._dispatch("underline.after",e,t,r)):e})),a.subParser("unescapeSpecialChars",(function(e,t,r){return e=(e=r.converter._dispatch("unescapeSpecialChars.before",e,t,r)).replace(/¨E(\d+)E/g,(function(e,t){var r=parseInt(t);return String.fromCharCode(r)})),e=r.converter._dispatch("unescapeSpecialChars.after",e,t,r)})),a.subParser("makeMarkdown.blockquote",(function(e,t){var r="";if(e.hasChildNodes())for(var n=e.childNodes,o=n.length,i=0;i<o;++i){var s=a.subParser("makeMarkdown.node")(n[i],t);""!==s&&(r+=s)}return r="> "+(r=r.trim()).split("\n").join("\n> ")})),a.subParser("makeMarkdown.codeBlock",(function(e,t){var r=e.getAttribute("language"),n=e.getAttribute("precodenum");return"```"+r+"\n"+t.preList[n]+"\n```"})),a.subParser("makeMarkdown.codeSpan",(function(e){return"`"+e.innerHTML+"`"})),a.subParser("makeMarkdown.emphasis",(function(e,t){var r="";if(e.hasChildNodes()){r+="*";for(var n=e.childNodes,o=n.length,i=0;i<o;++i)r+=a.subParser("makeMarkdown.node")(n[i],t);r+="*"}return r})),a.subParser("makeMarkdown.header",(function(e,t,r){var n=new Array(r+1).join("#"),o="";if(e.hasChildNodes()){o=n+" ";for(var i=e.childNodes,s=i.length,c=0;c<s;++c)o+=a.subParser("makeMarkdown.node")(i[c],t)}return o})),a.subParser("makeMarkdown.hr",(function(){return"---"})),a.subParser("makeMarkdown.image",(function(e){var t="";return e.hasAttribute("src")&&(t+="!["+e.getAttribute("alt")+"](",t+="<"+e.getAttribute("src")+">",e.hasAttribute("width")&&e.hasAttribute("height")&&(t+=" ="+e.getAttribute("width")+"x"+e.getAttribute("height")),e.hasAttribute("title")&&(t+=' "'+e.getAttribute("title")+'"'),t+=")"),t})),a.subParser("makeMarkdown.links",(function(e,t){var r="";if(e.hasChildNodes()&&e.hasAttribute("href")){var n=e.childNodes,o=n.length;r="[";for(var i=0;i<o;++i)r+=a.subParser("makeMarkdown.node")(n[i],t);r+="](",r+="<"+e.getAttribute("href")+">",e.hasAttribute("title")&&(r+=' "'+e.getAttribute("title")+'"'),r+=")"}return r})),a.subParser("makeMarkdown.list",(function(e,t,r){var n="";if(!e.hasChildNodes())return"";for(var o=e.childNodes,i=o.length,s=e.getAttribute("start")||1,c=0;c<i;++c)if(void 0!==o[c].tagName&&"li"===o[c].tagName.toLowerCase()){n+=("ol"===r?s.toString()+". ":"- ")+a.subParser("makeMarkdown.listItem")(o[c],t),++s}return(n+="\n\x3c!-- --\x3e\n").trim()})),a.subParser("makeMarkdown.listItem",(function(e,t){for(var r="",n=e.childNodes,o=n.length,i=0;i<o;++i)r+=a.subParser("makeMarkdown.node")(n[i],t);return/\n$/.test(r)?r=r.split("\n").join("\n    ").replace(/^ {4}$/gm,"").replace(/\n\n+/g,"\n\n"):r+="\n",r})),a.subParser("makeMarkdown.node",(function(e,t,r){r=r||!1;var n="";if(3===e.nodeType)return a.subParser("makeMarkdown.txt")(e,t);if(8===e.nodeType)return"\x3c!--"+e.data+"--\x3e\n\n";if(1!==e.nodeType)return"";switch(e.tagName.toLowerCase()){case"h1":r||(n=a.subParser("makeMarkdown.header")(e,t,1)+"\n\n");break;case"h2":r||(n=a.subParser("makeMarkdown.header")(e,t,2)+"\n\n");break;case"h3":r||(n=a.subParser("makeMarkdown.header")(e,t,3)+"\n\n");break;case"h4":r||(n=a.subParser("makeMarkdown.header")(e,t,4)+"\n\n");break;case"h5":r||(n=a.subParser("makeMarkdown.header")(e,t,5)+"\n\n");break;case"h6":r||(n=a.subParser("makeMarkdown.header")(e,t,6)+"\n\n");break;case"p":r||(n=a.subParser("makeMarkdown.paragraph")(e,t)+"\n\n");break;case"blockquote":r||(n=a.subParser("makeMarkdown.blockquote")(e,t)+"\n\n");break;case"hr":r||(n=a.subParser("makeMarkdown.hr")(e,t)+"\n\n");break;case"ol":r||(n=a.subParser("makeMarkdown.list")(e,t,"ol")+"\n\n");break;case"ul":r||(n=a.subParser("makeMarkdown.list")(e,t,"ul")+"\n\n");break;case"precode":r||(n=a.subParser("makeMarkdown.codeBlock")(e,t)+"\n\n");break;case"pre":r||(n=a.subParser("makeMarkdown.pre")(e,t)+"\n\n");break;case"table":r||(n=a.subParser("makeMarkdown.table")(e,t)+"\n\n");break;case"code":n=a.subParser("makeMarkdown.codeSpan")(e,t);break;case"em":case"i":n=a.subParser("makeMarkdown.emphasis")(e,t);break;case"strong":case"b":n=a.subParser("makeMarkdown.strong")(e,t);break;case"del":n=a.subParser("makeMarkdown.strikethrough")(e,t);break;case"a":n=a.subParser("makeMarkdown.links")(e,t);break;case"img":n=a.subParser("makeMarkdown.image")(e,t);break;default:n=e.outerHTML+"\n\n"}return n})),a.subParser("makeMarkdown.paragraph",(function(e,t){var r="";if(e.hasChildNodes())for(var n=e.childNodes,o=n.length,i=0;i<o;++i)r+=a.subParser("makeMarkdown.node")(n[i],t);return r=r.trim()})),a.subParser("makeMarkdown.pre",(function(e,t){var r=e.getAttribute("prenum");return"<pre>"+t.preList[r]+"</pre>"})),a.subParser("makeMarkdown.strikethrough",(function(e,t){var r="";if(e.hasChildNodes()){r+="~~";for(var n=e.childNodes,o=n.length,i=0;i<o;++i)r+=a.subParser("makeMarkdown.node")(n[i],t);r+="~~"}return r})),a.subParser("makeMarkdown.strong",(function(e,t){var r="";if(e.hasChildNodes()){r+="**";for(var n=e.childNodes,o=n.length,i=0;i<o;++i)r+=a.subParser("makeMarkdown.node")(n[i],t);r+="**"}return r})),a.subParser("makeMarkdown.table",(function(e,t){var r,n,o="",i=[[],[]],s=e.querySelectorAll("thead>tr>th"),c=e.querySelectorAll("tbody>tr");for(r=0;r<s.length;++r){var l=a.subParser("makeMarkdown.tableCell")(s[r],t),u="---";if(s[r].hasAttribute("style"))switch(s[r].getAttribute("style").toLowerCase().replace(/\s/g,"")){case"text-align:left;":u=":---";break;case"text-align:right;":u="---:";break;case"text-align:center;":u=":---:"}i[0][r]=l.trim(),i[1][r]=u}for(r=0;r<c.length;++r){var d=i.push([])-1,p=c[r].getElementsByTagName("td");for(n=0;n<s.length;++n){var h=" ";void 0!==p[n]&&(h=a.subParser("makeMarkdown.tableCell")(p[n],t)),i[d].push(h)}}var f=3;for(r=0;r<i.length;++r)for(n=0;n<i[r].length;++n){var m=i[r][n].length;m>f&&(f=m)}for(r=0;r<i.length;++r){for(n=0;n<i[r].length;++n)1===r?":"===i[r][n].slice(-1)?i[r][n]=a.helper.padEnd(i[r][n].slice(-1),f-1,"-")+":":i[r][n]=a.helper.padEnd(i[r][n],f,"-"):i[r][n]=a.helper.padEnd(i[r][n],f);o+="| "+i[r].join(" | ")+" |\n"}return o.trim()})),a.subParser("makeMarkdown.tableCell",(function(e,t){var r="";if(!e.hasChildNodes())return"";for(var n=e.childNodes,o=n.length,i=0;i<o;++i)r+=a.subParser("makeMarkdown.node")(n[i],t,!0);return r.trim()})),a.subParser("makeMarkdown.txt",(function(e){var t=e.nodeValue;return t=(t=t.replace(/ +/g," ")).replace(/¨NBSP;/g," "),t=(t=(t=(t=(t=(t=(t=(t=(t=a.helper.unescapeHTMLEntities(t)).replace(/([*_~|`])/g,"\\$1")).replace(/^(\s*)>/g,"\\$1>")).replace(/^#/gm,"\\#")).replace(/^(\s*)([-=]{3,})(\s*)$/,"$1\\$2$3")).replace(/^( {0,3}\d+)\./gm,"$1\\.")).replace(/^( {0,3})([+-])/gm,"$1\\$2")).replace(/]([\s]*)\(/g,"\\]$1\\(")).replace(/^ {0,3}\[([\S \t]*?)]:/gm,"\\[$1]:")}));void 0===(n=function(){return a}.call(t,r,t,e))||(e.exports=n)}).call(this)}},h={};function f(e){var t=h[e];if(void 0!==t)return t.exports;var r=h[e]={exports:{}};return p[e].call(r.exports,r,r.exports,f),r.exports}f.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return f.d(t,{a:t}),t},f.d=(e,t)=>{for(var r in t)f.o(t,r)&&!f.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},f.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);Error;function m(e){return Array.isArray?Array.isArray(e):"[object Array]"===x(e)}function g(e){return"string"==typeof e}function b(e){return"number"==typeof e}function v(e){return!0===e||!1===e||function(e){return _(e)&&null!==e}(e)&&"[object Boolean]"==x(e)}function _(e){return"object"==typeof e}function w(e){return null!=e}function y(e){return!e.trim().length}function x(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":Object.prototype.toString.call(e)}const k=Object.prototype.hasOwnProperty;class E{constructor(e){this._keys=[],this._keyMap={};let t=0;e.forEach((e=>{let r=P(e);this._keys.push(r),this._keyMap[r.id]=r,t+=r.weight})),this._keys.forEach((e=>{e.weight/=t}))}get(e){return this._keyMap[e]}keys(){return this._keys}toJSON(){return JSON.stringify(this._keys)}}function P(e){let t=null,r=null,n=null,o=1,a=null;if(g(e)||m(e))n=e,t=S(e),r=A(e);else{if(!k.call(e,"name"))throw new Error((e=>`Missing ${e} property in key`)("name"));const i=e.name;if(n=i,k.call(e,"weight")&&(o=e.weight,o<=0))throw new Error((e=>`Property 'weight' in key '${e}' must be a positive integer`)(i));t=S(i),r=A(i),a=e.getFn}return{path:t,id:r,weight:o,src:n,getFn:a}}function S(e){return m(e)?e:e.split(".")}function A(e){return m(e)?e.join("."):e}var C={isCaseSensitive:!1,ignoreDiacritics:!1,includeScore:!1,keys:[],shouldSort:!0,sortFn:(e,t)=>e.score===t.score?e.idx<t.idx?-1:1:e.score<t.score?-1:1,includeMatches:!1,findAllMatches:!1,minMatchCharLength:1,location:0,threshold:.6,distance:100,...{useExtendedSearch:!1,getFn:function(e,t){let r=[],n=!1;const o=(e,t,a)=>{if(w(e))if(t[a]){const i=e[t[a]];if(!w(i))return;if(a===t.length-1&&(g(i)||b(i)||v(i)))r.push(function(e){return null==e?"":function(e){if("string"==typeof e)return e;let t=e+"";return"0"==t&&1/e==-1/0?"-0":t}(e)}(i));else if(m(i)){n=!0;for(let e=0,r=i.length;e<r;e+=1)o(i[e],t,a+1)}else t.length&&o(i,t,a+1)}else r.push(e)};return o(e,g(t)?t.split("."):t,0),n?r:r[0]},ignoreLocation:!1,ignoreFieldNorm:!1,fieldNormWeight:1}};const I=/[^ ]+/g;class N{constructor({getFn:e=C.getFn,fieldNormWeight:t=C.fieldNormWeight}={}){this.norm=function(e=1,t=3){const r=new Map,n=Math.pow(10,t);return{get(t){const o=t.match(I).length;if(r.has(o))return r.get(o);const a=1/Math.pow(o,.5*e),i=parseFloat(Math.round(a*n)/n);return r.set(o,i),i},clear(){r.clear()}}}(t,3),this.getFn=e,this.isCreated=!1,this.setIndexRecords()}setSources(e=[]){this.docs=e}setIndexRecords(e=[]){this.records=e}setKeys(e=[]){this.keys=e,this._keysMap={},e.forEach(((e,t)=>{this._keysMap[e.id]=t}))}create(){!this.isCreated&&this.docs.length&&(this.isCreated=!0,g(this.docs[0])?this.docs.forEach(((e,t)=>{this._addString(e,t)})):this.docs.forEach(((e,t)=>{this._addObject(e,t)})),this.norm.clear())}add(e){const t=this.size();g(e)?this._addString(e,t):this._addObject(e,t)}removeAt(e){this.records.splice(e,1);for(let t=e,r=this.size();t<r;t+=1)this.records[t].i-=1}getValueForItemAtKeyId(e,t){return e[this._keysMap[t]]}size(){return this.records.length}_addString(e,t){if(!w(e)||y(e))return;let r={v:e,i:t,n:this.norm.get(e)};this.records.push(r)}_addObject(e,t){let r={i:t,$:{}};this.keys.forEach(((t,n)=>{let o=t.getFn?t.getFn(e):this.getFn(e,t.path);if(w(o))if(m(o)){let e=[];const t=[{nestedArrIndex:-1,value:o}];for(;t.length;){const{nestedArrIndex:r,value:n}=t.pop();if(w(n))if(g(n)&&!y(n)){let t={v:n,i:r,n:this.norm.get(n)};e.push(t)}else m(n)&&n.forEach(((e,r)=>{t.push({nestedArrIndex:r,value:e})}))}r.$[n]=e}else if(g(o)&&!y(o)){let e={v:o,n:this.norm.get(o)};r.$[n]=e}})),this.records.push(r)}toJSON(){return{keys:this.keys,records:this.records}}}function T(e,t,{getFn:r=C.getFn,fieldNormWeight:n=C.fieldNormWeight}={}){const o=new N({getFn:r,fieldNormWeight:n});return o.setKeys(e.map(P)),o.setSources(t),o.create(),o}function j(e,{errors:t=0,currentLocation:r=0,expectedLocation:n=0,distance:o=C.distance,ignoreLocation:a=C.ignoreLocation}={}){const i=t/e.length;if(a)return i;const s=Math.abs(n-r);return o?i+s/o:s?1:i}const L=32;function M(e,t,r,{location:n=C.location,distance:o=C.distance,threshold:a=C.threshold,findAllMatches:i=C.findAllMatches,minMatchCharLength:s=C.minMatchCharLength,includeMatches:c=C.includeMatches,ignoreLocation:l=C.ignoreLocation}={}){if(t.length>L)throw new Error(`Pattern length exceeds max of ${L}.`);const u=t.length,d=e.length,p=Math.max(0,Math.min(n,d));let h=a,f=p;const m=s>1||c,g=m?Array(d):[];let b;for(;(b=e.indexOf(t,f))>-1;){let e=j(t,{currentLocation:b,expectedLocation:p,distance:o,ignoreLocation:l});if(h=Math.min(e,h),f=b+u,m){let e=0;for(;e<u;)g[b+e]=1,e+=1}}f=-1;let v=[],_=1,w=u+d;const y=1<<u-1;for(let n=0;n<u;n+=1){let a=0,s=w;for(;a<s;){j(t,{errors:n,currentLocation:p+s,expectedLocation:p,distance:o,ignoreLocation:l})<=h?a=s:w=s,s=Math.floor((w-a)/2+a)}w=s;let c=Math.max(1,p-s+1),b=i?d:Math.min(p+s,d)+u,x=Array(b+2);x[b+1]=(1<<n)-1;for(let a=b;a>=c;a-=1){let i=a-1,s=r[e.charAt(i)];if(m&&(g[i]=+!!s),x[a]=(x[a+1]<<1|1)&s,n&&(x[a]|=(v[a+1]|v[a])<<1|1|v[a+1]),x[a]&y&&(_=j(t,{errors:n,currentLocation:i,expectedLocation:p,distance:o,ignoreLocation:l}),_<=h)){if(h=_,f=i,f<=p)break;c=Math.max(1,2*p-f)}}if(j(t,{errors:n+1,currentLocation:p,expectedLocation:p,distance:o,ignoreLocation:l})>h)break;v=x}const x={isMatch:f>=0,score:Math.max(.001,_)};if(m){const e=function(e=[],t=C.minMatchCharLength){let r=[],n=-1,o=-1,a=0;for(let i=e.length;a<i;a+=1){let i=e[a];i&&-1===n?n=a:i||-1===n||(o=a-1,o-n+1>=t&&r.push([n,o]),n=-1)}return e[a-1]&&a-n>=t&&r.push([n,a-1]),r}(g,s);e.length?c&&(x.indices=e):x.isMatch=!1}return x}function O(e){let t={};for(let r=0,n=e.length;r<n;r+=1){const o=e.charAt(r);t[o]=(t[o]||0)|1<<n-r-1}return t}const D=String.prototype.normalize?e=>e.normalize("NFD").replace(/[\u0300-\u036F\u0483-\u0489\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED\u0711\u0730-\u074A\u07A6-\u07B0\u07EB-\u07F3\u07FD\u0816-\u0819\u081B-\u0823\u0825-\u0827\u0829-\u082D\u0859-\u085B\u08D3-\u08E1\u08E3-\u0903\u093A-\u093C\u093E-\u094F\u0951-\u0957\u0962\u0963\u0981-\u0983\u09BC\u09BE-\u09C4\u09C7\u09C8\u09CB-\u09CD\u09D7\u09E2\u09E3\u09FE\u0A01-\u0A03\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A70\u0A71\u0A75\u0A81-\u0A83\u0ABC\u0ABE-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AE2\u0AE3\u0AFA-\u0AFF\u0B01-\u0B03\u0B3C\u0B3E-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B56\u0B57\u0B62\u0B63\u0B82\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD7\u0C00-\u0C04\u0C3E-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C62\u0C63\u0C81-\u0C83\u0CBC\u0CBE-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CE2\u0CE3\u0D00-\u0D03\u0D3B\u0D3C\u0D3E-\u0D44\u0D46-\u0D48\u0D4A-\u0D4D\u0D57\u0D62\u0D63\u0D82\u0D83\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DF2\u0DF3\u0E31\u0E34-\u0E3A\u0E47-\u0E4E\u0EB1\u0EB4-\u0EB9\u0EBB\u0EBC\u0EC8-\u0ECD\u0F18\u0F19\u0F35\u0F37\u0F39\u0F3E\u0F3F\u0F71-\u0F84\u0F86\u0F87\u0F8D-\u0F97\u0F99-\u0FBC\u0FC6\u102B-\u103E\u1056-\u1059\u105E-\u1060\u1062-\u1064\u1067-\u106D\u1071-\u1074\u1082-\u108D\u108F\u109A-\u109D\u135D-\u135F\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17B4-\u17D3\u17DD\u180B-\u180D\u1885\u1886\u18A9\u1920-\u192B\u1930-\u193B\u1A17-\u1A1B\u1A55-\u1A5E\u1A60-\u1A7C\u1A7F\u1AB0-\u1ABE\u1B00-\u1B04\u1B34-\u1B44\u1B6B-\u1B73\u1B80-\u1B82\u1BA1-\u1BAD\u1BE6-\u1BF3\u1C24-\u1C37\u1CD0-\u1CD2\u1CD4-\u1CE8\u1CED\u1CF2-\u1CF4\u1CF7-\u1CF9\u1DC0-\u1DF9\u1DFB-\u1DFF\u20D0-\u20F0\u2CEF-\u2CF1\u2D7F\u2DE0-\u2DFF\u302A-\u302F\u3099\u309A\uA66F-\uA672\uA674-\uA67D\uA69E\uA69F\uA6F0\uA6F1\uA802\uA806\uA80B\uA823-\uA827\uA880\uA881\uA8B4-\uA8C5\uA8E0-\uA8F1\uA8FF\uA926-\uA92D\uA947-\uA953\uA980-\uA983\uA9B3-\uA9C0\uA9E5\uAA29-\uAA36\uAA43\uAA4C\uAA4D\uAA7B-\uAA7D\uAAB0\uAAB2-\uAAB4\uAAB7\uAAB8\uAABE\uAABF\uAAC1\uAAEB-\uAAEF\uAAF5\uAAF6\uABE3-\uABEA\uABEC\uABED\uFB1E\uFE00-\uFE0F\uFE20-\uFE2F]/g,""):e=>e;class R{constructor(e,{location:t=C.location,threshold:r=C.threshold,distance:n=C.distance,includeMatches:o=C.includeMatches,findAllMatches:a=C.findAllMatches,minMatchCharLength:i=C.minMatchCharLength,isCaseSensitive:s=C.isCaseSensitive,ignoreDiacritics:c=C.ignoreDiacritics,ignoreLocation:l=C.ignoreLocation}={}){if(this.options={location:t,threshold:r,distance:n,includeMatches:o,findAllMatches:a,minMatchCharLength:i,isCaseSensitive:s,ignoreDiacritics:c,ignoreLocation:l},e=s?e:e.toLowerCase(),e=c?D(e):e,this.pattern=e,this.chunks=[],!this.pattern.length)return;const u=(e,t)=>{this.chunks.push({pattern:e,alphabet:O(e),startIndex:t})},d=this.pattern.length;if(d>L){let e=0;const t=d%L,r=d-t;for(;e<r;)u(this.pattern.substr(e,L),e),e+=L;if(t){const e=d-L;u(this.pattern.substr(e),e)}}else u(this.pattern,0)}searchIn(e){const{isCaseSensitive:t,ignoreDiacritics:r,includeMatches:n}=this.options;if(e=t?e:e.toLowerCase(),e=r?D(e):e,this.pattern===e){let t={isMatch:!0,score:0};return n&&(t.indices=[[0,e.length-1]]),t}const{location:o,distance:a,threshold:i,findAllMatches:s,minMatchCharLength:c,ignoreLocation:l}=this.options;let u=[],d=0,p=!1;this.chunks.forEach((({pattern:t,alphabet:r,startIndex:h})=>{const{isMatch:f,score:m,indices:g}=M(e,t,r,{location:o+h,distance:a,threshold:i,findAllMatches:s,minMatchCharLength:c,includeMatches:n,ignoreLocation:l});f&&(p=!0),d+=m,f&&g&&(u=[...u,...g])}));let h={isMatch:p,score:p?d/this.chunks.length:1};return p&&n&&(h.indices=u),h}}class B{constructor(e){this.pattern=e}static isMultiMatch(e){return F(e,this.multiRegex)}static isSingleMatch(e){return F(e,this.singleRegex)}search(){}}function F(e,t){const r=e.match(t);return r?r[1]:null}class z extends B{constructor(e,{location:t=C.location,threshold:r=C.threshold,distance:n=C.distance,includeMatches:o=C.includeMatches,findAllMatches:a=C.findAllMatches,minMatchCharLength:i=C.minMatchCharLength,isCaseSensitive:s=C.isCaseSensitive,ignoreDiacritics:c=C.ignoreDiacritics,ignoreLocation:l=C.ignoreLocation}={}){super(e),this._bitapSearch=new R(e,{location:t,threshold:r,distance:n,includeMatches:o,findAllMatches:a,minMatchCharLength:i,isCaseSensitive:s,ignoreDiacritics:c,ignoreLocation:l})}static get type(){return"fuzzy"}static get multiRegex(){return/^"(.*)"$/}static get singleRegex(){return/^(.*)$/}search(e){return this._bitapSearch.searchIn(e)}}class W extends B{constructor(e){super(e)}static get type(){return"include"}static get multiRegex(){return/^'"(.*)"$/}static get singleRegex(){return/^'(.*)$/}search(e){let t,r=0;const n=[],o=this.pattern.length;for(;(t=e.indexOf(this.pattern,r))>-1;)r=t+o,n.push([t,r-1]);const a=!!n.length;return{isMatch:a,score:a?0:1,indices:n}}}const V=[class extends B{constructor(e){super(e)}static get type(){return"exact"}static get multiRegex(){return/^="(.*)"$/}static get singleRegex(){return/^=(.*)$/}search(e){const t=e===this.pattern;return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}},W,class extends B{constructor(e){super(e)}static get type(){return"prefix-exact"}static get multiRegex(){return/^\^"(.*)"$/}static get singleRegex(){return/^\^(.*)$/}search(e){const t=e.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}},class extends B{constructor(e){super(e)}static get type(){return"inverse-prefix-exact"}static get multiRegex(){return/^!\^"(.*)"$/}static get singleRegex(){return/^!\^(.*)$/}search(e){const t=!e.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},class extends B{constructor(e){super(e)}static get type(){return"inverse-suffix-exact"}static get multiRegex(){return/^!"(.*)"\$$/}static get singleRegex(){return/^!(.*)\$$/}search(e){const t=!e.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},class extends B{constructor(e){super(e)}static get type(){return"suffix-exact"}static get multiRegex(){return/^"(.*)"\$$/}static get singleRegex(){return/^(.*)\$$/}search(e){const t=e.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[e.length-this.pattern.length,e.length-1]}}},class extends B{constructor(e){super(e)}static get type(){return"inverse-exact"}static get multiRegex(){return/^!"(.*)"$/}static get singleRegex(){return/^!(.*)$/}search(e){const t=-1===e.indexOf(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},z],H=V.length,G=/ +(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/;const q=new Set([z.type,W.type]);class U{constructor(e,{isCaseSensitive:t=C.isCaseSensitive,ignoreDiacritics:r=C.ignoreDiacritics,includeMatches:n=C.includeMatches,minMatchCharLength:o=C.minMatchCharLength,ignoreLocation:a=C.ignoreLocation,findAllMatches:i=C.findAllMatches,location:s=C.location,threshold:c=C.threshold,distance:l=C.distance}={}){this.query=null,this.options={isCaseSensitive:t,ignoreDiacritics:r,includeMatches:n,minMatchCharLength:o,findAllMatches:i,ignoreLocation:a,location:s,threshold:c,distance:l},e=t?e:e.toLowerCase(),e=r?D(e):e,this.pattern=e,this.query=function(e,t={}){return e.split("|").map((e=>{let r=e.trim().split(G).filter((e=>e&&!!e.trim())),n=[];for(let e=0,o=r.length;e<o;e+=1){const o=r[e];let a=!1,i=-1;for(;!a&&++i<H;){const e=V[i];let r=e.isMultiMatch(o);r&&(n.push(new e(r,t)),a=!0)}if(!a)for(i=-1;++i<H;){const e=V[i];let r=e.isSingleMatch(o);if(r){n.push(new e(r,t));break}}}return n}))}(this.pattern,this.options)}static condition(e,t){return t.useExtendedSearch}searchIn(e){const t=this.query;if(!t)return{isMatch:!1,score:1};const{includeMatches:r,isCaseSensitive:n,ignoreDiacritics:o}=this.options;e=n?e:e.toLowerCase(),e=o?D(e):e;let a=0,i=[],s=0;for(let n=0,o=t.length;n<o;n+=1){const o=t[n];i.length=0,a=0;for(let t=0,n=o.length;t<n;t+=1){const n=o[t],{isMatch:c,indices:l,score:u}=n.search(e);if(!c){s=0,a=0,i.length=0;break}if(a+=1,s+=u,r){const e=n.constructor.type;q.has(e)?i=[...i,...l]:i.push(l)}}if(a){let e={isMatch:!0,score:s/a};return r&&(e.indices=i),e}}return{isMatch:!1,score:1}}}const K=[];function Y(e,t){for(let r=0,n=K.length;r<n;r+=1){let n=K[r];if(n.condition(e,t))return new n(e,t)}return new R(e,t)}const X="$and",Z="$or",J="$path",Q="$val",ee=e=>!(!e[X]&&!e[Z]),te=e=>({[X]:Object.keys(e).map((t=>({[t]:e[t]})))});function re(e,t,{auto:r=!0}={}){const n=e=>{let o=Object.keys(e);const a=(e=>!!e[J])(e);if(!a&&o.length>1&&!ee(e))return n(te(e));if((e=>!m(e)&&_(e)&&!ee(e))(e)){const n=a?e[J]:o[0],i=a?e[Q]:e[n];if(!g(i))throw new Error((e=>`Invalid value for key ${e}`)(n));const s={keyId:A(n),pattern:i};return r&&(s.searcher=Y(i,t)),s}let i={children:[],operator:o[0]};return o.forEach((t=>{const r=e[t];m(r)&&r.forEach((e=>{i.children.push(n(e))}))})),i};return ee(e)||(e=te(e)),n(e)}function ne(e,t){const r=e.matches;t.matches=[],w(r)&&r.forEach((e=>{if(!w(e.indices)||!e.indices.length)return;const{indices:r,value:n}=e;let o={indices:r,value:n};e.key&&(o.key=e.key.src),e.idx>-1&&(o.refIndex=e.idx),t.matches.push(o)}))}function oe(e,t){t.score=e.score}class ae{constructor(e,t={},r){this.options={...C,...t},this.options.useExtendedSearch,this._keyStore=new E(this.options.keys),this.setCollection(e,r)}setCollection(e,t){if(this._docs=e,t&&!(t instanceof N))throw new Error("Incorrect 'index' type");this._myIndex=t||T(this.options.keys,this._docs,{getFn:this.options.getFn,fieldNormWeight:this.options.fieldNormWeight})}add(e){w(e)&&(this._docs.push(e),this._myIndex.add(e))}remove(e=()=>!1){const t=[];for(let r=0,n=this._docs.length;r<n;r+=1){const o=this._docs[r];e(o,r)&&(this.removeAt(r),r-=1,n-=1,t.push(o))}return t}removeAt(e){this._docs.splice(e,1),this._myIndex.removeAt(e)}getIndex(){return this._myIndex}search(e,{limit:t=-1}={}){const{includeMatches:r,includeScore:n,shouldSort:o,sortFn:a,ignoreFieldNorm:i}=this.options;let s=g(e)?g(this._docs[0])?this._searchStringList(e):this._searchObjectList(e):this._searchLogical(e);return function(e,{ignoreFieldNorm:t=C.ignoreFieldNorm}){e.forEach((e=>{let r=1;e.matches.forEach((({key:e,norm:n,score:o})=>{const a=e?e.weight:null;r*=Math.pow(0===o&&a?Number.EPSILON:o,(a||1)*(t?1:n))})),e.score=r}))}(s,{ignoreFieldNorm:i}),o&&s.sort(a),b(t)&&t>-1&&(s=s.slice(0,t)),function(e,t,{includeMatches:r=C.includeMatches,includeScore:n=C.includeScore}={}){const o=[];return r&&o.push(ne),n&&o.push(oe),e.map((e=>{const{idx:r}=e,n={item:t[r],refIndex:r};return o.length&&o.forEach((t=>{t(e,n)})),n}))}(s,this._docs,{includeMatches:r,includeScore:n})}_searchStringList(e){const t=Y(e,this.options),{records:r}=this._myIndex,n=[];return r.forEach((({v:e,i:r,n:o})=>{if(!w(e))return;const{isMatch:a,score:i,indices:s}=t.searchIn(e);a&&n.push({item:e,idx:r,matches:[{score:i,value:e,norm:o,indices:s}]})})),n}_searchLogical(e){const t=re(e,this.options),r=(e,t,n)=>{if(!e.children){const{keyId:r,searcher:o}=e,a=this._findMatches({key:this._keyStore.get(r),value:this._myIndex.getValueForItemAtKeyId(t,r),searcher:o});return a&&a.length?[{idx:n,item:t,matches:a}]:[]}const o=[];for(let a=0,i=e.children.length;a<i;a+=1){const i=e.children[a],s=r(i,t,n);if(s.length)o.push(...s);else if(e.operator===X)return[]}return o},n=this._myIndex.records,o={},a=[];return n.forEach((({$:e,i:n})=>{if(w(e)){let i=r(t,e,n);i.length&&(o[n]||(o[n]={idx:n,item:e,matches:[]},a.push(o[n])),i.forEach((({matches:e})=>{o[n].matches.push(...e)})))}})),a}_searchObjectList(e){const t=Y(e,this.options),{keys:r,records:n}=this._myIndex,o=[];return n.forEach((({$:e,i:n})=>{if(!w(e))return;let a=[];r.forEach(((r,n)=>{a.push(...this._findMatches({key:r,value:e[n],searcher:t}))})),a.length&&o.push({idx:n,item:e,matches:a})})),o}_findMatches({key:e,value:t,searcher:r}){if(!w(t))return[];let n=[];if(m(t))t.forEach((({v:t,i:o,n:a})=>{if(!w(t))return;const{isMatch:i,score:s,indices:c}=r.searchIn(t);i&&n.push({score:s,key:e,value:t,idx:o,norm:a,indices:c})}));else{const{v:o,n:a}=t,{isMatch:i,score:s,indices:c}=r.searchIn(o);i&&n.push({score:s,key:e,value:o,norm:a,indices:c})}return n}}function ie(e,t={}){const r="string"==typeof e?document.querySelector(e):e;if(!r)throw new Error(`Could not find container: ${e}`);const n=t.placeholderText||"Select items...",o=t.closeOnSelect??!1,a=t.enableSearch??!1,i=t.multiple??!0,s=t.searchPlaceholderText||"Search...",c=t.searchNoResultsText||"No results found",l=t.searchDebounceMs??200;let u=[...t.initialList||[]];r.innerHTML="",r.classList.add("fancy-dropdown-container"),Object.assign(r.style,{position:"relative",userSelect:"none"});const d=document.createElement("div");d.className="fancy-dropdown-trigger",Object.assign(d.style,{padding:"8px 12px",border:"1px solid var(--border-color)",backgroundColor:"var(--bg-color)",color:"var(--text-color)",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"space-between"});const p=document.createElement("span");p.className="fancy-dropdown-trigger-text",p.textContent=n;const h=document.createElement("i");h.className="fas fa-chevron-down",h.style.marginLeft="8px",d.append(p,h),r.append(d);const f=document.createElement("div");f.className="fancy-dropdown-list",Object.assign(f.style,{position:"absolute",top:"100%",left:"0",right:"0",maxHeight:"300px",display:"none",zIndex:"1050",border:"1px solid var(--border-color)",borderTop:"none",backgroundColor:"var(--bg-color-popup, var(--bg-color-secondary, var(--greyCAIbg, var(--grey30))))",color:"var(--text-color)",borderRadius:"0 0 4px 4px",boxShadow:"0 4px 8px var(--black50a)",overflowY:"auto"}),r.append(f);let m=null,g=null,b=null,v=null;a&&(g=document.createElement("div"),g.className="fancy-dropdown-search-wrapper",Object.assign(g.style,{padding:"8px",borderBottom:"1px solid var(--border-color)",position:"sticky",top:"0",backgroundColor:"inherit"}),m=document.createElement("input"),m.type="text",m.className="fancy-dropdown-search-input",m.placeholder=s,Object.assign(m.style,{width:"100%",padding:"6px 10px",border:"1px solid var(--border-color)",borderRadius:"3px",boxSizing:"border-box",backgroundColor:"var(--bg-color)",color:"var(--text-color)"}),m.addEventListener("click",(e=>e.stopPropagation())),g.append(m),f.append(g),b=document.createElement("div"),b.className="fancy-dropdown-no-results",b.textContent=c,Object.assign(b.style,{padding:"8px 12px",textAlign:"center",color:"var(--text-color-secondary, var(--grey50))",display:"none"}),f.append(b));let _=!1,w=null;const y=e=>"string"==typeof e?e:e.label,x=e=>"string"==typeof e?e:e.value;let k=(t.initialValues||[]).filter((e=>u.some((t=>x(t)===e))));const E=()=>{if(!a)return;const e={includeScore:!1,threshold:.4,isCaseSensitive:!1,findAllMatches:!0,...t.searchFuseOptions||{},keys:t.searchFuseOptions?.keys||[{name:"label",weight:.7},{name:"value",weight:.3}]},r=u.map((e=>"string"==typeof e?{value:e,label:e}:e));!t.searchFuseOptions?.keys&&u.every((e=>"string"==typeof e))&&(e.keys=["label"]),w=new ae(r,e)},P=e=>{let t=!1;f.querySelectorAll(".fancy-dropdown-item").forEach((r=>{const n=r.dataset.value,o=k.includes(n),a=r.querySelector(".checkmark");o?(r.classList.add("selected"),a&&(a.style.display="inline-block")):(r.classList.remove("selected"),a&&(a.style.display="none")),void 0!==e?e.includes(n)?(r.style.display="flex",t=!0):r.style.display="none":(r.style.display="flex",t=!0)})),a&&b&&(b.style.display=void 0===e||t?"none":"block"),(()=>{if(0===k.length)p.textContent=n;else if(1===k.length){const e=k[0],t=u.find((t=>x(t)===e)),r=t?y(t):e;p.textContent=r}else p.textContent=`${k.length} items selected`})()},S=e=>{if(!a||!w)return void P();const t=e.trim();if(""===t)return void P(void 0);const r=w.search(t).map((e=>e.item.value));P(r)},A=()=>{m&&(v&&clearTimeout(v),v=window.setTimeout((()=>{m&&S(m.value)}),l))},C=()=>{_||(_=!0,f.style.display="block",h.classList.remove("fa-chevron-down"),h.classList.add("fa-chevron-up"),a&&m&&setTimeout((()=>m?.focus()),50))},I=()=>{_&&(_=!1,f.style.display="none",a&&m&&(m.value="",S("")),h.classList.remove("fa-chevron-up"),h.classList.add("fa-chevron-down"),v&&clearTimeout(v))};d.addEventListener("click",(e=>{e.stopPropagation(),_?I():C()})),document.addEventListener("click",(e=>{_&&r&&!r.contains(e.target)&&I()})),a&&m&&m.addEventListener("input",A);const N=(e,r)=>{const n=x(e),s=y(e),c=document.createElement("div");c.className="fancy-dropdown-item",c.dataset.value=n,Object.assign(c.style,{padding:"8px 12px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"space-between"}),c.addEventListener("mouseenter",(()=>{c.style.backgroundColor="var(--hover-color, var(--white20a))"})),c.addEventListener("mouseleave",(()=>{c.style.backgroundColor=""}));const l=document.createElement("span");l.textContent=s,c.append(l);const u=document.createElement("i");return u.className="checkmark fa-solid fa-check",Object.assign(u.style,{marginLeft:"8px",display:r?"inline-block":"none"}),c.append(u),c.addEventListener("click",(function(e){e.stopPropagation();const r=e.currentTarget.dataset.value,n=[...k];let s;s=i?k.includes(r)?k.filter((e=>e!==r)):[...k,r]:k.includes(r)?[]:[r];(async()=>{if(t.onBeforeSelection)try{if(!await Promise.resolve(t.onBeforeSelection(n,s)))return!1}catch(e){return console.error("onBeforeSelection callback failed:",e),!1}return!0})().then((e=>{e&&(k=s,a&&m&&""!==m.value.trim()?S(m.value):P(void 0),t.onSelectChange&&Promise.resolve(t.onSelectChange(n,k)).catch((e=>console.error("onSelectChange callback failed:",e))),o&&I())}))})),b?f.insertBefore(c,b):f.append(c),c};u.length>0&&u.forEach((e=>{const t=x(e);N(e,k.includes(t))})),E(),P();return{container:r,dropdownTrigger:d,dropdownList:f,getValues:()=>[...k],setValues:e=>{const r=[...k],n=e.filter((e=>u.some((t=>x(t)===e))));k=[...n],a&&m&&""!==m.value?(m.value="",S("")):P();JSON.stringify(r.sort())!==JSON.stringify(k.sort())&&t.onSelectChange&&Promise.resolve(t.onSelectChange(r,k)).catch((e=>console.error("onSelectChange callback failed:",e)))},getOptions:()=>u.map((e=>"string"==typeof e?{value:e,label:e}:e)),addOption:(e,r=!1)=>{const n=x(e);if(u.some((e=>x(e)===n)))return;u.push(e),N(e,r),E();let o=!1;const s=[...k];r&&!k.includes(n)?(i?k.push(n):k=[n],o=!0):r&&!i&&k.length>0&&k[0]!==n&&(k=[n],o=!0),a&&m&&""!==m.value?S(m.value):P(),o&&t.onSelectChange&&Promise.resolve(t.onSelectChange(s,k)).catch((e=>console.error("onSelectChange callback failed:",e)))},removeOption:e=>{const r=u.length;if(u=u.filter((t=>x(t)!==e)),u.length===r)return;let n=!1;const o=[...k],i=k.indexOf(e);i>-1&&(k.splice(i,1),n=!0);const s=f.querySelector(`.fancy-dropdown-item[data-value="${e}"]`);s?.remove(),E(),a&&m&&""!==m.value?S(m.value):P(),n&&t.onSelectChange&&Promise.resolve(t.onSelectChange(o,k)).catch((e=>console.error("onSelectChange callback failed:",e)))},selectAll:()=>{if(!i)return;const e=[...k],r=u.map(x);k=[...new Set([...k,...r])];const n=JSON.stringify(e.sort())!==JSON.stringify(k.sort());a&&m&&""!==m.value?S(m.value):P(),n&&t.onSelectChange&&Promise.resolve(t.onSelectChange(e,k)).catch((e=>console.error("onSelectChange callback failed:",e)))},deselectAll:()=>{const e=[...k];k.length>0&&(k=[],a&&m&&""!==m.value?S(m.value):P(),t.onSelectChange&&Promise.resolve(t.onSelectChange(e,k)).catch((e=>console.error("onSelectChange callback failed:",e))))},disable:()=>{r.style.pointerEvents="none",r.style.opacity="0.6",_&&I()},enable:()=>{r.style.pointerEvents="auto",r.style.opacity="1"},open:C,close:I,toggle:()=>_?I():C()}}ae.version="7.1.0",ae.createIndex=T,ae.parseIndex=function(e,{getFn:t=C.getFn,fieldNormWeight:r=C.fieldNormWeight}={}){const{keys:n,records:o}=e,a=new N({getFn:t,fieldNormWeight:r});return a.setKeys(n),a.setIndexRecords(o),a},ae.config=C,ae.parseQuery=re,function(...e){K.push(...e)}(U);const se=(e=>{var t={};return f.d(t,e),t})({persona_description_positions:()=>e.persona_description_positions,renderStoryString:()=>e.renderStoryString});const ce=(e=>{var t={};return f.d(t,e),t})({baseChatReplace:()=>t.baseChatReplace,chat_metadata:()=>t.chat_metadata,depth_prompt_depth_default:()=>t.depth_prompt_depth_default,depth_prompt_role_default:()=>t.depth_prompt_role_default,extension_prompt_types:()=>t.extension_prompt_types,getMaxContextSize:()=>t.getMaxContextSize,name1:()=>t.name1,name2:()=>t.name2,parseMesExamples:()=>t.parseMesExamples,this_chid:()=>t.this_chid});const le=(e=>{var t={};return f.d(t,e),t})({METADATA_KEY:()=>r.METADATA_KEY,createWorldInfoEntry:()=>r.createWorldInfoEntry,selected_world_info:()=>r.selected_world_info,wi_anchor_position:()=>r.wi_anchor_position,world_info:()=>r.world_info,world_info_include_names:()=>r.world_info_include_names,world_names:()=>r.world_names});const ue=(e=>{var t={};return f.d(t,e),t})({formatInstructModeExamples:()=>n.formatInstructModeExamples,formatInstructModeSystemPrompt:()=>n.formatInstructModeSystemPrompt});const de=(e=>{var t={};return f.d(t,e),t})({appendFileContent:()=>o.appendFileContent});const pe=(e=>{var t={};return f.d(t,e),t})({formatWorldInfo:()=>a.formatWorldInfo,getPromptPosition:()=>a.getPromptPosition,getPromptRole:()=>a.getPromptRole,prepareOpenAIMessages:()=>a.prepareOpenAIMessages,setOpenAIMessageExamples:()=>a.setOpenAIMessageExamples,setOpenAIMessages:()=>a.setOpenAIMessages});const he=(e=>{var t={};return f.d(t,e),t})({metadata_keys:()=>i.metadata_keys});const fe=(e=>{var t={};return f.d(t,e),t})({getGroupDepthPrompts:()=>s.getGroupDepthPrompts,groups:()=>s.groups,selected_group:()=>s.selected_group});const me=(e=>{var t={};return f.d(t,e),t})({getRegexedString:()=>c.getRegexedString,regex_placement:()=>c.regex_placement});const ge=(e=>{var t={};return f.d(t,e),t})({getCharaFilename:()=>l.getCharaFilename});const be=(e=>{var t={};return f.d(t,e),t})({commonEnumProviders:()=>u.commonEnumProviders});async function ve(e,t,{escapeHtml:r=!0}={}){await async function(e,...t){await SillyTavern.getContext().SlashCommandParser.commands[e].callback(...t)}("echo",{severity:e,escapeHtml:Boolean(r).toString()},t)}function _e(e){return(0,ce.getMaxContextSize)(e)}function we(e,t){return(0,ce.parseMesExamples)(e,t)}function ye(e,t,r){return(0,ce.baseChatReplace)(e,t,r)}function xe(e){return(0,pe.getPromptRole)(e)}function ke(e,{wiFormat:t}={}){return(0,pe.formatWorldInfo)(e,{wiFormat:t})}function Ee(e){return(0,pe.getPromptPosition)(e)}function Pe(e,{manualAvatarKey:t}={}){return(0,ge.getCharaFilename)(e,{manualAvatarKey:t})}function Se(e,t){return(0,le.createWorldInfoEntry)(e,t)}function Ae(e,t={}){const r=SillyTavern.getContext(),n=t.readOnlyValues||[],o=document.querySelector(e);if(!o)throw new Error(`Could not find preset select: ${e}`);const a=t.label||"preset",i=document.createElement("div");i.className="preset-select-container",i.style.display="flex",i.style.alignItems="center";const s=e=>n.includes(e);if(o.parentNode?.insertBefore(i,o),i.appendChild(o),t.initialList&&t.initialList.length>0){o.innerHTML="";for(const e of t.initialList){const t=document.createElement("option");t.value=e,t.textContent=e,s(e)&&(t.dataset.readonly="true"),o.appendChild(t)}}if(t.initialValue){const e=Array.from(o.options).find((e=>e.value===t.initialValue||e.textContent===t.initialValue));e&&(o.value=e.value)}let c=o.value;if(o.addEventListener("change",(async()=>{const e=o.value;t.onSelectChange&&c!==e&&await t.onSelectChange(c,e),c=e})),t.create){const e=document.createElement("i");e.className="menu_button fa-solid fa-file-circle-plus",e.title=`Create a new ${a}`,e.setAttribute("data-i18n",`[title]Create a new ${a}`),e.addEventListener("click",(async()=>{t.create?.onPopupOpen&&await t.create.onPopupOpen();const e=await r.Popup.show.input(`Create a new ${a}`,`Please enter a name for the new ${a}:`,"");if(null===e||""===e.trim())return;const n=e.trim();if(Array.from(o.options).some((e=>e.textContent===n)))return void await ve("warning",`A ${a} with this name already exists.`);if(t.create?.onBeforeCreate){if(!await t.create.onBeforeCreate(n))return}const i=document.createElement("option");i.value=n,i.textContent=n,o.appendChild(i);const s=o.value;o.value=n,t.create?.onAfterCreate&&await t.create.onAfterCreate(n),t.onSelectChange&&s!==n&&await t.onSelectChange(s,n),c=n})),i.appendChild(e)}if(t.rename){const e=document.createElement("i");e.className="menu_button fa-solid fa-pencil",e.title=`Rename a ${a}`,e.setAttribute("data-i18n",`[title]Rename a ${a}`),e.addEventListener("click",(async()=>{if(-1===o.selectedIndex)return void await ve("warning",`Please select a ${a} to rename.`);const e=o.options[o.selectedIndex];let n=e.value;if(s(n))return void await ve("warning",`This ${a} cannot be renamed as it is read-only.`);t.rename?.onPopupOpen&&await t.rename.onPopupOpen();const i=await r.Popup.show.input(`Rename ${a}`,`Please enter a new name for "${n}":`,n);if(null===i||""===i.trim()||i===n)return;const l=i.trim();if(Array.from(o.options).some((t=>t.textContent===l&&t!==e)))await ve("warning",`A ${a} with this name already exists.`);else{if(t.rename?.onBeforeRename){if(!await t.rename.onBeforeRename(n,l))return}e.value=l,e.textContent=l,n===c&&(c=l),t.rename?.onAfterRename&&await t.rename.onAfterRename(n,l),t.onSelectChange&&o.value===l&&await t.onSelectChange(n,l)}})),i.appendChild(e)}if(t.delete){const e=document.createElement("i");e.className="menu_button fa-solid fa-trash-can",e.title=`Delete a ${a}`,e.setAttribute("data-i18n",`[title]Delete a ${a}`),e.addEventListener("click",(async()=>{if(-1===o.selectedIndex)return void await ve("warning",`Please select a ${a} to delete.`);const e=o.options[o.selectedIndex],n=e.value,i=o.selectedIndex;if(s(n))return void await ve("warning",`This ${a} cannot be deleted as it is read-only.`);t.delete?.onPopupOpen&&await t.delete.onPopupOpen();if(!await r.Popup.show.confirm(`Are you sure you want to delete "${n}"?`,`Delete ${a}`))return;if(t.delete?.onBeforeDelete){if(!await t.delete.onBeforeDelete(n))return}const l=n;let u,d=-1;o.options.length>1&&(d=i<o.options.length-1?i:i-1,u=o.options[d].value),o.removeChild(e),d>=0?(o.selectedIndex=d,c=u,t.onSelectChange&&await t.onSelectChange(l,u)):(t.onSelectChange&&await t.onSelectChange(l,void 0),c=void 0),t.delete?.onAfterDelete&&await t.delete.onAfterDelete(l)})),i.appendChild(e)}return{select:o,container:i}}async function Ce(e,{targetCharacterId:t,presetName:r,instructName:n,contextName:o,syspromptName:a,maxContext:i,includeNames:s,ignoreCharacterFields:c,ignoreAuthorNote:l,ignoreWorldInfo:u,messageIndexesBetween:d}={}){if(!["textgenerationwebui","openai"].includes(e))throw new Error("Unsupported API");const p=SillyTavern.getContext();let h=[],{description:f,personality:m,persona:g,scenario:b,mesExamples:v,system:_,jailbreak:w}=c?{description:"",personality:"",persona:"",scenario:"",mesExamples:"",system:"",jailbreak:""}:p.getCharacterCardFields({chid:t});const y="textgenerationwebui"===e?p.getPresetManager("instruct")?.getCompletionPresetByName(n):void 0,x=!!y?.enabled;let k=we(v,x);const E=function(){if("number"==typeof i)return i;if(!i)return _e();if("active"===i||!r)return _e();if("number"==typeof i)return i;let t;if("textgenerationwebui"===e){const e=p.getPresetManager("textgenerationwebui")?.getCompletionPresetByName(r);t=e?.max_length}else{const e=p.getPresetManager("openai")?.getCompletionPresetByName(r);t=e?.openai_max_context}return"number"==typeof t?t:_e()}();if(E<=0)return[];const P=p.ToolManager.isToolCallingSupported(),S=d?.start??0,A=d?.end?d.end+1:void 0;let C=-1===S&&0===A?[]:p.chat.slice(S,A).filter((e=>!e.is_system||P&&Array.isArray(e.extra?.tool_invocations)));C=await Promise.all(C.map((async(e,t)=>{let r=function(e,t,{characterOverride:r,isMarkdown:n,isPrompt:o,isEdit:a,depth:i}){return(0,me.getRegexedString)(e,t,{characterOverride:r,isMarkdown:n,isPrompt:o,isEdit:a,depth:i})}(e.mes,e.is_user?me.regex_placement.USER_INPUT:me.regex_placement.AI_OUTPUT,{isPrompt:!0,depth:C.length-t-1});return r=await async function(e,t){return await(0,de.appendFileContent)(e,t)}(e,r),e?.extra?.append_title&&e?.extra?.title&&(r=`${r}\n\n${e.extra.title}`),{...e,mes:r,index:t}})));const I=C.map((e=>le.world_info_include_names?`${e.name}: ${e.mes}`:e.mes)).reverse(),{worldInfoString:N,worldInfoBefore:T,worldInfoAfter:j,worldInfoExamples:L,worldInfoDepth:M,anBefore:O,anAfter:D}=u?{worldInfoString:"",worldInfoBefore:"",worldInfoAfter:"",worldInfoExamples:[],worldInfoDepth:[],anBefore:[],anAfter:[]}:await p.getWorldInfoPrompt(I,E,!1);for(const G of L){const q=G.content;if(0===q.length)continue;const U=we(ye(q,ce.name1,ce.name2),x);G.position===le.wi_anchor_position.before?k.unshift(...U):k.push(...U)}function R(){let e=0;const t=[];for(let r=C.length-1;r>=0;r--){const n=C[r];if(n.extra?.token_count&&e+n.extra.token_count>E)break;e+=n.extra?.token_count||0,t.unshift({role:n.is_user?"user":"assistant",content:s?`${n.name}: ${n.mes}`:n.mes})}h.push(...t)}if("textgenerationwebui"===e){const K=[...k];k&&(k=function(e,t,r){return(0,ue.formatInstructModeExamples)(e,t,r)}(k,ce.name1,ce.name2));const Y=p.getPresetManager("sysprompt")?.getCompletionPresetByName(a);Y&&(_=p.powerUserSettings.prefer_character_prompt&&_?_:ye(Y.content,ce.name1,ce.name2),_=x?(F=p.substituteParams(_,ce.name1,ce.name2,Y.content),z=y,(0,ue.formatInstructModeSystemPrompt)(F,z)):_);const X={description:f,personality:m,persona:p.powerUserSettings.persona_description_position==se.persona_description_positions.IN_PROMPT?g:"",scenario:b,system:_,char:ce.name2,user:ce.name1,wiBefore:T,wiAfter:j,loreBefore:T,loreAfter:j,mesExamples:k.join(""),mesExamplesRaw:K.join("")},Z=p.getPresetManager("context")?.getCompletionPresetByName(o);let J=function(e,{customStoryString:t,customInstructSettings:r}={}){return(0,se.renderStoryString)(e,{customStoryString:t,customInstructSettings:r})}(X,{customInstructSettings:y,customStoryString:Z?.story_string});h.push({role:"system",content:J,ignoreInstruct:!0}),R()}else{let Q=(B=C,(0,pe.setOpenAIMessages)(B)),ee=function(e){return(0,pe.setOpenAIMessageExamples)(e)}(k);async function te(){let[e,t]=await function({name2:e,charDescription:t,charPersonality:r,Scenario:n,worldInfoBefore:o,worldInfoAfter:a,bias:i,type:s,quietPrompt:c,quietImage:l,extensionPrompts:u,cyclePrompt:d,systemPromptOverride:p,jailbreakPromptOverride:h,personaDescription:f,messages:m,messageExamples:g},b){return(0,pe.prepareOpenAIMessages)({name2:e,charDescription:t,charPersonality:r,Scenario:n,worldInfoBefore:o,worldInfoAfter:a,bias:i,type:s,quietPrompt:c,quietImage:l,cyclePrompt:d,systemPromptOverride:p,jailbreakPromptOverride:h,personaDescription:f,extensionPrompts:u,messages:m,messageExamples:g},b)}({name2:ce.name2,charDescription:f,charPersonality:m,Scenario:b,worldInfoBefore:T,worldInfoAfter:j,extensionPrompts:p.extensionPrompts,bias:"",type:"normal",quietPrompt:void 0,quietImage:void 0,cyclePrompt:"",systemPromptOverride:_,jailbreakPromptOverride:w,personaDescription:g,messages:Q,messageExamples:ee},!1);h.push(...e)}if(!r)return await te(),h;const re=p.getPresetManager("openai")?.getCompletionPresetByName(r);if(!re)return console.warn(`Preset not found: ${r}. Using current preset.`),te(),h;let ne=re.prompt_order.find((e=>e.character_id===ce.this_chid));if(!ne&&re.prompt_order.length>0&&(ne=re.prompt_order[0]),!ne)return console.warn(`No prompt order found for preset: ${r}. Using current preset.`),te(),h;const oe=b&&re.scenario_format?p.substituteParams(re.scenario_format):"",ae=m&&re.personality_format?p.substituteParams(re.personality_format):"",ie=p.substituteParams(re.group_nudge_prompt),ge=re.impersonation_prompt?p.substituteParams(re.impersonation_prompt):"",be=[];u&&be.push({role:"system",content:ke(T,{wiFormat:re.wi_format}),identifier:"worldInfoBefore"},{role:"system",content:ke(j,{wiFormat:re.wi_format}),identifier:"worldInfoAfter"}),c||be.push({role:"system",content:f,identifier:"charDescription"},{role:"system",content:ae,identifier:"charPersonality"},{role:"system",content:oe,identifier:"scenario"}),be.push({role:"system",content:ge,identifier:"impersonate"},{role:"system",content:ie,identifier:"groupNudge"});const ve=p.extensionPrompts["1_memory"];ve&&ve.value&&be.push({role:xe(ve.role),content:ve.value,identifier:"summary",position:Ee(ve.position)});const Pe=p.extensionPrompts["2_floating_prompt"];!l&&Pe&&Pe.value&&be.push({role:xe(Pe.role),content:Pe.value,identifier:"authorsNote",position:Ee(Pe.position)});const Se=p.extensionPrompts["3_vectors"];Se&&Se.value&&be.push({role:"system",content:Se.value,identifier:"vectorsMemory",position:Ee(Se.position)});const Ae=p.extensionPrompts["4_vectors_data_bank"];Ae&&Ae.value&&be.push({role:xe(Ae.role),content:Ae.value,identifier:"vectorsDataBank",position:Ee(Ae.position)});const Ce=p.extensionPrompts.chromadb;Ce&&Ce.value&&be.push({role:"system",content:Ce.value,identifier:"smartContext",position:Ee(Ce.position)}),!c&&p.powerUserSettings.persona_description&&p.powerUserSettings.persona_description_position===se.persona_description_positions.IN_PROMPT&&be.push({role:"system",content:p.powerUserSettings.persona_description,identifier:"personaDescription"}),ne.order.forEach((e=>{if(!e.enabled)return;const t=(r=e.identifier,be.find((e=>e.identifier===r)));var r;t&&t.content?h.push({role:t.role??"system",content:p.substituteParams(t.content)}):"chatHistory"===e.identifier&&R()}))}var B,F,z;const $=["1_memory","2_floating_prompt","3_vectors","4_vectors_data_bank","chromadb","PERSONA_DESCRIPTION","QUIET_PROMPT","DEPTH_PROMPT"];for(const Ie in p.extensionPrompts)if(Object.hasOwn(p.extensionPrompts,Ie)){const Ne=p.extensionPrompts[Ie];if($.includes(Ie))continue;if(!p.extensionPrompts[Ie].value)continue;if(![ce.extension_prompt_types.BEFORE_PROMPT,ce.extension_prompt_types.IN_PROMPT].includes(Ne.position))continue;if("function"==typeof Ne.filter&&!await Ne.filter())continue;Ne.position===ce.extension_prompt_types.BEFORE_PROMPT?h=[...h.slice(0,Ne.depth),{role:xe(Ne.role)??"system",content:Ne.value},...h.slice(Ne.depth)]:Ne.position===ce.extension_prompt_types.IN_PROMPT&&(h=[...h.slice(0,h.length-Ne.depth),{role:xe(Ne.role)??"system",content:Ne.value},...h.slice(h.length-Ne.depth)])}for(const Te of M)h=[...h.slice(0,h.length-Te.depth),{role:xe(Te.role),content:Te.entries.join("\n")},...h.slice(h.length-Te.depth)];if(!c){const je=(W=fe.selected_group,V=Number(ce.this_chid),(0,fe.getGroupDepthPrompts)(W,V));if(fe.selected_group&&Array.isArray(je)&&je.length>0)je.filter((e=>e.text)).forEach(((e,t)=>{h=[...h.slice(0,h.length-e.depth),{role:e.role,content:e.text},...h.slice(h.length-e.depth)]}));else{const Le=ye(p.characters[ce.this_chid]?.data?.extensions?.depth_prompt?.prompt?.trim(),ce.name1,ce.name2)||"";if(Le){const Me=ce.depth_prompt_depth_default,Oe=p.characters[ce.this_chid]?.data?.extensions?.depth_prompt?.role??ce.depth_prompt_role_default;h=[...h.slice(0,h.length-Me),{role:xe(Oe),content:Le},...h.slice(h.length-Me)]}}}var W,V;let H=-1;if(!l){const De={prompt:ce.chat_metadata[he.metadata_keys.prompt],interval:ce.chat_metadata[he.metadata_keys.interval],position:ce.chat_metadata[he.metadata_keys.position],depth:ce.chat_metadata[he.metadata_keys.depth],role:ce.chat_metadata[he.metadata_keys.role]};if(De.prompt)switch(De.prompt=ye(De.prompt,ce.name1,ce.name2),De.position){case ce.extension_prompt_types.IN_PROMPT:h=[...h.slice(0,1),{role:"user",content:De.prompt},...h.slice(1)],H=1;break;case ce.extension_prompt_types.IN_CHAT:h=[...h.slice(0,h.length-De.depth),{role:xe(De.role),content:De.prompt},...h.slice(h.length-De.depth)],H=h.length-De.depth-1;break;case ce.extension_prompt_types.BEFORE_PROMPT:h.unshift({role:"user",content:De.prompt}),H=0}}return H>=0&&(O.length>0&&(h=[...h.slice(0,H),{role:"system",content:O.join("\n")},...h.slice(H)],H++),D.length>0&&(h=[...h.slice(0,H+1),{role:"system",content:D.join("\n")},...h.slice(H+1)])),h}async function Ie(e,t){function r(t){return e.includes("all")||e.includes(t)}const n=SillyTavern.getContext();let o={};if(r("global")&&le.selected_world_info?.length)for(const e of le.selected_world_info){const t=await n.loadWorldInfo(e);t&&(o[e]||(o[e]=[]),Object.values(t.entries).forEach((t=>{o[e].push(t)})))}if(r("chat")){const e=n.chatMetadata[le.METADATA_KEY];if(e&&!o[e]){o[e]=[];const t=await n.loadWorldInfo(e);t&&Object.values(t.entries).forEach((t=>{o[e].push(t)}))}}if(r("character")&&t){const e=n.characters[t];let r=new Set;const a=e?.data?.extensions?.world;a&&r.add(a);const i=Pe(t),s=le.world_info.charLore?.find((e=>e.name===i));s&&(r=new Set([...r,...s.extraBooks]));for(const e of r){const t=await n.loadWorldInfo(e);t&&!o[e]&&(o[e]=[],Object.values(t.entries).forEach((t=>{o[e].push(t)})))}}if(r("persona")){const e=n.powerUserSettings.persona_description_lorebook;if(e&&!o[e]){o[e]=[];const t=await n.loadWorldInfo(e);t&&Object.values(t.entries).forEach((t=>{o[e].push(t)}))}}return o}var Ne,Te;!function(e){e[e.TEXT=1]="TEXT",e[e.CONFIRM=2]="CONFIRM",e[e.INPUT=3]="INPUT",e[e.DISPLAY=4]="DISPLAY"}(Ne||(Ne={})),function(e){e[e.AFFIRMATIVE=1]="AFFIRMATIVE",e[e.NEGATIVE=0]="NEGATIVE",e[e.CANCELLED=null]="CANCELLED"}(Te||(Te={}));var je='=== SILLYTAVERN===\n\n**SillyTavern** is a popular open-source front-end interface designed for interacting with AI language models. It\'s primarily used for role-playing, creative writing, and conversational experiences, offering a user-friendly platform to customize interactions with AI. Here\'s an overview:\n\n### Key Features:\n1. **AI Backend Compatibility**: Works with APIs like OpenAI (GPT), KoboldAI, Claude, or local models (via services like Text-generation-webui or Ollama).\n2. **Customization**:\n   - Create and import character cards (with personas, scenarios, and dialogue examples).\n   - Adjust model parameters (temperature, repetition penalties) for tailored responses.\n3. **Plugins & Extensions**: Adds features like text-to-speech, image generation, emotion recognition, and world-building tools.\n4. **Privacy**: Self-hosted locally, giving users control over data (unlike cloud-based services).\n\n### Use Cases:\n- Role-playing with AI characters.\n- Collaborative storytelling or creative writing.\n- Experimental AI interactions (users often share character templates and scripts in communities).\n\n### Requirements:\n- Technical setup involves installing Node.js, cloning the GitHub repo, and configuring API connections.\n- Requires access to an AI model backend (e.g., OpenAI API key or a locally hosted model).\n\n### Community & Ethics:\n- Active communities on platforms like GitHub and Reddit share guides, characters, and plugins.\n- Encourages responsible use, as the tool can generate unrestricted content depending on the AI backend.\n\nSillyTavern is not an AI itself but a flexible interface to enhance interactions with LLMs.\n\n=== WORLDINFO (LOREBOOKS) ===\n\n**World Info** (often called **Lorebooks**) is a feature used in AI-driven storytelling and role-playing platforms (like SillyTavern, NovelAI, KoboldAI, or Text-generation-webui) to help AI models maintain consistency in fictional worlds. It acts as a dynamic knowledge base that the AI references during interactions to avoid contradictions and keep track of key details.\n\n---\n\n### **What is World Info/Lorebooks?**\n- **A structured database**: Stores details about characters, locations, rules, events, or concepts in your fictional world.\n- **Contextual triggers**: Entries activate automatically when specific keywords or phrases appear in the conversation/story.\n- **Prevents "amnesia"**: Ensures the AI remembers critical lore without relying solely on its limited context window.\n\n---\n\n### **How It Works**\n1. **Create Entries**: Define elements (e.g., a character’s backstory, a magic system’s rules).\n2. **Set Triggers**: Link entries to keywords (e.g., mention "Dragonstone" → inject lore about that location).\n3. **Dynamic Injection**: When a trigger word appears in the chat/story, the relevant entry is temporarily added to the AI’s context.\n\n---\n\n### **Key Features**\n- **Hierarchy**: Organize entries into categories (e.g., factions, items, timelines).\n- **Priority**: Set which entries take precedence if multiple triggers occur.\n- **Cross-references**: Link entries to each other (e.g., a character entry references their home city).\n- **Formatting**: Use markdown, JSON, or plain text depending on the platform.\n\n---\n\n### **Example Lorebook Entry**\n```plaintext\nName: Dragonstone Citadel\nTriggers: Dragonstone, Citadel, Obsidian Fortress\nContent:\n  A volcanic fortress built from black obsidian. Home to the ancient Order of Flames,\n  who guard the Eternal Fire—a magical flame that grants visions of the future.\n  The citadel is rumored to be cursed, as its rulers never live past 40 years.\n```\n\n---\n\n### **Use Cases**\n1. **Complex Worldbuilding**: Track political factions, religions, or history.\n2. **Character Consistency**: Ensure the AI remembers a character’s motives, secrets, or relationships.\n3. **Magic/Science Systems**: Define rules (e.g., "Magic drains lifeforce" or "Robots cannot harm humans").\n4. **Plot Hooks**: Store hidden clues or foreshadowing for the AI to weave into the narrative.\n\n---\n\n### **Tools Supporting Lorebooks**\n- **SillyTavern**: Integrates with lorebooks via extensions or prompts.\n- **NovelAI**: Has a built-in "Lorebook" feature with advanced triggers.\n- **KoboldAI/Text-generation-webui**: Use "world info" files or scripts.\n- **AIDungeon** (historically): Early adopter of world info, though less popular now.\n\n---\n\n### **Best Practices**\n- **Keep entries concise**: AI models process information best in short, clear snippets.\n- **Balance detail**: Too many entries can overwhelm the context window.\n- **Test triggers**: Ensure keywords are unique enough to avoid false activations.\n- **Update dynamically**: Add/remove entries as the story evolves.\n\nLorebooks are essential for long-term storytelling with AI.',Le="{{#each lorebooks}}\n  {{#if this.length}}\n## WORLD NAME: {{@key}}\n    {{#each this as |entry|}}\n      {{#unless entry.disable}}\n- (NAME: {{entry.comment}}) (ID: {{entry.uid}})\nTriggers: {{join entry.key ', '}}\nContent: {{entry.content}}\n\n      {{/unless}}\n    {{/each}}\n  {{/if}}\n{{/each}}",Me="- Don't suggest already existing or suggested entries.";const Oe=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",De=new RegExp("^"+("["+Oe+"]["+(Oe+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040")+"]*")+"$");function Re(e,t){const r=[];let n=t.exec(e);for(;n;){const o=[];o.startIndex=t.lastIndex-n[0].length;const a=n.length;for(let e=0;e<a;e++)o.push(n[e]);r.push(o),n=t.exec(e)}return r}const Be=function(e){const t=De.exec(e);return!(null==t)};const Fe={allowBooleanAttributes:!1,unpairedTags:[]};function ze(e,t){t=Object.assign({},Fe,t);const r=[];let n=!1,o=!1;"\ufeff"===e[0]&&(e=e.substr(1));for(let a=0;a<e.length;a++)if("<"===e[a]&&"?"===e[a+1]){if(a+=2,a=We(e,a),a.err)return a}else{if("<"!==e[a]){if($e(e[a]))continue;return Xe("InvalidChar","char '"+e[a]+"' is not expected.",Je(e,a))}{let i=a;if(a++,"!"===e[a]){a=Ve(e,a);continue}{let s=!1;"/"===e[a]&&(s=!0,a++);let c="";for(;a<e.length&&">"!==e[a]&&" "!==e[a]&&"\t"!==e[a]&&"\n"!==e[a]&&"\r"!==e[a];a++)c+=e[a];if(c=c.trim(),"/"===c[c.length-1]&&(c=c.substring(0,c.length-1),a--),!Be(c)){let t;return t=0===c.trim().length?"Invalid space after '<'.":"Tag '"+c+"' is an invalid name.",Xe("InvalidTag",t,Je(e,a))}const l=qe(e,a);if(!1===l)return Xe("InvalidAttr","Attributes for '"+c+"' have open quote.",Je(e,a));let u=l.value;if(a=l.index,"/"===u[u.length-1]){const r=a-u.length;u=u.substring(0,u.length-1);const o=Ke(u,t);if(!0!==o)return Xe(o.err.code,o.err.msg,Je(e,r+o.err.line));n=!0}else if(s){if(!l.tagClosed)return Xe("InvalidTag","Closing tag '"+c+"' doesn't have proper closing.",Je(e,a));if(u.trim().length>0)return Xe("InvalidTag","Closing tag '"+c+"' can't have attributes or invalid starting.",Je(e,i));if(0===r.length)return Xe("InvalidTag","Closing tag '"+c+"' has not been opened.",Je(e,i));{const t=r.pop();if(c!==t.tagName){let r=Je(e,t.tagStartPos);return Xe("InvalidTag","Expected closing tag '"+t.tagName+"' (opened in line "+r.line+", col "+r.col+") instead of closing tag '"+c+"'.",Je(e,i))}0==r.length&&(o=!0)}}else{const s=Ke(u,t);if(!0!==s)return Xe(s.err.code,s.err.msg,Je(e,a-u.length+s.err.line));if(!0===o)return Xe("InvalidXml","Multiple possible root nodes found.",Je(e,a));-1!==t.unpairedTags.indexOf(c)||r.push({tagName:c,tagStartPos:i}),n=!0}for(a++;a<e.length;a++)if("<"===e[a]){if("!"===e[a+1]){a++,a=Ve(e,a);continue}if("?"!==e[a+1])break;if(a=We(e,++a),a.err)return a}else if("&"===e[a]){const t=Ye(e,a);if(-1==t)return Xe("InvalidChar","char '&' is not expected.",Je(e,a));a=t}else if(!0===o&&!$e(e[a]))return Xe("InvalidXml","Extra text at the end",Je(e,a));"<"===e[a]&&a--}}}return n?1==r.length?Xe("InvalidTag","Unclosed tag '"+r[0].tagName+"'.",Je(e,r[0].tagStartPos)):!(r.length>0)||Xe("InvalidXml","Invalid '"+JSON.stringify(r.map((e=>e.tagName)),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1}):Xe("InvalidXml","Start tag expected.",1)}function $e(e){return" "===e||"\t"===e||"\n"===e||"\r"===e}function We(e,t){const r=t;for(;t<e.length;t++)if("?"!=e[t]&&" "!=e[t]);else{const n=e.substr(r,t-r);if(t>5&&"xml"===n)return Xe("InvalidXml","XML declaration allowed only at the start of the document.",Je(e,t));if("?"==e[t]&&">"==e[t+1]){t++;break}}return t}function Ve(e,t){if(e.length>t+5&&"-"===e[t+1]&&"-"===e[t+2]){for(t+=3;t<e.length;t++)if("-"===e[t]&&"-"===e[t+1]&&">"===e[t+2]){t+=2;break}}else if(e.length>t+8&&"D"===e[t+1]&&"O"===e[t+2]&&"C"===e[t+3]&&"T"===e[t+4]&&"Y"===e[t+5]&&"P"===e[t+6]&&"E"===e[t+7]){let r=1;for(t+=8;t<e.length;t++)if("<"===e[t])r++;else if(">"===e[t]&&(r--,0===r))break}else if(e.length>t+9&&"["===e[t+1]&&"C"===e[t+2]&&"D"===e[t+3]&&"A"===e[t+4]&&"T"===e[t+5]&&"A"===e[t+6]&&"["===e[t+7])for(t+=8;t<e.length;t++)if("]"===e[t]&&"]"===e[t+1]&&">"===e[t+2]){t+=2;break}return t}const He='"',Ge="'";function qe(e,t){let r="",n="",o=!1;for(;t<e.length;t++){if(e[t]===He||e[t]===Ge)""===n?n=e[t]:n!==e[t]||(n="");else if(">"===e[t]&&""===n){o=!0;break}r+=e[t]}return""===n&&{value:r,index:t,tagClosed:o}}const Ue=new RegExp("(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['\"])(([\\s\\S])*?)\\5)?","g");function Ke(e,t){const r=Re(e,Ue),n={};for(let e=0;e<r.length;e++){if(0===r[e][1].length)return Xe("InvalidAttr","Attribute '"+r[e][2]+"' has no space in starting.",Qe(r[e]));if(void 0!==r[e][3]&&void 0===r[e][4])return Xe("InvalidAttr","Attribute '"+r[e][2]+"' is without value.",Qe(r[e]));if(void 0===r[e][3]&&!t.allowBooleanAttributes)return Xe("InvalidAttr","boolean attribute '"+r[e][2]+"' is not allowed.",Qe(r[e]));const o=r[e][2];if(!Ze(o))return Xe("InvalidAttr","Attribute '"+o+"' is an invalid name.",Qe(r[e]));if(n.hasOwnProperty(o))return Xe("InvalidAttr","Attribute '"+o+"' is repeated.",Qe(r[e]));n[o]=1}return!0}function Ye(e,t){if(";"===e[++t])return-1;if("#"===e[t])return function(e,t){let r=/\d/;for("x"===e[t]&&(t++,r=/[\da-fA-F]/);t<e.length;t++){if(";"===e[t])return t;if(!e[t].match(r))break}return-1}(e,++t);let r=0;for(;t<e.length;t++,r++)if(!(e[t].match(/\w/)&&r<20)){if(";"===e[t])break;return-1}return t}function Xe(e,t,r){return{err:{code:e,msg:t,line:r.line||r,col:r.col}}}function Ze(e){return Be(e)}function Je(e,t){const r=e.substring(0,t).split(/\r?\n/);return{line:r.length,col:r[r.length-1].length+1}}function Qe(e){return e.startIndex+e[1].length}const et={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(e,t,r){return e}};class tt{constructor(e){this.tagname=e,this.child=[],this[":@"]={}}add(e,t){"__proto__"===e&&(e="#__proto__"),this.child.push({[e]:t})}addChild(e){"__proto__"===e.tagname&&(e.tagname="#__proto__"),e[":@"]&&Object.keys(e[":@"]).length>0?this.child.push({[e.tagname]:e.child,":@":e[":@"]}):this.child.push({[e.tagname]:e.child})}}function rt(e,t){const r={};if("O"!==e[t+3]||"C"!==e[t+4]||"T"!==e[t+5]||"Y"!==e[t+6]||"P"!==e[t+7]||"E"!==e[t+8])throw new Error("Invalid Tag instead of DOCTYPE");{t+=9;let n=1,o=!1,a=!1,i="";for(;t<e.length;t++)if("<"!==e[t]||a)if(">"===e[t]){if(a?"-"===e[t-1]&&"-"===e[t-2]&&(a=!1,n--):n--,0===n)break}else"["===e[t]?o=!0:i+=e[t];else{if(o&&at(e,t)){let n,o;t+=7,[n,o,t]=nt(e,t+1),-1===o.indexOf("&")&&(r[lt(n)]={regx:RegExp(`&${n};`,"g"),val:o})}else if(o&&it(e,t))t+=8;else if(o&&st(e,t))t+=8;else if(o&&ct(e,t))t+=9;else{if(!ot)throw new Error("Invalid DOCTYPE");a=!0}n++,i=""}if(0!==n)throw new Error("Unclosed DOCTYPE")}return{entities:r,i:t}}function nt(e,t){let r="";for(;t<e.length&&"'"!==e[t]&&'"'!==e[t];t++)r+=e[t];if(r=r.trim(),-1!==r.indexOf(" "))throw new Error("External entites are not supported");const n=e[t++];let o="";for(;t<e.length&&e[t]!==n;t++)o+=e[t];return[r,o,t]}function ot(e,t){return"!"===e[t+1]&&"-"===e[t+2]&&"-"===e[t+3]}function at(e,t){return"!"===e[t+1]&&"E"===e[t+2]&&"N"===e[t+3]&&"T"===e[t+4]&&"I"===e[t+5]&&"T"===e[t+6]&&"Y"===e[t+7]}function it(e,t){return"!"===e[t+1]&&"E"===e[t+2]&&"L"===e[t+3]&&"E"===e[t+4]&&"M"===e[t+5]&&"E"===e[t+6]&&"N"===e[t+7]&&"T"===e[t+8]}function st(e,t){return"!"===e[t+1]&&"A"===e[t+2]&&"T"===e[t+3]&&"T"===e[t+4]&&"L"===e[t+5]&&"I"===e[t+6]&&"S"===e[t+7]&&"T"===e[t+8]}function ct(e,t){return"!"===e[t+1]&&"N"===e[t+2]&&"O"===e[t+3]&&"T"===e[t+4]&&"A"===e[t+5]&&"T"===e[t+6]&&"I"===e[t+7]&&"O"===e[t+8]&&"N"===e[t+9]}function lt(e){if(Be(e))return e;throw new Error(`Invalid entity name ${e}`)}const ut=/^[-+]?0x[a-fA-F0-9]+$/,dt=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,pt={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function ht(e,t={}){if(t=Object.assign({},pt,t),!e||"string"!=typeof e)return e;let r=e.trim();if(void 0!==t.skipLike&&t.skipLike.test(r))return e;if("0"===e)return 0;if(t.hex&&ut.test(r))return function(e,t){if(parseInt)return parseInt(e,t);if(Number.parseInt)return Number.parseInt(e,t);if(window&&window.parseInt)return window.parseInt(e,t);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}(r,16);if(-1!==r.search(/[eE]/)){const n=r.match(/^([-\+])?(0*)([0-9]*(\.[0-9]*)?[eE][-\+]?[0-9]+)$/);if(n){if(t.leadingZeros)r=(n[1]||"")+n[3];else if("0"!==n[2]||"."!==n[3][0])return e;return t.eNotation?Number(r):e}return e}{const n=dt.exec(r);if(n){const o=n[1],a=n[2];let i=function(e){if(e&&-1!==e.indexOf("."))return"."===(e=e.replace(/0+$/,""))?e="0":"."===e[0]?e="0"+e:"."===e[e.length-1]&&(e=e.substr(0,e.length-1)),e;return e}(n[3]);if(!t.leadingZeros&&a.length>0&&o&&"."!==r[2])return e;if(!t.leadingZeros&&a.length>0&&!o&&"."!==r[1])return e;if(t.leadingZeros&&a===e)return 0;{const n=Number(r),s=""+n;return-1!==s.search(/[eE]/)?t.eNotation?n:e:-1!==r.indexOf(".")?"0"===s&&""===i||s===i||o&&s==="-"+i?n:e:a?i===s||o+i===s?n:e:r===s||r===o+s?n:e}}return e}}function ft(e){return"function"==typeof e?e:Array.isArray(e)?t=>{for(const r of e){if("string"==typeof r&&t===r)return!0;if(r instanceof RegExp&&r.test(t))return!0}}:()=>!1}class mt{constructor(e){this.options=e,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(e,t)=>String.fromCodePoint(Number.parseInt(t,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(e,t)=>String.fromCodePoint(Number.parseInt(t,16))}},this.addExternalEntities=gt,this.parseXml=yt,this.parseTextData=bt,this.resolveNameSpace=vt,this.buildAttributesMap=wt,this.isItStopNode=Pt,this.replaceEntitiesValue=kt,this.readStopNodeData=Ct,this.saveTextToParentTag=Et,this.addChild=xt,this.ignoreAttributesFn=ft(this.options.ignoreAttributes)}}function gt(e){const t=Object.keys(e);for(let r=0;r<t.length;r++){const n=t[r];this.lastEntities[n]={regex:new RegExp("&"+n+";","g"),val:e[n]}}}function bt(e,t,r,n,o,a,i){if(void 0!==e&&(this.options.trimValues&&!n&&(e=e.trim()),e.length>0)){i||(e=this.replaceEntitiesValue(e));const n=this.options.tagValueProcessor(t,e,r,o,a);if(null==n)return e;if(typeof n!=typeof e||n!==e)return n;if(this.options.trimValues)return It(e,this.options.parseTagValue,this.options.numberParseOptions);return e.trim()===e?It(e,this.options.parseTagValue,this.options.numberParseOptions):e}}function vt(e){if(this.options.removeNSPrefix){const t=e.split(":"),r="/"===e.charAt(0)?"/":"";if("xmlns"===t[0])return"";2===t.length&&(e=r+t[1])}return e}const _t=new RegExp("([^\\s=]+)\\s*(=\\s*(['\"])([\\s\\S]*?)\\3)?","gm");function wt(e,t,r){if(!0!==this.options.ignoreAttributes&&"string"==typeof e){const r=Re(e,_t),n=r.length,o={};for(let e=0;e<n;e++){const n=this.resolveNameSpace(r[e][1]);if(this.ignoreAttributesFn(n,t))continue;let a=r[e][4],i=this.options.attributeNamePrefix+n;if(n.length)if(this.options.transformAttributeName&&(i=this.options.transformAttributeName(i)),"__proto__"===i&&(i="#__proto__"),void 0!==a){this.options.trimValues&&(a=a.trim()),a=this.replaceEntitiesValue(a);const e=this.options.attributeValueProcessor(n,a,t);o[i]=null==e?a:typeof e!=typeof a||e!==a?e:It(a,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(o[i]=!0)}if(!Object.keys(o).length)return;if(this.options.attributesGroupName){const e={};return e[this.options.attributesGroupName]=o,e}return o}}const yt=function(e){e=e.replace(/\r\n?/g,"\n");const t=new tt("!xml");let r=t,n="",o="";for(let a=0;a<e.length;a++){if("<"===e[a])if("/"===e[a+1]){const t=St(e,">",a,"Closing Tag is not closed.");let i=e.substring(a+2,t).trim();if(this.options.removeNSPrefix){const e=i.indexOf(":");-1!==e&&(i=i.substr(e+1))}this.options.transformTagName&&(i=this.options.transformTagName(i)),r&&(n=this.saveTextToParentTag(n,r,o));const s=o.substring(o.lastIndexOf(".")+1);if(i&&-1!==this.options.unpairedTags.indexOf(i))throw new Error(`Unpaired tag can not be used as closing tag: </${i}>`);let c=0;s&&-1!==this.options.unpairedTags.indexOf(s)?(c=o.lastIndexOf(".",o.lastIndexOf(".")-1),this.tagsNodeStack.pop()):c=o.lastIndexOf("."),o=o.substring(0,c),r=this.tagsNodeStack.pop(),n="",a=t}else if("?"===e[a+1]){let t=At(e,a,!1,"?>");if(!t)throw new Error("Pi Tag is not closed.");if(n=this.saveTextToParentTag(n,r,o),this.options.ignoreDeclaration&&"?xml"===t.tagName||this.options.ignorePiTags);else{const e=new tt(t.tagName);e.add(this.options.textNodeName,""),t.tagName!==t.tagExp&&t.attrExpPresent&&(e[":@"]=this.buildAttributesMap(t.tagExp,o,t.tagName)),this.addChild(r,e,o)}a=t.closeIndex+1}else if("!--"===e.substr(a+1,3)){const t=St(e,"--\x3e",a+4,"Comment is not closed.");if(this.options.commentPropName){const i=e.substring(a+4,t-2);n=this.saveTextToParentTag(n,r,o),r.add(this.options.commentPropName,[{[this.options.textNodeName]:i}])}a=t}else if("!D"===e.substr(a+1,2)){const t=rt(e,a);this.docTypeEntities=t.entities,a=t.i}else if("!["===e.substr(a+1,2)){const t=St(e,"]]>",a,"CDATA is not closed.")-2,i=e.substring(a+9,t);n=this.saveTextToParentTag(n,r,o);let s=this.parseTextData(i,r.tagname,o,!0,!1,!0,!0);null==s&&(s=""),this.options.cdataPropName?r.add(this.options.cdataPropName,[{[this.options.textNodeName]:i}]):r.add(this.options.textNodeName,s),a=t+2}else{let i=At(e,a,this.options.removeNSPrefix),s=i.tagName;const c=i.rawTagName;let l=i.tagExp,u=i.attrExpPresent,d=i.closeIndex;this.options.transformTagName&&(s=this.options.transformTagName(s)),r&&n&&"!xml"!==r.tagname&&(n=this.saveTextToParentTag(n,r,o,!1));const p=r;if(p&&-1!==this.options.unpairedTags.indexOf(p.tagname)&&(r=this.tagsNodeStack.pop(),o=o.substring(0,o.lastIndexOf("."))),s!==t.tagname&&(o+=o?"."+s:s),this.isItStopNode(this.options.stopNodes,o,s)){let t="";if(l.length>0&&l.lastIndexOf("/")===l.length-1)"/"===s[s.length-1]?(s=s.substr(0,s.length-1),o=o.substr(0,o.length-1),l=s):l=l.substr(0,l.length-1),a=i.closeIndex;else if(-1!==this.options.unpairedTags.indexOf(s))a=i.closeIndex;else{const r=this.readStopNodeData(e,c,d+1);if(!r)throw new Error(`Unexpected end of ${c}`);a=r.i,t=r.tagContent}const n=new tt(s);s!==l&&u&&(n[":@"]=this.buildAttributesMap(l,o,s)),t&&(t=this.parseTextData(t,s,o,!0,u,!0,!0)),o=o.substr(0,o.lastIndexOf(".")),n.add(this.options.textNodeName,t),this.addChild(r,n,o)}else{if(l.length>0&&l.lastIndexOf("/")===l.length-1){"/"===s[s.length-1]?(s=s.substr(0,s.length-1),o=o.substr(0,o.length-1),l=s):l=l.substr(0,l.length-1),this.options.transformTagName&&(s=this.options.transformTagName(s));const e=new tt(s);s!==l&&u&&(e[":@"]=this.buildAttributesMap(l,o,s)),this.addChild(r,e,o),o=o.substr(0,o.lastIndexOf("."))}else{const e=new tt(s);this.tagsNodeStack.push(r),s!==l&&u&&(e[":@"]=this.buildAttributesMap(l,o,s)),this.addChild(r,e,o),r=e}n="",a=d}}else n+=e[a]}return t.child};function xt(e,t,r){const n=this.options.updateTag(t.tagname,r,t[":@"]);!1===n||("string"==typeof n?(t.tagname=n,e.addChild(t)):e.addChild(t))}const kt=function(e){if(this.options.processEntities){for(let t in this.docTypeEntities){const r=this.docTypeEntities[t];e=e.replace(r.regx,r.val)}for(let t in this.lastEntities){const r=this.lastEntities[t];e=e.replace(r.regex,r.val)}if(this.options.htmlEntities)for(let t in this.htmlEntities){const r=this.htmlEntities[t];e=e.replace(r.regex,r.val)}e=e.replace(this.ampEntity.regex,this.ampEntity.val)}return e};function Et(e,t,r,n){return e&&(void 0===n&&(n=0===t.child.length),void 0!==(e=this.parseTextData(e,t.tagname,r,!1,!!t[":@"]&&0!==Object.keys(t[":@"]).length,n))&&""!==e&&t.add(this.options.textNodeName,e),e=""),e}function Pt(e,t,r){const n="*."+r;for(const r in e){const o=e[r];if(n===o||t===o)return!0}return!1}function St(e,t,r,n){const o=e.indexOf(t,r);if(-1===o)throw new Error(n);return o+t.length-1}function At(e,t,r,n=">"){const o=function(e,t,r=">"){let n,o="";for(let a=t;a<e.length;a++){let t=e[a];if(n)t===n&&(n="");else if('"'===t||"'"===t)n=t;else if(t===r[0]){if(!r[1])return{data:o,index:a};if(e[a+1]===r[1])return{data:o,index:a}}else"\t"===t&&(t=" ");o+=t}}(e,t+1,n);if(!o)return;let a=o.data;const i=o.index,s=a.search(/\s/);let c=a,l=!0;-1!==s&&(c=a.substring(0,s),a=a.substring(s+1).trimStart());const u=c;if(r){const e=c.indexOf(":");-1!==e&&(c=c.substr(e+1),l=c!==o.data.substr(e+1))}return{tagName:c,tagExp:a,closeIndex:i,attrExpPresent:l,rawTagName:u}}function Ct(e,t,r){const n=r;let o=1;for(;r<e.length;r++)if("<"===e[r])if("/"===e[r+1]){const a=St(e,">",r,`${t} is not closed`);if(e.substring(r+2,a).trim()===t&&(o--,0===o))return{tagContent:e.substring(n,r),i:a};r=a}else if("?"===e[r+1]){r=St(e,"?>",r+1,"StopNode is not closed.")}else if("!--"===e.substr(r+1,3)){r=St(e,"--\x3e",r+3,"StopNode is not closed.")}else if("!["===e.substr(r+1,2)){r=St(e,"]]>",r,"StopNode is not closed.")-2}else{const n=At(e,r,">");if(n){(n&&n.tagName)===t&&"/"!==n.tagExp[n.tagExp.length-1]&&o++,r=n.closeIndex}}}function It(e,t,r){if(t&&"string"==typeof e){const t=e.trim();return"true"===t||"false"!==t&&ht(e,r)}return void 0!==e?e:""}function Nt(e,t){return Tt(e,t)}function Tt(e,t,r){let n;const o={};for(let a=0;a<e.length;a++){const i=e[a],s=jt(i);let c="";if(c=void 0===r?s:r+"."+s,s===t.textNodeName)void 0===n?n=i[s]:n+=""+i[s];else{if(void 0===s)continue;if(i[s]){let e=Tt(i[s],t,c);const r=Mt(e,t);i[":@"]?Lt(e,i[":@"],c,t):1!==Object.keys(e).length||void 0===e[t.textNodeName]||t.alwaysCreateTextNode?0===Object.keys(e).length&&(t.alwaysCreateTextNode?e[t.textNodeName]="":e=""):e=e[t.textNodeName],void 0!==o[s]&&o.hasOwnProperty(s)?(Array.isArray(o[s])||(o[s]=[o[s]]),o[s].push(e)):t.isArray(s,c,r)?o[s]=[e]:o[s]=e}}}return"string"==typeof n?n.length>0&&(o[t.textNodeName]=n):void 0!==n&&(o[t.textNodeName]=n),o}function jt(e){const t=Object.keys(e);for(let e=0;e<t.length;e++){const r=t[e];if(":@"!==r)return r}}function Lt(e,t,r,n){if(t){const o=Object.keys(t),a=o.length;for(let i=0;i<a;i++){const a=o[i];n.isArray(a,r+"."+a,!0,!0)?e[a]=[t[a]]:e[a]=t[a]}}}function Mt(e,t){const{textNodeName:r}=t,n=Object.keys(e).length;return 0===n||!(1!==n||!e[r]&&"boolean"!=typeof e[r]&&0!==e[r])}function Ot(e,t){let r="";return t.format&&t.indentBy.length>0&&(r="\n"),Dt(e,t,"",r)}function Dt(e,t,r,n){let o="",a=!1;for(let i=0;i<e.length;i++){const s=e[i],c=Rt(s);if(void 0===c)continue;let l="";if(l=0===r.length?c:`${r}.${c}`,c===t.textNodeName){let e=s[c];Ft(l,t)||(e=t.tagValueProcessor(c,e),e=zt(e,t)),a&&(o+=n),o+=e,a=!1;continue}if(c===t.cdataPropName){a&&(o+=n),o+=`<![CDATA[${s[c][0][t.textNodeName]}]]>`,a=!1;continue}if(c===t.commentPropName){o+=n+`\x3c!--${s[c][0][t.textNodeName]}--\x3e`,a=!0;continue}if("?"===c[0]){const e=Bt(s[":@"],t),r="?xml"===c?"":n;let i=s[c][0][t.textNodeName];i=0!==i.length?" "+i:"",o+=r+`<${c}${i}${e}?>`,a=!0;continue}let u=n;""!==u&&(u+=t.indentBy);const d=n+`<${c}${Bt(s[":@"],t)}`,p=Dt(s[c],t,l,u);-1!==t.unpairedTags.indexOf(c)?t.suppressUnpairedNode?o+=d+">":o+=d+"/>":p&&0!==p.length||!t.suppressEmptyNode?p&&p.endsWith(">")?o+=d+`>${p}${n}</${c}>`:(o+=d+">",p&&""!==n&&(p.includes("/>")||p.includes("</"))?o+=n+t.indentBy+p+n:o+=p,o+=`</${c}>`):o+=d+"/>",a=!0}return o}function Rt(e){const t=Object.keys(e);for(let r=0;r<t.length;r++){const n=t[r];if(e.hasOwnProperty(n)&&":@"!==n)return n}}function Bt(e,t){let r="";if(e&&!t.ignoreAttributes)for(let n in e){if(!e.hasOwnProperty(n))continue;let o=t.attributeValueProcessor(n,e[n]);o=zt(o,t),!0===o&&t.suppressBooleanAttributes?r+=` ${n.substr(t.attributeNamePrefix.length)}`:r+=` ${n.substr(t.attributeNamePrefix.length)}="${o}"`}return r}function Ft(e,t){let r=(e=e.substr(0,e.length-t.textNodeName.length-1)).substr(e.lastIndexOf(".")+1);for(let n in t.stopNodes)if(t.stopNodes[n]===e||t.stopNodes[n]==="*."+r)return!0;return!1}function zt(e,t){if(e&&e.length>0&&t.processEntities)for(let r=0;r<t.entities.length;r++){const n=t.entities[r];e=e.replace(n.regex,n.val)}return e}const $t={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function Wt(e){this.options=Object.assign({},$t,e),!0===this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.ignoreAttributesFn=ft(this.options.ignoreAttributes),this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=Gt),this.processTextOrObjNode=Vt,this.options.format?(this.indentate=Ht,this.tagEndChar=">\n",this.newLine="\n"):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}function Vt(e,t,r,n){const o=this.j2x(e,r+1,n.concat(t));return void 0!==e[this.options.textNodeName]&&1===Object.keys(e).length?this.buildTextValNode(e[this.options.textNodeName],t,o.attrStr,r):this.buildObjectNode(o.val,t,o.attrStr,r)}function Ht(e){return this.options.indentBy.repeat(e)}function Gt(e){return!(!e.startsWith(this.options.attributeNamePrefix)||e===this.options.textNodeName)&&e.substr(this.attrPrefixLen)}Wt.prototype.build=function(e){return this.options.preserveOrder?Ot(e,this.options):(Array.isArray(e)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(e={[this.options.arrayNodeName]:e}),this.j2x(e,0,[]).val)},Wt.prototype.j2x=function(e,t,r){let n="",o="";const a=r.join(".");for(let i in e)if(Object.prototype.hasOwnProperty.call(e,i))if(void 0===e[i])this.isAttribute(i)&&(o+="");else if(null===e[i])this.isAttribute(i)||i===this.options.cdataPropName?o+="":"?"===i[0]?o+=this.indentate(t)+"<"+i+"?"+this.tagEndChar:o+=this.indentate(t)+"<"+i+"/"+this.tagEndChar;else if(e[i]instanceof Date)o+=this.buildTextValNode(e[i],i,"",t);else if("object"!=typeof e[i]){const r=this.isAttribute(i);if(r&&!this.ignoreAttributesFn(r,a))n+=this.buildAttrPairStr(r,""+e[i]);else if(!r)if(i===this.options.textNodeName){let t=this.options.tagValueProcessor(i,""+e[i]);o+=this.replaceEntitiesValue(t)}else o+=this.buildTextValNode(e[i],i,"",t)}else if(Array.isArray(e[i])){const n=e[i].length;let a="",s="";for(let c=0;c<n;c++){const n=e[i][c];if(void 0===n);else if(null===n)"?"===i[0]?o+=this.indentate(t)+"<"+i+"?"+this.tagEndChar:o+=this.indentate(t)+"<"+i+"/"+this.tagEndChar;else if("object"==typeof n)if(this.options.oneListGroup){const e=this.j2x(n,t+1,r.concat(i));a+=e.val,this.options.attributesGroupName&&n.hasOwnProperty(this.options.attributesGroupName)&&(s+=e.attrStr)}else a+=this.processTextOrObjNode(n,i,t,r);else if(this.options.oneListGroup){let e=this.options.tagValueProcessor(i,n);e=this.replaceEntitiesValue(e),a+=e}else a+=this.buildTextValNode(n,i,"",t)}this.options.oneListGroup&&(a=this.buildObjectNode(a,i,s,t)),o+=a}else if(this.options.attributesGroupName&&i===this.options.attributesGroupName){const t=Object.keys(e[i]),r=t.length;for(let o=0;o<r;o++)n+=this.buildAttrPairStr(t[o],""+e[i][t[o]])}else o+=this.processTextOrObjNode(e[i],i,t,r);return{attrStr:n,val:o}},Wt.prototype.buildAttrPairStr=function(e,t){return t=this.options.attributeValueProcessor(e,""+t),t=this.replaceEntitiesValue(t),this.options.suppressBooleanAttributes&&"true"===t?" "+e:" "+e+'="'+t+'"'},Wt.prototype.buildObjectNode=function(e,t,r,n){if(""===e)return"?"===t[0]?this.indentate(n)+"<"+t+r+"?"+this.tagEndChar:this.indentate(n)+"<"+t+r+this.closeTag(t)+this.tagEndChar;{let o="</"+t+this.tagEndChar,a="";return"?"===t[0]&&(a="?",o=""),!r&&""!==r||-1!==e.indexOf("<")?!1!==this.options.commentPropName&&t===this.options.commentPropName&&0===a.length?this.indentate(n)+`\x3c!--${e}--\x3e`+this.newLine:this.indentate(n)+"<"+t+r+a+this.tagEndChar+e+this.indentate(n)+o:this.indentate(n)+"<"+t+r+a+">"+e+o}},Wt.prototype.closeTag=function(e){let t="";return-1!==this.options.unpairedTags.indexOf(e)?this.options.suppressUnpairedNode||(t="/"):t=this.options.suppressEmptyNode?"/":`></${e}`,t},Wt.prototype.buildTextValNode=function(e,t,r,n){if(!1!==this.options.cdataPropName&&t===this.options.cdataPropName)return this.indentate(n)+`<![CDATA[${e}]]>`+this.newLine;if(!1!==this.options.commentPropName&&t===this.options.commentPropName)return this.indentate(n)+`\x3c!--${e}--\x3e`+this.newLine;if("?"===t[0])return this.indentate(n)+"<"+t+r+"?"+this.tagEndChar;{let o=this.options.tagValueProcessor(t,e);return o=this.replaceEntitiesValue(o),""===o?this.indentate(n)+"<"+t+r+this.closeTag(t)+this.tagEndChar:this.indentate(n)+"<"+t+r+">"+o+"</"+t+this.tagEndChar}},Wt.prototype.replaceEntitiesValue=function(e){if(e&&e.length>0&&this.options.processEntities)for(let t=0;t<this.options.entities.length;t++){const r=this.options.entities[t];e=e.replace(r.regex,r.val)}return e};function qt(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return Ut(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Ut(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,a=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw a}}}}function Ut(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}var Kt="If you are creating a new entry you should write it like this:\n```xml\n<lorebooks>\n    <entry>\n        <worldName>World 1</worldName>\n        <name>Book 1</name>\n        <triggers>word1,word2</triggers>\n        <content>Content of book 1</content>\n    </entry>\n</lorebooks>\n```\n\nIf you are updating an existing entry you should specify the id of the entry. Like this:\n```xml\n<lorebooks>\n    <entry>\n        <worldName>World 1</worldName>\n        <id>15</id> // Id should be the id of the entry\n        <name>Book 1</name>\n        <triggers>word1,word2</triggers>\n        <content>Content of book 1</content>\n    </entry>\n</lorebooks>\n```",Yt=new class{constructor(e){this.externalEntities={},this.options=function(e){return Object.assign({},et,e)}(e)}parse(e,t){if("string"==typeof e);else{if(!e.toString)throw new Error("XML data is accepted in String or Bytes[] form.");e=e.toString()}if(t){!0===t&&(t={});const r=ze(e,t);if(!0!==r)throw Error(`${r.err.msg}:${r.err.line}:${r.err.col}`)}const r=new mt(this.options);r.addExternalEntities(this.externalEntities);const n=r.parseXml(e);return this.options.preserveOrder||void 0===n?n:Nt(n,this.options)}addEntity(e,t){if(-1!==t.indexOf("&"))throw new Error("Entity value can't have '&'");if(-1!==e.indexOf("&")||-1!==e.indexOf(";"))throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if("&"===t)throw new Error("An entity with value '&' is not permitted");this.externalEntities[e]=t}};function Xt(e){var t,r,n,o=e.replace(/```xml/g,"").replace(/```/g,""),a={};try{var i,s=Yt.parse(o);if(!s.lorebooks)return a;var c,l=qt(null!==(i=s.lorebooks.entry)&&void 0!==i&&i.content?[s.lorebooks.entry]:s.lorebooks.entry);try{for(l.s();!(c=l.n()).done;){var u,d,p,h=c.value,f=h.worldName;f&&(a[f]||(a[f]=[]),a[f].push({uid:null!==(u=h.id)&&void 0!==u?u:(t=6,r=void 0,n=void 0,r=Math.pow(10,t-1),n=Math.pow(10,t)-1,Math.floor(Math.random()*(n-r+1))+r),key:null!==(d=null===(p=h.triggers)||void 0===p?void 0:p.split(",").map((function(e){return e.trim()})))&&void 0!==d?d:[],content:h.content,comment:h.name}))}}catch(e){l.e(e)}finally{l.f()}return a}catch(e){throw console.error(e),new Error("Model response is not valid XML")}}var Zt=f(552),Jt=f.n(Zt);const Qt=(e=>{var t={};return f.d(t,e),t})({Handlebars:()=>d.Handlebars});function er(e){return er="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},er(e)}function tr(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */tr=function(){return t};var e,t={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(e,t,r){e[t]=r.value},a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",c=a.toStringTag||"@@toStringTag";function l(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,r){return e[t]=r}}function u(e,t,r,n){var a=t&&t.prototype instanceof b?t:b,i=Object.create(a.prototype),s=new N(n||[]);return o(i,"_invoke",{value:S(e,r,s)}),i}function d(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var p="suspendedStart",h="suspendedYield",f="executing",m="completed",g={};function b(){}function v(){}function _(){}var w={};l(w,i,(function(){return this}));var y=Object.getPrototypeOf,x=y&&y(y(T([])));x&&x!==r&&n.call(x,i)&&(w=x);var k=_.prototype=b.prototype=Object.create(w);function E(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function P(e,t){function r(o,a,i,s){var c=d(e[o],e,a);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==er(u)&&n.call(u,"__await")?t.resolve(u.__await).then((function(e){r("next",e,i,s)}),(function(e){r("throw",e,i,s)})):t.resolve(u).then((function(e){l.value=e,i(l)}),(function(e){return r("throw",e,i,s)}))}s(c.arg)}var a;o(this,"_invoke",{value:function(e,n){function o(){return new t((function(t,o){r(e,n,t,o)}))}return a=a?a.then(o,o):o()}})}function S(t,r,n){var o=p;return function(a,i){if(o===f)throw Error("Generator is already running");if(o===m){if("throw"===a)throw i;return{value:e,done:!0}}for(n.method=a,n.arg=i;;){var s=n.delegate;if(s){var c=A(s,n);if(c){if(c===g)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===p)throw o=m,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=f;var l=d(t,r,n);if("normal"===l.type){if(o=n.done?m:h,l.arg===g)continue;return{value:l.arg,done:n.done}}"throw"===l.type&&(o=m,n.method="throw",n.arg=l.arg)}}}function A(t,r){var n=r.method,o=t.iterator[n];if(o===e)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=e,A(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),g;var a=d(o,t.iterator,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,g;var i=a.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,g):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,g)}function C(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function I(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function N(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(C,this),this.reset(!0)}function T(t){if(t||""===t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function r(){for(;++o<t.length;)if(n.call(t,o))return r.value=t[o],r.done=!1,r;return r.value=e,r.done=!0,r};return a.next=a}}throw new TypeError(er(t)+" is not iterable")}return v.prototype=_,o(k,"constructor",{value:_,configurable:!0}),o(_,"constructor",{value:v,configurable:!0}),v.displayName=l(_,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,_):(e.__proto__=_,l(e,c,"GeneratorFunction")),e.prototype=Object.create(k),e},t.awrap=function(e){return{__await:e}},E(P.prototype),l(P.prototype,s,(function(){return this})),t.AsyncIterator=P,t.async=function(e,r,n,o,a){void 0===a&&(a=Promise);var i=new P(u(e,r,n,o),a);return t.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},E(k),l(k,c,"Generator"),l(k,i,(function(){return this})),l(k,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},t.values=T,N.prototype={constructor:N,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(I),!t)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function o(n,o){return s.type="throw",s.arg=t,r.next=n,o&&(r.method="next",r.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],s=i.completion;if("root"===i.tryLoc)return o("end");if(i.tryLoc<=this.prev){var c=n.call(i,"catchLoc"),l=n.call(i,"finallyLoc");if(c&&l){if(this.prev<i.catchLoc)return o(i.catchLoc,!0);if(this.prev<i.finallyLoc)return o(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return o(i.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return o(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,g):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),I(r),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;I(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={iterator:T(t),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=e),g}},t}function rr(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,o,a,i,s=[],c=!0,l=!1;try{if(a=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;c=!1}else for(;!(c=(n=a.call(r)).done)&&(s.push(n.value),s.length!==t);c=!0);}catch(e){l=!0,o=e}finally{try{if(!c&&null!=r.return&&(i=r.return(),Object(i)!==i))return}finally{if(l)throw o}}return s}}(e,t)||or(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function nr(e){return function(e){if(Array.isArray(e))return ar(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||or(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function or(e,t){if(e){if("string"==typeof e)return ar(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?ar(e,t):void 0}}function ar(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function ir(e,t,r,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,o)}var sr=SillyTavern.getContext();function cr(e){return lr.apply(this,arguments)}function lr(){var e;return e=tr().mark((function e(t){var r,n,o,a,i,s,c,l,u,d,p,h,f,m,g,b,v,_,w,y,x,k,E,P;return tr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.profileId,o=t.userPrompt,a=t.buildPromptOptions,i=t.contextToSend,s=t.session,c=t.entriesGroupByWorldName,l=t.promptSettings,u=t.maxResponseToken,n){e.next=3;break}throw new Error("No connection profile selected.");case 3:if(d=SillyTavern.getContext(),p=null===(r=d.extensionSettings.connectionManager)||void 0===r||null===(r=r.profiles)||void 0===r?void 0:r.find((function(e){return e.id===n}))){e.next=7;break}throw new Error('Connection profile with ID "'.concat(n,'" not found.'));case 7:if(h=sr.substituteParams(o.trim())){e.next=10;break}throw new Error("Prompt is empty after macro substitution.");case 10:if(f=[],m=p.api?sr.CONNECT_API_MAP[p.api].selected:void 0){e.next=14;break}throw new Error('Could not determine API for profile "'.concat(p.name,'".'));case 14:return e.t0=f.push,e.t1=f,e.t2=nr,e.next=19,Ce(m,a);case 19:return e.t3=e.sent,e.t4=(0,e.t2)(e.t3),e.t0.apply.call(e.t0,e.t1,e.t4),i.stDescription&&f.push({role:"system",content:l.stWorldInfoPrompt}),i.worldInfo&&s.selectedWorldNames.length>0&&(g=Qt.Handlebars.compile(l.lorebookDefinitionPrompt,{noEscape:!0}),b={},Object.entries(c).filter((function(e){var t=rr(e,2),r=t[0];return t[1].length>0&&s.selectedWorldNames.includes(r)})).forEach((function(e){var t=rr(e,2),r=t[0],n=t[1];b[r]=n})),(v=g({lorebooks:b}))&&f.push({role:"assistant",content:"=== CURRENT LOREBOOKS ===\n".concat(v)})),s.blackListedEntries.length>0&&(_="# Blacklisted Entries:\n",s.blackListedEntries.forEach((function(e){_+="- ".concat(e,"\n")})),f.push({role:"system",content:_})),i.suggestedEntries&&Object.keys(s.suggestedEntries).length>0&&Object.values(s.suggestedEntries).some((function(e){return e.length>0}))&&(w=Qt.Handlebars.compile(l.lorebookDefinitionPrompt,{noEscape:!0}),y={},Object.entries(s.suggestedEntries).filter((function(e){var t=rr(e,2);return t[0],t[1].length>0})).forEach((function(e){var t=rr(e,2),r=t[0],n=t[1];y[r]=n})),x=w({lorebooks:y}),f.push({role:"system",content:"=== Already suggested entries ===\n".concat(x)})),k="".concat(l.responseRulesPrompt,"\n\n").concat(l.lorebookRulesPrompt,"\n\nYour task:\n").concat(h),f.push({role:"user",content:k}),e.next=30,sr.ConnectionManagerRequestService.sendRequest(n,f,u);case 30:if(E=e.sent,P=Xt(E.content),0!==Object.keys(P).length){e.next=34;break}return e.abrupt("return",{});case 34:return Object.entries(P).forEach((function(e){var t=rr(e,2),r=t[0],n=t[1];c[r]&&n.forEach((function(e){var t,n=null===(t=c[r])||void 0===t?void 0:t.find((function(t){return t.uid===e.uid}));n&&(0===e.key.length&&(e.key=n.key),e.comment||(e.comment=n.comment)),null!==e.comment&&void 0!==e.comment||(e.comment="")}))})),e.abrupt("return",P);case 36:case"end":return e.stop()}}),e)})),lr=function(){var t=this,r=arguments;return new Promise((function(n,o){var a=e.apply(t,r);function i(e){ir(a,n,o,i,s,"next",e)}function s(e){ir(a,n,o,i,s,"throw",e)}i(void 0)}))},lr.apply(this,arguments)}function ur(e,t,r){r[t]||(r[t]=[]);var n,o=r[t],a=o.findIndex((function(t){return t.uid===e.uid})),i=-1!==a;if(i)n=o[a];else{var s={entries:{}};o.forEach((function(e){return s.entries[e.uid]=e}));var c=Se(t,s);if(!c)throw new Error('Failed to create a new entry structure in world "'.concat(t,'"'));var l=o.length>0?o[o.length-1]:void 0;if(l){var u=c.uid;Object.assign(c,l),c.uid=u}n=c,o.push(n)}return n.key=e.key,n.content=e.content,n.comment=e.comment,{modifiedEntry:n,status:i?"updated":"added"}}function dr(){var e,t,r=null!==(e=null===(t=sr.extensionSettings)||void 0===t||null===(t=t.connectionManager)||void 0===t?void 0:t.profiles)&&void 0!==e?e:[];return r.map((function(e){var t;return{value:null!==(t=e.name)&&void 0!==t?t:e.id,valueProvider:function(e){var t;return null===(t=r.find((function(t){var r;return null===(r=t.name)||void 0===r?void 0:r.includes(e)})))||void 0===t?void 0:t.name}}}))}var pr,hr="SillyTavern-WorldInfo-Recommender",fr={version:"0.1.1",formatVersion:"F_1.0",profileId:"",maxContextType:"profile",maxContextValue:16384,maxResponseToken:1024,contextToSend:{stDescription:!0,messages:{type:"all",first:10,last:10,range:{start:0,end:10}},charCard:!0,authorNote:!0,worldInfo:!0,suggestedEntries:!0},stWorldInfoPrompt:je,usingDefaultStWorldInfoPrompt:!0,lorebookDefinitionPrompt:Le,usingDefaultLorebookDefinitionPrompt:!0,lorebookRulesPrompt:Me,usingDefaultLorebookRulesPrompt:!0,responseRulesPrompt:Kt,usingDefaultResponseRulesPrompt:!0,promptPreset:"default",promptPresets:{default:{content:""}}},mr=new class{settingsKey;defaultSettings;constructor(e,t){this.settingsKey=e,this.defaultSettings=t}async initializeSettings(e={}){const{strategy:t="recursive"}=e,r=this.defaultSettings.version,n=this.defaultSettings.formatVersion,o=SillyTavern.getContext().extensionSettings[this.settingsKey],a={version:{changed:!1,new:r??""},formatVersion:{changed:!1,new:n??""},oldSettings:null,newSettings:this.defaultSettings};if(!o)return SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings(),a;const i={...a,oldSettings:structuredClone(o),version:{changed:!1,old:o.version,new:o.version},formatVersion:{changed:!1,old:o.formatVersion,new:o.formatVersion}};if("recursive"===t){function s(e,t){let r=!1;for(const n of Object.keys(t))void 0===e[n]?(e[n]=t[n],r=!0):"object"==typeof t[n]&&null!==t[n]&&(e[n]=e[n]||{},s(e[n],t[n])&&(r=!0));return r}r&&o.version!==r&&(i.version.changed=!0,i.version.new=r,o.version=r),n&&o.formatVersion!==n&&(i.formatVersion.changed=!0,i.formatVersion.new=n,o.formatVersion=n),(s(o,this.defaultSettings)||i.version.changed||i.formatVersion.changed)&&this.saveSettings()}else if(Array.isArray(t)){r&&!o.version&&(o.version=r,i.version.changed=!0,i.version.new=r),n&&!o.formatVersion&&(o.formatVersion=n,i.formatVersion.changed=!0,i.formatVersion.new=n);let c=structuredClone(o),l=o.formatVersion;try{for(const u of t)if(l===u.from){c=await u.action(c),l=u.to,c.formatVersion=u.to;const d=this.defaultSettings.version;d&&(c.version=d),i.formatVersion.changed=!0,i.formatVersion.new=u.to}if(i.formatVersion.changed){Object.assign(o,c);for(const p of Object.keys(o))Object.keys(c).includes(p)||delete o[p];this.saveSettings()}}catch(h){throw console.error("Failed to apply version changes:",h),new Error(`Version migration failed: ${h instanceof Error?h.message:h}`,{cause:h})}}return i.newSettings=o,i}getSettings(){return SillyTavern.getContext().extensionSettings[this.settingsKey]}updateSetting(e,t){SillyTavern.getContext().extensionSettings[this.settingsKey][e]=t,this.saveSettings()}saveSettings(){SillyTavern.getContext().saveSettingsDebounced()}resetSettings(){SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings()}}("worldInfoRecommender",fr);function gr(e){return gr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},gr(e)}function br(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,o,a,i,s=[],c=!0,l=!1;try{if(a=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;c=!1}else for(;!(c=(n=a.call(r)).done)&&(s.push(n.value),s.length!==t);c=!0);}catch(e){l=!0,o=e}finally{try{if(!c&&null!=r.return&&(i=r.return(),Object(i)!==i))return}finally{if(l)throw o}}return s}}(e,t)||Pr(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function vr(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function _r(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?vr(Object(r),!0).forEach((function(t){wr(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):vr(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function wr(e,t,r){return(t=function(e){var t=function(e,t){if("object"!=gr(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=gr(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==gr(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function yr(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */yr=function(){return t};var e,t={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(e,t,r){e[t]=r.value},a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",c=a.toStringTag||"@@toStringTag";function l(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,r){return e[t]=r}}function u(e,t,r,n){var a=t&&t.prototype instanceof b?t:b,i=Object.create(a.prototype),s=new N(n||[]);return o(i,"_invoke",{value:S(e,r,s)}),i}function d(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var p="suspendedStart",h="suspendedYield",f="executing",m="completed",g={};function b(){}function v(){}function _(){}var w={};l(w,i,(function(){return this}));var y=Object.getPrototypeOf,x=y&&y(y(T([])));x&&x!==r&&n.call(x,i)&&(w=x);var k=_.prototype=b.prototype=Object.create(w);function E(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function P(e,t){function r(o,a,i,s){var c=d(e[o],e,a);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==gr(u)&&n.call(u,"__await")?t.resolve(u.__await).then((function(e){r("next",e,i,s)}),(function(e){r("throw",e,i,s)})):t.resolve(u).then((function(e){l.value=e,i(l)}),(function(e){return r("throw",e,i,s)}))}s(c.arg)}var a;o(this,"_invoke",{value:function(e,n){function o(){return new t((function(t,o){r(e,n,t,o)}))}return a=a?a.then(o,o):o()}})}function S(t,r,n){var o=p;return function(a,i){if(o===f)throw Error("Generator is already running");if(o===m){if("throw"===a)throw i;return{value:e,done:!0}}for(n.method=a,n.arg=i;;){var s=n.delegate;if(s){var c=A(s,n);if(c){if(c===g)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===p)throw o=m,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=f;var l=d(t,r,n);if("normal"===l.type){if(o=n.done?m:h,l.arg===g)continue;return{value:l.arg,done:n.done}}"throw"===l.type&&(o=m,n.method="throw",n.arg=l.arg)}}}function A(t,r){var n=r.method,o=t.iterator[n];if(o===e)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=e,A(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),g;var a=d(o,t.iterator,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,g;var i=a.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,g):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,g)}function C(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function I(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function N(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(C,this),this.reset(!0)}function T(t){if(t||""===t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function r(){for(;++o<t.length;)if(n.call(t,o))return r.value=t[o],r.done=!1,r;return r.value=e,r.done=!0,r};return a.next=a}}throw new TypeError(gr(t)+" is not iterable")}return v.prototype=_,o(k,"constructor",{value:_,configurable:!0}),o(_,"constructor",{value:v,configurable:!0}),v.displayName=l(_,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,_):(e.__proto__=_,l(e,c,"GeneratorFunction")),e.prototype=Object.create(k),e},t.awrap=function(e){return{__await:e}},E(P.prototype),l(P.prototype,s,(function(){return this})),t.AsyncIterator=P,t.async=function(e,r,n,o,a){void 0===a&&(a=Promise);var i=new P(u(e,r,n,o),a);return t.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},E(k),l(k,c,"Generator"),l(k,i,(function(){return this})),l(k,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},t.values=T,N.prototype={constructor:N,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(I),!t)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function o(n,o){return s.type="throw",s.arg=t,r.next=n,o&&(r.method="next",r.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],s=i.completion;if("root"===i.tryLoc)return o("end");if(i.tryLoc<=this.prev){var c=n.call(i,"catchLoc"),l=n.call(i,"finallyLoc");if(c&&l){if(this.prev<i.catchLoc)return o(i.catchLoc,!0);if(this.prev<i.finallyLoc)return o(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return o(i.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return o(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,g):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),I(r),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;I(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={iterator:T(t),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=e),g}},t}function xr(e,t,r,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,o)}function kr(e){return function(){var t=this,r=arguments;return new Promise((function(n,o){var a=e.apply(t,r);function i(e){xr(a,n,o,i,s,"next",e)}function s(e){xr(a,n,o,i,s,"throw",e)}i(void 0)}))}}function Er(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=Pr(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,a=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw a}}}}function Pr(e,t){if(e){if("string"==typeof e)return Sr(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Sr(e,t):void 0}}function Sr(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function Ar(e){return Ar="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ar(e)}function Cr(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,o,a,i,s=[],c=!0,l=!1;try{if(a=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;c=!1}else for(;!(c=(n=a.call(r)).done)&&(s.push(n.value),s.length!==t);c=!0);}catch(e){l=!0,o=e}finally{try{if(!c&&null!=r.return&&(i=r.return(),Object(i)!==i))return}finally{if(l)throw o}}return s}}(e,t)||Nr(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ir(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=Nr(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,a=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw a}}}}function Nr(e,t){if(e){if("string"==typeof e)return Tr(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Tr(e,t):void 0}}function Tr(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function jr(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */jr=function(){return t};var e,t={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(e,t,r){e[t]=r.value},a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",c=a.toStringTag||"@@toStringTag";function l(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,r){return e[t]=r}}function u(e,t,r,n){var a=t&&t.prototype instanceof b?t:b,i=Object.create(a.prototype),s=new N(n||[]);return o(i,"_invoke",{value:S(e,r,s)}),i}function d(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var p="suspendedStart",h="suspendedYield",f="executing",m="completed",g={};function b(){}function v(){}function _(){}var w={};l(w,i,(function(){return this}));var y=Object.getPrototypeOf,x=y&&y(y(T([])));x&&x!==r&&n.call(x,i)&&(w=x);var k=_.prototype=b.prototype=Object.create(w);function E(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function P(e,t){function r(o,a,i,s){var c=d(e[o],e,a);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==Ar(u)&&n.call(u,"__await")?t.resolve(u.__await).then((function(e){r("next",e,i,s)}),(function(e){r("throw",e,i,s)})):t.resolve(u).then((function(e){l.value=e,i(l)}),(function(e){return r("throw",e,i,s)}))}s(c.arg)}var a;o(this,"_invoke",{value:function(e,n){function o(){return new t((function(t,o){r(e,n,t,o)}))}return a=a?a.then(o,o):o()}})}function S(t,r,n){var o=p;return function(a,i){if(o===f)throw Error("Generator is already running");if(o===m){if("throw"===a)throw i;return{value:e,done:!0}}for(n.method=a,n.arg=i;;){var s=n.delegate;if(s){var c=A(s,n);if(c){if(c===g)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===p)throw o=m,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=f;var l=d(t,r,n);if("normal"===l.type){if(o=n.done?m:h,l.arg===g)continue;return{value:l.arg,done:n.done}}"throw"===l.type&&(o=m,n.method="throw",n.arg=l.arg)}}}function A(t,r){var n=r.method,o=t.iterator[n];if(o===e)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=e,A(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),g;var a=d(o,t.iterator,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,g;var i=a.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,g):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,g)}function C(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function I(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function N(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(C,this),this.reset(!0)}function T(t){if(t||""===t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function r(){for(;++o<t.length;)if(n.call(t,o))return r.value=t[o],r.done=!1,r;return r.value=e,r.done=!0,r};return a.next=a}}throw new TypeError(Ar(t)+" is not iterable")}return v.prototype=_,o(k,"constructor",{value:_,configurable:!0}),o(_,"constructor",{value:v,configurable:!0}),v.displayName=l(_,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,_):(e.__proto__=_,l(e,c,"GeneratorFunction")),e.prototype=Object.create(k),e},t.awrap=function(e){return{__await:e}},E(P.prototype),l(P.prototype,s,(function(){return this})),t.AsyncIterator=P,t.async=function(e,r,n,o,a){void 0===a&&(a=Promise);var i=new P(u(e,r,n,o),a);return t.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},E(k),l(k,c,"Generator"),l(k,i,(function(){return this})),l(k,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},t.values=T,N.prototype={constructor:N,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(I),!t)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function o(n,o){return s.type="throw",s.arg=t,r.next=n,o&&(r.method="next",r.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],s=i.completion;if("root"===i.tryLoc)return o("end");if(i.tryLoc<=this.prev){var c=n.call(i,"catchLoc"),l=n.call(i,"finallyLoc");if(c&&l){if(this.prev<i.catchLoc)return o(i.catchLoc,!0);if(this.prev<i.finallyLoc)return o(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return o(i.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return o(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,g):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),I(r),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;I(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={iterator:T(t),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=e),g}},t}function Lr(e,t,r,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,o)}function Mr(e){return function(){var t=this,r=arguments;return new Promise((function(n,o){var a=e.apply(t,r);function i(e){Lr(a,n,o,i,s,"next",e)}function s(e){Lr(a,n,o,i,s,"throw",e)}i(void 0)}))}}Qt.Handlebars.helpers.join||Qt.Handlebars.registerHelper("join",(function(e,t){return e.join(t)}));var Or=new(Jt().Converter);function Dr(){return Dr=Mr(jr().mark((function e(){var t,r,n,o,a,i,s,c,l,u,d,p,h;return jr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,sr.renderExtensionTemplateAsync("third-party/".concat(hr),"templates/settings");case 2:t=e.sent,$("#extensions_settings").append(t),r=$(".worldInfoRecommender_settings"),n=mr.getSettings(),o=r.find(".stWorldInfoPrompt"),a=o.find("textarea"),i=r.find(".lorebookDefinitionPrompt"),s=i.find("textarea"),c=r.find(".lorebookRulesPrompt"),l=c.find("textarea"),u=r.find(".responseRulesPrompt"),d=u.find("textarea"),a.val(n.stWorldInfoPrompt),s.val(n.lorebookDefinitionPrompt),l.val(n.lorebookRulesPrompt),d.val(n.responseRulesPrompt),o.find(".restore_default").on("click",Mr(jr().mark((function e(){return jr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,sr.Popup.show.confirm("Are you sure you want to restore the default ST/World Info description?","World Info Recommender");case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:a.val(je),a.trigger("change");case 7:case"end":return e.stop()}}),e)})))),i.find(".restore_default").on("click",Mr(jr().mark((function e(){return jr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,sr.Popup.show.confirm("Are you sure you want to restore the default lorebook definition?","World Info Recommender");case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:s.val(Le),s.trigger("change");case 7:case"end":return e.stop()}}),e)})))),c.find(".restore_default").on("click",Mr(jr().mark((function e(){return jr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,sr.Popup.show.confirm("Are you sure you want to restore the default lorebook rules?","World Info Recommender");case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:l.val(Me),l.trigger("change");case 7:case"end":return e.stop()}}),e)})))),u.find(".restore_default").on("click",Mr(jr().mark((function e(){return jr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,sr.Popup.show.confirm("Are you sure you want to restore the default response rules?","World Info Recommender");case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:d.val(Kt),d.trigger("change");case 7:case"end":return e.stop()}}),e)})))),a.on("change",(function(){var e;n.stWorldInfoPrompt=null!==(e=a.val())&&void 0!==e?e:"",n.usingDefaultStWorldInfoPrompt=n.stWorldInfoPrompt===je,mr.saveSettings()})),s.on("change",(function(){var e;n.lorebookDefinitionPrompt=null!==(e=s.val())&&void 0!==e?e:"",n.usingDefaultLorebookDefinitionPrompt=n.lorebookDefinitionPrompt===Le,mr.saveSettings()})),l.on("change",(function(){var e;n.lorebookRulesPrompt=null!==(e=l.val())&&void 0!==e?e:"",n.usingDefaultLorebookRulesPrompt=n.lorebookRulesPrompt===Me,mr.saveSettings()})),d.on("change",(function(){var e;n.responseRulesPrompt=null!==(e=d.val())&&void 0!==e?e:"",n.usingDefaultResponseRulesPrompt=n.responseRulesPrompt===Kt,mr.saveSettings()})),p='<div class="menu_button fa-brands fa-wpexplorer interactable worldInfoRecommender-icon" title="World Info Recommender"></div>',$(".form_create_bottom_buttons_block").prepend($(p)),$("#GroupFavDelOkBack").prepend($(p)),$("#form_character_search_form").prepend(p),h=$(".worldInfoRecommender-icon"),f=h.eq(0),pr=f,h.on("click",Mr(jr().mark((function e(){var t,r,o,a,i,s,c,l,u,d,p,h,f,m,g,b,v,_,w,y,x,k,E,P,S,A,C,I,N,T,j,L,M,O,D,R,B,F,z,W,V,H,G,q,U,K,Y,X,Z,J,Q,ee,te,re,ne,oe,ae,se,ue,de,pe;return jr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return pe=function(){oe.empty(),X.suggestedEntries={},X.blackListedEntries=[],X.selectedWorldNames=structuredClone(K),ee(),Z()},de=function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"classic";function n(e,t){var r=e.data("world-name"),n=e.data("id"),o=e.data("comment");e&&r&&null!=n&&o?(t&&X.blackListedEntries.push("".concat(r," (").concat(o,")")),X.suggestedEntries[r]=X.suggestedEntries[r].filter((function(e){return e.uid!==parseInt(n)})),e.remove()):r||ve("warning","Selected entry is missing world name")}Object.entries(e).forEach((function(e){var n=Cr(e,2),o=n[0];n[1].forEach((function(e){var n=o,a=K.indexOf(n);-1===a&&(n=t||(K.length>0?K[0]:"")),a=K.indexOf(n),X.suggestedEntries[o]||(X.suggestedEntries[o]=[]);var i,s="initial"===r?void 0:X.suggestedEntries[o].find((function(t){return t.uid===e.uid&&t.comment===e.comment}));if(s){var c='.entry[data-id="'.concat(e.uid,'"][data-world-name="').concat(o,'"]');i=oe.find(c)}else i=$(ae.html());if(i.attr("data-world-name",o),i.attr("data-id",e.uid.toString()),i.attr("data-comment",e.comment),n){var l,u=null===(l=V[n])||void 0===l?void 0:l.find((function(t){return t.uid===e.uid}));i.find(".add").text(u?"Update":"Add")}var d=i.find(".world-select");d.empty(),K.forEach((function(e,t){var r=document.createElement("option");r.value=t.toString(),r.text=e,d.append(r)})),-1!==a&&d.val(a.toString()),d.on("change",(function(){var t,r=parseInt($(this).val());if(!(isNaN(r)||r<0||r>=K.length)){var n=K[r],o=null===(t=V[n])||void 0===t?void 0:t.find((function(t){return t.uid===e.uid&&t.comment===e.comment}));i.find(".add").text(o?"Update":"Add")}})),i.find(".comment").text(e.comment),i.find(".key").text(e.key.join(", ")),i.find(".content").html(Or.makeHtml(e.content)),"classic"===r&&(s?(s.key=e.key,s.content=e.content,s.comment=e.comment):X.suggestedEntries[o].push(e)),s||oe.append(i)}))})),"classic"===r&&Object.keys(e).length>0&&Z(),oe.find(".blacklist").on("click",(function(e){var t=$(e.currentTarget).closest(".entry");t&&(n(t,!0),Z())})),oe.find(".remove").on("click",(function(e){var t=$(e.currentTarget).closest(".entry");t&&(n(t,!1),Z())}));var o=oe.find(".add");o.on("click",function(){var e=Mr(jr().mark((function e(r){var a,i,s,c,l,u,d,p;return jr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,o.prop("disabled",!0),a=$(r.currentTarget).closest(".entry")){e.next=5;break}return e.abrupt("return");case 5:if(i=a.data("world-name"),s=a.data("id"),c=a.data("comment"),a&&i&&null!=s&&c){e.next=11;break}return i||ve("warning","Selected entry is missing world name"),e.abrupt("return");case 11:if(l=structuredClone(X.suggestedEntries[i].find((function(e){return e.uid===parseInt(s)}))),l){e.next=14;break}return e.abrupt("return");case 14:if(u=a.find(".world-select"),d=parseInt(u.val()),!(isNaN(d)||d<0||d>=K.length)){e.next=19;break}return ve("warning","Please select a valid world"),e.abrupt("return");case 19:return p=K[d],t=p,n(a,!1),e.next=24,se(l,p);case 24:ve("success","added"===e.sent?"Entry added":"Entry updated"),e.next=32;break;case 28:e.prev=28,e.t0=e.catch(0),console.error(e.t0),ve("error",e.t0 instanceof Error?e.t0.message:e.t0);case 32:return e.prev=32,o.prop("disabled",!1),e.finish(32);case 35:case"end":return e.stop()}}),e,null,[[0,28,32,35]])})));return function(t){return e.apply(this,arguments)}}())},ue=function(){return ue=Mr(jr().mark((function e(t,r){var n,o,a,i,s,c,l,u,d,p,h,f,m=arguments;return jr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=m.length>2&&void 0!==m[2]&&m[2],V[r]||(V[r]=[]),a={entries:{}},i=Ir(V[r]);try{for(i.s();!(s=i.n()).done;)c=s.value,a.entries[c.uid]=c}catch(e){i.e(e)}finally{i.f()}if(l=null===(n=V[r])||void 0===n?void 0:n.find((function(e){return e.uid===t.uid})),!(d=!!l)){e.next=11;break}u=l,e.next=19;break;case 11:if(p=Object.values(a.entries),h=p.length>0?p[p.length-1]:void 0,u=Se(r,a)){e.next=16;break}throw new Error("Failed to create entry");case 16:f=u.uid,h&&Object.assign(u,h),u.uid=f;case 19:if(u.key=t.key,u.content=t.content,u.comment=t.comment,a.entries[u.uid]=u,V[r]=Object.values(a.entries),o){e.next=29;break}return e.next=27,sr.saveWorldInfo(r,a);case 27:sr.reloadWorldInfoEditor(r,!0),Z();case 29:return e.abrupt("return",d?"updated":"added");case 30:case"end":return e.stop()}}),e)}))),ue.apply(this,arguments)},se=function(e,t){return ue.apply(this,arguments)},Z=function(){localStorage.setItem(Y,JSON.stringify(X))},R=function(e){switch(N.hide(),T.hide(),j.hide(),e){case"first":N.show();break;case"last":T.show();break;case"range":j.show()}},e.next=8,sr.renderExtensionTemplateAsync("third-party/".concat(hr),"templates/popup");case 8:if(d=e.sent,sr.callGenericPopup(d,Ne.DISPLAY,void 0,{large:!0,wide:!0}),p=$("#worldInfoRecommenderPopup"),sr.ConnectionManagerRequestService.handleDropdown("#worldInfoRecommenderPopup #worldInfoRecommend_connectionProfile",n.profileId,(function(e){var t;n.profileId=null!==(t=null==e?void 0:e.id)&&void 0!==t?t:"",mr.saveSettings()})),h=SillyTavern.getContext(),f=p.find("#worldInfoRecommend_charCardContainer"),m=f.find("#worldInfoRecommend_charCardSelect"),!fe.selected_group){e.next=40;break}if(b=fe.groups.findIndex((function(e){return e.id===fe.selected_group})),0!==(v=fe.groups[b]).generation_mode){e.next=39;break}m.empty(),_=Ir(v.members),e.prev=21,y=jr().mark((function e(){var t,r,n;return jr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=w.value,r=h.characters.findIndex((function(e){return e.avatar===t})),n=h.characters[r].name,m.append('<option value="'.concat(r,'">').concat(n,"</option>"));case 4:case"end":return e.stop()}}),e)})),_.s();case 24:if((w=_.n()).done){e.next=28;break}return e.delegateYield(y(),"t0",26);case 26:e.next=24;break;case 28:e.next=33;break;case 30:e.prev=30,e.t1=e.catch(21),_.e(e.t1);case 33:return e.prev=33,_.f(),e.finish(33);case 36:f.show(),e.next=40;break;case 39:v.members.length>0&&(g=h.characters.findIndex((function(e){return e.avatar===v.members[0]})));case 40:if(x=ce.this_chid?Pe(ce.this_chid):fe.selected_group,k=p.find("#worldInfoRecommend_stDescription"),E=p.find(".message-options"),x||E.hide(),P=p.find("#worldInfoRecommend_charCard"),S=p.find("#worldInfoRecommend_authorNote"),A=p.find("#worldInfoRecommend_worldInfo"),C=p.find("#worldInfoRecommend_includeSuggestedEntries"),k.prop("checked",n.contextToSend.stDescription),P.prop("checked",n.contextToSend.charCard),S.prop("checked",n.contextToSend.authorNote),A.prop("checked",n.contextToSend.worldInfo),C.prop("checked",n.contextToSend.suggestedEntries),I=E.find("#messageType"),N=E.find("#firstX"),T=E.find("#lastX"),j=E.find("#rangeX"),L=E.find("#firstXMessages"),M=E.find("#lastXMessages"),O=E.find("#rangeStart"),D=E.find("#rangeEnd"),I.val(n.contextToSend.messages.type),L.val(null!==(t=n.contextToSend.messages.first)&&void 0!==t?t:10),M.val(null!==(r=n.contextToSend.messages.last)&&void 0!==r?r:10),O.val(null!==(o=null===(a=n.contextToSend.messages.range)||void 0===a?void 0:a.start)&&void 0!==o?o:0),D.val(null!==(i=null===(s=n.contextToSend.messages.range)||void 0===s?void 0:s.end)&&void 0!==i?i:10),R(n.contextToSend.messages.type),k.on("change",(function(){n.contextToSend.stDescription=k.prop("checked"),mr.saveSettings()})),P.on("change",(function(){n.contextToSend.charCard=P.prop("checked"),mr.saveSettings()})),S.on("change",(function(){n.contextToSend.authorNote=S.prop("checked"),mr.saveSettings()})),A.on("change",(function(){n.contextToSend.worldInfo=A.prop("checked"),mr.saveSettings()})),C.on("change",(function(){n.contextToSend.suggestedEntries=C.prop("checked"),mr.saveSettings()})),I.on("change",(function(){var e=I.val();n.contextToSend.messages.type=e,mr.saveSettings(),R(e)})),L.on("change",(function(){n.contextToSend.messages.first=parseInt(L.val())||10,mr.saveSettings()})),M.on("change",(function(){n.contextToSend.messages.last=parseInt(M.val())||10,mr.saveSettings()})),O.on("change",(function(){n.contextToSend.messages.range||(n.contextToSend.messages.range={start:0,end:10}),n.contextToSend.messages.range.start=parseInt(O.val())||0,mr.saveSettings()})),D.on("change",(function(){n.contextToSend.messages.range||(n.contextToSend.messages.range={start:0,end:10}),n.contextToSend.messages.range.end=parseInt(D.val())||10,mr.saveSettings()})),B=p.find("#worldInfoRecommend_maxContextType"),F=p.find("#worldInfoRecommend_maxTokens_container"),B.val(n.maxContextType),F.css("display","custom"===n.maxContextType?"block":"none"),B.on("change",(function(){var e=B.val();n.maxContextType=e,mr.saveSettings(),"custom"===e?F.show():F.hide()})),(z=p.find("#worldInfoRecommend_maxTokens")).val(n.maxContextValue),z.on("change",(function(){var e=Number(z.val());n.maxContextValue=e,mr.saveSettings()})),(W=p.find("#worldInfoRecommend_maxResponseTokens")).val(n.maxResponseToken),W.on("change",(function(){var e=Number(W.val());n.maxResponseToken=e,mr.saveSettings()})),V={},!x){e.next=95;break}return e.next=92,Ie(["all"],ce.this_chid);case 92:V=e.sent,e.next=114;break;case 95:H=Ir(le.world_names),e.prev=96,H.s();case 98:if((G=H.n()).done){e.next=106;break}return q=G.value,e.next=102,sr.loadWorldInfo(q);case 102:(U=e.sent)&&(V[q]=Object.values(U.entries));case 104:e.next=98;break;case 106:e.next=111;break;case 108:e.prev=108,e.t2=e.catch(96),H.e(e.t2);case 111:return e.prev=111,H.f(),e.finish(111);case 114:if(0===(K=Object.keys(V)).length&&ve("warning","No active World Info entries found."),Y="worldInfoRecommend_".concat(null!=x?x:"_global"),(X=JSON.parse(null!==(c=localStorage.getItem(Y))&&void 0!==c?c:"{}")).suggestedEntries||(X.suggestedEntries={},Z()),X.blackListedEntries||(X.blackListedEntries=[],Z()),X.selectedWorldNames||(X.selectedWorldNames=x?structuredClone(K):[],Z()),J=X.selectedWorldNames.filter((function(e){return!K.includes(e)})),J.length>0&&(ve("warning","World names missing from last session: ".concat(J.join(", "))),X.selectedWorldNames=X.selectedWorldNames.filter((function(e){return!J.includes(e)})),Z()),Q=ie("#worldInfoRecommend_worldInfoContainer",{initialList:K,initialValues:X.selectedWorldNames,onSelectChange:function(e,t){X.selectedWorldNames=t,Z()},enableSearch:K.length>10}),ee=Q.selectAll,te=p.find("#worldInfoRecommend_prompt"),Ae("#worldInfoRecommenderPopup #worldInfoRecommend_promptPreset",{label:"prompt",initialValue:n.promptPreset,initialList:Object.keys(n.promptPresets),readOnlyValues:["default"],onSelectChange:function(){var e=Mr(jr().mark((function e(t,r){var o,a,i;return jr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=null!=r?r:"default",n.promptPreset=i,mr.saveSettings(),te.val(null!==(o=null===(a=n.promptPresets[i])||void 0===a?void 0:a.content)&&void 0!==o?o:"");case 4:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),create:{onAfterCreate:function(e){var t,r=n.promptPresets[n.promptPreset];n.promptPresets[e]={content:null!==(t=null==r?void 0:r.content)&&void 0!==t?t:""}}},rename:{onAfterRename:function(e,t){n.promptPresets[t]=n.promptPresets[e],delete n.promptPresets[e]}},delete:{onAfterDelete:function(e){delete n.promptPresets[e]}}}),te.val(null!==(l=null===(u=n.promptPresets[n.promptPreset])||void 0===u?void 0:u.content)&&void 0!==l?l:""),te.on("change",(function(){var e=$(this).val();n.promptPresets[n.promptPreset].content=e,mr.saveSettings()})),re=p.find("#worldInfoRecommend_sendPrompt"),ne=p.find("#worldInfoRecommend_addAll"),oe=p.find("#worldInfoRecommend_suggestedEntries"),ae=p.find("#worldInfoRecommend_entryTemplate")){e.next=135;break}return ve("warning","Missing entry template. Contact developer."),e.abrupt("return");case 135:de(X.suggestedEntries,null,"initial"),p.find("#worldInfoRecommend_reset").on("click",Mr(jr().mark((function e(){return jr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,sr.Popup.show.confirm("World Info Recommender",'Are you sure you want to reset? This will clear all suggested entries, reset the "Lorebooks to Include".');case 3:if(e.sent){e.next=6;break}return e.abrupt("return");case 6:pe(),ve("success","Reset successful"),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(0),console.error(e.t0),ve("error",e.t0 instanceof Error?e.t0.message:e.t0);case 14:case"end":return e.stop()}}),e,null,[[0,10]])})))),ne.on("click",Mr(jr().mark((function e(){var t,r,n,o,a,i,s,c,l,u,d,h,f,m,g,b,v,_,w,y,x,k;return jr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,ne.prop("disabled",!0),0!==K.length){e.next=5;break}return ve("error","No available worlds to add entries to"),e.abrupt("return");case 5:if(t=Object.values(X.suggestedEntries).reduce((function(e,t){return e+t.length}),0),0!==t){e.next=9;break}return ve("warning","No entries to add"),e.abrupt("return");case 9:return e.next=11,sr.Popup.show.confirm("World Info Recommender","Are you sure you want to add/update all ".concat(t," suggested entries?"));case 11:if(e.sent){e.next=14;break}return e.abrupt("return");case 14:r=0,n=0,o=[],a=new Set,i=0,s=Object.entries(X.suggestedEntries);case 19:if(!(i<s.length)){e.next=56;break}if(c=Cr(s[i],2),l=c[0],0!==(u=c[1]).length){e.next=23;break}return e.abrupt("continue",53);case 23:d=Ir(u),e.prev=24,d.s();case 26:if((h=d.n()).done){e.next=45;break}return f=h.value,V[m=l]||(m=K[0]),e.prev=30,e.next=33,se(f,m,!0);case 33:g=e.sent,o.push({worldName:m,entry:f,status:g}),"added"===g?r++:n++,a.add(m),e.next=43;break;case 39:e.prev=39,e.t0=e.catch(30),console.error("Failed to process entry: ".concat(f.comment),e.t0),ve("error","Failed to process entry: ".concat(f.comment));case 43:e.next=26;break;case 45:e.next=50;break;case 47:e.prev=47,e.t1=e.catch(24),d.e(e.t1);case 50:return e.prev=50,d.f(),e.finish(50);case 53:i++,e.next=19;break;case 56:b=Ir(a),e.prev=57,b.s();case 59:if((v=b.n()).done){e.next=69;break}_=v.value,w={entries:{}},y=Ir(V[_]);try{for(y.s();!(x=y.n()).done;)k=x.value,w.entries[k.uid]=k}catch(e){y.e(e)}finally{y.f()}return e.next=66,sr.saveWorldInfo(_,w);case 66:sr.reloadWorldInfoEditor(_,!0);case 67:e.next=59;break;case 69:e.next=74;break;case 71:e.prev=71,e.t2=e.catch(57),b.e(e.t2);case 74:return e.prev=74,b.f(),e.finish(74);case 77:X.suggestedEntries={},Z(),p.find("#worldInfoRecommend_suggestedEntries").empty(),r>0||n>0?ve("success",'\n            <div class="results-summary">\n              <p>Successfully processed '.concat(r+n," entries:</p>\n              <ul>\n              <li>Added: ").concat(r,"</li>\n              <li>Updated: ").concat(n,"</li>\n              <li>Modified worlds: ").concat(Array.from(a).join(", "),"</li>\n              </ul>\n            </div>"),{escapeHtml:!1}):ve("warning","No entries were processed successfully"),e.next=87;break;case 83:e.prev=83,e.t3=e.catch(0),console.error(e.t3),ve("error",e.t3 instanceof Error?e.t3.message:e.t3);case 87:return e.prev=87,ne.prop("disabled",!1),e.finish(87);case 90:case"end":return e.stop()}}),e,null,[[0,83,87,90],[24,47,50,53],[30,39],[57,71,74,77]])})))),re.on("click",Mr(jr().mark((function e(){var t,r,o,a,i,s,c,l,u,d,p,h,f,b,v,_;return jr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(re.prop("disabled",!0),i=null,e.prev=2,l=te.val(),n.profileId){e.next=7;break}return ve("warning","Please select a connection profile."),e.abrupt("return");case 7:if(l){e.next=10;break}return ve("warning","Please enter a prompt."),e.abrupt("return");case 10:if(u=m.val(),d=fe.selected_group?null!==(s=u?Number(u):void 0)&&void 0!==s?s:g:void 0,p=SillyTavern.getContext(),h=null===(c=p.extensionSettings.connectionManager)||void 0===c||null===(c=c.profiles)||void 0===c?void 0:c.find((function(e){return e.id===n.profileId}))){e.next=17;break}return ve("warning","Connection profile not found."),e.abrupt("return");case 17:if(f={presetName:h.preset,contextName:h.context,instructName:h.instruct,syspromptName:h.sysprompt,ignoreCharacterFields:!n.contextToSend.charCard,ignoreWorldInfo:!0,ignoreAuthorNote:!n.contextToSend.authorNote,maxContext:"custom"===n.maxContextType?n.maxContextValue:"profile"===n.maxContextType?"preset":"active",includeNames:!!fe.selected_group,targetCharacterId:d},x){e.next=22;break}f.messageIndexesBetween={start:-1,end:-1},e.next=36;break;case 22:e.t0=n.contextToSend.messages.type,e.next="none"===e.t0?25:"first"===e.t0?27:"last"===e.t0?29:"range"===e.t0?33:(e.t0,35);break;case 25:return f.messageIndexesBetween={start:-1,end:-1},e.abrupt("break",36);case 27:return f.messageIndexesBetween={start:0,end:null!==(t=n.contextToSend.messages.first)&&void 0!==t?t:10},e.abrupt("break",36);case 29:return b=null!==(r=n.contextToSend.messages.last)&&void 0!==r?r:10,v=null!==(o=null===(a=p.chat)||void 0===a?void 0:a.length)&&void 0!==o?o:0,f.messageIndexesBetween={end:Math.max(0,v-1),start:Math.max(0,v-b)},e.abrupt("break",36);case 33:return n.contextToSend.messages.range&&(f.messageIndexesBetween={start:n.contextToSend.messages.range.start,end:n.contextToSend.messages.range.end}),e.abrupt("break",36);case 35:return e.abrupt("break",36);case 36:return e.next=38,cr({profileId:n.profileId,userPrompt:l,buildPromptOptions:f,contextToSend:n.contextToSend,session:X,entriesGroupByWorldName:V,promptSettings:{stWorldInfoPrompt:n.stWorldInfoPrompt,lorebookDefinitionPrompt:n.lorebookDefinitionPrompt,responseRulesPrompt:n.responseRulesPrompt,lorebookRulesPrompt:n.lorebookRulesPrompt},maxResponseToken:n.maxResponseToken});case 38:_=e.sent,Object.keys(_).length>0?de(_,i,"classic"):ve("warning","No results from AI"),e.next=46;break;case 42:e.prev=42,e.t1=e.catch(2),console.error(e.t1),ve("error",e.t1 instanceof Error?e.t1.message:String(e.t1));case 46:return e.prev=46,re.prop("disabled",!1),e.finish(46);case 49:case"end":return e.stop()}}),e,null,[[2,42,46,49]])}))));case 140:case"end":return e.stop()}}),e,null,[[21,30,33,36],[96,108,111,114]])}))));case 33:case"end":return e.stop()}var f}),e)}))),Dr.apply(this,arguments)}function Rr(){!function(){Dr.apply(this,arguments)}(),function(){function e(e){if(!e)return null;var t,r=[],n=Er(Array.isArray(e)?e:[e]);try{for(n.s();!(t=n.n()).done;){var o=t.value.trim();o.startsWith("[")&&o.endsWith("]")&&(o=o.slice(1,-1));for(var a="",i=!1,s="",c=0;c<o.length;c++){var l=o[c];'"'===l||"'"===l?c>0&&"\\"===o[c-1]?a=a.slice(0,-1)+l:i?l===s?(i=!1,a.trim()&&r.push(a.trim()),a="",s=""):a+=l:(i=!0,s=l):","!==l||i?a+=l:(a.trim()&&r.push(a.trim()),a="")}a.trim()&&r.push(a.trim())}}catch(e){n.e(e)}finally{n.f()}return r}var t,r;sr.SlashCommandParser.addCommandObject(sr.SlashCommand.fromProps({name:"world-info-recommender-popup-open",helpString:"Open World Info Recommender popup",unnamedArgumentList:[],callback:(t=kr(yr().mark((function e(t,r){return yr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!pr){e.next=3;break}return pr.trigger("click"),e.abrupt("return",!0);case 3:return e.abrupt("return",!1);case 4:case"end":return e.stop()}}),e)}))),function(e,r){return t.apply(this,arguments)}),returns:sr.ARGUMENT_TYPE.BOOLEAN})),sr.SlashCommandParser.addCommandObject(sr.SlashCommand.fromProps({name:"world-info-recommender-run",helpString:"\n              <div class=\"inline-drawer\">\n                  <details>\n                      <summary>Run the World Info Recommender AI automatically.</summary>\n                      <div class=\"list-group\">\n                          Executes the recommendation process using the specified parameters.\n                          <br>\n                          - <b>profile</b>: (Required) Connection profile ID/name to use for the AI request.\n                          <br>\n                          - <b>prompt</b>: (Required) The core task/instruction for the AI. Passed as unnamed argument(s).\n                          <br>\n                          - <b>lorebooks</b>: List of lorebook names to include as context. Defaults to currently active worlds.\n                          <br>\n                          - <b>allowed-ops</b>: List of operations allowed ('add', 'update'). Defaults to 'add,update'.\n                          <br>\n                          - <b>editable-entries</b>: Comma-separated list of specific entries allowed for update, format: <code>WorldName.EntryComment</code> or <code>WorldName.UID</code>. If provided, only these entries can be updated. Adds are still allowed if 'add' is in allowed-ops. Defaults to allowing updates for all entries.\n                          <br>\n                          - <b>context</b>: Context parts ('stDescription', 'messages', 'charCard', 'authorNote', 'worldInfo'). Defaults to extension settings.\n                          <br>\n                          - <b>messages</b>: Message range ('all', 'none', 'first:N', 'last:N', 'range:S-E'). Defaults to extension settings.\n                          <br>\n                          - <b>max-context</b>: Override context token limit (number). Defaults to extension settings.\n                          <br>\n                          - <b>max-response</b>: Override response token limit (number). Defaults to extension settings.\n                          <br>\n                          - <b>silent</b>: Suppress success/error messages (boolean). Defaults to false.\n                      </div>\n                      <div>\n                          <b>Example:</b>\n                          <pre><code>/wir-run profile=your_profile_id lorebooks=[CommonEvents,Characters] allowed-ops=[add] \"Create 3 new entries about recent events in the tavern based on the last 5 messages.\"</code></pre>\n                          <pre><code>/wir-run profile=your_profile_name editable-entries=[Characters.12345,Locations.The Docks] messages=last:10 prompt=\"Update the description for character UID 12345 and The Docks based on the recent fight.\"</code></pre>\n                      </div>\n                  </details>\n              </div>\n          ",returns:sr.ARGUMENT_TYPE.BOOLEAN,namedArgumentList:[sr.SlashCommandNamedArgument.fromProps({name:"profile",description:"Connection Profile ID/name to use for the AI request.",typeList:[sr.ARGUMENT_TYPE.STRING],isRequired:!0,enumProvider:dr}),sr.SlashCommandNamedArgument.fromProps({name:"lorebooks",description:"List of lorebook names to include as context (defaults to active).",typeList:[sr.ARGUMENT_TYPE.LIST],isRequired:!1,acceptsMultiple:!0,enumProvider:be.commonEnumProviders.worlds}),sr.SlashCommandNamedArgument.fromProps({name:"allowed-ops",description:"Operations allowed: 'add', 'update'.",typeList:[sr.ARGUMENT_TYPE.LIST],isRequired:!1,defaultValue:"[add,update]",enumList:["add","update"]}),sr.SlashCommandNamedArgument.fromProps({name:"editable-entries",description:"Specific entries allowed for update: 'WorldName.Comment' or 'WorldName.UID' (comma-separated).",typeList:[sr.ARGUMENT_TYPE.STRING],isRequired:!1}),sr.SlashCommandNamedArgument.fromProps({name:"context",description:"Context parts: 'stDescription', 'messages', 'charCard', 'authorNote', 'worldInfo'.",typeList:[sr.ARGUMENT_TYPE.LIST],isRequired:!1,acceptsMultiple:!0,enumList:["stDescription","messages","charCard","authorNote","worldInfo"]}),sr.SlashCommandNamedArgument.fromProps({name:"messages",description:"Message range: 'all', 'none', 'first:N', 'last:N', 'range:S-E'.",typeList:[sr.ARGUMENT_TYPE.STRING],isRequired:!1}),sr.SlashCommandNamedArgument.fromProps({name:"max-context",description:"Override context token limit.",typeList:[sr.ARGUMENT_TYPE.NUMBER],isRequired:!1}),sr.SlashCommandNamedArgument.fromProps({name:"max-response",description:"Override response token limit.",typeList:[sr.ARGUMENT_TYPE.NUMBER],isRequired:!1}),sr.SlashCommandNamedArgument.fromProps({name:"silent",description:"Suppress success/error messages.",typeList:[sr.ARGUMENT_TYPE.BOOLEAN],isRequired:!1,defaultValue:!1})],unnamedArgumentList:[sr.SlashCommandArgument.fromProps({description:"The prompt/task for the AI.",typeList:[sr.ARGUMENT_TYPE.STRING],isRequired:!0,acceptsMultiple:!0})],callback:(r=kr(yr().mark((function t(r,n){var o,a,i,s,c,l,u,d,p,h,f,m,g,b,v,_,w,y,x,k,E,P,S,A,C,I,N,T,j,L,M,O,D,R,B,F,z,$,W,V,H,G,q,U,K,Y,X,Z,J,Q,ee,te,re,ne,oe,ae,ie,se;return yr().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(l=null!==(o=r.silent)&&void 0!==o&&o,t.prev=1,p=mr.getSettings(),h=Array.isArray(n)?n.join(" "):n,f=r.profile,h){t.next=7;break}throw new Error("Prompt argument is required.");case 7:if(f){t.next=9;break}throw new Error("Profile argument is required.");case 9:if(g=null===(u=sr.extensionSettings)||void 0===u||null===(u=u.connectionManager)||void 0===u||null===(u=u.profiles)||void 0===u?void 0:u.find((function(e){return e.id===f||e.name===f}))){t.next=12;break}throw new Error('Profile with ID "'.concat(f,'" not found.'));case 12:if(m=g.id,null===(b=e(r.lorebooks))){t.next=37;break}v={},_=Er(b),t.prev=17,_.s();case 19:if((w=_.n()).done){t.next=27;break}return y=w.value,t.next=23,sr.loadWorldInfo(y);case 23:(x=t.sent)&&(v[y]=Object.values(x.entries));case 25:t.next=19;break;case 27:t.next=32;break;case 29:t.prev=29,t.t0=t.catch(17),_.e(t.t0);case 32:return t.prev=32,_.f(),t.finish(32);case 35:t.next=40;break;case 37:return t.next=39,Ie(["all"],ce.this_chid);case 39:v=t.sent;case 40:if(k=Object.keys(v),null===b){t.next=47;break}if(E=b.map((function(e){return e.trim()})).filter((function(e){return!!k.includes(e)||(l||ve("warning",'Specified lorebook "'.concat(e,'" is not active or does not exist. Ignoring.')),!1)})),0!==E.length){t.next=45;break}throw new Error("No valid lorebooks specified or active.");case 45:t.next=48;break;case 47:E=k;case 48:0===E.length&&(l||ve("warning","No active lorebooks found to use for context.")),P=e(r["allowed-ops"]),A=(S=null!==P?P:["add","update"]).includes("add"),C=S.includes("update"),I=new Set,null!==(N=e(r["editable-entries"]))&&N.forEach((function(e){I.add(e.trim())})),T=I.size>0,j=e(r.context),L=_r({},p.contextToSend),null!==j&&(M=j.map((function(e){return e.trim()})),L.stDescription=M.includes("stdescription"),L.messages.type=M.includes("messages")?L.messages.type:"none",L.charCard=M.includes("charcard"),L.authorNote=M.includes("authornote"),L.worldInfo=M.includes("worldinfo"),L.suggestedEntries=!1),r.messages&&"none"!==L.messages.type&&("all"===(O=r.messages.toLowerCase().trim())?L.messages.type="all":"none"===O?L.messages.type="none":O.startsWith("first:")?(L.messages.type="first",L.messages.first=parseInt(O.split(":")[1])||10):O.startsWith("last:")?(L.messages.type="last",L.messages.last=parseInt(O.split(":")[1])||10):O.startsWith("range:")?(D=O.split(":")[1].split("-"),L.messages.type="range",L.messages.range={start:parseInt(D[0])||0,end:parseInt(D[1])||10}):l||ve("warning","Invalid 'messages' argument format: \"".concat(r.messages,'". Using default.'))),R={presetName:void 0,contextName:void 0,instructName:void 0,syspromptName:void 0,ignoreCharacterFields:!L.charCard,ignoreWorldInfo:!0,ignoreAuthorNote:!L.authorNote,maxContext:null!==(d=r["max-context"])&&void 0!==d?d:"custom"===p.maxContextType?p.maxContextValue:"profile"===p.maxContextType?"preset":"active",includeNames:!!fe.selected_group,targetCharacterId:fe.selected_group?ce.this_chid:void 0},t.t1=L.messages.type,t.next="none"===t.t1?65:"first"===t.t1?67:"last"===t.t1?69:"range"===t.t1?73:(t.t1,75);break;case 65:return R.messageIndexesBetween={start:-1,end:-1},t.abrupt("break",76);case 67:return R.messageIndexesBetween={start:0,end:null!==(a=L.messages.first)&&void 0!==a?a:10},t.abrupt("break",76);case 69:return B=null!==(i=L.messages.last)&&void 0!==i?i:10,F=null!==(s=null===(c=sr.chat)||void 0===c?void 0:c.length)&&void 0!==s?s:0,R.messageIndexesBetween={end:Math.max(0,F-1),start:Math.max(0,F-B)},t.abrupt("break",76);case 73:return L.messages.range&&(R.messageIndexesBetween={start:L.messages.range.start,end:L.messages.range.end}),t.abrupt("break",76);case 75:return t.abrupt("break",76);case 76:return z={selectedWorldNames:E,suggestedEntries:{},blackListedEntries:[]},$=r["max-response"]?parseInt(r["max-response"]):void 0,W={profileId:m,userPrompt:h,buildPromptOptions:R,contextToSend:L,session:z,entriesGroupByWorldName:v,promptSettings:{stWorldInfoPrompt:p.stWorldInfoPrompt,lorebookDefinitionPrompt:p.lorebookDefinitionPrompt,responseRulesPrompt:p.responseRulesPrompt,lorebookRulesPrompt:p.lorebookRulesPrompt},maxResponseToken:null!=$?$:p.maxResponseToken},l||ve("info","Running World Info Recommender..."),t.next=82,cr(W);case 82:if(V=t.sent,0!==Object.keys(V).length){t.next=86;break}return l||ve("info","AI returned no suggestions."),t.abrupt("return",!0);case 86:H=0,G=0,q=0,U=new Set,K=structuredClone(v),Y=0,X=Object.entries(V);case 92:if(!(Y<X.length)){t.next=132;break}if(Z=br(X[Y],2),J=Z[0],Q=Z[1],ee=J,E.includes(ee)){t.next=110;break}if(!k.includes(ee)){t.next=102;break}return l||ve("warning",'AI suggested entry for "'.concat(ee,"\", but it wasn't in the specified 'lorebooks'. Skipping ").concat(Q.length," entries.")),q+=Q.length,t.abrupt("continue",129);case 102:if(!(E.length>0)){t.next=107;break}ee=E[0],l||ve("warning",'AI suggested entry for non-existent/inactive world "'.concat(J,'". Attempting to place in "').concat(ee,'".')),t.next=110;break;case 107:return l||ve("error",'AI suggested entry for "'.concat(J,'", but no valid target lorebook available. Skipping ').concat(Q.length," entries.")),q+=Q.length,t.abrupt("continue",129);case 110:te=Er(Q),t.prev=111,ne=yr().mark((function e(){var t,r,n,o;return yr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=re.value,!(null===(t=K[ee])||void 0===t?void 0:t.some((function(e){return e.uid===r.uid})))){e.next=16;break}if(C){e.next=7;break}return l||ve("info",'Skipping update for "'.concat(ee,".").concat(r.comment||r.uid,'" (updates disallowed).')),q++,e.abrupt("return",0);case 7:if(!T){e.next=14;break}if(n="".concat(ee,".").concat(r.comment),o="".concat(ee,".").concat(r.uid),I.has(n)||I.has(o)){e.next=14;break}return l||ve("info",'Skipping update for "'.concat(ee,".").concat(r.comment||r.uid,'" (not in editable-entries).')),q++,e.abrupt("return",0);case 14:e.next=20;break;case 16:if(A){e.next=20;break}return l||ve("info",'Skipping add for "'.concat(ee,".").concat(r.comment||"New Entry",'" (adds disallowed).')),q++,e.abrupt("return",0);case 20:try{"added"===ur(r,ee,K).status?H++:G++,U.add(ee)}catch(e){l||ve("error",'Failed to prepare modification for "'.concat(ee,".").concat(r.comment||r.uid,'": ').concat(e.message)),q++}case 21:case"end":return e.stop()}}),e)})),te.s();case 114:if((re=te.n()).done){t.next=121;break}return t.delegateYield(ne(),"t2",116);case 116:if(0!==t.t2){t.next=119;break}return t.abrupt("continue",119);case 119:t.next=114;break;case 121:t.next=126;break;case 123:t.prev=123,t.t3=t.catch(111),te.e(t.t3);case 126:return t.prev=126,te.f(),t.finish(126);case 129:Y++,t.next=92;break;case 132:if(!(U.size>0)){t.next=150;break}l||ve("info","Saving changes to ".concat(U.size," lorebook(s)...")),oe=Er(U),t.prev=135,ie=yr().mark((function e(){var t,r,n;return yr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=ae.value,r=K[t],n={entries:{}},r.forEach((function(e){return n.entries[e.uid]=e})),e.next=6,sr.saveWorldInfo(t,n);case 6:sr.reloadWorldInfoEditor(t,!0);case 7:case"end":return e.stop()}}),e)})),oe.s();case 138:if((ae=oe.n()).done){t.next=142;break}return t.delegateYield(ie(),"t4",140);case 140:t.next=138;break;case 142:t.next=147;break;case 144:t.prev=144,t.t5=t.catch(135),oe.e(t.t5);case 147:return t.prev=147,oe.f(),t.finish(147);case 150:return l||(se=[],(H>0||G>0||q>0)&&se.push('\n                <div class="results-summary">\n                  <ul>\n                  <li><strong>Added:</strong> '.concat(H,"</li>\n                  <li><strong>Updated:</strong> ").concat(G,"</li>\n                  <li><strong>Skipped:</strong> ").concat(q,"</li>\n                  </ul>\n                </div>\n                ")),U.size>0&&se.push('\n                <div class="modified-worlds">\n                  <strong>Modified Lorebooks:</strong>\n                  <ul>\n                  '.concat(Array.from(U).map((function(e){return"<li>".concat(e,"</li>")})).join(""),"\n                  </ul>\n                </div>\n                ")),ve("success",se.length>0?'\n                <div class="wir-results">\n                  <h4>World Info Recommender Results:</h4>\n                  '.concat(se.join(""),"\n                </div>\n                "):'\n                <div class="wir-results">\n                  <h4>World Info Recommender:</h4>\n                  <p>No changes were made</p>\n                </div>\n                ',{escapeHtml:!1})),t.abrupt("return",!0);case 154:return t.prev=154,t.t6=t.catch(1),console.error("Error running world-info-recommender-run command:",t.t6),l||ve("error","World Info Recommender command failed: ".concat(t.t6.message)),t.abrupt("return",!1);case 159:case"end":return t.stop()}}),t,null,[[1,154],[17,29,32,35],[111,123,126,129],[135,144,147,150]])}))),function(e,t){return r.apply(this,arguments)})}))}()}if(sr.ConnectionManagerRequestService&&sr.getCharacterCardFields&&sr.getWorldInfoPrompt&&sr.reloadWorldInfoEditor)mr.initializeSettings().then((function(e){if(e.version.changed){var t=mr.getSettings(),r=!1;t.usingDefaultStWorldInfoPrompt&&t.stWorldInfoPrompt!==je&&(t.stWorldInfoPrompt=je,r=!0),t.usingDefaultLorebookDefinitionPrompt&&t.lorebookDefinitionPrompt!==Le&&(t.lorebookDefinitionPrompt=Le,r=!0),t.usingDefaultLorebookRulesPrompt&&t.lorebookRulesPrompt!==Me&&(t.lorebookRulesPrompt=Me,r=!0),t.usingDefaultResponseRulesPrompt&&t.responseRulesPrompt!==Kt&&(t.responseRulesPrompt=Kt,r=!0),r&&mr.saveSettings()}Rr()})).catch((function(e){ve("error",e),sr.Popup.show.confirm("Data migration failed. Do you want to reset the World Info Recommender data?","World Info Recommender").then((function(e){e&&(mr.resetSettings(),Rr())}))}));else{ve("error","[World Info Recommender Error] Make sure you are on staging branch and staging is updated.")}