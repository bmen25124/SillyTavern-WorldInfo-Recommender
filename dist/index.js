import*as e from"../../../../power-user.js";import*as t from"../../../../../script.js";import*as n from"../../../../world-info.js";import*as r from"../../../../instruct-mode.js";import*as o from"../../../../chats.js";import*as i from"../../../../openai.js";import*as s from"../../../../authors-note.js";import*as a from"../../../../group-chats.js";import*as l from"../../../regex/engine.js";import*as c from"../../../../utils.js";import*as u from"../../../../../lib.js";var d={d:(e,t)=>{for(var n in t)d.o(t,n)&&!d.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};function p(e,t={}){const n=$(e);if(0===n.length)throw new Error(`Could not find container: ${e}`);n.empty().addClass("fancy-dropdown-container");const r=$("<div></div>").addClass("fancy-dropdown-list").css({"max-height":"300px","overflow-y":"auto",border:"1px solid var(--border-color)","background-color":"var(--bg-color)",color:"var(--text-color)","border-radius":"4px"});n.append(r);let o=[...t.initialValues||[]];const i=()=>{r.find(".fancy-dropdown-item").each((function(){const e=$(this),t=e.data("value");o.includes(t)?(e.addClass("selected"),e.find(".checkmark").show()):(e.removeClass("selected"),e.find(".checkmark").hide())}))};if(t.initialList&&t.initialList.length>0)for(const e of t.initialList){const n=$("<div></div>").addClass("fancy-dropdown-item").data("value",e).css({padding:"8px 12px",cursor:"pointer",display:"flex","align-items":"center","justify-content":"space-between"}).hover((function(){$(this).css("background-color","var(--hover-color, #444)")}),(function(){$(this).css("background-color","")}));$("<span></span>").text(e).appendTo(n);const s=$("<i></i>").addClass("checkmark fa-solid fa-check").css({"margin-left":"8px",display:o.includes(e)?"inline-block":"none"});n.append(s),n.on("click",(function(){const e=$(this).data("value"),n=[...o];o.includes(e)?o=o.filter((t=>t!==e)):o.push(e),i(),t.onSelectChange&&t.onSelectChange(n,o)})),r.append(n)}return i(),{$container:n,$dropdownList:r,getValues:()=>[...o],setValues:e=>{const n=[...o];o=[...e],i(),t.onSelectChange&&JSON.stringify(n)!==JSON.stringify(o)&&t.onSelectChange(n,o)},getOptions:()=>t.initialList||[],addOption:(e,n=!1)=>{if(t.initialList&&t.initialList.includes(e))return;t.initialList||(t.initialList=[]),t.initialList.push(e);const s=$("<div></div>").addClass("fancy-dropdown-item").data("value",e).css({padding:"8px 12px",cursor:"pointer",display:"flex","align-items":"center","justify-content":"space-between"}).hover((function(){$(this).css("background-color","var(--hover-color, #444)")}),(function(){$(this).css("background-color","")}));$("<span></span>").text(e).appendTo(s);const a=$("<i></i>").addClass("checkmark fa-solid fa-check").css({"margin-left":"8px",display:"none"});if(s.append(a),s.on("click",(function(){const e=$(this).data("value"),n=[...o];o.includes(e)?o=o.filter((t=>t!==e)):o.push(e),i(),t.onSelectChange&&t.onSelectChange(n,o)})),r.append(s),n&&!o.includes(e)){const n=[...o];o.push(e),i(),t.onSelectChange&&t.onSelectChange(n,o)}},removeOption:e=>{if(t.initialList&&(t.initialList=t.initialList.filter((t=>t!==e))),o.includes(e)){const n=[...o];o=o.filter((t=>t!==e)),t.onSelectChange&&t.onSelectChange(n,o)}r.find(`.fancy-dropdown-item[data-value="${e}"]`).remove()},selectAll:()=>{const e=[...o];o=[...t.initialList||[]],i(),t.onSelectChange&&JSON.stringify(e)!==JSON.stringify(o)&&t.onSelectChange(e,o)},deselectAll:()=>{const e=[...o];o=[],i(),t.onSelectChange&&e.length>0&&t.onSelectChange(e,o)},disable:()=>{r.css("pointer-events","none").css("opacity","0.6")},enable:()=>{r.css("pointer-events","auto").css("opacity","1")}}}const f=(e=>{var t={};return d.d(t,e),t})({persona_description_positions:()=>e.persona_description_positions,renderStoryString:()=>e.renderStoryString});const m=(e=>{var t={};return d.d(t,e),t})({baseChatReplace:()=>t.baseChatReplace,characters:()=>t.characters,chat_metadata:()=>t.chat_metadata,depth_prompt_depth_default:()=>t.depth_prompt_depth_default,depth_prompt_role_default:()=>t.depth_prompt_role_default,extension_prompt_types:()=>t.extension_prompt_types,getMaxContextSize:()=>t.getMaxContextSize,name1:()=>t.name1,name2:()=>t.name2,parseMesExamples:()=>t.parseMesExamples,this_chid:()=>t.this_chid});const h=(e=>{var t={};return d.d(t,e),t})({METADATA_KEY:()=>n.METADATA_KEY,createWorldInfoEntry:()=>n.createWorldInfoEntry,selected_world_info:()=>n.selected_world_info,wi_anchor_position:()=>n.wi_anchor_position,world_info:()=>n.world_info,world_info_include_names:()=>n.world_info_include_names});const g=(e=>{var t={};return d.d(t,e),t})({formatInstructModeExamples:()=>r.formatInstructModeExamples,formatInstructModeSystemPrompt:()=>r.formatInstructModeSystemPrompt});const v=(e=>{var t={};return d.d(t,e),t})({appendFileContent:()=>o.appendFileContent});const y=(e=>{var t={};return d.d(t,e),t})({formatWorldInfo:()=>i.formatWorldInfo,getPromptPosition:()=>i.getPromptPosition,getPromptRole:()=>i.getPromptRole,prepareOpenAIMessages:()=>i.prepareOpenAIMessages,setOpenAIMessageExamples:()=>i.setOpenAIMessageExamples,setOpenAIMessages:()=>i.setOpenAIMessages});const x=(e=>{var t={};return d.d(t,e),t})({metadata_keys:()=>s.metadata_keys});const b=(e=>{var t={};return d.d(t,e),t})({getGroupDepthPrompts:()=>a.getGroupDepthPrompts,groups:()=>a.groups,selected_group:()=>a.selected_group});const w=(e=>{var t={};return d.d(t,e),t})({getRegexedString:()=>l.getRegexedString,regex_placement:()=>l.regex_placement});const P=(e=>{var t={};return d.d(t,e),t})({getCharaFilename:()=>c.getCharaFilename});async function k(e,t,{escapeHtml:n=!0}={}){await async function(e,...t){await SillyTavern.getContext().SlashCommandParser.commands[e].callback(...t)}("echo",{severity:e,escapeHtml:Boolean(n).toString()},t)}function I(e){return(0,m.getMaxContextSize)(e)}function S(e,t){return(0,m.parseMesExamples)(e,t)}function E(e,t,n){return(0,m.baseChatReplace)(e,t,n)}function N(e){return(0,y.getPromptRole)(e)}function _(e,{wiFormat:t}={}){return(0,y.formatWorldInfo)(e,{wiFormat:t})}function T(e){return(0,y.getPromptPosition)(e)}function A(e,{manualAvatarKey:t}={}){return(0,P.getCharaFilename)(e,{manualAvatarKey:t})}function C(e,t={}){const n=SillyTavern.getContext(),r=t.readOnlyValues||[],o=document.querySelector(e);if(!o)throw new Error(`Could not find preset select: ${e}`);const i=t.label||"preset",s=document.createElement("div");s.className="preset-select-container",s.style.display="flex",s.style.alignItems="center";const a=e=>r.includes(e);if(o.parentNode?.insertBefore(s,o),s.appendChild(o),t.initialList&&t.initialList.length>0){o.innerHTML="";for(const e of t.initialList){const t=document.createElement("option");t.value=e,t.textContent=e,a(e)&&(t.dataset.readonly="true"),o.appendChild(t)}}if(t.initialValue){const e=Array.from(o.options).find((e=>e.value===t.initialValue||e.textContent===t.initialValue));e&&(o.value=e.value)}let l=o.value;if(o.addEventListener("change",(async()=>{const e=o.value;t.onSelectChange&&l!==e&&await t.onSelectChange(l,e),l=e})),t.create){const e=document.createElement("i");e.className="menu_button fa-solid fa-file-circle-plus",e.title=`Create a new ${i}`,e.setAttribute("data-i18n",`[title]Create a new ${i}`),e.addEventListener("click",(async()=>{t.create?.onPopupOpen&&await t.create.onPopupOpen();const e=await n.Popup.show.input(`Create a new ${i}`,`Please enter a name for the new ${i}:`,"");if(null===e||""===e.trim())return;const r=e.trim();if(Array.from(o.options).some((e=>e.textContent===r)))return void await k("warning",`A ${i} with this name already exists.`);if(t.create?.onBeforeCreate){if(!await t.create.onBeforeCreate(r))return}const s=document.createElement("option");s.value=r,s.textContent=r,o.appendChild(s);const a=o.value;o.value=r,t.create?.onAfterCreate&&await t.create.onAfterCreate(r),t.onSelectChange&&a!==r&&await t.onSelectChange(a,r),l=r})),s.appendChild(e)}if(t.rename){const e=document.createElement("i");e.className="menu_button fa-solid fa-pencil",e.title=`Rename a ${i}`,e.setAttribute("data-i18n",`[title]Rename a ${i}`),e.addEventListener("click",(async()=>{if(-1===o.selectedIndex)return void await k("warning",`Please select a ${i} to rename.`);const e=o.options[o.selectedIndex];let r=e.value;if(a(r))return void await k("warning",`This ${i} cannot be renamed as it is read-only.`);t.rename?.onPopupOpen&&await t.rename.onPopupOpen();const s=await n.Popup.show.input(`Rename ${i}`,`Please enter a new name for "${r}":`,r);if(null===s||""===s.trim()||s===r)return;const c=s.trim();if(Array.from(o.options).some((t=>t.textContent===c&&t!==e)))await k("warning",`A ${i} with this name already exists.`);else{if(t.rename?.onBeforeRename){if(!await t.rename.onBeforeRename(r,c))return}e.value=c,e.textContent=c,r===l&&(l=c),t.rename?.onAfterRename&&await t.rename.onAfterRename(r,c),t.onSelectChange&&o.value===c&&await t.onSelectChange(r,c)}})),s.appendChild(e)}if(t.delete){const e=document.createElement("i");e.className="menu_button fa-solid fa-trash-can",e.title=`Delete a ${i}`,e.setAttribute("data-i18n",`[title]Delete a ${i}`),e.addEventListener("click",(async()=>{if(-1===o.selectedIndex)return void await k("warning",`Please select a ${i} to delete.`);const e=o.options[o.selectedIndex],r=e.value,s=o.selectedIndex;if(a(r))return void await k("warning",`This ${i} cannot be deleted as it is read-only.`);t.delete?.onPopupOpen&&await t.delete.onPopupOpen();if(!await n.Popup.show.confirm(`Are you sure you want to delete "${r}"?`,`Delete ${i}`))return;if(t.delete?.onBeforeDelete){if(!await t.delete.onBeforeDelete(r))return}const c=r;let u,d=-1;o.options.length>1&&(d=s<o.options.length-1?s:s-1,u=o.options[d].value),o.removeChild(e),d>=0?(o.selectedIndex=d,l=u,t.onSelectChange&&await t.onSelectChange(c,u)):(t.onSelectChange&&await t.onSelectChange(c,void 0),l=void 0),t.delete?.onAfterDelete&&await t.delete.onAfterDelete(c)})),s.appendChild(e)}return{select:o,container:s}}async function O(e,{targetCharacterId:t,presetName:n,instructName:r,contextName:o,syspromptName:i,maxContext:s,includeNames:a,ignoreCharacterFields:l,ignoreAuthorNote:c,ignoreWorldInfo:u,messageIndexesBetween:d}={}){if(!["textgenerationwebui","openai"].includes(e))throw new Error("Unsupported API");const p=SillyTavern.getContext();let P=[],{description:k,personality:A,persona:C,scenario:O,mesExamples:R,system:j,jailbreak:L}=l?{description:"",personality:"",persona:"",scenario:"",mesExamples:"",system:"",jailbreak:""}:p.getCharacterCardFields({chid:t});const D="textgenerationwebui"===e?p.getPresetManager("instruct")?.getCompletionPresetByName(r):void 0,$=!!D?.enabled;let M=S(R,$);const V=function(){if("number"==typeof s)return s;if(!s)return I();if("active"===s||!n)return I();if("number"==typeof s)return s;let t;if("textgenerationwebui"===e){const e=p.getPresetManager("textgenerationwebui")?.getCompletionPresetByName(n);t=e?.max_length}else{const e=p.getPresetManager("openai")?.getCompletionPresetByName(n);t=e?.openai_max_context}return"number"==typeof t?t:I()}();if(V<=0)return[];const F=p.ToolManager.isToolCallingSupported(),W=d?.start??0,B=d?.end?d.end+1:void 0;let U=-1===W&&0===B?[]:p.chat.slice(W,B).filter((e=>!e.is_system||F&&Array.isArray(e.extra?.tool_invocations)));U=await Promise.all(U.map((async(e,t)=>{let n=function(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:i,depth:s}){return(0,w.getRegexedString)(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:i,depth:s})}(e.mes,e.is_user?w.regex_placement.USER_INPUT:w.regex_placement.AI_OUTPUT,{isPrompt:!0,depth:U.length-t-1});return n=await async function(e,t){return await(0,v.appendFileContent)(e,t)}(e,n),e?.extra?.append_title&&e?.extra?.title&&(n=`${n}\n\n${e.extra.title}`),{...e,mes:n,index:t}})));const G=U.map((e=>h.world_info_include_names?`${e.name}: ${e.mes}`:e.mes)).reverse(),{worldInfoString:H,worldInfoBefore:K,worldInfoAfter:q,worldInfoExamples:Y,worldInfoDepth:X,anBefore:z,anAfter:J}=u?{worldInfoString:"",worldInfoBefore:"",worldInfoAfter:"",worldInfoExamples:[],worldInfoDepth:[],anBefore:[],anAfter:[]}:await p.getWorldInfoPrompt(G,V,!1);for(const se of Y){const ae=se.content;if(0===ae.length)continue;const le=S(E(ae,m.name1,m.name2),$);se.position===h.wi_anchor_position.before?M.unshift(...le):M.push(...le)}function Z(){let e=0;const t=[];for(let n=U.length-1;n>=0;n--){const r=U[n];if(r.extra?.token_count&&e+r.extra.token_count>V)break;e+=r.extra?.token_count||0,t.unshift({role:r.is_user?"user":"assistant",content:a?`${r.name}: ${r.mes}`:r.mes})}P.push(...t)}if("textgenerationwebui"===e){const ce=[...M];M&&(M=function(e,t,n){return(0,g.formatInstructModeExamples)(e,t,n)}(M,m.name1,m.name2));const ue=p.getPresetManager("sysprompt")?.getCompletionPresetByName(i);ue&&(j=p.powerUserSettings.prefer_character_prompt&&j?j:E(ue.content,m.name1,m.name2),j=$?(ee=p.substituteParams(j,m.name1,m.name2,ue.content),te=D,(0,g.formatInstructModeSystemPrompt)(ee,te)):j);const de={description:k,personality:A,persona:p.powerUserSettings.persona_description_position==f.persona_description_positions.IN_PROMPT?C:"",scenario:O,system:j,char:m.name2,user:m.name1,wiBefore:K,wiAfter:q,loreBefore:K,loreAfter:q,mesExamples:M.join(""),mesExamplesRaw:ce.join("")},pe=p.getPresetManager("context")?.getCompletionPresetByName(o);let fe=function(e,{customStoryString:t,customInstructSettings:n}={}){return(0,f.renderStoryString)(e,{customStoryString:t,customInstructSettings:n})}(de,{customInstructSettings:D,customStoryString:pe?.story_string});P.push({role:"system",content:fe,ignoreInstruct:!0}),Z()}else{let me=(Q=U,(0,y.setOpenAIMessages)(Q)),he=function(e){return(0,y.setOpenAIMessageExamples)(e)}(M);async function ge(){let[e,t]=await function({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:i,bias:s,type:a,quietPrompt:l,quietImage:c,extensionPrompts:u,cyclePrompt:d,systemPromptOverride:p,jailbreakPromptOverride:f,personaDescription:m,messages:h,messageExamples:g},v){return(0,y.prepareOpenAIMessages)({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:i,bias:s,type:a,quietPrompt:l,quietImage:c,cyclePrompt:d,systemPromptOverride:p,jailbreakPromptOverride:f,personaDescription:m,extensionPrompts:u,messages:h,messageExamples:g},v)}({name2:m.name2,charDescription:k,charPersonality:A,Scenario:O,worldInfoBefore:K,worldInfoAfter:q,extensionPrompts:p.extensionPrompts,bias:"",type:"normal",quietPrompt:void 0,quietImage:void 0,cyclePrompt:"",systemPromptOverride:j,jailbreakPromptOverride:L,personaDescription:C,messages:me,messageExamples:he},!1);P.push(...e)}if(!n)return await ge(),P;const ve=p.getPresetManager("openai")?.getCompletionPresetByName(n);if(!ve)return console.warn(`Preset not found: ${n}. Using current preset.`),ge(),P;let ye=ve.prompt_order.find((e=>e.character_id===m.this_chid));if(!ye&&ve.prompt_order.length>0&&(ye=ve.prompt_order[0]),!ye)return console.warn(`No prompt order found for preset: ${n}. Using current preset.`),ge(),P;const xe=O&&ve.scenario_format?p.substituteParams(ve.scenario_format):"",be=A&&ve.personality_format?p.substituteParams(ve.personality_format):"",we=p.substituteParams(ve.group_nudge_prompt),Pe=ve.impersonation_prompt?p.substituteParams(ve.impersonation_prompt):"",ke=[];u&&ke.push({role:"system",content:_(K,{wiFormat:ve.wi_format}),identifier:"worldInfoBefore"},{role:"system",content:_(q,{wiFormat:ve.wi_format}),identifier:"worldInfoAfter"}),l||ke.push({role:"system",content:k,identifier:"charDescription"},{role:"system",content:be,identifier:"charPersonality"},{role:"system",content:xe,identifier:"scenario"}),ke.push({role:"system",content:Pe,identifier:"impersonate"},{role:"system",content:we,identifier:"groupNudge"});const Ie=p.extensionPrompts["1_memory"];Ie&&Ie.value&&ke.push({role:N(Ie.role),content:Ie.value,identifier:"summary",position:T(Ie.position)});const Se=p.extensionPrompts["2_floating_prompt"];!c&&Se&&Se.value&&ke.push({role:N(Se.role),content:Se.value,identifier:"authorsNote",position:T(Se.position)});const Ee=p.extensionPrompts["3_vectors"];Ee&&Ee.value&&ke.push({role:"system",content:Ee.value,identifier:"vectorsMemory",position:T(Ee.position)});const Ne=p.extensionPrompts["4_vectors_data_bank"];Ne&&Ne.value&&ke.push({role:N(Ne.role),content:Ne.value,identifier:"vectorsDataBank",position:T(Ne.position)});const _e=p.extensionPrompts.chromadb;_e&&_e.value&&ke.push({role:"system",content:_e.value,identifier:"smartContext",position:T(_e.position)}),!l&&p.powerUserSettings.persona_description&&p.powerUserSettings.persona_description_position===f.persona_description_positions.IN_PROMPT&&ke.push({role:"system",content:p.powerUserSettings.persona_description,identifier:"personaDescription"}),ye.order.forEach((e=>{if(!e.enabled)return;const t=(n=e.identifier,ke.find((e=>e.identifier===n)));var n;t&&t.content?P.push({role:t.role??"system",content:p.substituteParams(t.content)}):"chatHistory"===e.identifier&&Z()}))}var Q,ee,te;const ne=["1_memory","2_floating_prompt","3_vectors","4_vectors_data_bank","chromadb","PERSONA_DESCRIPTION","QUIET_PROMPT","DEPTH_PROMPT"];for(const Te in p.extensionPrompts)if(Object.hasOwn(p.extensionPrompts,Te)){const Ae=p.extensionPrompts[Te];if(ne.includes(Te))continue;if(!p.extensionPrompts[Te].value)continue;if(![m.extension_prompt_types.BEFORE_PROMPT,m.extension_prompt_types.IN_PROMPT].includes(Ae.position))continue;if("function"==typeof Ae.filter&&!await Ae.filter())continue;Ae.position===m.extension_prompt_types.BEFORE_PROMPT?P=[...P.slice(0,Ae.depth),{role:N(Ae.role)??"system",content:Ae.value},...P.slice(Ae.depth)]:Ae.position===m.extension_prompt_types.IN_PROMPT&&(P=[...P.slice(0,P.length-Ae.depth),{role:N(Ae.role)??"system",content:Ae.value},...P.slice(P.length-Ae.depth)])}for(const Ce of X)P=[...P.slice(0,P.length-Ce.depth),{role:N(Ce.role),content:Ce.entries.join("\n")},...P.slice(P.length-Ce.depth)];if(!l){const Oe=(re=b.selected_group,oe=Number(m.this_chid),(0,b.getGroupDepthPrompts)(re,oe));if(b.selected_group&&Array.isArray(Oe)&&Oe.length>0)Oe.filter((e=>e.text)).forEach(((e,t)=>{P=[...P.slice(0,P.length-e.depth),{role:e.role,content:e.text},...P.slice(P.length-e.depth)]}));else{const Re=E(m.characters[m.this_chid]?.data?.extensions?.depth_prompt?.prompt?.trim(),m.name1,m.name2)||"";if(Re){const je=m.depth_prompt_depth_default,Le=m.characters[m.this_chid]?.data?.extensions?.depth_prompt?.role??m.depth_prompt_role_default;P=[...P.slice(0,P.length-je),{role:N(Le),content:Re},...P.slice(P.length-je)]}}}var re,oe;let ie=-1;if(!c){const De={prompt:m.chat_metadata[x.metadata_keys.prompt],interval:m.chat_metadata[x.metadata_keys.interval],position:m.chat_metadata[x.metadata_keys.position],depth:m.chat_metadata[x.metadata_keys.depth],role:m.chat_metadata[x.metadata_keys.role]};if(De.prompt)switch(De.prompt=E(De.prompt,m.name1,m.name2),De.position){case m.extension_prompt_types.IN_PROMPT:P=[...P.slice(0,1),{role:"user",content:De.prompt},...P.slice(1)],ie=1;break;case m.extension_prompt_types.IN_CHAT:P=[...P.slice(0,P.length-De.depth),{role:N(De.role),content:De.prompt},...P.slice(P.length-De.depth)],ie=P.length-De.depth-1;break;case m.extension_prompt_types.BEFORE_PROMPT:P.unshift({role:"user",content:De.prompt}),ie=0}}return ie>=0&&(z.length>0&&(P=[...P.slice(0,ie),{role:"system",content:z.join("\n")},...P.slice(ie)],ie++),J.length>0&&(P=[...P.slice(0,ie+1),{role:"system",content:J.join("\n")},...P.slice(ie+1)])),P}async function R(e,t){function n(t){return e.includes("all")||e.includes(t)}const r=SillyTavern.getContext();let o={};if(n("global")&&h.selected_world_info?.length)for(const e of h.selected_world_info){const t=await r.loadWorldInfo(e);t&&(o[e]||(o[e]=[]),Object.values(t.entries).forEach((t=>{o[e].push(t)})))}if(n("chat")){const e=r.chatMetadata[h.METADATA_KEY];if(e&&!o[e]){o[e]=[];const t=await r.loadWorldInfo(e);t&&Object.values(t.entries).forEach((t=>{o[e].push(t)}))}}if(n("character")&&t){const e=m.characters[t];let n=new Set;const i=e?.data?.extensions?.world;i&&n.add(i);const s=A(t),a=h.world_info.charLore?.find((e=>e.name===s));a&&(n=new Set([...n,...a.extraBooks]));for(const e of n){const t=await r.loadWorldInfo(e);t&&!o[e]&&(o[e]=[],Object.values(t.entries).forEach((t=>{o[e].push(t)})))}}if(n("persona")){const e=r.powerUserSettings.persona_description_lorebook;if(e&&!o[e]){o[e]=[];const t=await r.loadWorldInfo(e);t&&Object.values(t.entries).forEach((t=>{o[e].push(t)}))}}return o}var j,L;!function(e){e[e.TEXT=1]="TEXT",e[e.CONFIRM=2]="CONFIRM",e[e.INPUT=3]="INPUT",e[e.DISPLAY=4]="DISPLAY"}(j||(j={})),function(e){e[e.AFFIRMATIVE=1]="AFFIRMATIVE",e[e.NEGATIVE=0]="NEGATIVE",e[e.CANCELLED=null]="CANCELLED"}(L||(L={}));var D='=== SILLYTAVERN===\n\n**SillyTavern** is a popular open-source front-end interface designed for interacting with AI language models. It\'s primarily used for role-playing, creative writing, and conversational experiences, offering a user-friendly platform to customize interactions with AI. Here\'s an overview:\n\n### Key Features:\n1. **AI Backend Compatibility**: Works with APIs like OpenAI (GPT), KoboldAI, Claude, or local models (via services like Text-generation-webui or Ollama).\n2. **Customization**:\n   - Create and import character cards (with personas, scenarios, and dialogue examples).\n   - Adjust model parameters (temperature, repetition penalties) for tailored responses.\n3. **Plugins & Extensions**: Adds features like text-to-speech, image generation, emotion recognition, and world-building tools.\n4. **Privacy**: Self-hosted locally, giving users control over data (unlike cloud-based services).\n\n### Use Cases:\n- Role-playing with AI characters.\n- Collaborative storytelling or creative writing.\n- Experimental AI interactions (users often share character templates and scripts in communities).\n\n### Requirements:\n- Technical setup involves installing Node.js, cloning the GitHub repo, and configuring API connections.\n- Requires access to an AI model backend (e.g., OpenAI API key or a locally hosted model).\n\n### Community & Ethics:\n- Active communities on platforms like GitHub and Reddit share guides, characters, and plugins.\n- Encourages responsible use, as the tool can generate unrestricted content depending on the AI backend.\n\nSillyTavern is not an AI itself but a flexible interface to enhance interactions with LLMs.\n\n=== WORLDINFO (LOREBOOKS) ===\n\n**World Info** (often called **Lorebooks**) is a feature used in AI-driven storytelling and role-playing platforms (like SillyTavern, NovelAI, KoboldAI, or Text-generation-webui) to help AI models maintain consistency in fictional worlds. It acts as a dynamic knowledge base that the AI references during interactions to avoid contradictions and keep track of key details.\n\n---\n\n### **What is World Info/Lorebooks?**\n- **A structured database**: Stores details about characters, locations, rules, events, or concepts in your fictional world.\n- **Contextual triggers**: Entries activate automatically when specific keywords or phrases appear in the conversation/story.\n- **Prevents "amnesia"**: Ensures the AI remembers critical lore without relying solely on its limited context window.\n\n---\n\n### **How It Works**\n1. **Create Entries**: Define elements (e.g., a character’s backstory, a magic system’s rules).\n2. **Set Triggers**: Link entries to keywords (e.g., mention "Dragonstone" → inject lore about that location).\n3. **Dynamic Injection**: When a trigger word appears in the chat/story, the relevant entry is temporarily added to the AI’s context.\n\n---\n\n### **Key Features**\n- **Hierarchy**: Organize entries into categories (e.g., factions, items, timelines).\n- **Priority**: Set which entries take precedence if multiple triggers occur.\n- **Cross-references**: Link entries to each other (e.g., a character entry references their home city).\n- **Formatting**: Use markdown, JSON, or plain text depending on the platform.\n\n---\n\n### **Example Lorebook Entry**\n```plaintext\nName: Dragonstone Citadel\nTriggers: Dragonstone, Citadel, Obsidian Fortress\nContent:\n  A volcanic fortress built from black obsidian. Home to the ancient Order of Flames,\n  who guard the Eternal Fire—a magical flame that grants visions of the future.\n  The citadel is rumored to be cursed, as its rulers never live past 40 years.\n```\n\n---\n\n### **Use Cases**\n1. **Complex Worldbuilding**: Track political factions, religions, or history.\n2. **Character Consistency**: Ensure the AI remembers a character’s motives, secrets, or relationships.\n3. **Magic/Science Systems**: Define rules (e.g., "Magic drains lifeforce" or "Robots cannot harm humans").\n4. **Plot Hooks**: Store hidden clues or foreshadowing for the AI to weave into the narrative.\n\n---\n\n### **Tools Supporting Lorebooks**\n- **SillyTavern**: Integrates with lorebooks via extensions or prompts.\n- **NovelAI**: Has a built-in "Lorebook" feature with advanced triggers.\n- **KoboldAI/Text-generation-webui**: Use "world info" files or scripts.\n- **AIDungeon** (historically): Early adopter of world info, though less popular now.\n\n---\n\n### **Best Practices**\n- **Keep entries concise**: AI models process information best in short, clear snippets.\n- **Balance detail**: Too many entries can overwhelm the context window.\n- **Test triggers**: Ensure keywords are unique enough to avoid false activations.\n- **Update dynamically**: Add/remove entries as the story evolves.\n\nLorebooks are essential for long-term storytelling with AI.',M="{{#each lorebooks}}\n  {{#if this.length}}\n## WORLD NAME: {{@key}}\n    {{#each this as |entry|}}\n      {{#unless entry.disable}}\n- (NAME: {{entry.comment}}) (ID: {{entry.uid}})\nTriggers: {{join entry.key ', '}}\nContent: {{entry.content}}\n\n      {{/unless}}\n    {{/each}}\n  {{/if}}\n{{/each}}",V="- Don't suggest already existing or suggested entries.";const F=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",W=new RegExp("^"+("["+F+"]["+(F+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040")+"]*")+"$");function B(e,t){const n=[];let r=t.exec(e);for(;r;){const o=[];o.startIndex=t.lastIndex-r[0].length;const i=r.length;for(let e=0;e<i;e++)o.push(r[e]);n.push(o),r=t.exec(e)}return n}const U=function(e){const t=W.exec(e);return!(null==t)};const G={allowBooleanAttributes:!1,unpairedTags:[]};function H(e,t){t=Object.assign({},G,t);const n=[];let r=!1,o=!1;"\ufeff"===e[0]&&(e=e.substr(1));for(let i=0;i<e.length;i++)if("<"===e[i]&&"?"===e[i+1]){if(i+=2,i=q(e,i),i.err)return i}else{if("<"!==e[i]){if(K(e[i]))continue;return te("InvalidChar","char '"+e[i]+"' is not expected.",re(e,i))}{let s=i;if(i++,"!"===e[i]){i=Y(e,i);continue}{let a=!1;"/"===e[i]&&(a=!0,i++);let l="";for(;i<e.length&&">"!==e[i]&&" "!==e[i]&&"\t"!==e[i]&&"\n"!==e[i]&&"\r"!==e[i];i++)l+=e[i];if(l=l.trim(),"/"===l[l.length-1]&&(l=l.substring(0,l.length-1),i--),!U(l)){let t;return t=0===l.trim().length?"Invalid space after '<'.":"Tag '"+l+"' is an invalid name.",te("InvalidTag",t,re(e,i))}const c=J(e,i);if(!1===c)return te("InvalidAttr","Attributes for '"+l+"' have open quote.",re(e,i));let u=c.value;if(i=c.index,"/"===u[u.length-1]){const n=i-u.length;u=u.substring(0,u.length-1);const o=Q(u,t);if(!0!==o)return te(o.err.code,o.err.msg,re(e,n+o.err.line));r=!0}else if(a){if(!c.tagClosed)return te("InvalidTag","Closing tag '"+l+"' doesn't have proper closing.",re(e,i));if(u.trim().length>0)return te("InvalidTag","Closing tag '"+l+"' can't have attributes or invalid starting.",re(e,s));if(0===n.length)return te("InvalidTag","Closing tag '"+l+"' has not been opened.",re(e,s));{const t=n.pop();if(l!==t.tagName){let n=re(e,t.tagStartPos);return te("InvalidTag","Expected closing tag '"+t.tagName+"' (opened in line "+n.line+", col "+n.col+") instead of closing tag '"+l+"'.",re(e,s))}0==n.length&&(o=!0)}}else{const a=Q(u,t);if(!0!==a)return te(a.err.code,a.err.msg,re(e,i-u.length+a.err.line));if(!0===o)return te("InvalidXml","Multiple possible root nodes found.",re(e,i));-1!==t.unpairedTags.indexOf(l)||n.push({tagName:l,tagStartPos:s}),r=!0}for(i++;i<e.length;i++)if("<"===e[i]){if("!"===e[i+1]){i++,i=Y(e,i);continue}if("?"!==e[i+1])break;if(i=q(e,++i),i.err)return i}else if("&"===e[i]){const t=ee(e,i);if(-1==t)return te("InvalidChar","char '&' is not expected.",re(e,i));i=t}else if(!0===o&&!K(e[i]))return te("InvalidXml","Extra text at the end",re(e,i));"<"===e[i]&&i--}}}return r?1==n.length?te("InvalidTag","Unclosed tag '"+n[0].tagName+"'.",re(e,n[0].tagStartPos)):!(n.length>0)||te("InvalidXml","Invalid '"+JSON.stringify(n.map((e=>e.tagName)),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1}):te("InvalidXml","Start tag expected.",1)}function K(e){return" "===e||"\t"===e||"\n"===e||"\r"===e}function q(e,t){const n=t;for(;t<e.length;t++)if("?"!=e[t]&&" "!=e[t]);else{const r=e.substr(n,t-n);if(t>5&&"xml"===r)return te("InvalidXml","XML declaration allowed only at the start of the document.",re(e,t));if("?"==e[t]&&">"==e[t+1]){t++;break}}return t}function Y(e,t){if(e.length>t+5&&"-"===e[t+1]&&"-"===e[t+2]){for(t+=3;t<e.length;t++)if("-"===e[t]&&"-"===e[t+1]&&">"===e[t+2]){t+=2;break}}else if(e.length>t+8&&"D"===e[t+1]&&"O"===e[t+2]&&"C"===e[t+3]&&"T"===e[t+4]&&"Y"===e[t+5]&&"P"===e[t+6]&&"E"===e[t+7]){let n=1;for(t+=8;t<e.length;t++)if("<"===e[t])n++;else if(">"===e[t]&&(n--,0===n))break}else if(e.length>t+9&&"["===e[t+1]&&"C"===e[t+2]&&"D"===e[t+3]&&"A"===e[t+4]&&"T"===e[t+5]&&"A"===e[t+6]&&"["===e[t+7])for(t+=8;t<e.length;t++)if("]"===e[t]&&"]"===e[t+1]&&">"===e[t+2]){t+=2;break}return t}const X='"',z="'";function J(e,t){let n="",r="",o=!1;for(;t<e.length;t++){if(e[t]===X||e[t]===z)""===r?r=e[t]:r!==e[t]||(r="");else if(">"===e[t]&&""===r){o=!0;break}n+=e[t]}return""===r&&{value:n,index:t,tagClosed:o}}const Z=new RegExp("(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['\"])(([\\s\\S])*?)\\5)?","g");function Q(e,t){const n=B(e,Z),r={};for(let e=0;e<n.length;e++){if(0===n[e][1].length)return te("InvalidAttr","Attribute '"+n[e][2]+"' has no space in starting.",oe(n[e]));if(void 0!==n[e][3]&&void 0===n[e][4])return te("InvalidAttr","Attribute '"+n[e][2]+"' is without value.",oe(n[e]));if(void 0===n[e][3]&&!t.allowBooleanAttributes)return te("InvalidAttr","boolean attribute '"+n[e][2]+"' is not allowed.",oe(n[e]));const o=n[e][2];if(!ne(o))return te("InvalidAttr","Attribute '"+o+"' is an invalid name.",oe(n[e]));if(r.hasOwnProperty(o))return te("InvalidAttr","Attribute '"+o+"' is repeated.",oe(n[e]));r[o]=1}return!0}function ee(e,t){if(";"===e[++t])return-1;if("#"===e[t])return function(e,t){let n=/\d/;for("x"===e[t]&&(t++,n=/[\da-fA-F]/);t<e.length;t++){if(";"===e[t])return t;if(!e[t].match(n))break}return-1}(e,++t);let n=0;for(;t<e.length;t++,n++)if(!(e[t].match(/\w/)&&n<20)){if(";"===e[t])break;return-1}return t}function te(e,t,n){return{err:{code:e,msg:t,line:n.line||n,col:n.col}}}function ne(e){return U(e)}function re(e,t){const n=e.substring(0,t).split(/\r?\n/);return{line:n.length,col:n[n.length-1].length+1}}function oe(e){return e.startIndex+e[1].length}const ie={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(e,t,n){return e}};class se{constructor(e){this.tagname=e,this.child=[],this[":@"]={}}add(e,t){"__proto__"===e&&(e="#__proto__"),this.child.push({[e]:t})}addChild(e){"__proto__"===e.tagname&&(e.tagname="#__proto__"),e[":@"]&&Object.keys(e[":@"]).length>0?this.child.push({[e.tagname]:e.child,":@":e[":@"]}):this.child.push({[e.tagname]:e.child})}}function ae(e,t){const n={};if("O"!==e[t+3]||"C"!==e[t+4]||"T"!==e[t+5]||"Y"!==e[t+6]||"P"!==e[t+7]||"E"!==e[t+8])throw new Error("Invalid Tag instead of DOCTYPE");{t+=9;let r=1,o=!1,i=!1,s="";for(;t<e.length;t++)if("<"!==e[t]||i)if(">"===e[t]){if(i?"-"===e[t-1]&&"-"===e[t-2]&&(i=!1,r--):r--,0===r)break}else"["===e[t]?o=!0:s+=e[t];else{if(o&&ue(e,t)){let r,o;t+=7,[r,o,t]=le(e,t+1),-1===o.indexOf("&")&&(n[me(r)]={regx:RegExp(`&${r};`,"g"),val:o})}else if(o&&de(e,t))t+=8;else if(o&&pe(e,t))t+=8;else if(o&&fe(e,t))t+=9;else{if(!ce)throw new Error("Invalid DOCTYPE");i=!0}r++,s=""}if(0!==r)throw new Error("Unclosed DOCTYPE")}return{entities:n,i:t}}function le(e,t){let n="";for(;t<e.length&&"'"!==e[t]&&'"'!==e[t];t++)n+=e[t];if(n=n.trim(),-1!==n.indexOf(" "))throw new Error("External entites are not supported");const r=e[t++];let o="";for(;t<e.length&&e[t]!==r;t++)o+=e[t];return[n,o,t]}function ce(e,t){return"!"===e[t+1]&&"-"===e[t+2]&&"-"===e[t+3]}function ue(e,t){return"!"===e[t+1]&&"E"===e[t+2]&&"N"===e[t+3]&&"T"===e[t+4]&&"I"===e[t+5]&&"T"===e[t+6]&&"Y"===e[t+7]}function de(e,t){return"!"===e[t+1]&&"E"===e[t+2]&&"L"===e[t+3]&&"E"===e[t+4]&&"M"===e[t+5]&&"E"===e[t+6]&&"N"===e[t+7]&&"T"===e[t+8]}function pe(e,t){return"!"===e[t+1]&&"A"===e[t+2]&&"T"===e[t+3]&&"T"===e[t+4]&&"L"===e[t+5]&&"I"===e[t+6]&&"S"===e[t+7]&&"T"===e[t+8]}function fe(e,t){return"!"===e[t+1]&&"N"===e[t+2]&&"O"===e[t+3]&&"T"===e[t+4]&&"A"===e[t+5]&&"T"===e[t+6]&&"I"===e[t+7]&&"O"===e[t+8]&&"N"===e[t+9]}function me(e){if(U(e))return e;throw new Error(`Invalid entity name ${e}`)}const he=/^[-+]?0x[a-fA-F0-9]+$/,ge=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,ve={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function ye(e,t={}){if(t=Object.assign({},ve,t),!e||"string"!=typeof e)return e;let n=e.trim();if(void 0!==t.skipLike&&t.skipLike.test(n))return e;if("0"===e)return 0;if(t.hex&&he.test(n))return function(e,t){if(parseInt)return parseInt(e,t);if(Number.parseInt)return Number.parseInt(e,t);if(window&&window.parseInt)return window.parseInt(e,t);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}(n,16);if(-1!==n.search(/[eE]/)){const r=n.match(/^([-\+])?(0*)([0-9]*(\.[0-9]*)?[eE][-\+]?[0-9]+)$/);if(r){if(t.leadingZeros)n=(r[1]||"")+r[3];else if("0"!==r[2]||"."!==r[3][0])return e;return t.eNotation?Number(n):e}return e}{const r=ge.exec(n);if(r){const o=r[1],i=r[2];let s=function(e){if(e&&-1!==e.indexOf("."))return"."===(e=e.replace(/0+$/,""))?e="0":"."===e[0]?e="0"+e:"."===e[e.length-1]&&(e=e.substr(0,e.length-1)),e;return e}(r[3]);if(!t.leadingZeros&&i.length>0&&o&&"."!==n[2])return e;if(!t.leadingZeros&&i.length>0&&!o&&"."!==n[1])return e;if(t.leadingZeros&&i===e)return 0;{const r=Number(n),a=""+r;return-1!==a.search(/[eE]/)?t.eNotation?r:e:-1!==n.indexOf(".")?"0"===a&&""===s||a===s||o&&a==="-"+s?r:e:i?s===a||o+s===a?r:e:n===a||n===o+a?r:e}}return e}}function xe(e){return"function"==typeof e?e:Array.isArray(e)?t=>{for(const n of e){if("string"==typeof n&&t===n)return!0;if(n instanceof RegExp&&n.test(t))return!0}}:()=>!1}class be{constructor(e){this.options=e,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(e,t)=>String.fromCodePoint(Number.parseInt(t,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(e,t)=>String.fromCodePoint(Number.parseInt(t,16))}},this.addExternalEntities=we,this.parseXml=Ee,this.parseTextData=Pe,this.resolveNameSpace=ke,this.buildAttributesMap=Se,this.isItStopNode=Ae,this.replaceEntitiesValue=_e,this.readStopNodeData=Re,this.saveTextToParentTag=Te,this.addChild=Ne,this.ignoreAttributesFn=xe(this.options.ignoreAttributes)}}function we(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];this.lastEntities[r]={regex:new RegExp("&"+r+";","g"),val:e[r]}}}function Pe(e,t,n,r,o,i,s){if(void 0!==e&&(this.options.trimValues&&!r&&(e=e.trim()),e.length>0)){s||(e=this.replaceEntitiesValue(e));const r=this.options.tagValueProcessor(t,e,n,o,i);if(null==r)return e;if(typeof r!=typeof e||r!==e)return r;if(this.options.trimValues)return je(e,this.options.parseTagValue,this.options.numberParseOptions);return e.trim()===e?je(e,this.options.parseTagValue,this.options.numberParseOptions):e}}function ke(e){if(this.options.removeNSPrefix){const t=e.split(":"),n="/"===e.charAt(0)?"/":"";if("xmlns"===t[0])return"";2===t.length&&(e=n+t[1])}return e}const Ie=new RegExp("([^\\s=]+)\\s*(=\\s*(['\"])([\\s\\S]*?)\\3)?","gm");function Se(e,t,n){if(!0!==this.options.ignoreAttributes&&"string"==typeof e){const n=B(e,Ie),r=n.length,o={};for(let e=0;e<r;e++){const r=this.resolveNameSpace(n[e][1]);if(this.ignoreAttributesFn(r,t))continue;let i=n[e][4],s=this.options.attributeNamePrefix+r;if(r.length)if(this.options.transformAttributeName&&(s=this.options.transformAttributeName(s)),"__proto__"===s&&(s="#__proto__"),void 0!==i){this.options.trimValues&&(i=i.trim()),i=this.replaceEntitiesValue(i);const e=this.options.attributeValueProcessor(r,i,t);o[s]=null==e?i:typeof e!=typeof i||e!==i?e:je(i,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(o[s]=!0)}if(!Object.keys(o).length)return;if(this.options.attributesGroupName){const e={};return e[this.options.attributesGroupName]=o,e}return o}}const Ee=function(e){e=e.replace(/\r\n?/g,"\n");const t=new se("!xml");let n=t,r="",o="";for(let i=0;i<e.length;i++){if("<"===e[i])if("/"===e[i+1]){const t=Ce(e,">",i,"Closing Tag is not closed.");let s=e.substring(i+2,t).trim();if(this.options.removeNSPrefix){const e=s.indexOf(":");-1!==e&&(s=s.substr(e+1))}this.options.transformTagName&&(s=this.options.transformTagName(s)),n&&(r=this.saveTextToParentTag(r,n,o));const a=o.substring(o.lastIndexOf(".")+1);if(s&&-1!==this.options.unpairedTags.indexOf(s))throw new Error(`Unpaired tag can not be used as closing tag: </${s}>`);let l=0;a&&-1!==this.options.unpairedTags.indexOf(a)?(l=o.lastIndexOf(".",o.lastIndexOf(".")-1),this.tagsNodeStack.pop()):l=o.lastIndexOf("."),o=o.substring(0,l),n=this.tagsNodeStack.pop(),r="",i=t}else if("?"===e[i+1]){let t=Oe(e,i,!1,"?>");if(!t)throw new Error("Pi Tag is not closed.");if(r=this.saveTextToParentTag(r,n,o),this.options.ignoreDeclaration&&"?xml"===t.tagName||this.options.ignorePiTags);else{const e=new se(t.tagName);e.add(this.options.textNodeName,""),t.tagName!==t.tagExp&&t.attrExpPresent&&(e[":@"]=this.buildAttributesMap(t.tagExp,o,t.tagName)),this.addChild(n,e,o)}i=t.closeIndex+1}else if("!--"===e.substr(i+1,3)){const t=Ce(e,"--\x3e",i+4,"Comment is not closed.");if(this.options.commentPropName){const s=e.substring(i+4,t-2);r=this.saveTextToParentTag(r,n,o),n.add(this.options.commentPropName,[{[this.options.textNodeName]:s}])}i=t}else if("!D"===e.substr(i+1,2)){const t=ae(e,i);this.docTypeEntities=t.entities,i=t.i}else if("!["===e.substr(i+1,2)){const t=Ce(e,"]]>",i,"CDATA is not closed.")-2,s=e.substring(i+9,t);r=this.saveTextToParentTag(r,n,o);let a=this.parseTextData(s,n.tagname,o,!0,!1,!0,!0);null==a&&(a=""),this.options.cdataPropName?n.add(this.options.cdataPropName,[{[this.options.textNodeName]:s}]):n.add(this.options.textNodeName,a),i=t+2}else{let s=Oe(e,i,this.options.removeNSPrefix),a=s.tagName;const l=s.rawTagName;let c=s.tagExp,u=s.attrExpPresent,d=s.closeIndex;this.options.transformTagName&&(a=this.options.transformTagName(a)),n&&r&&"!xml"!==n.tagname&&(r=this.saveTextToParentTag(r,n,o,!1));const p=n;if(p&&-1!==this.options.unpairedTags.indexOf(p.tagname)&&(n=this.tagsNodeStack.pop(),o=o.substring(0,o.lastIndexOf("."))),a!==t.tagname&&(o+=o?"."+a:a),this.isItStopNode(this.options.stopNodes,o,a)){let t="";if(c.length>0&&c.lastIndexOf("/")===c.length-1)"/"===a[a.length-1]?(a=a.substr(0,a.length-1),o=o.substr(0,o.length-1),c=a):c=c.substr(0,c.length-1),i=s.closeIndex;else if(-1!==this.options.unpairedTags.indexOf(a))i=s.closeIndex;else{const n=this.readStopNodeData(e,l,d+1);if(!n)throw new Error(`Unexpected end of ${l}`);i=n.i,t=n.tagContent}const r=new se(a);a!==c&&u&&(r[":@"]=this.buildAttributesMap(c,o,a)),t&&(t=this.parseTextData(t,a,o,!0,u,!0,!0)),o=o.substr(0,o.lastIndexOf(".")),r.add(this.options.textNodeName,t),this.addChild(n,r,o)}else{if(c.length>0&&c.lastIndexOf("/")===c.length-1){"/"===a[a.length-1]?(a=a.substr(0,a.length-1),o=o.substr(0,o.length-1),c=a):c=c.substr(0,c.length-1),this.options.transformTagName&&(a=this.options.transformTagName(a));const e=new se(a);a!==c&&u&&(e[":@"]=this.buildAttributesMap(c,o,a)),this.addChild(n,e,o),o=o.substr(0,o.lastIndexOf("."))}else{const e=new se(a);this.tagsNodeStack.push(n),a!==c&&u&&(e[":@"]=this.buildAttributesMap(c,o,a)),this.addChild(n,e,o),n=e}r="",i=d}}else r+=e[i]}return t.child};function Ne(e,t,n){const r=this.options.updateTag(t.tagname,n,t[":@"]);!1===r||("string"==typeof r?(t.tagname=r,e.addChild(t)):e.addChild(t))}const _e=function(e){if(this.options.processEntities){for(let t in this.docTypeEntities){const n=this.docTypeEntities[t];e=e.replace(n.regx,n.val)}for(let t in this.lastEntities){const n=this.lastEntities[t];e=e.replace(n.regex,n.val)}if(this.options.htmlEntities)for(let t in this.htmlEntities){const n=this.htmlEntities[t];e=e.replace(n.regex,n.val)}e=e.replace(this.ampEntity.regex,this.ampEntity.val)}return e};function Te(e,t,n,r){return e&&(void 0===r&&(r=0===t.child.length),void 0!==(e=this.parseTextData(e,t.tagname,n,!1,!!t[":@"]&&0!==Object.keys(t[":@"]).length,r))&&""!==e&&t.add(this.options.textNodeName,e),e=""),e}function Ae(e,t,n){const r="*."+n;for(const n in e){const o=e[n];if(r===o||t===o)return!0}return!1}function Ce(e,t,n,r){const o=e.indexOf(t,n);if(-1===o)throw new Error(r);return o+t.length-1}function Oe(e,t,n,r=">"){const o=function(e,t,n=">"){let r,o="";for(let i=t;i<e.length;i++){let t=e[i];if(r)t===r&&(r="");else if('"'===t||"'"===t)r=t;else if(t===n[0]){if(!n[1])return{data:o,index:i};if(e[i+1]===n[1])return{data:o,index:i}}else"\t"===t&&(t=" ");o+=t}}(e,t+1,r);if(!o)return;let i=o.data;const s=o.index,a=i.search(/\s/);let l=i,c=!0;-1!==a&&(l=i.substring(0,a),i=i.substring(a+1).trimStart());const u=l;if(n){const e=l.indexOf(":");-1!==e&&(l=l.substr(e+1),c=l!==o.data.substr(e+1))}return{tagName:l,tagExp:i,closeIndex:s,attrExpPresent:c,rawTagName:u}}function Re(e,t,n){const r=n;let o=1;for(;n<e.length;n++)if("<"===e[n])if("/"===e[n+1]){const i=Ce(e,">",n,`${t} is not closed`);if(e.substring(n+2,i).trim()===t&&(o--,0===o))return{tagContent:e.substring(r,n),i};n=i}else if("?"===e[n+1]){n=Ce(e,"?>",n+1,"StopNode is not closed.")}else if("!--"===e.substr(n+1,3)){n=Ce(e,"--\x3e",n+3,"StopNode is not closed.")}else if("!["===e.substr(n+1,2)){n=Ce(e,"]]>",n,"StopNode is not closed.")-2}else{const r=Oe(e,n,">");if(r){(r&&r.tagName)===t&&"/"!==r.tagExp[r.tagExp.length-1]&&o++,n=r.closeIndex}}}function je(e,t,n){if(t&&"string"==typeof e){const t=e.trim();return"true"===t||"false"!==t&&ye(e,n)}return void 0!==e?e:""}function Le(e,t){return De(e,t)}function De(e,t,n){let r;const o={};for(let i=0;i<e.length;i++){const s=e[i],a=$e(s);let l="";if(l=void 0===n?a:n+"."+a,a===t.textNodeName)void 0===r?r=s[a]:r+=""+s[a];else{if(void 0===a)continue;if(s[a]){let e=De(s[a],t,l);const n=Ve(e,t);s[":@"]?Me(e,s[":@"],l,t):1!==Object.keys(e).length||void 0===e[t.textNodeName]||t.alwaysCreateTextNode?0===Object.keys(e).length&&(t.alwaysCreateTextNode?e[t.textNodeName]="":e=""):e=e[t.textNodeName],void 0!==o[a]&&o.hasOwnProperty(a)?(Array.isArray(o[a])||(o[a]=[o[a]]),o[a].push(e)):t.isArray(a,l,n)?o[a]=[e]:o[a]=e}}}return"string"==typeof r?r.length>0&&(o[t.textNodeName]=r):void 0!==r&&(o[t.textNodeName]=r),o}function $e(e){const t=Object.keys(e);for(let e=0;e<t.length;e++){const n=t[e];if(":@"!==n)return n}}function Me(e,t,n,r){if(t){const o=Object.keys(t),i=o.length;for(let s=0;s<i;s++){const i=o[s];r.isArray(i,n+"."+i,!0,!0)?e[i]=[t[i]]:e[i]=t[i]}}}function Ve(e,t){const{textNodeName:n}=t,r=Object.keys(e).length;return 0===r||!(1!==r||!e[n]&&"boolean"!=typeof e[n]&&0!==e[n])}function Fe(e,t){let n="";return t.format&&t.indentBy.length>0&&(n="\n"),We(e,t,"",n)}function We(e,t,n,r){let o="",i=!1;for(let s=0;s<e.length;s++){const a=e[s],l=Be(a);if(void 0===l)continue;let c="";if(c=0===n.length?l:`${n}.${l}`,l===t.textNodeName){let e=a[l];Ge(c,t)||(e=t.tagValueProcessor(l,e),e=He(e,t)),i&&(o+=r),o+=e,i=!1;continue}if(l===t.cdataPropName){i&&(o+=r),o+=`<![CDATA[${a[l][0][t.textNodeName]}]]>`,i=!1;continue}if(l===t.commentPropName){o+=r+`\x3c!--${a[l][0][t.textNodeName]}--\x3e`,i=!0;continue}if("?"===l[0]){const e=Ue(a[":@"],t),n="?xml"===l?"":r;let s=a[l][0][t.textNodeName];s=0!==s.length?" "+s:"",o+=n+`<${l}${s}${e}?>`,i=!0;continue}let u=r;""!==u&&(u+=t.indentBy);const d=r+`<${l}${Ue(a[":@"],t)}`,p=We(a[l],t,c,u);-1!==t.unpairedTags.indexOf(l)?t.suppressUnpairedNode?o+=d+">":o+=d+"/>":p&&0!==p.length||!t.suppressEmptyNode?p&&p.endsWith(">")?o+=d+`>${p}${r}</${l}>`:(o+=d+">",p&&""!==r&&(p.includes("/>")||p.includes("</"))?o+=r+t.indentBy+p+r:o+=p,o+=`</${l}>`):o+=d+"/>",i=!0}return o}function Be(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];if(e.hasOwnProperty(r)&&":@"!==r)return r}}function Ue(e,t){let n="";if(e&&!t.ignoreAttributes)for(let r in e){if(!e.hasOwnProperty(r))continue;let o=t.attributeValueProcessor(r,e[r]);o=He(o,t),!0===o&&t.suppressBooleanAttributes?n+=` ${r.substr(t.attributeNamePrefix.length)}`:n+=` ${r.substr(t.attributeNamePrefix.length)}="${o}"`}return n}function Ge(e,t){let n=(e=e.substr(0,e.length-t.textNodeName.length-1)).substr(e.lastIndexOf(".")+1);for(let r in t.stopNodes)if(t.stopNodes[r]===e||t.stopNodes[r]==="*."+n)return!0;return!1}function He(e,t){if(e&&e.length>0&&t.processEntities)for(let n=0;n<t.entities.length;n++){const r=t.entities[n];e=e.replace(r.regex,r.val)}return e}const Ke={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function qe(e){this.options=Object.assign({},Ke,e),!0===this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.ignoreAttributesFn=xe(this.options.ignoreAttributes),this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=ze),this.processTextOrObjNode=Ye,this.options.format?(this.indentate=Xe,this.tagEndChar=">\n",this.newLine="\n"):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}function Ye(e,t,n,r){const o=this.j2x(e,n+1,r.concat(t));return void 0!==e[this.options.textNodeName]&&1===Object.keys(e).length?this.buildTextValNode(e[this.options.textNodeName],t,o.attrStr,n):this.buildObjectNode(o.val,t,o.attrStr,n)}function Xe(e){return this.options.indentBy.repeat(e)}function ze(e){return!(!e.startsWith(this.options.attributeNamePrefix)||e===this.options.textNodeName)&&e.substr(this.attrPrefixLen)}qe.prototype.build=function(e){return this.options.preserveOrder?Fe(e,this.options):(Array.isArray(e)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(e={[this.options.arrayNodeName]:e}),this.j2x(e,0,[]).val)},qe.prototype.j2x=function(e,t,n){let r="",o="";const i=n.join(".");for(let s in e)if(Object.prototype.hasOwnProperty.call(e,s))if(void 0===e[s])this.isAttribute(s)&&(o+="");else if(null===e[s])this.isAttribute(s)||s===this.options.cdataPropName?o+="":"?"===s[0]?o+=this.indentate(t)+"<"+s+"?"+this.tagEndChar:o+=this.indentate(t)+"<"+s+"/"+this.tagEndChar;else if(e[s]instanceof Date)o+=this.buildTextValNode(e[s],s,"",t);else if("object"!=typeof e[s]){const n=this.isAttribute(s);if(n&&!this.ignoreAttributesFn(n,i))r+=this.buildAttrPairStr(n,""+e[s]);else if(!n)if(s===this.options.textNodeName){let t=this.options.tagValueProcessor(s,""+e[s]);o+=this.replaceEntitiesValue(t)}else o+=this.buildTextValNode(e[s],s,"",t)}else if(Array.isArray(e[s])){const r=e[s].length;let i="",a="";for(let l=0;l<r;l++){const r=e[s][l];if(void 0===r);else if(null===r)"?"===s[0]?o+=this.indentate(t)+"<"+s+"?"+this.tagEndChar:o+=this.indentate(t)+"<"+s+"/"+this.tagEndChar;else if("object"==typeof r)if(this.options.oneListGroup){const e=this.j2x(r,t+1,n.concat(s));i+=e.val,this.options.attributesGroupName&&r.hasOwnProperty(this.options.attributesGroupName)&&(a+=e.attrStr)}else i+=this.processTextOrObjNode(r,s,t,n);else if(this.options.oneListGroup){let e=this.options.tagValueProcessor(s,r);e=this.replaceEntitiesValue(e),i+=e}else i+=this.buildTextValNode(r,s,"",t)}this.options.oneListGroup&&(i=this.buildObjectNode(i,s,a,t)),o+=i}else if(this.options.attributesGroupName&&s===this.options.attributesGroupName){const t=Object.keys(e[s]),n=t.length;for(let o=0;o<n;o++)r+=this.buildAttrPairStr(t[o],""+e[s][t[o]])}else o+=this.processTextOrObjNode(e[s],s,t,n);return{attrStr:r,val:o}},qe.prototype.buildAttrPairStr=function(e,t){return t=this.options.attributeValueProcessor(e,""+t),t=this.replaceEntitiesValue(t),this.options.suppressBooleanAttributes&&"true"===t?" "+e:" "+e+'="'+t+'"'},qe.prototype.buildObjectNode=function(e,t,n,r){if(""===e)return"?"===t[0]?this.indentate(r)+"<"+t+n+"?"+this.tagEndChar:this.indentate(r)+"<"+t+n+this.closeTag(t)+this.tagEndChar;{let o="</"+t+this.tagEndChar,i="";return"?"===t[0]&&(i="?",o=""),!n&&""!==n||-1!==e.indexOf("<")?!1!==this.options.commentPropName&&t===this.options.commentPropName&&0===i.length?this.indentate(r)+`\x3c!--${e}--\x3e`+this.newLine:this.indentate(r)+"<"+t+n+i+this.tagEndChar+e+this.indentate(r)+o:this.indentate(r)+"<"+t+n+i+">"+e+o}},qe.prototype.closeTag=function(e){let t="";return-1!==this.options.unpairedTags.indexOf(e)?this.options.suppressUnpairedNode||(t="/"):t=this.options.suppressEmptyNode?"/":`></${e}`,t},qe.prototype.buildTextValNode=function(e,t,n,r){if(!1!==this.options.cdataPropName&&t===this.options.cdataPropName)return this.indentate(r)+`<![CDATA[${e}]]>`+this.newLine;if(!1!==this.options.commentPropName&&t===this.options.commentPropName)return this.indentate(r)+`\x3c!--${e}--\x3e`+this.newLine;if("?"===t[0])return this.indentate(r)+"<"+t+n+"?"+this.tagEndChar;{let o=this.options.tagValueProcessor(t,e);return o=this.replaceEntitiesValue(o),""===o?this.indentate(r)+"<"+t+n+this.closeTag(t)+this.tagEndChar:this.indentate(r)+"<"+t+n+">"+o+"</"+t+this.tagEndChar}},qe.prototype.replaceEntitiesValue=function(e){if(e&&e.length>0&&this.options.processEntities)for(let t=0;t<this.options.entities.length;t++){const n=this.options.entities[t];e=e.replace(n.regex,n.val)}return e};function Je(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Ze(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Ze(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,i=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw i}}}}function Ze(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}var Qe="If you are creating a new entry you should write it like this:\n```xml\n<lorebooks>\n    <entry>\n        <worldName>World 1</worldName>\n        <name>Book 1</name>\n        <triggers>word1,word2</triggers>\n        <content>Content of book 1</content>\n    </entry>\n</lorebooks>\n```\n\nIf you are updating an existing entry you should specify the id of the entry. Like this:\n```xml\n<lorebooks>\n    <entry>\n        <worldName>World 1</worldName>\n        <id>15</id> // Id should be the id of the entry\n        <name>Book 1</name>\n        <triggers>word1,word2</triggers>\n        <content>Content of book 1</content>\n    </entry>\n</lorebooks>\n```",et=new class{constructor(e){this.externalEntities={},this.options=function(e){return Object.assign({},ie,e)}(e)}parse(e,t){if("string"==typeof e);else{if(!e.toString)throw new Error("XML data is accepted in String or Bytes[] form.");e=e.toString()}if(t){!0===t&&(t={});const n=H(e,t);if(!0!==n)throw Error(`${n.err.msg}:${n.err.line}:${n.err.col}`)}const n=new be(this.options);n.addExternalEntities(this.externalEntities);const r=n.parseXml(e);return this.options.preserveOrder||void 0===r?r:Le(r,this.options)}addEntity(e,t){if(-1!==t.indexOf("&"))throw new Error("Entity value can't have '&'");if(-1!==e.indexOf("&")||-1!==e.indexOf(";"))throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if("&"===t)throw new Error("An entity with value '&' is not permitted");this.externalEntities[e]=t}};function tt(e){var t,n,r,o=e.replace(/```xml/g,"").replace(/```/g,""),i={};try{var s,a=et.parse(o);if(!a.lorebooks)return i;var l,c=Je(null!==(s=a.lorebooks.entry)&&void 0!==s&&s.content?[a.lorebooks.entry]:a.lorebooks.entry);try{for(c.s();!(l=c.n()).done;){var u,d,p,f=l.value,m=f.worldName;m&&(i[m]||(i[m]=[]),i[m].push({uid:null!==(u=f.id)&&void 0!==u?u:(t=6,n=void 0,r=void 0,n=Math.pow(10,t-1),r=Math.pow(10,t)-1,Math.floor(Math.random()*(r-n+1))+n),key:null!==(d=null===(p=f.triggers)||void 0===p?void 0:p.split(",").map((function(e){return e.trim()})))&&void 0!==d?d:[],content:f.content,comment:f.name}))}}catch(e){c.e(e)}finally{c.f()}return i}catch(e){throw console.error(e),new Error("Model response is not valid XML")}}const nt=(e=>{var t={};return d.d(t,e),t})({Handlebars:()=>u.Handlebars});function rt(e){return rt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},rt(e)}function ot(e){return function(e){if(Array.isArray(e))return lt(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||at(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function it(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,i,s,a=[],l=!0,c=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=i.call(n)).done)&&(a.push(r.value),a.length!==t);l=!0);}catch(e){c=!0,o=e}finally{try{if(!l&&null!=n.return&&(s=n.return(),Object(s)!==s))return}finally{if(c)throw o}}return a}}(e,t)||at(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function st(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=at(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,i=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw i}}}}function at(e,t){if(e){if("string"==typeof e)return lt(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?lt(e,t):void 0}}function lt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function ct(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */ct=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},i="function"==typeof Symbol?Symbol:{},s=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",l=i.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var i=t&&t.prototype instanceof v?t:v,s=Object.create(i.prototype),a=new A(r||[]);return o(s,"_invoke",{value:E(e,n,a)}),s}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var p="suspendedStart",f="suspendedYield",m="executing",h="completed",g={};function v(){}function y(){}function x(){}var b={};c(b,s,(function(){return this}));var w=Object.getPrototypeOf,P=w&&w(w(C([])));P&&P!==n&&r.call(P,s)&&(b=P);var k=x.prototype=v.prototype=Object.create(b);function I(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function S(e,t){function n(o,i,s,a){var l=d(e[o],e,i);if("throw"!==l.type){var c=l.arg,u=c.value;return u&&"object"==rt(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,s,a)}),(function(e){n("throw",e,s,a)})):t.resolve(u).then((function(e){c.value=e,s(c)}),(function(e){return n("throw",e,s,a)}))}a(l.arg)}var i;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return i=i?i.then(o,o):o()}})}function E(t,n,r){var o=p;return function(i,s){if(o===m)throw Error("Generator is already running");if(o===h){if("throw"===i)throw s;return{value:e,done:!0}}for(r.method=i,r.arg=s;;){var a=r.delegate;if(a){var l=N(a,r);if(l){if(l===g)continue;return l}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===p)throw o=h,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=m;var c=d(t,n,r);if("normal"===c.type){if(o=r.done?h:f,c.arg===g)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(o=h,r.method="throw",r.arg=c.arg)}}}function N(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,N(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var i=d(o,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,g;var s=i.arg;return s?s.done?(n[t.resultName]=s.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):s:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function T(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function C(t){if(t||""===t){var n=t[s];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,i=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return i.next=i}}throw new TypeError(rt(t)+" is not iterable")}return y.prototype=x,o(k,"constructor",{value:x,configurable:!0}),o(x,"constructor",{value:y,configurable:!0}),y.displayName=c(x,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,x):(e.__proto__=x,c(e,l,"GeneratorFunction")),e.prototype=Object.create(k),e},t.awrap=function(e){return{__await:e}},I(S.prototype),c(S.prototype,a,(function(){return this})),t.AsyncIterator=S,t.async=function(e,n,r,o,i){void 0===i&&(i=Promise);var s=new S(u(e,n,r,o),i);return t.isGeneratorFunction(n)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},I(k),c(k,l,"Generator"),c(k,s,(function(){return this})),c(k,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=C,A.prototype={constructor:A,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(T),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return a.type="throw",a.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i],a=s.completion;if("root"===s.tryLoc)return o("end");if(s.tryLoc<=this.prev){var l=r.call(s,"catchLoc"),c=r.call(s,"finallyLoc");if(l&&c){if(this.prev<s.catchLoc)return o(s.catchLoc,!0);if(this.prev<s.finallyLoc)return o(s.finallyLoc)}else if(l){if(this.prev<s.catchLoc)return o(s.catchLoc,!0)}else{if(!c)throw Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return o(s.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=e,s.arg=t,i?(this.method="next",this.next=i.finallyLoc,g):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),T(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;T(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:C(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),g}},t}function ut(e,t,n,r,o,i,s){try{var a=e[i](s),l=a.value}catch(e){return void n(e)}a.done?t(l):Promise.resolve(l).then(r,o)}function dt(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function s(e){ut(i,r,o,s,a,"next",e)}function a(e){ut(i,r,o,s,a,"throw",e)}s(void 0)}))}}nt.Handlebars.helpers.join||nt.Handlebars.registerHelper("join",(function(e,t){return e.join(t)}));var pt,ft="SillyTavern-WorldInfo-Recommender",mt=SillyTavern.getContext(),ht={version:"0.1.1",formatVersion:"F_1.0",profileId:"",maxContextType:"profile",maxContextValue:16384,maxResponseToken:1024,contextToSend:{stDescription:!0,messages:{type:"all",first:10,last:10,range:{start:0,end:10}},charCard:!0,authorNote:!0,worldInfo:!0},stWorldInfoPrompt:D,usingDefaultStWorldInfoPrompt:!0,lorebookDefinitionPrompt:M,usingDefaultLorebookDefinitionPrompt:!0,lorebookRulesPrompt:V,usingDefaultLorebookRulesPrompt:!0,responseRulesPrompt:Qe,usingDefaultResponseRulesPrompt:!0,promptPreset:"default",promptPresets:{default:{content:""}}},gt=new class{settingsKey;defaultSettings;constructor(e,t){this.settingsKey=e,this.defaultSettings=t}async initializeSettings(e={}){const{strategy:t="recursive"}=e,n=this.defaultSettings.version,r=this.defaultSettings.formatVersion,o=SillyTavern.getContext().extensionSettings[this.settingsKey],i={version:{changed:!1,new:n??""},formatVersion:{changed:!1,new:r??""},oldSettings:null,newSettings:this.defaultSettings};if(!o)return SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings(),i;const s={...i,oldSettings:structuredClone(o),version:{changed:!1,old:o.version,new:o.version},formatVersion:{changed:!1,old:o.formatVersion,new:o.formatVersion}};if("recursive"===t){function a(e,t){let n=!1;for(const r of Object.keys(t))void 0===e[r]?(e[r]=t[r],n=!0):"object"==typeof t[r]&&null!==t[r]&&(e[r]=e[r]||{},a(e[r],t[r])&&(n=!0));return n}n&&o.version!==n&&(s.version.changed=!0,s.version.new=n,o.version=n),r&&o.formatVersion!==r&&(s.formatVersion.changed=!0,s.formatVersion.new=r,o.formatVersion=r),(a(o,this.defaultSettings)||s.version.changed||s.formatVersion.changed)&&this.saveSettings()}else if(Array.isArray(t)){n&&!o.version&&(o.version=n,s.version.changed=!0,s.version.new=n),r&&!o.formatVersion&&(o.formatVersion=r,s.formatVersion.changed=!0,s.formatVersion.new=r);let l=structuredClone(o),c=o.formatVersion;try{for(const u of t)if(c===u.from){l=await u.action(l),c=u.to,l.formatVersion=u.to;const d=this.defaultSettings.version;d&&(l.version=d),s.formatVersion.changed=!0,s.formatVersion.new=u.to}if(s.formatVersion.changed){Object.assign(o,l);for(const p of Object.keys(o))Object.keys(l).includes(p)||delete o[p];this.saveSettings()}}catch(f){throw console.error("Failed to apply version changes:",f),new Error(`Version migration failed: ${f instanceof Error?f.message:f}`,{cause:f})}}return s.newSettings=o,s}getSettings(){return SillyTavern.getContext().extensionSettings[this.settingsKey]}updateSetting(e,t){SillyTavern.getContext().extensionSettings[this.settingsKey][e]=t,this.saveSettings()}saveSettings(){SillyTavern.getContext().saveSettingsDebounced()}resetSettings(){SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings()}}("worldInfoRecommender",ht);function vt(){return vt=dt(ct().mark((function e(){var t,n,r,o,i,s,a,l,c,u,d,f,g;return ct().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,mt.renderExtensionTemplateAsync("third-party/".concat(ft),"templates/settings");case 2:t=e.sent,$("#extensions_settings").append(t),n=$(".worldInfoRecommender_settings"),r=gt.getSettings(),o=n.find(".stWorldInfoPrompt"),i=o.find("textarea"),s=n.find(".lorebookDefinitionPrompt"),a=s.find("textarea"),l=n.find(".lorebookRulesPrompt"),c=l.find("textarea"),u=n.find(".responseRulesPrompt"),d=u.find("textarea"),i.val(r.stWorldInfoPrompt),a.val(r.lorebookDefinitionPrompt),c.val(r.lorebookRulesPrompt),d.val(r.responseRulesPrompt),o.find(".restore_default").on("click",dt(ct().mark((function e(){return ct().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,mt.Popup.show.confirm("Are you sure you want to restore the default ST/World Info description?","World Info Recommender");case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:i.val(D),i.trigger("change");case 7:case"end":return e.stop()}}),e)})))),s.find(".restore_default").on("click",dt(ct().mark((function e(){return ct().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,mt.Popup.show.confirm("Are you sure you want to restore the default lorebook definition?","World Info Recommender");case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:a.val(M),a.trigger("change");case 7:case"end":return e.stop()}}),e)})))),l.find(".restore_default").on("click",dt(ct().mark((function e(){return ct().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,mt.Popup.show.confirm("Are you sure you want to restore the default lorebook rules?","World Info Recommender");case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:c.val(V),c.trigger("change");case 7:case"end":return e.stop()}}),e)})))),u.find(".restore_default").on("click",dt(ct().mark((function e(){return ct().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,mt.Popup.show.confirm("Are you sure you want to restore the default response rules?","World Info Recommender");case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:d.val(Qe),d.trigger("change");case 7:case"end":return e.stop()}}),e)})))),i.on("change",(function(){var e;r.stWorldInfoPrompt=null!==(e=i.val())&&void 0!==e?e:"",r.usingDefaultStWorldInfoPrompt=r.stWorldInfoPrompt===D,gt.saveSettings()})),a.on("change",(function(){var e;r.lorebookDefinitionPrompt=null!==(e=a.val())&&void 0!==e?e:"",r.usingDefaultLorebookDefinitionPrompt=r.lorebookDefinitionPrompt===M,gt.saveSettings()})),c.on("change",(function(){var e;r.lorebookRulesPrompt=null!==(e=c.val())&&void 0!==e?e:"",r.usingDefaultLorebookRulesPrompt=r.lorebookRulesPrompt===V,gt.saveSettings()})),d.on("change",(function(){var e;r.responseRulesPrompt=null!==(e=d.val())&&void 0!==e?e:"",r.usingDefaultResponseRulesPrompt=r.responseRulesPrompt===Qe,gt.saveSettings()})),f='<div class="menu_button fa-brands fa-wpexplorer interactable worldInfoRecommender-icon" title="World Info Recommender"></div>',$(".form_create_bottom_buttons_block").prepend($(f)),$("#GroupFavDelOkBack").prepend($(f)),g=$(".worldInfoRecommender-icon"),pt=g.eq(0),g.on("click",dt(ct().mark((function e(){var t,n,o,i,s,a,l,c,u,d,f,g,v,y,x,w,P,I,S,E,N,_,T,L,D,M,V,F,W,B,U,G,H,K,q,Y,X,z,J,Z,Q,ee,te,ne,re,oe,ie,se,ae,le,ce,ue,de,pe,fe;return ct().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return fe=function(){le.empty(),ee.suggestedEntries={},ee.blackListedEntries=[],ee.selectedWorldNames=structuredClone(Z),oe(),te()},pe=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"classic";function r(e,t){var n=e.data("world-name"),r=e.data("id"),o=e.data("comment");e&&n&&null!=r&&o?(t&&ee.blackListedEntries.push("".concat(n," (").concat(o,")")),ee.suggestedEntries[n]=ee.suggestedEntries[n].filter((function(e){return e.uid!==parseInt(r)})),e.remove()):n||k("warning","Selected entry is missing world name")}Object.entries(e).forEach((function(e){var r=it(e,2),o=r[0];r[1].forEach((function(e){var r=o,i=Z.indexOf(r);-1===i&&(r=t||(Z.length>0?Z[0]:"")),i=Z.indexOf(r),ee.suggestedEntries[o]||(ee.suggestedEntries[o]=[]);var s,a="initial"===n?void 0:ee.suggestedEntries[o].find((function(t){return t.uid===e.uid&&t.comment===e.comment}));if(a){var l='.entry[data-id="'.concat(e.uid,'"][data-world-name="').concat(o,'"]');s=le.find(l)}else s=$(ce.html());if(s.attr("data-world-name",o),s.attr("data-id",e.uid.toString()),s.attr("data-comment",e.comment),r){var c,u=null===(c=J[r])||void 0===c?void 0:c.find((function(t){return t.uid===e.uid}));s.find(".add").text(u?"Update":"Add")}var d=s.find(".world-select");d.empty(),Z.forEach((function(e,t){var n=document.createElement("option");n.value=t.toString(),n.text=e,d.append(n)})),-1!==i&&d.val(i.toString()),d.on("change",(function(){var t,n=parseInt($(this).val());if(!(isNaN(n)||n<0||n>=Z.length)){var r=Z[n],o=null===(t=J[r])||void 0===t?void 0:t.find((function(t){return t.uid===e.uid&&t.comment===e.comment}));s.find(".add").text(o?"Update":"Add")}})),s.find(".comment").text(e.comment),s.find(".key").text(e.key.join(", ")),s.find(".content").text(e.content),"classic"===n&&(a?(a.key=e.key,a.content=e.content,a.comment=e.comment):ee.suggestedEntries[o].push(e)),a||le.append(s)}))})),"classic"===n&&Object.keys(e).length>0&&te(),le.find(".blacklist").on("click",(function(e){var t=$(e.currentTarget).closest(".entry");t&&(r(t,!0),te())})),le.find(".remove").on("click",(function(e){var t=$(e.currentTarget).closest(".entry");t&&(r(t,!1),te())}));var o=le.find(".add");o.on("click",function(){var e=dt(ct().mark((function e(n){var i,s,a,l,c,u,d,p;return ct().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,o.prop("disabled",!0),i=$(n.currentTarget).closest(".entry")){e.next=5;break}return e.abrupt("return");case 5:if(s=i.data("world-name"),a=i.data("id"),l=i.data("comment"),i&&s&&null!=a&&l){e.next=11;break}return s||k("warning","Selected entry is missing world name"),e.abrupt("return");case 11:if(c=structuredClone(ee.suggestedEntries[s].find((function(e){return e.uid===parseInt(a)}))),c){e.next=14;break}return e.abrupt("return");case 14:if(u=i.find(".world-select"),d=parseInt(u.val()),!(isNaN(d)||d<0||d>=Z.length)){e.next=19;break}return k("warning","Please select a valid world"),e.abrupt("return");case 19:return p=Z[d],t=p,r(i,!1),e.next=24,ue(c,p);case 24:k("success","added"===e.sent?"Entry added":"Entry updated"),e.next=32;break;case 28:e.prev=28,e.t0=e.catch(0),console.error(e.t0),k("error",e.t0 instanceof Error?e.t0.message:e.t0);case 32:return e.prev=32,o.prop("disabled",!1),e.finish(32);case 35:case"end":return e.stop()}}),e,null,[[0,28,32,35]])})));return function(t){return e.apply(this,arguments)}}())},de=function(){return de=dt(ct().mark((function e(t,n){var r,o,i,s,a,l,c,u,d,p,f,m,g=arguments;return ct().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=g.length>2&&void 0!==g[2]&&g[2],J[n]||(J[n]=[]),i={entries:{}},s=st(J[n]);try{for(s.s();!(a=s.n()).done;)l=a.value,i.entries[l.uid]=l}catch(e){s.e(e)}finally{s.f()}if(c=null===(r=J[n])||void 0===r?void 0:r.find((function(e){return e.uid===t.uid})),!(d=!!c)){e.next=11;break}u=c,e.next=19;break;case 11:if(p=Object.values(i.entries),f=p.length>0?p[p.length-1]:void 0,v=n,y=i,u=(0,h.createWorldInfoEntry)(v,y)){e.next=16;break}throw new Error("Failed to create entry");case 16:m=u.uid,f&&Object.assign(u,f),u.uid=m;case 19:if(u.key=t.key,u.content=t.content,u.comment=t.comment,i.entries[u.uid]=u,J[n]=Object.values(i.entries),o){e.next=29;break}return e.next=27,mt.saveWorldInfo(n,i);case 27:mt.reloadWorldInfoEditor(n,!0),te();case 29:return e.abrupt("return",d?"updated":"added");case 30:case"end":return e.stop()}var v,y}),e)}))),de.apply(this,arguments)},ue=function(e,t){return de.apply(this,arguments)},te=function(){localStorage.setItem(Q,JSON.stringify(ee))},K=function(e){switch(V.hide(),F.hide(),W.hide(),e){case"first":V.show();break;case"last":F.show();break;case"range":W.show()}},e.next=8,mt.renderExtensionTemplateAsync("third-party/".concat(ft),"templates/popup");case 8:if(d=e.sent,mt.callGenericPopup(d,j.DISPLAY,void 0,{large:!0,wide:!0}),f=$("#worldInfoRecommenderPopup"),mt.ConnectionManagerRequestService.handleDropdown("#worldInfoRecommenderPopup #worldInfoRecommend_connectionProfile",r.profileId,(function(e){var t;r.profileId=null!==(t=null==e?void 0:e.id)&&void 0!==t?t:"",gt.saveSettings()})),g=f.find("#worldInfoRecommend_charCardContainer"),v=g.find("#worldInfoRecommend_charCardSelect"),!b.selected_group){e.next=39;break}if(x=b.groups.findIndex((function(e){return e.id===b.selected_group})),0!==(w=b.groups[x]).generation_mode){e.next=38;break}v.empty(),P=st(w.members),e.prev=20,S=ct().mark((function e(){var t,n,r;return ct().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=I.value,n=m.characters.findIndex((function(e){return e.avatar===t})),r=m.characters[n].name,v.append('<option value="'.concat(n,'">').concat(r,"</option>"));case 4:case"end":return e.stop()}}),e)})),P.s();case 23:if((I=P.n()).done){e.next=27;break}return e.delegateYield(S(),"t0",25);case 25:e.next=23;break;case 27:e.next=32;break;case 29:e.prev=29,e.t1=e.catch(20),P.e(e.t1);case 32:return e.prev=32,P.f(),e.finish(32);case 35:g.show(),e.next=39;break;case 38:w.members.length>0&&(y=m.characters.findIndex((function(e){return e.avatar===w.members[0]})));case 39:if(E=m.this_chid?A(m.this_chid):b.selected_group){e.next=43;break}return k("warning","No active character found."),e.abrupt("return");case 43:return N=f.find("#worldInfoRecommend_stDescription"),_=f.find(".message-options"),T=f.find("#worldInfoRecommend_charCard"),L=f.find("#worldInfoRecommend_authorNote"),D=f.find("#worldInfoRecommend_worldInfo"),N.prop("checked",r.contextToSend.stDescription),T.prop("checked",r.contextToSend.charCard),L.prop("checked",r.contextToSend.authorNote),D.prop("checked",r.contextToSend.worldInfo),M=_.find("#messageType"),V=_.find("#firstX"),F=_.find("#lastX"),W=_.find("#rangeX"),B=_.find("#firstXMessages"),U=_.find("#lastXMessages"),G=_.find("#rangeStart"),H=_.find("#rangeEnd"),M.val(r.contextToSend.messages.type),B.val(null!==(t=r.contextToSend.messages.first)&&void 0!==t?t:10),U.val(null!==(n=r.contextToSend.messages.last)&&void 0!==n?n:10),G.val(null!==(o=null===(i=r.contextToSend.messages.range)||void 0===i?void 0:i.start)&&void 0!==o?o:0),H.val(null!==(s=null===(a=r.contextToSend.messages.range)||void 0===a?void 0:a.end)&&void 0!==s?s:10),K(r.contextToSend.messages.type),N.on("change",(function(){r.contextToSend.stDescription=N.prop("checked"),gt.saveSettings()})),T.on("change",(function(){r.contextToSend.charCard=T.prop("checked"),gt.saveSettings()})),L.on("change",(function(){r.contextToSend.authorNote=L.prop("checked"),gt.saveSettings()})),D.on("change",(function(){r.contextToSend.worldInfo=D.prop("checked"),gt.saveSettings()})),M.on("change",(function(){var e=M.val();r.contextToSend.messages.type=e,gt.saveSettings(),K(e)})),B.on("change",(function(){r.contextToSend.messages.first=parseInt(B.val())||10,gt.saveSettings()})),U.on("change",(function(){r.contextToSend.messages.last=parseInt(U.val())||10,gt.saveSettings()})),G.on("change",(function(){r.contextToSend.messages.range||(r.contextToSend.messages.range={start:0,end:10}),r.contextToSend.messages.range.start=parseInt(G.val())||0,gt.saveSettings()})),H.on("change",(function(){r.contextToSend.messages.range||(r.contextToSend.messages.range={start:0,end:10}),r.contextToSend.messages.range.end=parseInt(H.val())||10,gt.saveSettings()})),q=f.find("#worldInfoRecommend_maxContextType"),Y=f.find("#worldInfoRecommend_maxTokens_container"),q.val(r.maxContextType),Y.css("display","custom"===r.maxContextType?"block":"none"),q.on("change",(function(){var e=q.val();r.maxContextType=e,gt.saveSettings(),"custom"===e?Y.show():Y.hide()})),(X=f.find("#worldInfoRecommend_maxTokens")).val(r.maxContextValue),X.on("change",(function(){var e=Number(X.val());r.maxContextValue=e,gt.saveSettings()})),(z=f.find("#worldInfoRecommend_maxResponseTokens")).val(r.maxResponseToken),z.on("change",(function(){var e=Number(z.val());r.maxResponseToken=e,gt.saveSettings()})),e.next=88,R(["all"],m.this_chid);case 88:if(J=e.sent,0===(Z=Object.keys(J)).length&&k("warning","No active World Info entries found."),Q="worldInfoRecommend_".concat(E),(ee=JSON.parse(null!==(l=localStorage.getItem(Q))&&void 0!==l?l:"{}")).suggestedEntries||(ee.suggestedEntries={},te()),ee.blackListedEntries||(ee.blackListedEntries=[],te()),ee.selectedWorldNames||(ee.selectedWorldNames=structuredClone(Z),te()),(ne=ee.selectedWorldNames.filter((function(e){return!Z.includes(e)}))).length>0&&(k("warning","World names missing from last session: ".concat(ne.join(", "))),ee.selectedWorldNames=ee.selectedWorldNames.filter((function(e){return!ne.includes(e)})),te()),re=p("#worldInfoRecommend_worldInfoContainer",{label:"World Info",initialList:Z,initialValues:ee.selectedWorldNames,onSelectChange:function(e,t){ee.selectedWorldNames=t,te()}}),oe=re.selectAll,ie=f.find("#worldInfoRecommend_prompt"),C("#worldInfoRecommenderPopup #worldInfoRecommend_promptPreset",{label:"prompt",initialValue:r.promptPreset,initialList:Object.keys(r.promptPresets),readOnlyValues:["default"],onSelectChange:function(){var e=dt(ct().mark((function e(t,n){var o,i,s;return ct().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:s=null!=n?n:"default",r.promptPreset=s,gt.saveSettings(),ie.val(null!==(o=null===(i=r.promptPresets[s])||void 0===i?void 0:i.content)&&void 0!==o?o:"");case 4:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),create:{onAfterCreate:function(e){var t,n=r.promptPresets[r.promptPreset];r.promptPresets[e]={content:null!==(t=null==n?void 0:n.content)&&void 0!==t?t:""}}},rename:{onAfterRename:function(e,t){r.promptPresets[t]=r.promptPresets[e],delete r.promptPresets[e]}},delete:{onAfterDelete:function(e){delete r.promptPresets[e]}}}),ie.val(null!==(c=null===(u=r.promptPresets[r.promptPreset])||void 0===u?void 0:u.content)&&void 0!==c?c:""),ie.on("change",(function(){var e=$(this).val();r.promptPresets[r.promptPreset].content=e,gt.saveSettings()})),se=f.find("#worldInfoRecommend_sendPrompt"),ae=f.find("#worldInfoRecommend_addAll"),le=f.find("#worldInfoRecommend_suggestedEntries"),ce=f.find("#worldInfoRecommend_entryTemplate")){e.next=110;break}return k("warning","Missing entry template. Contact developer."),e.abrupt("return");case 110:pe(ee.suggestedEntries,null,"initial"),f.find("#worldInfoRecommend_reset").on("click",dt(ct().mark((function e(){return ct().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,mt.Popup.show.confirm("World Info Recommender",'Are you sure you want to reset? This will clear all suggested entries, reset the "Lorebooks to Include".');case 3:if(e.sent){e.next=6;break}return e.abrupt("return");case 6:fe(),k("success","Reset successful"),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(0),console.error(e.t0),k("error",e.t0 instanceof Error?e.t0.message:e.t0);case 14:case"end":return e.stop()}}),e,null,[[0,10]])})))),ae.on("click",dt(ct().mark((function e(){var t,n,r,o,i,s,a,l,c,u,d,p,m,h,g,v,y,x,b,w,P,I;return ct().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,ae.prop("disabled",!0),0!==Z.length){e.next=5;break}return k("error","No available worlds to add entries to"),e.abrupt("return");case 5:if(t=Object.values(ee.suggestedEntries).reduce((function(e,t){return e+t.length}),0),0!==t){e.next=9;break}return k("warning","No entries to add"),e.abrupt("return");case 9:return e.next=11,mt.Popup.show.confirm("World Info Recommender","Are you sure you want to add/update all ".concat(t," suggested entries?"));case 11:if(e.sent){e.next=14;break}return e.abrupt("return");case 14:n=0,r=0,o=[],i=new Set,s=0,a=Object.entries(ee.suggestedEntries);case 19:if(!(s<a.length)){e.next=56;break}if(l=it(a[s],2),c=l[0],0!==(u=l[1]).length){e.next=23;break}return e.abrupt("continue",53);case 23:d=st(u),e.prev=24,d.s();case 26:if((p=d.n()).done){e.next=45;break}return m=p.value,J[h=c]||(h=Z[0]),e.prev=30,e.next=33,ue(m,h,!0);case 33:g=e.sent,o.push({worldName:h,entry:m,status:g}),"added"===g?n++:r++,i.add(h),e.next=43;break;case 39:e.prev=39,e.t0=e.catch(30),console.error("Failed to process entry: ".concat(m.comment),e.t0),k("error","Failed to process entry: ".concat(m.comment));case 43:e.next=26;break;case 45:e.next=50;break;case 47:e.prev=47,e.t1=e.catch(24),d.e(e.t1);case 50:return e.prev=50,d.f(),e.finish(50);case 53:s++,e.next=19;break;case 56:v=st(i),e.prev=57,v.s();case 59:if((y=v.n()).done){e.next=69;break}x=y.value,b={entries:{}},w=st(J[x]);try{for(w.s();!(P=w.n()).done;)I=P.value,b.entries[I.uid]=I}catch(e){w.e(e)}finally{w.f()}return e.next=66,mt.saveWorldInfo(x,b);case 66:mt.reloadWorldInfoEditor(x,!0);case 67:e.next=59;break;case 69:e.next=74;break;case 71:e.prev=71,e.t2=e.catch(57),v.e(e.t2);case 74:return e.prev=74,v.f(),e.finish(74);case 77:ee.suggestedEntries={},te(),f.find("#worldInfoRecommend_suggestedEntries").empty(),n>0||r>0?k("success",'\n            <div class="results-summary">\n              <p>Successfully processed '.concat(n+r," entries:</p>\n              <ul>\n              <li>Added: ").concat(n,"</li>\n              <li>Updated: ").concat(r,"</li>\n              <li>Modified worlds: ").concat(Array.from(i).join(", "),"</li>\n              </ul>\n            </div>"),{escapeHtml:!1}):k("warning","No entries were processed successfully"),e.next=87;break;case 83:e.prev=83,e.t3=e.catch(0),console.error(e.t3),k("error",e.t3 instanceof Error?e.t3.message:e.t3);case 87:return e.prev=87,ae.prop("disabled",!1),e.finish(87);case 90:case"end":return e.stop()}}),e,null,[[0,83,87,90],[24,47,50,53],[30,39],[57,71,74,77]])})))),se.on("click",dt(ct().mark((function e(){var t,n,o,i,s,a,l,c,u,d,p,f,m,h,g,x,w,P,I,S,E,N,_;return ct().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,se.prop("disabled",!0),r.profileId){e.next=4;break}return e.abrupt("return");case 4:if(s=SillyTavern.getContext(),a=null===(o=s.extensionSettings.connectionManager)||void 0===o||null===(o=o.profiles)||void 0===o?void 0:o.find((function(e){return e.id===r.profileId}))){e.next=8;break}return e.abrupt("return");case 8:if(l=ie.val()){e.next=11;break}return e.abrupt("return");case 11:if(l=mt.substituteParams(l.trim())){e.next=14;break}return e.abrupt("return");case 14:if(c=[],u=a.api?mt.CONNECT_API_MAP[a.api].selected:void 0){e.next=18;break}return e.abrupt("return");case 18:d=v.val(),p={presetName:a.preset,contextName:a.context,instructName:a.instruct,syspromptName:a.sysprompt,ignoreCharacterFields:!r.contextToSend.charCard,ignoreWorldInfo:!0,ignoreAuthorNote:!r.contextToSend.authorNote,maxContext:"custom"===r.maxContextType?r.maxContextValue:"profile"===r.maxContextType?"preset":"active",includeNames:!!b.selected_group,targetCharacterId:b.selected_group?null!==(i=d?Number(d):void 0)&&void 0!==i?i:y:void 0},e.t0=r.contextToSend.messages.type,e.next="none"===e.t0?23:"first"===e.t0?25:"last"===e.t0?27:"range"===e.t0?30:(e.t0,32);break;case 23:return p.messageIndexesBetween={start:-1,end:-1},e.abrupt("break",33);case 25:return p.messageIndexesBetween={start:0,end:null!==(t=r.contextToSend.messages.first)&&void 0!==t?t:10},e.abrupt("break",33);case 27:return f=null!==(n=r.contextToSend.messages.last)&&void 0!==n?n:10,p.messageIndexesBetween={end:s.chat.length-1,start:s.chat.length-f},e.abrupt("break",33);case 30:return r.contextToSend.messages.range&&(p.messageIndexesBetween={start:r.contextToSend.messages.range.start,end:r.contextToSend.messages.range.end}),e.abrupt("break",33);case 32:return e.abrupt("break",33);case 33:return e.t1=c.push,e.t2=c,e.t3=ot,e.next=38,O(u,p);case 38:return e.t4=e.sent,e.t5=(0,e.t3)(e.t4),e.t1.apply.call(e.t1,e.t2,e.t5),r.contextToSend.stDescription&&c.push({role:"system",content:r.stWorldInfoPrompt}),r.contextToSend.worldInfo&&ee.selectedWorldNames.length>0&&(m=nt.Handlebars.compile(r.lorebookDefinitionPrompt,{noEscape:!0}),h={},Object.entries(J).filter((function(e){var t=it(e,2),n=t[0];return t[1].length>0&&ee.selectedWorldNames.includes(n)})).forEach((function(e){var t=it(e,2),n=t[0],r=t[1];h[n]=r})),(g=m({lorebooks:h}))&&c.push({role:"assistant",content:"=== CURRENT LOREBOOKS ===\n".concat(g)})),ee.blackListedEntries.length>0&&(x="# Blacklisted Entries:\n",ee.blackListedEntries.forEach((function(e){x+="- ".concat(e,"\n")})),c.push({role:"system",content:x})),Object.keys(ee.suggestedEntries).length>0&&(w=Object.values(ee.suggestedEntries).some((function(e){return e.length>0})),w&&(P=nt.Handlebars.compile(r.lorebookDefinitionPrompt,{noEscape:!0}),I={},Object.entries(ee.suggestedEntries).filter((function(e){var t=it(e,2);t[0];return t[1].length>0})).forEach((function(e){var t=it(e,2),n=t[0],r=t[1];I[n]=r})),S=P({lorebooks:I}),c.push({role:"system",content:"=== Already suggested entries ===\n".concat(S)}))),E="".concat(r.responseRulesPrompt,"\n\n").concat(r.lorebookRulesPrompt,"\n\nYour task:\n").concat(l),c.push({role:"user",content:E}),e.next=49,mt.ConnectionManagerRequestService.sendRequest(a.id,c,r.maxResponseToken);case 49:if(N=e.sent,_=tt(N.content),0!==Object.keys(_).length){e.next=54;break}return k("warning","No entries in response"),e.abrupt("return");case 54:Object.entries(_).forEach((function(e){var t=it(e,2),n=t[0],r=t[1];J[n]&&r.forEach((function(e){var t,r=null===(t=J[n])||void 0===t?void 0:t.find((function(t){return t.uid===e.uid}));r&&(0===e.key.length&&(e.key=r.key),e.comment||(e.comment=r.comment))}))})),pe(_,null,"classic"),e.next=63;break;case 59:e.prev=59,e.t6=e.catch(0),console.error(e.t6),k("error",e.t6 instanceof Error?e.t6.message:e.t6);case 63:return e.prev=63,se.prop("disabled",!1),e.finish(63);case 66:case"end":return e.stop()}}),e,null,[[0,59,63,66]])}))));case 115:case"end":return e.stop()}}),e,null,[[20,29,32,35]])}))));case 32:case"end":return e.stop()}}),e)}))),vt.apply(this,arguments)}function yt(){var e;!function(){vt.apply(this,arguments)}(),mt.SlashCommandParser.addCommandObject(mt.SlashCommand.fromProps({name:"world-info-recommender-popup-open",helpString:"Open World Info Recommender popup",unnamedArgumentList:[],callback:(e=dt(ct().mark((function e(t,n){return ct().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!pt){e.next=3;break}return pt.trigger("click"),e.abrupt("return",!0);case 3:return e.abrupt("return",!1);case 4:case"end":return e.stop()}}),e)}))),function(t,n){return e.apply(this,arguments)}),returns:mt.ARGUMENT_TYPE.BOOLEAN}))}if(mt.ConnectionManagerRequestService&&mt.getCharacterCardFields&&mt.getWorldInfoPrompt&&mt.reloadWorldInfoEditor)gt.initializeSettings().then((function(e){if(e.version.changed){var t=gt.getSettings(),n=!1;t.usingDefaultStWorldInfoPrompt&&t.stWorldInfoPrompt!==D&&(t.stWorldInfoPrompt=D,n=!0),t.usingDefaultLorebookDefinitionPrompt&&t.lorebookDefinitionPrompt!==M&&(t.lorebookDefinitionPrompt=M,n=!0),t.usingDefaultLorebookRulesPrompt&&t.lorebookRulesPrompt!==V&&(t.lorebookRulesPrompt=V,n=!0),t.usingDefaultResponseRulesPrompt&&t.responseRulesPrompt!==Qe&&(t.responseRulesPrompt=Qe,n=!0),n&&gt.saveSettings()}yt()})).catch((function(e){k("error",e),mt.Popup.show.confirm("Data migration failed. Do you want to reset the World Info Recommender data?","World Info Recommender").then((function(e){e&&(gt.resetSettings(),yt())}))}));else{k("error","[World Info Recommender Error] Make sure you are on staging branch and staging is updated.")}